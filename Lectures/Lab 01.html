<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lab 01: Prescreening Model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="Lab 01_files/libs/clipboard/clipboard.min.js"></script>
<script src="Lab 01_files/libs/quarto-html/quarto.js"></script>
<script src="Lab 01_files/libs/quarto-html/popper.min.js"></script>
<script src="Lab 01_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Lab 01_files/libs/quarto-html/anchor.min.js"></script>
<link href="Lab 01_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Lab 01_files/libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Lab 01_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Lab 01_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Lab 01_files/libs/bootstrap/bootstrap-2cdb6c447a9b70e5e1f1f0acec0d17a0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#import-python-libraries" id="toc-import-python-libraries" class="nav-link active" data-scroll-target="#import-python-libraries"><span class="header-section-number">1</span> Import Python Libraries</a></li>
  <li><a href="#read-data" id="toc-read-data" class="nav-link" data-scroll-target="#read-data"><span class="header-section-number">2</span> Read Data</a></li>
  <li><a href="#peek-at-the-tables" id="toc-peek-at-the-tables" class="nav-link" data-scroll-target="#peek-at-the-tables"><span class="header-section-number">3</span> Peek at the Tables</a>
  <ul class="collapse">
  <li><a href="#data-checks" id="toc-data-checks" class="nav-link" data-scroll-target="#data-checks"><span class="header-section-number">3.1</span> Data Checks</a></li>
  <li><a href="#qa" id="toc-qa" class="nav-link" data-scroll-target="#qa"><span class="header-section-number">3.2</span> Q&amp;A</a>
  <ul class="collapse">
  <li><a href="#question" id="toc-question" class="nav-link" data-scroll-target="#question"><span class="header-section-number">3.2.1</span> Question</a></li>
  <li><a href="#question-1" id="toc-question-1" class="nav-link" data-scroll-target="#question-1"><span class="header-section-number">3.2.2</span> Question</a></li>
  <li><a href="#question-2" id="toc-question-2" class="nav-link" data-scroll-target="#question-2"><span class="header-section-number">3.2.3</span> Question</a></li>
  <li><a href="#question-3" id="toc-question-3" class="nav-link" data-scroll-target="#question-3"><span class="header-section-number">3.2.4</span> Question</a></li>
  <li><a href="#question-4" id="toc-question-4" class="nav-link" data-scroll-target="#question-4"><span class="header-section-number">3.2.5</span> Question</a></li>
  <li><a href="#question-5" id="toc-question-5" class="nav-link" data-scroll-target="#question-5"><span class="header-section-number">3.2.6</span> Question</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#merge-the-tables" id="toc-merge-the-tables" class="nav-link" data-scroll-target="#merge-the-tables"><span class="header-section-number">4</span> Merge the Tables</a></li>
  <li><a href="#split-the-data" id="toc-split-the-data" class="nav-link" data-scroll-target="#split-the-data"><span class="header-section-number">5</span> Split the Data</a></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis"><span class="header-section-number">6</span> Exploratory Data Analysis</a></li>
  <li><a href="#replace--99999-with--1" id="toc-replace--99999-with--1" class="nav-link" data-scroll-target="#replace--99999-with--1"><span class="header-section-number">7</span> Replace -99999 with -1</a></li>
  <li><a href="#subset-the-features" id="toc-subset-the-features" class="nav-link" data-scroll-target="#subset-the-features"><span class="header-section-number">8</span> Subset the features</a></li>
  <li><a href="#supervised-learning" id="toc-supervised-learning" class="nav-link" data-scroll-target="#supervised-learning"><span class="header-section-number">9</span> Supervised Learning</a></li>
  <li><a href="#best-model" id="toc-best-model" class="nav-link" data-scroll-target="#best-model"><span class="header-section-number">10</span> Best Model</a></li>
  <li><a href="#check-probability-calibration" id="toc-check-probability-calibration" class="nav-link" data-scroll-target="#check-probability-calibration"><span class="header-section-number">11</span> Check Probability Calibration</a></li>
  <li><a href="#permutation-feature-importance" id="toc-permutation-feature-importance" class="nav-link" data-scroll-target="#permutation-feature-importance"><span class="header-section-number">12</span> Permutation Feature Importance</a></li>
  <li><a href="#partial-dependence-plots" id="toc-partial-dependence-plots" class="nav-link" data-scroll-target="#partial-dependence-plots"><span class="header-section-number">13</span> Partial Dependence Plots</a>
  <ul class="collapse">
  <li><a href="#qa-1" id="toc-qa-1" class="nav-link" data-scroll-target="#qa-1"><span class="header-section-number">13.1</span> Q&amp;A</a>
  <ul class="collapse">
  <li><a href="#question-6" id="toc-question-6" class="nav-link" data-scroll-target="#question-6"><span class="header-section-number">13.1.1</span> Question</a></li>
  <li><a href="#question-7" id="toc-question-7" class="nav-link" data-scroll-target="#question-7"><span class="header-section-number">13.1.2</span> Question</a></li>
  </ul></li>
  <li><a href="#more-pdp" id="toc-more-pdp" class="nav-link" data-scroll-target="#more-pdp"><span class="header-section-number">13.2</span> More PDP</a></li>
  </ul></li>
  <li><a href="#accumulated-local-effects-plots" id="toc-accumulated-local-effects-plots" class="nav-link" data-scroll-target="#accumulated-local-effects-plots"><span class="header-section-number">14</span> Accumulated Local Effects Plots</a></li>
  <li><a href="#model-evaluation" id="toc-model-evaluation" class="nav-link" data-scroll-target="#model-evaluation"><span class="header-section-number">15</span> Model Evaluation</a>
  <ul class="collapse">
  <li><a href="#qa-2" id="toc-qa-2" class="nav-link" data-scroll-target="#qa-2"><span class="header-section-number">15.1</span> Q&amp;A</a>
  <ul class="collapse">
  <li><a href="#question-8" id="toc-question-8" class="nav-link" data-scroll-target="#question-8"><span class="header-section-number">15.1.1</span> Question</a></li>
  <li><a href="#question-9" id="toc-question-9" class="nav-link" data-scroll-target="#question-9"><span class="header-section-number">15.1.2</span> Question</a></li>
  <li><a href="#question-10" id="toc-question-10" class="nav-link" data-scroll-target="#question-10"><span class="header-section-number">15.1.3</span> Question</a></li>
  <li><a href="#question-11" id="toc-question-11" class="nav-link" data-scroll-target="#question-11"><span class="header-section-number">15.1.4</span> Question</a></li>
  <li><a href="#question-12" id="toc-question-12" class="nav-link" data-scroll-target="#question-12"><span class="header-section-number">15.1.5</span> Question</a></li>
  <li><a href="#question-13" id="toc-question-13" class="nav-link" data-scroll-target="#question-13"><span class="header-section-number">15.1.6</span> Question</a></li>
  <li><a href="#question-14" id="toc-question-14" class="nav-link" data-scroll-target="#question-14"><span class="header-section-number">15.1.7</span> Question</a></li>
  </ul></li>
  <li><a href="#gain-and-lift-plots" id="toc-gain-and-lift-plots" class="nav-link" data-scroll-target="#gain-and-lift-plots"><span class="header-section-number">15.2</span> Gain and Lift Plots</a></li>
  <li><a href="#gain-and-lift-plots-automated" id="toc-gain-and-lift-plots-automated" class="nav-link" data-scroll-target="#gain-and-lift-plots-automated"><span class="header-section-number">15.3</span> Gain and Lift Plots (Automated)</a></li>
  </ul></li>
  <li><a href="#pick-a-threshold-to-maximize-f1-score" id="toc-pick-a-threshold-to-maximize-f1-score" class="nav-link" data-scroll-target="#pick-a-threshold-to-maximize-f1-score"><span class="header-section-number">16</span> Pick a Threshold to Maximize F1 Score</a></li>
  <li><a href="#select-targets" id="toc-select-targets" class="nav-link" data-scroll-target="#select-targets"><span class="header-section-number">17</span> Select Targets</a></li>
  <li><a href="#measure-campaign-effectiveness" id="toc-measure-campaign-effectiveness" class="nav-link" data-scroll-target="#measure-campaign-effectiveness"><span class="header-section-number">18</span> Measure Campaign Effectiveness</a></li>
  <li><a href="#measure-campaign-roi" id="toc-measure-campaign-roi" class="nav-link" data-scroll-target="#measure-campaign-roi"><span class="header-section-number">19</span> Measure Campaign ROI</a></li>
  <li><a href="#feature-reduction-methods" id="toc-feature-reduction-methods" class="nav-link" data-scroll-target="#feature-reduction-methods"><span class="header-section-number">20</span> Feature Reduction Methods</a>
  <ul class="collapse">
  <li><a href="#filter-based-methods" id="toc-filter-based-methods" class="nav-link" data-scroll-target="#filter-based-methods"><span class="header-section-number">20.1</span> Filter-based Methods</a></li>
  <li><a href="#embedded-methods" id="toc-embedded-methods" class="nav-link" data-scroll-target="#embedded-methods"><span class="header-section-number">20.2</span> Embedded Methods</a></li>
  <li><a href="#wrapper-methods" id="toc-wrapper-methods" class="nav-link" data-scroll-target="#wrapper-methods"><span class="header-section-number">20.3</span> Wrapper Methods</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Lab 01: Prescreening Model</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta column-page-left">

    
  
    
  </div>
  


</header>


<section id="import-python-libraries" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Import Python Libraries</h1>
<div id="638d0599" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># System utilities</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> shutil</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> random</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> torch</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="im">import</span> psutil</span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co"># Set n_jobs to half the number of physical cores</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>num_jobs <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">int</span>(psutil.cpu_count(logical<span class="op">=</span><span class="va">False</span>) <span class="op">/</span> <span class="dv">2</span>))</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co"># Data manipulation and visualization</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="im">import</span> duckdb</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co"># Machine learning - scikit-learn</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, ClassifierMixin, TransformerMixin</span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="im">from</span> sklearn.utils.validation <span class="im">import</span> check_is_fitted, check_X_y, check_array</span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> FunctionTransformer, OrdinalEncoder</span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> CalibrationDisplay, CalibratedClassifierCV</span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="im">from</span> sklearn.feature_selection <span class="im">import</span> SelectKBest, SelectFromModel, SequentialFeatureSelector, mutual_info_classif</span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="im">from</span> sklearn.inspection <span class="im">import</span> PartialDependenceDisplay</span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> make_column_transformer, make_column_selector</span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> ExtraTreesClassifier</span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="im">from</span> sklearn <span class="im">import</span> set_config</span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="co"># Specialized ML libraries</span></span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="im">from</span> autogluon.tabular <span class="im">import</span> TabularPredictor, TabularDataset</span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="im">from</span> ydata_profiling <span class="im">import</span> ProfileReport</span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="im">from</span> scikitplot.metrics <span class="im">import</span> plot_cumulative_gain, plot_lift_curve</span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="im">from</span> PyALE <span class="im">import</span> ale</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="read-data" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Read Data</h1>
<p>Text and CSV files are common data formats in universities. However, in companies, data is often stored in databases (like SQL Server, PostgreSQL, Snowflake, or DataBricks).</p>
<p>In the lab, we will use the <code>duckdb</code> library to process data as if we were using a database.</p>
<p>The code loads two parquet files into tables:</p>
<ul>
<li><code>prospects.parquet</code>: Contains data about potential clients.</li>
<li><code>campaign_history.parquet</code>: Contains data about past prescreening campaigns.</li>
</ul>
<div id="575019cb" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>tbl_prospects <span class="op">=</span> duckdb.query(<span class="st">"""</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="st">    SELECT *</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="st">    FROM '../Data/cibil/prospects.parquet'</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="st">    """</span>)</span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a>tbl_campaign_history <span class="op">=</span> duckdb.query(<span class="st">"""</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="st">    SELECT * </span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="st">    FROM '../Data/cibil/campaign_history.parquet'</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="st">    """</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Show the column names from <code>tbl_prospects</code> and refer to the data dictionary (<code>../Data/cibil/Data Dictionary.xlsx</code>) for column definitions.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>duckdb.sql(<span class="st">"""</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="st">    SELECT column_name, column_type</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="st">    FROM</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="st">    (DESCRIBE SELECT * FROM tbl_prospects)</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="st">    """</span>).show(max_rows<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-meta-prospects" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="3">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-meta-prospects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Metadata for tbl_prospects
</figcaption>
<div aria-describedby="tbl-meta-prospects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-stdout">
<pre><code>┌──────────────────────────────┬─────────────┐
│         column_name          │ column_type │
│           varchar            │   varchar   │
├──────────────────────────────┼─────────────┤
│ PROSPECTID                   │ VARCHAR     │
│ time_since_recent_payment    │ BIGINT      │
│ time_since_first_deliquency  │ BIGINT      │
│ time_since_recent_deliquency │ BIGINT      │
│ num_times_delinquent         │ BIGINT      │
│ max_delinquency_level        │ BIGINT      │
│ max_recent_level_of_deliq    │ BIGINT      │
│ num_deliq_6mts               │ BIGINT      │
│ num_deliq_12mts              │ BIGINT      │
│ num_deliq_6_12mts            │ BIGINT      │
│ max_deliq_6mts               │ BIGINT      │
│ max_deliq_12mts              │ BIGINT      │
│ num_times_30p_dpd            │ BIGINT      │
│ num_times_60p_dpd            │ BIGINT      │
│ num_std                      │ BIGINT      │
│ num_std_6mts                 │ BIGINT      │
│ num_std_12mts                │ BIGINT      │
│ num_sub                      │ BIGINT      │
│ num_sub_6mts                 │ BIGINT      │
│ num_sub_12mts                │ BIGINT      │
│ num_dbt                      │ BIGINT      │
│ num_dbt_6mts                 │ BIGINT      │
│ num_dbt_12mts                │ BIGINT      │
│ num_lss                      │ BIGINT      │
│ num_lss_6mts                 │ BIGINT      │
│ num_lss_12mts                │ BIGINT      │
│ recent_level_of_deliq        │ BIGINT      │
│ tot_enq                      │ BIGINT      │
│ CC_enq                       │ BIGINT      │
│ CC_enq_L6m                   │ BIGINT      │
│ CC_enq_L12m                  │ BIGINT      │
│ PL_enq                       │ BIGINT      │
│ PL_enq_L6m                   │ BIGINT      │
│ PL_enq_L12m                  │ BIGINT      │
│ time_since_recent_enq        │ BIGINT      │
│ enq_L12m                     │ BIGINT      │
│ enq_L6m                      │ BIGINT      │
│ enq_L3m                      │ BIGINT      │
│ MARITALSTATUS                │ VARCHAR     │
│ EDUCATION                    │ VARCHAR     │
│ AGE                          │ BIGINT      │
│ GENDER                       │ VARCHAR     │
│ NETMONTHLYINCOME             │ BIGINT      │
│ Time_With_Curr_Empr          │ BIGINT      │
│ pct_of_active_TLs_ever       │ DOUBLE      │
│ pct_opened_TLs_L6m_of_L12m   │ DOUBLE      │
│ pct_currentBal_all_TL        │ DOUBLE      │
│ CC_utilization               │ DOUBLE      │
│ CC_Flag                      │ BIGINT      │
│ PL_utilization               │ DOUBLE      │
│ PL_Flag                      │ BIGINT      │
│ pct_PL_enq_L6m_of_L12m       │ DOUBLE      │
│ pct_CC_enq_L6m_of_L12m       │ DOUBLE      │
│ pct_PL_enq_L6m_of_ever       │ DOUBLE      │
│ pct_CC_enq_L6m_of_ever       │ DOUBLE      │
│ max_unsec_exposure_inPct     │ DOUBLE      │
│ HL_Flag                      │ BIGINT      │
│ GL_Flag                      │ BIGINT      │
│ last_prod_enq2               │ VARCHAR     │
│ first_prod_enq2              │ VARCHAR     │
│ Credit_Score                 │ BIGINT      │
│ Total_TL                     │ BIGINT      │
│ Tot_Closed_TL                │ BIGINT      │
│ Tot_Active_TL                │ BIGINT      │
│ Total_TL_opened_L6M          │ BIGINT      │
│ Tot_TL_closed_L6M            │ BIGINT      │
│ pct_tl_open_L6M              │ DOUBLE      │
│ pct_tl_closed_L6M            │ DOUBLE      │
│ pct_active_tl                │ DOUBLE      │
│ pct_closed_tl                │ DOUBLE      │
│ Total_TL_opened_L12M         │ BIGINT      │
│ Tot_TL_closed_L12M           │ BIGINT      │
│ pct_tl_open_L12M             │ DOUBLE      │
│ pct_tl_closed_L12M           │ DOUBLE      │
│ Tot_Missed_Pmnt              │ BIGINT      │
│ Auto_TL                      │ BIGINT      │
│ CC_TL                        │ BIGINT      │
│ Consumer_TL                  │ BIGINT      │
│ Gold_TL                      │ BIGINT      │
│ Home_TL                      │ BIGINT      │
│ PL_TL                        │ BIGINT      │
│ Secured_TL                   │ BIGINT      │
│ Unsecured_TL                 │ BIGINT      │
│ Other_TL                     │ BIGINT      │
│ Age_Oldest_TL                │ BIGINT      │
│ Age_Newest_TL                │ BIGINT      │
├──────────────────────────────┴─────────────┤
│ 86 rows                          2 columns │
└────────────────────────────────────────────┘
</code></pre>
</div>
</div>
</figure>
</div>
<p>Show the column names from <code>tbl_campaign_history</code>. The columns are defined as follows:</p>
<ul>
<li><code>PROSPECTID</code>: Unique identifier for each potential client.</li>
<li><code>CAMPAIGNID</code>: Unique identifier for each prescreening campaign. There are two historical campaigns and a current campaign (<code>campaign_id = '3'</code>).</li>
<li><code>response_flag</code>: Indicates whether the prospect responded to the campaign (1 for yes, 0 for no). For <code>campaign_id = '3'</code>, the flag is <code>NULL</code>.</li>
<li><code>direct_mail_flag</code>: Indicates whether the prospect was targeted in the campaign (Y for yes, N for no). For <code>campaign_id = '3'</code>, the flag is <code>NULL</code>.</li>
</ul>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>duckdb.sql(<span class="st">"""</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="st">    SELECT column_name, column_type</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="st">    FROM</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="st">    (DESCRIBE SELECT * FROM tbl_campaign_history)</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="st">    """</span>).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-meta-campaigns" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="4">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-meta-campaigns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Metadata for tbl_campaign_history
</figcaption>
<div aria-describedby="tbl-meta-campaigns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-stdout">
<pre><code>┌──────────────────┬─────────────┐
│   column_name    │ column_type │
│     varchar      │   varchar   │
├──────────────────┼─────────────┤
│ PROSPECTID       │ VARCHAR     │
│ campaign_id      │ VARCHAR     │
│ response_flag    │ INTEGER     │
│ direct_mail_flag │ VARCHAR     │
└──────────────────┴─────────────┘
</code></pre>
</div>
</div>
</figure>
</div>
</section>
<section id="peek-at-the-tables" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Peek at the Tables</h1>
<section id="data-checks" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="data-checks"><span class="header-section-number">3.1</span> Data Checks</h2>
<p>Look at the first 5 rows of each table.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>duckdb.sql(<span class="st">"""</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="st">    SELECT *</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="st">    FROM tbl_prospects</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="st">    LIMIT 5</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="st">"""</span>).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-top5-prospects" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="5">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-top5-prospects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: First 5 rows of tbl_prospects
</figcaption>
<div aria-describedby="tbl-top5-prospects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-stdout">
<pre><code>┌────────────┬───────────────────────────┬─────────────────────────────┬──────────────────────────────┬──────────────────────┬───────────────────────┬───────────────────────────┬────────────────┬─────────────────┬───────────────────┬────────────────┬─────────────────┬───────────────────┬───────────────────┬─────────┬──────────────┬───────────────┬─────────┬──────────────┬───────────────┬─────────┬──────────────┬───────────────┬─────────┬──────────────┬───────────────┬───────────────────────┬─────────┬────────┬────────────┬─────────────┬────────┬────────────┬─────────────┬───────────────────────┬──────────┬─────────┬─────────┬───────────────┬───────────┬───────┬─────────┬──────────────────┬─────────────────────┬────────────────────────┬────────────────────────────┬───────────────────────┬────────────────┬─────────┬────────────────┬─────────┬────────────────────────┬────────────────────────┬────────────────────────┬────────────────────────┬──────────────────────────┬─────────┬─────────┬────────────────┬─────────────────┬──────────────┬──────────┬───────────────┬───────────────┬─────────────────────┬───────────────────┬─────────────────┬───────────────────┬───────────────┬───────────────┬──────────────────────┬────────────────────┬──────────────────┬────────────────────┬─────────────────┬─────────┬───────┬─────────────┬─────────┬─────────┬───────┬────────────┬──────────────┬──────────┬───────────────┬───────────────┐
│ PROSPECTID │ time_since_recent_payment │ time_since_first_deliquency │ time_since_recent_deliquency │ num_times_delinquent │ max_delinquency_level │ max_recent_level_of_deliq │ num_deliq_6mts │ num_deliq_12mts │ num_deliq_6_12mts │ max_deliq_6mts │ max_deliq_12mts │ num_times_30p_dpd │ num_times_60p_dpd │ num_std │ num_std_6mts │ num_std_12mts │ num_sub │ num_sub_6mts │ num_sub_12mts │ num_dbt │ num_dbt_6mts │ num_dbt_12mts │ num_lss │ num_lss_6mts │ num_lss_12mts │ recent_level_of_deliq │ tot_enq │ CC_enq │ CC_enq_L6m │ CC_enq_L12m │ PL_enq │ PL_enq_L6m │ PL_enq_L12m │ time_since_recent_enq │ enq_L12m │ enq_L6m │ enq_L3m │ MARITALSTATUS │ EDUCATION │  AGE  │ GENDER  │ NETMONTHLYINCOME │ Time_With_Curr_Empr │ pct_of_active_TLs_ever │ pct_opened_TLs_L6m_of_L12m │ pct_currentBal_all_TL │ CC_utilization │ CC_Flag │ PL_utilization │ PL_Flag │ pct_PL_enq_L6m_of_L12m │ pct_CC_enq_L6m_of_L12m │ pct_PL_enq_L6m_of_ever │ pct_CC_enq_L6m_of_ever │ max_unsec_exposure_inPct │ HL_Flag │ GL_Flag │ last_prod_enq2 │ first_prod_enq2 │ Credit_Score │ Total_TL │ Tot_Closed_TL │ Tot_Active_TL │ Total_TL_opened_L6M │ Tot_TL_closed_L6M │ pct_tl_open_L6M │ pct_tl_closed_L6M │ pct_active_tl │ pct_closed_tl │ Total_TL_opened_L12M │ Tot_TL_closed_L12M │ pct_tl_open_L12M │ pct_tl_closed_L12M │ Tot_Missed_Pmnt │ Auto_TL │ CC_TL │ Consumer_TL │ Gold_TL │ Home_TL │ PL_TL │ Secured_TL │ Unsecured_TL │ Other_TL │ Age_Oldest_TL │ Age_Newest_TL │
│  varchar   │           int64           │            int64            │            int64             │        int64         │         int64         │           int64           │     int64      │      int64      │       int64       │     int64      │      int64      │       int64       │       int64       │  int64  │    int64     │     int64     │  int64  │    int64     │     int64     │  int64  │    int64     │     int64     │  int64  │    int64     │     int64     │         int64         │  int64  │ int64  │   int64    │    int64    │ int64  │   int64    │    int64    │         int64         │  int64   │  int64  │  int64  │    varchar    │  varchar  │ int64 │ varchar │      int64       │        int64        │         double         │           double           │        double         │     double     │  int64  │     double     │  int64  │         double         │         double         │         double         │         double         │          double          │  int64  │  int64  │    varchar     │     varchar     │    int64     │  int64   │     int64     │     int64     │        int64        │       int64       │     double      │      double       │    double     │    double     │        int64         │       int64        │      double      │       double       │      int64      │  int64  │ int64 │    int64    │  int64  │  int64  │ int64 │   int64    │    int64     │  int64   │     int64     │     int64     │
├────────────┼───────────────────────────┼─────────────────────────────┼──────────────────────────────┼──────────────────────┼───────────────────────┼───────────────────────────┼────────────────┼─────────────────┼───────────────────┼────────────────┼─────────────────┼───────────────────┼───────────────────┼─────────┼──────────────┼───────────────┼─────────┼──────────────┼───────────────┼─────────┼──────────────┼───────────────┼─────────┼──────────────┼───────────────┼───────────────────────┼─────────┼────────┼────────────┼─────────────┼────────┼────────────┼─────────────┼───────────────────────┼──────────┼─────────┼─────────┼───────────────┼───────────┼───────┼─────────┼──────────────────┼─────────────────────┼────────────────────────┼────────────────────────────┼───────────────────────┼────────────────┼─────────┼────────────────┼─────────┼────────────────────────┼────────────────────────┼────────────────────────┼────────────────────────┼──────────────────────────┼─────────┼─────────┼────────────────┼─────────────────┼──────────────┼──────────┼───────────────┼───────────────┼─────────────────────┼───────────────────┼─────────────────┼───────────────────┼───────────────┼───────────────┼──────────────────────┼────────────────────┼──────────────────┼────────────────────┼─────────────────┼─────────┼───────┼─────────────┼─────────┼─────────┼───────┼────────────┼──────────────┼──────────┼───────────────┼───────────────┤
│ 1          │                      1214 │                      -99999 │                       -99999 │                    0 │                -99999 │                         0 │              0 │               0 │                 0 │         -99999 │          -99999 │                 0 │                 0 │       0 │            0 │             0 │       0 │            0 │             0 │       0 │            0 │             0 │       0 │            0 │             0 │                     0 │       2 │      0 │          0 │           0 │      0 │          0 │           0 │                     1 │        1 │       1 │       1 │ Married       │ GRADUATE  │    42 │ M       │            28500 │                 297 │                    0.0 │                        0.0 │                   0.0 │       -99999.0 │       0 │       -99999.0 │       0 │                    0.0 │                    0.0 │                    0.0 │                    0.0 │                 -99999.0 │       0 │       0 │ others         │ others          │          685 │        1 │             1 │             0 │                   0 │                 0 │             0.0 │               0.0 │           0.0 │           1.0 │                    0 │                  0 │              0.0 │                0.0 │               0 │       1 │     0 │           0 │       0 │       0 │     0 │          1 │            0 │        0 │            58 │            58 │
│ 2          │                        89 │                      -99999 │                       -99999 │                    0 │                -99999 │                         0 │              0 │               0 │                 0 │              0 │               0 │                 0 │                 0 │       0 │            0 │             0 │       0 │            0 │             0 │       0 │            0 │             0 │       0 │            0 │             0 │                     0 │       1 │      0 │          0 │           0 │      1 │          1 │           1 │                   165 │        1 │       1 │       0 │ Single        │ GRADUATE  │    25 │ M       │            11000 │                  35 │                    1.0 │                        1.0 │                   0.5 │       -99999.0 │       0 │       -99999.0 │       0 │                    1.0 │                    0.0 │                    1.0 │                    0.0 │                    1.745 │       0 │       0 │ PL             │ PL              │          678 │        1 │             0 │             1 │                   1 │                 0 │             1.0 │               0.0 │           1.0 │           0.0 │                    1 │                  0 │              1.0 │                0.0 │               0 │       0 │     0 │           1 │       0 │       0 │     0 │          0 │            1 │        0 │             5 │             5 │
│ 3          │                        40 │                          20 │                            2 │                   13 │                    70 │                        11 │              2 │               3 │                 1 │              1 │              11 │                 3 │                 1 │      39 │            2 │            10 │       0 │            0 │             0 │       0 │            0 │             0 │       0 │            0 │             0 │                     1 │       5 │      0 │          0 │           0 │      3 │          3 │           3 │                    87 │        3 │       3 │       1 │ Single        │ 12TH      │    25 │ M       │            23500 │                  63 │                  0.571 │                        1.0 │                 0.926 │       -99999.0 │       1 │          0.978 │       1 │                    1.0 │                    0.0 │                    1.0 │                    0.0 │                   14.894 │       0 │       0 │ PL             │ others          │          696 │        7 │             3 │             4 │                   2 │                 1 │           0.286 │             0.143 │         0.571 │         0.429 │                    2 │                  2 │            0.286 │              0.286 │               0 │       1 │     1 │           0 │       0 │       0 │     2 │          3 │            4 │        3 │            67 │             3 │
│ 4          │                        61 │                      -99999 │                       -99999 │                    0 │                -99999 │                         0 │              0 │               0 │                 0 │         -99999 │          -99999 │                 0 │                 0 │       7 │            4 │             7 │       0 │            0 │             0 │       0 │            0 │             0 │       0 │            0 │             0 │                     0 │       2 │      0 │          0 │           0 │      0 │          0 │           0 │                   147 │        1 │       1 │       0 │ Married       │ 12TH      │    27 │ M       │            30000 │                 180 │                    1.0 │                        0.0 │                 0.784 │       -99999.0 │       0 │       -99999.0 │       0 │                    0.0 │                    0.0 │                    0.0 │                    0.0 │                 -99999.0 │       0 │       0 │ ConsumerLoan   │ others          │          694 │        1 │             0 │             1 │                   0 │                 0 │             0.0 │               0.0 │           1.0 │           0.0 │                    1 │                  0 │              1.0 │                0.0 │               0 │       1 │     0 │           0 │       0 │       0 │     0 │          1 │            0 │        0 │            12 │            12 │
│ 5          │                        46 │                           6 │                            2 │                    2 │                     3 │                         3 │              1 │               2 │                 1 │              3 │               3 │                 0 │                 0 │      50 │           18 │            36 │       0 │            0 │             0 │       0 │            0 │             0 │       0 │            0 │             0 │                     3 │       6 │      4 │          1 │           1 │      1 │          0 │           0 │                     7 │        2 │       2 │       1 │ Married       │ GRADUATE  │    38 │ M       │            40000 │                 104 │                    0.6 │                       0.75 │                  0.77 │          0.045 │       1 │          0.708 │       1 │                    0.0 │                    1.0 │                    0.0 │                   0.25 │                    9.116 │       1 │       0 │ others         │ CC              │          734 │       10 │             4 │             6 │                   3 │                 1 │             0.3 │               0.1 │           0.6 │           0.4 │                    4 │                  1 │              0.4 │                0.1 │               3 │       0 │     2 │           0 │       4 │       0 │     1 │          7 │            3 │        3 │           102 │             2 │
└────────────┴───────────────────────────┴─────────────────────────────┴──────────────────────────────┴──────────────────────┴───────────────────────┴───────────────────────────┴────────────────┴─────────────────┴───────────────────┴────────────────┴─────────────────┴───────────────────┴───────────────────┴─────────┴──────────────┴───────────────┴─────────┴──────────────┴───────────────┴─────────┴──────────────┴───────────────┴─────────┴──────────────┴───────────────┴───────────────────────┴─────────┴────────┴────────────┴─────────────┴────────┴────────────┴─────────────┴───────────────────────┴──────────┴─────────┴─────────┴───────────────┴───────────┴───────┴─────────┴──────────────────┴─────────────────────┴────────────────────────┴────────────────────────────┴───────────────────────┴────────────────┴─────────┴────────────────┴─────────┴────────────────────────┴────────────────────────┴────────────────────────┴────────────────────────┴──────────────────────────┴─────────┴─────────┴────────────────┴─────────────────┴──────────────┴──────────┴───────────────┴───────────────┴─────────────────────┴───────────────────┴─────────────────┴───────────────────┴───────────────┴───────────────┴──────────────────────┴────────────────────┴──────────────────┴────────────────────┴─────────────────┴─────────┴───────┴─────────────┴─────────┴─────────┴───────┴────────────┴──────────────┴──────────┴───────────────┴───────────────┘
</code></pre>
</div>
</div>
</figure>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>duckdb.sql(<span class="st">"""</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="st">    SELECT *</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="st">    FROM tbl_campaign_history</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="st">    LIMIT 5</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="st">"""</span>).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-top5-campaigns" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="6">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-top5-campaigns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: First 5 rows of tbl_campaign_history
</figcaption>
<div aria-describedby="tbl-top5-campaigns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-stdout">
<pre><code>┌────────────┬─────────────┬───────────────┬──────────────────┐
│ PROSPECTID │ campaign_id │ response_flag │ direct_mail_flag │
│  varchar   │   varchar   │     int32     │     varchar      │
├────────────┼─────────────┼───────────────┼──────────────────┤
│ 1          │ 1           │             0 │ Y                │
│ 2          │ 3           │          NULL │ NULL             │
│ 3          │ 2           │             0 │ Y                │
│ 4          │ 1           │             0 │ Y                │
│ 5          │ 1           │             0 │ Y                │
└────────────┴─────────────┴───────────────┴──────────────────┘
</code></pre>
</div>
</div>
</figure>
</div>
<p>Aggregate the <code>tbl_campaign_history</code> table to see how many prospects were targeted and responded to each campaign.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>duckdb.sql(<span class="st">"""</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="st">    SELECT campaign_id, </span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="st">            COUNT(*) AS num_prospects,</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="st">            SUM(CASE WHEN direct_mail_flag = 'Y'</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="st">            THEN 1 </span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="st">            ELSE 0 END) AS num_direct_mails,</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="st">            SUM(CASE WHEN response_flag = 1 </span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="st">            THEN 1 </span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="st">            ELSE 0 END) AS num_responses</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="st">    FROM tbl_campaign_history</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="st">    GROUP BY campaign_id</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="st">    ORDER BY campaign_id</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="st">"""</span>).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-campaign-history" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="7">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-campaign-history-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Campaign History
</figcaption>
<div aria-describedby="tbl-campaign-history-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-stdout">
<pre><code>┌─────────────┬───────────────┬──────────────────┬───────────────┐
│ campaign_id │ num_prospects │ num_direct_mails │ num_responses │
│   varchar   │     int64     │      int128      │    int128     │
├─────────────┼───────────────┼──────────────────┼───────────────┤
│ 1           │        384017 │           384017 │         22037 │
│ 2           │         96014 │            96014 │          5566 │
│ 3           │         95889 │                0 │             0 │
└─────────────┴───────────────┴──────────────────┴───────────────┘
</code></pre>
</div>
</div>
</figure>
</div>
</section>
<section id="qa" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="qa"><span class="header-section-number">3.2</span> Q&amp;A</h2>
<section id="question" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="question"><span class="header-section-number">3.2.1</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In campaign 1, what percentage of prospects were sent direct mail?</p>
</div>
</div>
</section>
<section id="question-1" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="question-1"><span class="header-section-number">3.2.2</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In campaign 1, what was the response rate among prospects who were sent direct mail?</p>
</div>
</div>
</section>
<section id="question-2" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="question-2"><span class="header-section-number">3.2.3</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose the average cost of sending direct mail is $7.00 per prospect. What was the total cost of campaign 1?</p>
</div>
</div>
</section>
<section id="question-3" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="question-3"><span class="header-section-number">3.2.4</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose the average revenue from a response is $100 per client. What was the total revenue of campaign 1?</p>
</div>
</div>
</section>
<section id="question-4" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="question-4"><span class="header-section-number">3.2.5</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The return on investment (ROI) of the campaign is:</p>
<p><span class="math display">\[ROI = \frac{TotalRevenue - TotalCost}{TotalCost} \times 100\]</span></p>
<p>What was the ROI of campaign 1?</p>
</div>
</div>
</section>
<section id="question-5" class="level3" data-number="3.2.6">
<h3 data-number="3.2.6" class="anchored" data-anchor-id="question-5"><span class="header-section-number">3.2.6</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>What was the ROI of campaign 2?</p>
</div>
</div>
</section>
</section>
</section>
<section id="merge-the-tables" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Merge the Tables</h1>
<p>Merge the tables (<code>tbl_prospects</code> and <code>tbl_campaign_history</code>) to create a new table (<code>tbl_merged</code>) that contains all columns from both tables. Use a left join to keep all rows from <code>tbl_prospects</code>.</p>
<div id="dfaea119" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>tbl_merged <span class="op">=</span> duckdb.query(<span class="st">"""</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="st">    SELECT c.*, p.*</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="st">    FROM tbl_campaign_history AS c</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">    RIGHT JOIN tbl_prospects AS p</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="st">    ON p.prospectid = c.prospectid</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="st">    ORDER BY c.campaign_id, CAST(p.prospectid AS INT)</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="st">"""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Convert <code>tbl_merged</code> to a Pandas DataFrame and display the first 5 rows.</p>
<div id="01b92ede" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>df_merged <span class="op">=</span> tbl_merged.to_df()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>df_merged.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-top5-merged" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="10">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-top5-merged-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: First 5 rows of df_merged
</figcaption>
<div aria-describedby="tbl-top5-merged-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PROSPECTID</th>
<th data-quarto-table-cell-role="th">campaign_id</th>
<th data-quarto-table-cell-role="th">response_flag</th>
<th data-quarto-table-cell-role="th">direct_mail_flag</th>
<th data-quarto-table-cell-role="th">PROSPECTID_1</th>
<th data-quarto-table-cell-role="th">time_since_recent_payment</th>
<th data-quarto-table-cell-role="th">time_since_first_deliquency</th>
<th data-quarto-table-cell-role="th">time_since_recent_deliquency</th>
<th data-quarto-table-cell-role="th">num_times_delinquent</th>
<th data-quarto-table-cell-role="th">max_delinquency_level</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">CC_TL</th>
<th data-quarto-table-cell-role="th">Consumer_TL</th>
<th data-quarto-table-cell-role="th">Gold_TL</th>
<th data-quarto-table-cell-role="th">Home_TL</th>
<th data-quarto-table-cell-role="th">PL_TL</th>
<th data-quarto-table-cell-role="th">Secured_TL</th>
<th data-quarto-table-cell-role="th">Unsecured_TL</th>
<th data-quarto-table-cell-role="th">Other_TL</th>
<th data-quarto-table-cell-role="th">Age_Oldest_TL</th>
<th data-quarto-table-cell-role="th">Age_Newest_TL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>1</td>
<td>1214</td>
<td>-99999</td>
<td>-99999</td>
<td>0</td>
<td>-99999</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>58</td>
<td>58</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>4</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>4</td>
<td>61</td>
<td>-99999</td>
<td>-99999</td>
<td>0</td>
<td>-99999</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>12</td>
<td>12</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>5</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>5</td>
<td>46</td>
<td>6</td>
<td>2</td>
<td>2</td>
<td>3</td>
<td>...</td>
<td>2</td>
<td>0</td>
<td>4</td>
<td>0</td>
<td>1</td>
<td>7</td>
<td>3</td>
<td>3</td>
<td>102</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>6</td>
<td>52</td>
<td>-99999</td>
<td>-99999</td>
<td>0</td>
<td>-99999</td>
<td>...</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>6</td>
<td>6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>7</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>7</td>
<td>49</td>
<td>-99999</td>
<td>-99999</td>
<td>0</td>
<td>-99999</td>
<td>...</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>10</td>
<td>10</td>
</tr>
</tbody>
</table>

<p>5 rows × 90 columns</p>
</div>
</div>
</div>
</figure>
</div>
</div>
<p>Remove the <code>PROSPECTID_1</code> column from <code>df_merged</code>.</p>
<div id="3e9b779a" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>df_merged <span class="op">=</span> df_merged.drop(columns<span class="op">=</span>[<span class="st">'PROSPECTID_1'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Check the shapes of each data frame to ensure no rows were lost during the merge.</p>
<div id="192f827a" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>display(tbl_prospects.shape)</span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a>display(tbl_campaign_history.shape)</span>
<span id="cb17-4"><a href="#cb17-4"></a></span>
<span id="cb17-5"><a href="#cb17-5"></a>display(df_merged.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>(575920, 86)</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>(575920, 4)</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>(575920, 89)</code></pre>
</div>
</div>
</section>
<section id="split-the-data" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Split the Data</h1>
<p>Split the data by <code>campaign_id</code> into three separate DataFrames: <code>df_campaign_1</code>, <code>df_campaign_2</code>, and <code>df_campaign_3</code>.</p>
<div id="ca21746e" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>df_campaign_1 <span class="op">=</span> df_merged[df_merged[<span class="st">'campaign_id'</span>] <span class="op">==</span> <span class="st">'1'</span>].copy()</span>
<span id="cb21-2"><a href="#cb21-2"></a>df_campaign_2 <span class="op">=</span> df_merged[df_merged[<span class="st">'campaign_id'</span>] <span class="op">==</span> <span class="st">'2'</span>].copy()</span>
<span id="cb21-3"><a href="#cb21-3"></a>df_campaign_3 <span class="op">=</span> df_merged[df_merged[<span class="st">'campaign_id'</span>] <span class="op">==</span> <span class="st">'3'</span>].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We will train the model only on <code>df_campaign_1</code>. We evaluate the model using <code>df_campaign_2</code> and <code>df_campaign_3</code>.</p>
<p>Split <code>df_campaign_1</code> into <code>df_campaign_1_train</code> and <code>df_campaign_1_test</code> using a 70/30 split.</p>
<div id="7ad41ece" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a>df_campaign_1_train, df_campaign_1_test <span class="op">=</span> train_test_split(</span>
<span id="cb22-2"><a href="#cb22-2"></a>    df_campaign_1,</span>
<span id="cb22-3"><a href="#cb22-3"></a>    test_size<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb22-4"><a href="#cb22-4"></a>    random_state<span class="op">=</span><span class="dv">2025</span>,</span>
<span id="cb22-5"><a href="#cb22-5"></a>    stratify<span class="op">=</span>df_campaign_1[<span class="st">'response_flag'</span>]</span>
<span id="cb22-6"><a href="#cb22-6"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="f33521eb" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a>display(<span class="ss">f"Train data response rate: </span><span class="sc">{</span>df_campaign_1_train[<span class="st">'response_flag'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.3f}</span><span class="ss">%"</span>)</span>
<span id="cb23-2"><a href="#cb23-2"></a>display(<span class="ss">f"Test data response rate: </span><span class="sc">{</span>df_campaign_1_test[<span class="st">'response_flag'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.3f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>'Train data response rate: 5.739%'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>'Test data response rate: 5.738%'</code></pre>
</div>
</div>
</section>
<section id="exploratory-data-analysis" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Exploratory Data Analysis</h1>
<p>Use the <code>ydata_profiling</code> library to compare <code>df_campaign_1_train</code> and <code>df_campaign_1_test</code>.</p>
<div id="e5f22f71" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a>p_frac <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb26-2"><a href="#cb26-2"></a></span>
<span id="cb26-3"><a href="#cb26-3"></a>train_data_profile <span class="op">=</span> ProfileReport(</span>
<span id="cb26-4"><a href="#cb26-4"></a>            df_campaign_1_train.sample(frac<span class="op">=</span>p_frac, random_state<span class="op">=</span><span class="dv">2025</span>), </span>
<span id="cb26-5"><a href="#cb26-5"></a>            title<span class="op">=</span><span class="st">"Train"</span>,</span>
<span id="cb26-6"><a href="#cb26-6"></a>            progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb26-7"><a href="#cb26-7"></a>            duplicates<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb26-8"><a href="#cb26-8"></a>            interactions<span class="op">=</span><span class="va">None</span></span>
<span id="cb26-9"><a href="#cb26-9"></a>            )</span>
<span id="cb26-10"><a href="#cb26-10"></a></span>
<span id="cb26-11"><a href="#cb26-11"></a>test_data_profile <span class="op">=</span> ProfileReport(</span>
<span id="cb26-12"><a href="#cb26-12"></a>            df_campaign_1_test.sample(frac<span class="op">=</span>p_frac, random_state<span class="op">=</span><span class="dv">2025</span>), </span>
<span id="cb26-13"><a href="#cb26-13"></a>            title<span class="op">=</span><span class="st">"Test"</span>,</span>
<span id="cb26-14"><a href="#cb26-14"></a>            progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb26-15"><a href="#cb26-15"></a>            duplicates<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb26-16"><a href="#cb26-16"></a>            interactions<span class="op">=</span><span class="va">None</span></span>
<span id="cb26-17"><a href="#cb26-17"></a>            )</span>
<span id="cb26-18"><a href="#cb26-18"></a></span>
<span id="cb26-19"><a href="#cb26-19"></a>compare_profile <span class="op">=</span> train_data_profile.compare(test_data_profile)</span>
<span id="cb26-20"><a href="#cb26-20"></a></span>
<span id="cb26-21"><a href="#cb26-21"></a>compare_profile.to_file(<span class="st">"Lab01_eda_report_ydata.html"</span>)</span>
<span id="cb26-22"><a href="#cb26-22"></a></span>
<span id="cb26-23"><a href="#cb26-23"></a><span class="co"># compare_profile.to_notebook_iframe()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Many of the columns contain a special value called <code>-99999</code>.</p>
</section>
<section id="replace--99999-with--1" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Replace -99999 with -1</h1>
<p>Replace <code>-99999</code> with <code>-1</code> in the <code>df_campaign_1_train</code> and <code>df_campaign_1_test</code> data frames.</p>
<p>Leaving the special value untreated would <em>not</em> cause problems for the models, but would make the PDP and ALE plots difficult to interpret.</p>
<div id="06eee1b9" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a>df_campaign_1_train <span class="op">=</span> df_campaign_1_train.replace(<span class="op">-</span><span class="dv">99999</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb27-2"><a href="#cb27-2"></a>df_campaign_1_test <span class="op">=</span> df_campaign_1_test.replace(<span class="op">-</span><span class="dv">99999</span>, <span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="76783135" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a>train_data_profile_1 <span class="op">=</span> ProfileReport(</span>
<span id="cb28-2"><a href="#cb28-2"></a>            df_campaign_1_train.sample(frac<span class="op">=</span>p_frac, random_state<span class="op">=</span><span class="dv">2025</span>), </span>
<span id="cb28-3"><a href="#cb28-3"></a>            title<span class="op">=</span><span class="st">"Train"</span>,</span>
<span id="cb28-4"><a href="#cb28-4"></a>            progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb28-5"><a href="#cb28-5"></a>            duplicates<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb28-6"><a href="#cb28-6"></a>            interactions<span class="op">=</span><span class="va">None</span></span>
<span id="cb28-7"><a href="#cb28-7"></a>            )</span>
<span id="cb28-8"><a href="#cb28-8"></a></span>
<span id="cb28-9"><a href="#cb28-9"></a>test_data_profile_1 <span class="op">=</span> ProfileReport(</span>
<span id="cb28-10"><a href="#cb28-10"></a>            df_campaign_1_test.sample(frac<span class="op">=</span>p_frac, random_state<span class="op">=</span><span class="dv">2025</span>), </span>
<span id="cb28-11"><a href="#cb28-11"></a>            title<span class="op">=</span><span class="st">"Test"</span>,</span>
<span id="cb28-12"><a href="#cb28-12"></a>            progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb28-13"><a href="#cb28-13"></a>            duplicates<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb28-14"><a href="#cb28-14"></a>            interactions<span class="op">=</span><span class="va">None</span></span>
<span id="cb28-15"><a href="#cb28-15"></a>            )</span>
<span id="cb28-16"><a href="#cb28-16"></a></span>
<span id="cb28-17"><a href="#cb28-17"></a>compare_profile_1 <span class="op">=</span> train_data_profile_1.compare(test_data_profile_1)</span>
<span id="cb28-18"><a href="#cb28-18"></a></span>
<span id="cb28-19"><a href="#cb28-19"></a>compare_profile_1.to_file(<span class="st">"Lab01_eda_report_ydata_1.html"</span>)</span>
<span id="cb28-20"><a href="#cb28-20"></a></span>
<span id="cb28-21"><a href="#cb28-21"></a><span class="co"># compare_profile.to_notebook_iframe()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="subset-the-features" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Subset the features</h1>
<p>The <code>df_campaign_1_train</code> and <code>df_campaign_1_test</code> data frames are very wide and the columns are highly collinear. We will subset the columns to make the data more manageable.</p>
<div id="947fcd52" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a>subset_cols <span class="op">=</span> [<span class="st">'CC_utilization'</span>, </span>
<span id="cb29-2"><a href="#cb29-2"></a>        <span class="st">'PL_utilization'</span>, </span>
<span id="cb29-3"><a href="#cb29-3"></a>        <span class="st">'last_prod_enq2'</span>, </span>
<span id="cb29-4"><a href="#cb29-4"></a>        <span class="st">'PL_enq_L6m'</span>, </span>
<span id="cb29-5"><a href="#cb29-5"></a>        <span class="st">'CC_enq_L6m'</span>,</span>
<span id="cb29-6"><a href="#cb29-6"></a>        <span class="st">'response_flag'</span>]</span>
<span id="cb29-7"><a href="#cb29-7"></a></span>
<span id="cb29-8"><a href="#cb29-8"></a>df_campaign_1_train_subset <span class="op">=</span> df_campaign_1_train[subset_cols].copy()</span>
<span id="cb29-9"><a href="#cb29-9"></a></span>
<span id="cb29-10"><a href="#cb29-10"></a>df_campaign_1_test_subset <span class="op">=</span> df_campaign_1_test[subset_cols].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Convert <code>last_prod_enq2</code> to a categorical variable.</p>
<div id="6e54c3fa" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a>df_campaign_1_train_subset[<span class="st">'last_prod_enq2'</span>] <span class="op">=</span> df_campaign_1_train_subset[<span class="st">'last_prod_enq2'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb30-2"><a href="#cb30-2"></a>df_campaign_1_test_subset[<span class="st">'last_prod_enq2'</span>] <span class="op">=</span> df_campaign_1_test_subset[<span class="st">'last_prod_enq2'</span>].astype(<span class="st">'category'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We will revisit the full data frames later in the course. For now, we will use the data frames with subsetted columns.</p>
</section>
<section id="supervised-learning" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Supervised Learning</h1>
<p>Create a function that sets random seed values.</p>
<div id="247c778f" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">def</span> global_set_seed(seed_value<span class="op">=</span><span class="dv">2025</span>):</span>
<span id="cb31-2"><a href="#cb31-2"></a>    random.seed(seed_value)</span>
<span id="cb31-3"><a href="#cb31-3"></a>    np.random.seed(seed_value)</span>
<span id="cb31-4"><a href="#cb31-4"></a>    torch.manual_seed(seed_value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Create a scikit-learn compatible wrapper for <code>autogluon</code>.</p>
<div id="fec110ca" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">class</span> AutoGluonSklearnWrapper(ClassifierMixin, BaseEstimator):</span>
<span id="cb32-2"><a href="#cb32-2"></a>    <span class="co">"""</span></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="co">    Scikit-learn compatible wrapper for AutoGluon TabularPredictor</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="co">    </span></span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="co">    Inherits from scikit-learn's BaseEstimator and ClassifierMixin to provide</span></span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="co">    full compatibility with scikit-learn tools like PartialDependenceDisplay().</span></span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="co">    </span></span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="co">    Parameters</span></span>
<span id="cb32-9"><a href="#cb32-9"></a><span class="co">    ----------</span></span>
<span id="cb32-10"><a href="#cb32-10"></a><span class="co">    label : str</span></span>
<span id="cb32-11"><a href="#cb32-11"></a><span class="co">        Name of the target column</span></span>
<span id="cb32-12"><a href="#cb32-12"></a></span>
<span id="cb32-13"><a href="#cb32-13"></a><span class="co">    **predictor_args : dict</span></span>
<span id="cb32-14"><a href="#cb32-14"></a><span class="co">        Additional arguments passed to TabularPredictor()</span></span>
<span id="cb32-15"><a href="#cb32-15"></a><span class="co">        (e.g., problem_type, eval_metric, path)</span></span>
<span id="cb32-16"><a href="#cb32-16"></a></span>
<span id="cb32-17"><a href="#cb32-17"></a><span class="co">    **fit_args : dict</span></span>
<span id="cb32-18"><a href="#cb32-18"></a><span class="co">        Additional arguments passed to TabularPredictor.fit() method</span></span>
<span id="cb32-19"><a href="#cb32-19"></a><span class="co">        (e.g., holdout_frac, presets, time_limit, excluded_model_types)</span></span>
<span id="cb32-20"><a href="#cb32-20"></a></span>
<span id="cb32-21"><a href="#cb32-21"></a></span>
<span id="cb32-22"><a href="#cb32-22"></a><span class="co">    Attributes</span></span>
<span id="cb32-23"><a href="#cb32-23"></a><span class="co">    ----------</span></span>
<span id="cb32-24"><a href="#cb32-24"></a><span class="co">    predictor : TabularPredictor</span></span>
<span id="cb32-25"><a href="#cb32-25"></a><span class="co">        The trained AutoGluon predictor</span></span>
<span id="cb32-26"><a href="#cb32-26"></a></span>
<span id="cb32-27"><a href="#cb32-27"></a><span class="co">    classes_ : ndarray</span></span>
<span id="cb32-28"><a href="#cb32-28"></a><span class="co">        Class labels (for classification tasks)</span></span>
<span id="cb32-29"><a href="#cb32-29"></a></span>
<span id="cb32-30"><a href="#cb32-30"></a><span class="co">    n_features_in_ : int</span></span>
<span id="cb32-31"><a href="#cb32-31"></a><span class="co">        Number of features seen during fit</span></span>
<span id="cb32-32"><a href="#cb32-32"></a></span>
<span id="cb32-33"><a href="#cb32-33"></a><span class="co">    feature_names_ : list</span></span>
<span id="cb32-34"><a href="#cb32-34"></a><span class="co">        Feature names inferred during fitting</span></span>
<span id="cb32-35"><a href="#cb32-35"></a></span>
<span id="cb32-36"><a href="#cb32-36"></a><span class="co">    is_fitted_ : bool</span></span>
<span id="cb32-37"><a href="#cb32-37"></a><span class="co">        Whether the estimator has been fitted</span></span>
<span id="cb32-38"><a href="#cb32-38"></a><span class="co">    """</span></span>
<span id="cb32-39"><a href="#cb32-39"></a>    _estimator_type <span class="op">=</span> <span class="st">"classifier"</span></span>
<span id="cb32-40"><a href="#cb32-40"></a></span>
<span id="cb32-41"><a href="#cb32-41"></a>    <span class="kw">def</span> _more_tags(<span class="va">self</span>):</span>
<span id="cb32-42"><a href="#cb32-42"></a>        <span class="cf">return</span> {<span class="st">"estimator_type"</span>: <span class="st">"classifier"</span>}</span>
<span id="cb32-43"><a href="#cb32-43"></a></span>
<span id="cb32-44"><a href="#cb32-44"></a>    <span class="kw">def</span> __sklearn_tags__(<span class="va">self</span>):</span>
<span id="cb32-45"><a href="#cb32-45"></a>        tags <span class="op">=</span> <span class="bu">super</span>().__sklearn_tags__()</span>
<span id="cb32-46"><a href="#cb32-46"></a>        tags.estimator_type <span class="op">=</span> <span class="st">"classifier"</span></span>
<span id="cb32-47"><a href="#cb32-47"></a>        <span class="cf">return</span> tags</span>
<span id="cb32-48"><a href="#cb32-48"></a>    </span>
<span id="cb32-49"><a href="#cb32-49"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, label, predictor_args<span class="op">=</span><span class="va">None</span>, fit_args<span class="op">=</span><span class="va">None</span>, n_jobs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb32-50"><a href="#cb32-50"></a>        <span class="va">self</span>.label <span class="op">=</span> label</span>
<span id="cb32-51"><a href="#cb32-51"></a>        <span class="va">self</span>.predictor_args <span class="op">=</span> predictor_args <span class="cf">if</span> predictor_args <span class="cf">else</span> {}</span>
<span id="cb32-52"><a href="#cb32-52"></a>        <span class="va">self</span>.fit_args <span class="op">=</span> fit_args <span class="cf">if</span> fit_args <span class="cf">else</span> {}</span>
<span id="cb32-53"><a href="#cb32-53"></a>        <span class="va">self</span>.n_jobs <span class="op">=</span> n_jobs</span>
<span id="cb32-54"><a href="#cb32-54"></a></span>
<span id="cb32-55"><a href="#cb32-55"></a>    <span class="kw">def</span> _validate_features(<span class="va">self</span>, X):</span>
<span id="cb32-56"><a href="#cb32-56"></a>        <span class="co">"""Validate feature names/counts and return a DataFrame with training features."""</span></span>
<span id="cb32-57"><a href="#cb32-57"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(X, <span class="st">"columns"</span>):</span>
<span id="cb32-58"><a href="#cb32-58"></a>            cols <span class="op">=</span> <span class="bu">list</span>(X.columns)</span>
<span id="cb32-59"><a href="#cb32-59"></a>            <span class="cf">if</span> cols <span class="op">!=</span> <span class="va">self</span>.feature_names_:</span>
<span id="cb32-60"><a href="#cb32-60"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Feature names do not match training data."</span>)</span>
<span id="cb32-61"><a href="#cb32-61"></a>            <span class="cf">return</span> X.copy()</span>
<span id="cb32-62"><a href="#cb32-62"></a></span>
<span id="cb32-63"><a href="#cb32-63"></a>        <span class="cf">if</span> X.shape[<span class="dv">1</span>] <span class="op">!=</span> <span class="bu">len</span>(<span class="va">self</span>.feature_names_):</span>
<span id="cb32-64"><a href="#cb32-64"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Number of features does not match training data."</span>)</span>
<span id="cb32-65"><a href="#cb32-65"></a></span>
<span id="cb32-66"><a href="#cb32-66"></a>        <span class="cf">return</span> pd.DataFrame(X, columns<span class="op">=</span><span class="va">self</span>.feature_names_)</span>
<span id="cb32-67"><a href="#cb32-67"></a></span>
<span id="cb32-68"><a href="#cb32-68"></a>    <span class="kw">def</span> __sklearn_is_fitted__(<span class="va">self</span>):</span>
<span id="cb32-69"><a href="#cb32-69"></a>        <span class="co">"""Official scikit-learn API for checking fitted status"""</span></span>
<span id="cb32-70"><a href="#cb32-70"></a>        <span class="cf">return</span> <span class="bu">getattr</span>(<span class="va">self</span>, <span class="st">"is_fitted_"</span>, <span class="va">False</span>)</span>
<span id="cb32-71"><a href="#cb32-71"></a></span>
<span id="cb32-72"><a href="#cb32-72"></a>    <span class="kw">def</span> __getstate__(<span class="va">self</span>):</span>
<span id="cb32-73"><a href="#cb32-73"></a>        <span class="co">"""Make the wrapper pickle-friendly for joblib/Parallel."""</span></span>
<span id="cb32-74"><a href="#cb32-74"></a>        state <span class="op">=</span> <span class="va">self</span>.__dict__.copy()</span>
<span id="cb32-75"><a href="#cb32-75"></a>        predictor_path <span class="op">=</span> state.get(<span class="st">"predictor_path_"</span>, <span class="va">None</span>)</span>
<span id="cb32-76"><a href="#cb32-76"></a>        predictor <span class="op">=</span> state.get(<span class="st">"predictor_"</span>, <span class="va">None</span>)</span>
<span id="cb32-77"><a href="#cb32-77"></a>        <span class="cf">if</span> predictor_path <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> predictor <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb32-78"><a href="#cb32-78"></a>            predictor_path <span class="op">=</span> predictor.path</span>
<span id="cb32-79"><a href="#cb32-79"></a>        <span class="cf">if</span> predictor_path <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb32-80"><a href="#cb32-80"></a>            state[<span class="st">"predictor_path_"</span>] <span class="op">=</span> os.path.abspath(predictor_path)</span>
<span id="cb32-81"><a href="#cb32-81"></a>        state[<span class="st">"predictor_"</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb32-82"><a href="#cb32-82"></a>        <span class="cf">return</span> state</span>
<span id="cb32-83"><a href="#cb32-83"></a></span>
<span id="cb32-84"><a href="#cb32-84"></a>    <span class="kw">def</span> __setstate__(<span class="va">self</span>, state):</span>
<span id="cb32-85"><a href="#cb32-85"></a>        <span class="co">"""Restore predictor on unpickle."""</span></span>
<span id="cb32-86"><a href="#cb32-86"></a>        <span class="va">self</span>.__dict__.update(state)</span>
<span id="cb32-87"><a href="#cb32-87"></a>        predictor_path <span class="op">=</span> <span class="va">self</span>.__dict__.get(<span class="st">"predictor_path_"</span>, <span class="va">None</span>)</span>
<span id="cb32-88"><a href="#cb32-88"></a>        <span class="cf">if</span> predictor_path:</span>
<span id="cb32-89"><a href="#cb32-89"></a>            <span class="va">self</span>.predictor_ <span class="op">=</span> TabularPredictor.load(predictor_path)</span>
<span id="cb32-90"><a href="#cb32-90"></a>        <span class="va">self</span>.is_fitted_ <span class="op">=</span> predictor_path <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb32-91"><a href="#cb32-91"></a></span>
<span id="cb32-92"><a href="#cb32-92"></a>    <span class="at">@property</span></span>
<span id="cb32-93"><a href="#cb32-93"></a>    <span class="kw">def</span> predictor(<span class="va">self</span>):</span>
<span id="cb32-94"><a href="#cb32-94"></a>        <span class="co">"""Backward-compatible access to the fitted AutoGluon predictor."""</span></span>
<span id="cb32-95"><a href="#cb32-95"></a>        <span class="cf">return</span> <span class="bu">getattr</span>(<span class="va">self</span>, <span class="st">"predictor_"</span>, <span class="va">None</span>)</span>
<span id="cb32-96"><a href="#cb32-96"></a></span>
<span id="cb32-97"><a href="#cb32-97"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>, sample_weight<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb32-98"><a href="#cb32-98"></a>        <span class="co">"""</span></span>
<span id="cb32-99"><a href="#cb32-99"></a><span class="co">        Fit AutoGluon model using scikit-learn interface</span></span>
<span id="cb32-100"><a href="#cb32-100"></a><span class="co">        </span></span>
<span id="cb32-101"><a href="#cb32-101"></a><span class="co">        Parameters</span></span>
<span id="cb32-102"><a href="#cb32-102"></a><span class="co">        ----------</span></span>
<span id="cb32-103"><a href="#cb32-103"></a><span class="co">        X : {array-like, sparse matrix} of shape (n_samples, n_features)</span></span>
<span id="cb32-104"><a href="#cb32-104"></a><span class="co">            Training data</span></span>
<span id="cb32-105"><a href="#cb32-105"></a><span class="co">        y : array-like of shape (n_samples,)</span></span>
<span id="cb32-106"><a href="#cb32-106"></a><span class="co">            Target values</span></span>
<span id="cb32-107"><a href="#cb32-107"></a></span>
<span id="cb32-108"><a href="#cb32-108"></a><span class="co">        sample_weight : array-like of shape (n_samples,), optional</span></span>
<span id="cb32-109"><a href="#cb32-109"></a><span class="co">            Sample weights to pass to AutoGluon if configured</span></span>
<span id="cb32-110"><a href="#cb32-110"></a><span class="co">            </span></span>
<span id="cb32-111"><a href="#cb32-111"></a><span class="co">        Returns</span></span>
<span id="cb32-112"><a href="#cb32-112"></a><span class="co">        -------</span></span>
<span id="cb32-113"><a href="#cb32-113"></a><span class="co">        self : object</span></span>
<span id="cb32-114"><a href="#cb32-114"></a><span class="co">            Fitted estimator</span></span>
<span id="cb32-115"><a href="#cb32-115"></a><span class="co">        """</span></span>
<span id="cb32-116"><a href="#cb32-116"></a>        X_checked, y_checked <span class="op">=</span> check_X_y(X, y, accept_sparse<span class="op">=</span><span class="va">False</span>, dtype<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb32-117"><a href="#cb32-117"></a>        y <span class="op">=</span> y_checked</span>
<span id="cb32-118"><a href="#cb32-118"></a></span>
<span id="cb32-119"><a href="#cb32-119"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(X, <span class="st">"columns"</span>):</span>
<span id="cb32-120"><a href="#cb32-120"></a>            <span class="va">self</span>.feature_names_ <span class="op">=</span> <span class="bu">list</span>(X.columns)</span>
<span id="cb32-121"><a href="#cb32-121"></a>            train_df <span class="op">=</span> X.copy()</span>
<span id="cb32-122"><a href="#cb32-122"></a>        <span class="cf">else</span>:</span>
<span id="cb32-123"><a href="#cb32-123"></a>            <span class="va">self</span>.feature_names_ <span class="op">=</span> [<span class="ss">f"feat_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(X_checked.shape[<span class="dv">1</span>])]</span>
<span id="cb32-124"><a href="#cb32-124"></a>            train_df <span class="op">=</span> pd.DataFrame(X_checked, columns<span class="op">=</span><span class="va">self</span>.feature_names_)</span>
<span id="cb32-125"><a href="#cb32-125"></a></span>
<span id="cb32-126"><a href="#cb32-126"></a>        <span class="va">self</span>.n_features_in_ <span class="op">=</span> train_df.shape[<span class="dv">1</span>]</span>
<span id="cb32-127"><a href="#cb32-127"></a></span>
<span id="cb32-128"><a href="#cb32-128"></a>        predictor_args <span class="op">=</span> <span class="bu">dict</span>(<span class="va">self</span>.predictor_args)</span>
<span id="cb32-129"><a href="#cb32-129"></a>        <span class="cf">if</span> sample_weight <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb32-130"><a href="#cb32-130"></a>            weight_col <span class="op">=</span> predictor_args.get(<span class="st">"sample_weight"</span>)</span>
<span id="cb32-131"><a href="#cb32-131"></a>            <span class="cf">if</span> weight_col <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb32-132"><a href="#cb32-132"></a>                weight_col <span class="op">=</span> <span class="st">"sample_weight"</span></span>
<span id="cb32-133"><a href="#cb32-133"></a>                predictor_args[<span class="st">"sample_weight"</span>] <span class="op">=</span> weight_col</span>
<span id="cb32-134"><a href="#cb32-134"></a>            train_df[weight_col] <span class="op">=</span> sample_weight</span>
<span id="cb32-135"><a href="#cb32-135"></a></span>
<span id="cb32-136"><a href="#cb32-136"></a>        train_df[<span class="va">self</span>.label] <span class="op">=</span> y</span>
<span id="cb32-137"><a href="#cb32-137"></a>        train_data <span class="op">=</span> TabularDataset(train_df)</span>
<span id="cb32-138"><a href="#cb32-138"></a></span>
<span id="cb32-139"><a href="#cb32-139"></a>        fit_args <span class="op">=</span> <span class="bu">dict</span>(<span class="va">self</span>.fit_args)</span>
<span id="cb32-140"><a href="#cb32-140"></a>        <span class="cf">if</span> <span class="va">self</span>.n_jobs <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> fit_args.get(<span class="st">"num_cpus"</span>) <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb32-141"><a href="#cb32-141"></a>            fit_args[<span class="st">"num_cpus"</span>] <span class="op">=</span> <span class="va">self</span>.n_jobs</span>
<span id="cb32-142"><a href="#cb32-142"></a></span>
<span id="cb32-143"><a href="#cb32-143"></a>        <span class="va">self</span>.predictor_ <span class="op">=</span> TabularPredictor(</span>
<span id="cb32-144"><a href="#cb32-144"></a>            label<span class="op">=</span><span class="va">self</span>.label,</span>
<span id="cb32-145"><a href="#cb32-145"></a>            <span class="op">**</span>predictor_args</span>
<span id="cb32-146"><a href="#cb32-146"></a>        ).fit(train_data, <span class="op">**</span>fit_args)</span>
<span id="cb32-147"><a href="#cb32-147"></a></span>
<span id="cb32-148"><a href="#cb32-148"></a>        <span class="va">self</span>.predictor_path_ <span class="op">=</span> os.path.abspath(<span class="va">self</span>.predictor_.path)</span>
<span id="cb32-149"><a href="#cb32-149"></a></span>
<span id="cb32-150"><a href="#cb32-150"></a>        <span class="cf">if</span> <span class="va">self</span>.predictor_.problem_type <span class="kw">in</span> [<span class="st">'binary'</span>, <span class="st">'multiclass'</span>]:</span>
<span id="cb32-151"><a href="#cb32-151"></a>            <span class="va">self</span>.classes_ <span class="op">=</span> np.array(<span class="va">self</span>.predictor_.class_labels)</span>
<span id="cb32-152"><a href="#cb32-152"></a></span>
<span id="cb32-153"><a href="#cb32-153"></a>        <span class="va">self</span>.is_fitted_ <span class="op">=</span> <span class="va">True</span></span>
<span id="cb32-154"><a href="#cb32-154"></a></span>
<span id="cb32-155"><a href="#cb32-155"></a>        <span class="cf">return</span> <span class="va">self</span> </span>
<span id="cb32-156"><a href="#cb32-156"></a></span>
<span id="cb32-157"><a href="#cb32-157"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, X):</span>
<span id="cb32-158"><a href="#cb32-158"></a>        <span class="co">"""</span></span>
<span id="cb32-159"><a href="#cb32-159"></a><span class="co">        Make class predictions</span></span>
<span id="cb32-160"><a href="#cb32-160"></a><span class="co">        </span></span>
<span id="cb32-161"><a href="#cb32-161"></a><span class="co">        Parameters</span></span>
<span id="cb32-162"><a href="#cb32-162"></a><span class="co">        ----------</span></span>
<span id="cb32-163"><a href="#cb32-163"></a><span class="co">        X : {array-like, sparse matrix} of shape (n_samples, n_features)</span></span>
<span id="cb32-164"><a href="#cb32-164"></a><span class="co">            Input data</span></span>
<span id="cb32-165"><a href="#cb32-165"></a><span class="co">            </span></span>
<span id="cb32-166"><a href="#cb32-166"></a><span class="co">        Returns</span></span>
<span id="cb32-167"><a href="#cb32-167"></a><span class="co">        -------</span></span>
<span id="cb32-168"><a href="#cb32-168"></a><span class="co">        y_pred : ndarray of shape (n_samples,)</span></span>
<span id="cb32-169"><a href="#cb32-169"></a><span class="co">            Predicted class labels</span></span>
<span id="cb32-170"><a href="#cb32-170"></a><span class="co">        """</span></span>
<span id="cb32-171"><a href="#cb32-171"></a>        check_is_fitted(<span class="va">self</span>)</span>
<span id="cb32-172"><a href="#cb32-172"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(X, <span class="st">"columns"</span>):</span>
<span id="cb32-173"><a href="#cb32-173"></a>            check_array(X, accept_sparse<span class="op">=</span><span class="va">False</span>, dtype<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb32-174"><a href="#cb32-174"></a>            df <span class="op">=</span> <span class="va">self</span>._validate_features(X)</span>
<span id="cb32-175"><a href="#cb32-175"></a>        <span class="cf">else</span>:</span>
<span id="cb32-176"><a href="#cb32-176"></a>            X_checked <span class="op">=</span> check_array(X, accept_sparse<span class="op">=</span><span class="va">False</span>, dtype<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb32-177"><a href="#cb32-177"></a>            df <span class="op">=</span> <span class="va">self</span>._validate_features(X_checked)</span>
<span id="cb32-178"><a href="#cb32-178"></a></span>
<span id="cb32-179"><a href="#cb32-179"></a>        <span class="cf">return</span> <span class="va">self</span>.predictor_.predict(TabularDataset(df)).values</span>
<span id="cb32-180"><a href="#cb32-180"></a></span>
<span id="cb32-181"><a href="#cb32-181"></a>    <span class="kw">def</span> predict_proba(<span class="va">self</span>, X):</span>
<span id="cb32-182"><a href="#cb32-182"></a>        <span class="co">"""</span></span>
<span id="cb32-183"><a href="#cb32-183"></a><span class="co">        Predict class probabilities</span></span>
<span id="cb32-184"><a href="#cb32-184"></a><span class="co">        </span></span>
<span id="cb32-185"><a href="#cb32-185"></a><span class="co">        Parameters</span></span>
<span id="cb32-186"><a href="#cb32-186"></a><span class="co">        ----------</span></span>
<span id="cb32-187"><a href="#cb32-187"></a><span class="co">        X : {array-like, sparse matrix} of shape (n_samples, n_features)</span></span>
<span id="cb32-188"><a href="#cb32-188"></a><span class="co">            Input data</span></span>
<span id="cb32-189"><a href="#cb32-189"></a><span class="co">            </span></span>
<span id="cb32-190"><a href="#cb32-190"></a><span class="co">        Returns</span></span>
<span id="cb32-191"><a href="#cb32-191"></a><span class="co">        -------</span></span>
<span id="cb32-192"><a href="#cb32-192"></a><span class="co">        proba : ndarray of shape (n_samples, n_classes)</span></span>
<span id="cb32-193"><a href="#cb32-193"></a><span class="co">            Class probabilities</span></span>
<span id="cb32-194"><a href="#cb32-194"></a><span class="co">        """</span></span>
<span id="cb32-195"><a href="#cb32-195"></a>        check_is_fitted(<span class="va">self</span>)</span>
<span id="cb32-196"><a href="#cb32-196"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(X, <span class="st">"columns"</span>):</span>
<span id="cb32-197"><a href="#cb32-197"></a>            check_array(X, accept_sparse<span class="op">=</span><span class="va">False</span>, dtype<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb32-198"><a href="#cb32-198"></a>            df <span class="op">=</span> <span class="va">self</span>._validate_features(X)</span>
<span id="cb32-199"><a href="#cb32-199"></a>        <span class="cf">else</span>:</span>
<span id="cb32-200"><a href="#cb32-200"></a>            X_checked <span class="op">=</span> check_array(X, accept_sparse<span class="op">=</span><span class="va">False</span>, dtype<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb32-201"><a href="#cb32-201"></a>            df <span class="op">=</span> <span class="va">self</span>._validate_features(X_checked)</span>
<span id="cb32-202"><a href="#cb32-202"></a></span>
<span id="cb32-203"><a href="#cb32-203"></a>        <span class="cf">return</span> <span class="va">self</span>.predictor_.predict_proba(TabularDataset(df)).values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Use the standard scikit-learn stack to keep the lab dependency-light and portable.</p>
<p>Setup data frames for <code>autogluon</code>.</p>
<div id="61f8675f" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1"></a>label <span class="op">=</span> <span class="st">'response_flag'</span></span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a>train_data <span class="op">=</span> TabularDataset(df_campaign_1_train_subset)</span>
<span id="cb33-4"><a href="#cb33-4"></a>test_data <span class="op">=</span> TabularDataset(df_campaign_1_test_subset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Remove the model folder if it already exists.</p>
<div id="d7536a55" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1"></a>model_folder <span class="op">=</span> <span class="st">'Lab01_ag_models_NoTransform'</span></span>
<span id="cb34-2"><a href="#cb34-2"></a></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="kw">def</span> remove_ag_folder(mdl_folder: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb34-4"><a href="#cb34-4"></a>    <span class="co">"""</span></span>
<span id="cb34-5"><a href="#cb34-5"></a><span class="co">    Remove the AutoGluon model folder if it exists</span></span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="co">    """</span></span>
<span id="cb34-7"><a href="#cb34-7"></a>    <span class="cf">if</span> os.path.exists(mdl_folder):</span>
<span id="cb34-8"><a href="#cb34-8"></a>        shutil.rmtree(mdl_folder)</span>
<span id="cb34-9"><a href="#cb34-9"></a></span>
<span id="cb34-10"><a href="#cb34-10"></a>remove_ag_folder(model_folder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The code below trains multiple machine learning models using <code>autogluon</code> and evaluates them using the ROC AUC metric (on a validation set that is derived from <code>train_data</code>).</p>
<p>Hyperparameter tuning is set to <code>medium_quality</code> to reduce compute time. The allotted training time is set to <code>180</code> seconds. In real-world situations, you should use a better preset (<code>good_quality</code>) and a longer training time (<code>3600</code>).</p>
<p>Create a scikit-learn pipeline that replaces <code>-99999</code> with <code>-1</code> and trains <code>autogluon</code> models.</p>
<div id="bbcecf9c" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1"></a><span class="kw">def</span> replace_vals(X: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="cf">return</span> X.replace(<span class="op">-</span><span class="dv">99999</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb35-3"><a href="#cb35-3"></a></span>
<span id="cb35-4"><a href="#cb35-4"></a>ag_model <span class="op">=</span> Pipeline([</span>
<span id="cb35-5"><a href="#cb35-5"></a>    (<span class="st">'replace_values'</span>, FunctionTransformer(replace_vals)),</span>
<span id="cb35-6"><a href="#cb35-6"></a>    (<span class="st">'autogluon'</span>, AutoGluonSklearnWrapper(label<span class="op">=</span>label,</span>
<span id="cb35-7"><a href="#cb35-7"></a>                                    predictor_args<span class="op">=</span>{<span class="st">'problem_type'</span>: <span class="st">'binary'</span>,</span>
<span id="cb35-8"><a href="#cb35-8"></a>                                                    <span class="st">'eval_metric'</span>: <span class="st">'roc_auc'</span>,</span>
<span id="cb35-9"><a href="#cb35-9"></a>                                                    <span class="st">'path'</span>: model_folder},</span>
<span id="cb35-10"><a href="#cb35-10"></a>                                    fit_args<span class="op">=</span>{<span class="st">'holdout_frac'</span>: <span class="fl">0.2</span>,</span>
<span id="cb35-11"><a href="#cb35-11"></a>                                                <span class="st">'excluded_model_types'</span>: [<span class="st">'KNN'</span>],</span>
<span id="cb35-12"><a href="#cb35-12"></a>                                                <span class="st">'presets'</span>: <span class="st">'medium_quality'</span>,</span>
<span id="cb35-13"><a href="#cb35-13"></a>                                                <span class="st">'time_limit'</span>: <span class="dv">180</span><span class="op">*</span><span class="fl">1.5</span>},</span>
<span id="cb35-14"><a href="#cb35-14"></a>                                    n_jobs<span class="op">=</span>num_jobs))</span>
<span id="cb35-15"><a href="#cb35-15"></a>])</span>
<span id="cb35-16"><a href="#cb35-16"></a></span>
<span id="cb35-17"><a href="#cb35-17"></a>global_set_seed()</span>
<span id="cb35-18"><a href="#cb35-18"></a></span>
<span id="cb35-19"><a href="#cb35-19"></a>ag_model.fit( X <span class="op">=</span> train_data.drop(columns<span class="op">=</span>[label]),</span>
<span id="cb35-20"><a href="#cb35-20"></a>            y <span class="op">=</span> train_data[label]</span>
<span id="cb35-21"><a href="#cb35-21"></a>            )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Verbosity: 2 (Standard Logging)
=================== System Info ===================
AutoGluon Version:  1.2
Python Version:     3.11.14
Operating System:   Windows
Platform Machine:   AMD64
Platform Version:   10.0.26200
CPU Count:          20
Memory Avail:       18.18 GB / 31.75 GB (57.3%)
Disk Space Avail:   618.91 GB / 951.67 GB (65.0%)
===================================================
Presets specified: ['medium_quality']
Beginning AutoGluon training ... Time limit = 270s
AutoGluon will save models to "C:\Users\chiuw\IML4Finance\Lectures\Lab01_ag_models_NoTransform"
Train Data Rows:    268811
Train Data Columns: 5
Label Column:       response_flag
Problem Type:       binary
Preprocessing data ...
Selected class &lt;--&gt; label mapping:  class 1 = 1, class 0 = 0
Using Feature Generators to preprocess the data ...
Fitting AutoMLPipelineFeatureGenerator...
    Available Memory:                    18610.01 MB
    Train Data (Original)  Memory Usage: 8.46 MB (0.0% of available memory)
    Inferring data type of each feature based on column values. Set feature_metadata_in to manually specify special dtypes of the features.
    Stage 1 Generators:
        Fitting AsTypeFeatureGenerator...
    Stage 2 Generators:
        Fitting FillNaFeatureGenerator...
    Stage 3 Generators:
        Fitting IdentityFeatureGenerator...
        Fitting CategoryFeatureGenerator...
            Fitting CategoryMemoryMinimizeFeatureGenerator...
    Stage 4 Generators:
        Fitting DropUniqueFeatureGenerator...
    Stage 5 Generators:
        Fitting DropDuplicatesFeatureGenerator...
    Types of features in original data (raw dtype, special dtypes):
        ('category', []) : 1 | ['last_prod_enq2']
        ('float', [])    : 2 | ['CC_utilization', 'PL_utilization']
        ('int', [])      : 2 | ['PL_enq_L6m', 'CC_enq_L6m']
    Types of features in processed data (raw dtype, special dtypes):
        ('category', []) : 1 | ['last_prod_enq2']
        ('float', [])    : 2 | ['CC_utilization', 'PL_utilization']
        ('int', [])      : 2 | ['PL_enq_L6m', 'CC_enq_L6m']
    0.2s = Fit runtime
    5 features in original data used to generate 5 features in processed data.
    Train Data (Processed) Memory Usage: 8.46 MB (0.0% of available memory)
Data preprocessing and feature engineering runtime = 0.25s ...
AutoGluon will gauge predictive performance using evaluation metric: 'roc_auc'
    This metric expects predicted probabilities rather than predicted class labels, so you'll need to use predict_proba() instead of predict()
    To change this, specify the eval_metric parameter of Predictor()
Automatically generating train/validation split with holdout_frac=0.2, Train Rows: 215048, Val Rows: 53763
User-specified model hyperparameters to be fit:
{
    'NN_TORCH': [{}],
    'GBM': [{'extra_trees': True, 'ag_args': {'name_suffix': 'XT'}}, {}, {'learning_rate': 0.03, 'num_leaves': 128, 'feature_fraction': 0.9, 'min_data_in_leaf': 3, 'ag_args': {'name_suffix': 'Large', 'priority': 0, 'hyperparameter_tune_kwargs': None}}],
    'CAT': [{}],
    'XGB': [{}],
    'FASTAI': [{}],
    'RF': [{'criterion': 'gini', 'ag_args': {'name_suffix': 'Gini', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'entropy', 'ag_args': {'name_suffix': 'Entr', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'squared_error', 'ag_args': {'name_suffix': 'MSE', 'problem_types': ['regression', 'quantile']}}],
    'XT': [{'criterion': 'gini', 'ag_args': {'name_suffix': 'Gini', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'entropy', 'ag_args': {'name_suffix': 'Entr', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'squared_error', 'ag_args': {'name_suffix': 'MSE', 'problem_types': ['regression', 'quantile']}}],
    'KNN': [{'weights': 'uniform', 'ag_args': {'name_suffix': 'Unif'}}, {'weights': 'distance', 'ag_args': {'name_suffix': 'Dist'}}],
}
Excluded models: ['KNN'] (Specified by `excluded_model_types`)
Fitting 11 L1 models, fit_strategy="sequential" ...
Fitting model: LightGBMXT ... Training model for up to 269.75s of the 269.75s of remaining time.
    0.7172   = Validation score   (roc_auc)
    1.77s    = Training   runtime
    0.11s    = Validation runtime
Fitting model: LightGBM ... Training model for up to 267.84s of the 267.84s of remaining time.
    0.7184   = Validation score   (roc_auc)
    0.73s    = Training   runtime
    0.03s    = Validation runtime
Fitting model: RandomForestGini ... Training model for up to 267.06s of the 267.06s of remaining time.
    0.6713   = Validation score   (roc_auc)
    6.88s    = Training   runtime
    0.16s    = Validation runtime
Fitting model: RandomForestEntr ... Training model for up to 259.30s of the 259.30s of remaining time.
    0.6712   = Validation score   (roc_auc)
    6.45s    = Training   runtime
    0.15s    = Validation runtime
Fitting model: CatBoost ... Training model for up to 251.90s of the 251.90s of remaining time.
    0.7185   = Validation score   (roc_auc)
    20.69s   = Training   runtime
    0.01s    = Validation runtime
Fitting model: ExtraTreesGini ... Training model for up to 231.17s of the 231.17s of remaining time.
    0.6715   = Validation score   (roc_auc)
    3.97s    = Training   runtime
    0.14s    = Validation runtime
Fitting model: ExtraTreesEntr ... Training model for up to 226.83s of the 226.83s of remaining time.
    0.6716   = Validation score   (roc_auc)
    3.84s    = Training   runtime
    0.14s    = Validation runtime
Fitting model: NeuralNetFastAI ... Training model for up to 222.61s of the 222.61s of remaining time.
    0.7173   = Validation score   (roc_auc)
    82.05s   = Training   runtime
    0.22s    = Validation runtime
Fitting model: XGBoost ... Training model for up to 140.26s of the 140.26s of remaining time.
    0.7178   = Validation score   (roc_auc)
    5.09s    = Training   runtime
    0.05s    = Validation runtime
Fitting model: NeuralNetTorch ... Training model for up to 135.10s of the 135.10s of remaining time.
    0.7183   = Validation score   (roc_auc)
    135.11s  = Training   runtime
    0.14s    = Validation runtime
Fitting model: WeightedEnsemble_L2 ... Training model for up to 269.75s of the -0.18s of remaining time.
    Ensemble Weights: {'LightGBM': 0.556, 'CatBoost': 0.333, 'NeuralNetTorch': 0.111}
    0.7197   = Validation score   (roc_auc)
    0.72s    = Training   runtime
    0.0s     = Validation runtime
AutoGluon training complete, total runtime = 271.1s ... Best model: WeightedEnsemble_L2 | Estimated inference throughput: 298329.2 rows/s (53763 batch size)
TabularPredictor saved. To load, use: predictor = TabularPredictor.load("C:\Users\chiuw\IML4Finance\Lectures\Lab01_ag_models_NoTransform")</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="25">
<style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[('replace_values',
                 FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                ('autogluon',
                 AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN'],
                                                   'holdout_frac': 0.2,
                                                   'presets': 'medium_quality',
                                                   'time_limit': 270.0},
                                         label='response_flag', n_jobs=7,
                                         predictor_args={'eval_metric': 'roc_auc',
                                                         'path': 'Lab01_ag_models_NoTransform',
                                                         'problem_type': 'binary'}))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox"><label for="sk-estimator-id-1" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;&nbsp;Pipeline<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.pipeline.Pipeline.html">?<span>Documentation for Pipeline</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>Pipeline(steps=[('replace_values',
                 FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                ('autogluon',
                 AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN'],
                                                   'holdout_frac': 0.2,
                                                   'presets': 'medium_quality',
                                                   'time_limit': 270.0},
                                         label='response_flag', n_jobs=7,
                                         predictor_args={'eval_metric': 'roc_auc',
                                                         'path': 'Lab01_ag_models_NoTransform',
                                                         'problem_type': 'binary'}))])</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox"><label for="sk-estimator-id-2" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;FunctionTransformer<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.preprocessing.FunctionTransformer.html">?<span>Documentation for FunctionTransformer</span></a></label><div class="sk-toggleable__content fitted"><pre>FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)</pre></div> </div></div><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox"><label for="sk-estimator-id-3" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">AutoGluonSklearnWrapper</label><div class="sk-toggleable__content fitted"><pre>AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN'],
                                  'holdout_frac': 0.2,
                                  'presets': 'medium_quality',
                                  'time_limit': 270.0},
                        label='response_flag', n_jobs=7,
                        predictor_args={'eval_metric': 'roc_auc',
                                        'path': 'Lab01_ag_models_NoTransform',
                                        'problem_type': 'binary'})</pre></div> </div></div></div></div></div></div>
</div>
</div>
<p>The attribute <code>ag_model.named_steps['autogluon'].predictor</code> contains the original fit object from <code>autogluon</code>.</p>
<p>Generate a leaderboard to see the performance of each model on <code>test_data</code>.</p>
<div id="323cb999" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1"></a>df_leaders <span class="op">=</span> ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.leaderboard(test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\chiuw\miniforge3\envs\env_iml4finance_2026\Lib\site-packages\fastai\learner.py:455: UserWarning:

load_learner` uses Python's insecure pickle module, which can execute malicious arbitrary code when loading. Only load files you trust.
If you only need to load model weights and optimizer state, use the safe `Learner.load` instead.
</code></pre>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1"></a>display(df_leaders)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-ag-leaderboard" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="27">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ag-leaderboard-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7: Autogluon Leaderboard
</figcaption>
<div aria-describedby="tbl-ag-leaderboard-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">score_test</th>
<th data-quarto-table-cell-role="th">score_val</th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">pred_time_test</th>
<th data-quarto-table-cell-role="th">pred_time_val</th>
<th data-quarto-table-cell-role="th">fit_time</th>
<th data-quarto-table-cell-role="th">pred_time_test_marginal</th>
<th data-quarto-table-cell-role="th">pred_time_val_marginal</th>
<th data-quarto-table-cell-role="th">fit_time_marginal</th>
<th data-quarto-table-cell-role="th">stack_level</th>
<th data-quarto-table-cell-role="th">can_infer</th>
<th data-quarto-table-cell-role="th">fit_order</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>WeightedEnsemble_L2</td>
<td>0.720141</td>
<td>0.719659</td>
<td>roc_auc</td>
<td>0.458547</td>
<td>0.180214</td>
<td>157.236423</td>
<td>0.003995</td>
<td>0.002999</td>
<td>0.717124</td>
<td>2</td>
<td>True</td>
<td>11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>CatBoost</td>
<td>0.719936</td>
<td>0.718538</td>
<td>roc_auc</td>
<td>0.036111</td>
<td>0.008000</td>
<td>20.686615</td>
<td>0.036111</td>
<td>0.008000</td>
<td>20.686615</td>
<td>1</td>
<td>True</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>LightGBM</td>
<td>0.719203</td>
<td>0.718404</td>
<td>roc_auc</td>
<td>0.055043</td>
<td>0.031034</td>
<td>0.725682</td>
<td>0.055043</td>
<td>0.031034</td>
<td>0.725682</td>
<td>1</td>
<td>True</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>NeuralNetTorch</td>
<td>0.718158</td>
<td>0.718287</td>
<td>roc_auc</td>
<td>0.363397</td>
<td>0.138180</td>
<td>135.107002</td>
<td>0.363397</td>
<td>0.138180</td>
<td>135.107002</td>
<td>1</td>
<td>True</td>
<td>10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>NeuralNetFastAI</td>
<td>0.718123</td>
<td>0.717316</td>
<td>roc_auc</td>
<td>0.523138</td>
<td>0.224352</td>
<td>82.045661</td>
<td>0.523138</td>
<td>0.224352</td>
<td>82.045661</td>
<td>1</td>
<td>True</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>XGBoost</td>
<td>0.717188</td>
<td>0.717808</td>
<td>roc_auc</td>
<td>0.082088</td>
<td>0.050536</td>
<td>5.088922</td>
<td>0.082088</td>
<td>0.050536</td>
<td>5.088922</td>
<td>1</td>
<td>True</td>
<td>9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>LightGBMXT</td>
<td>0.717089</td>
<td>0.717234</td>
<td>roc_auc</td>
<td>0.205157</td>
<td>0.114115</td>
<td>1.768851</td>
<td>0.205157</td>
<td>0.114115</td>
<td>1.768851</td>
<td>1</td>
<td>True</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>ExtraTreesGini</td>
<td>0.659221</td>
<td>0.671457</td>
<td>roc_auc</td>
<td>0.414664</td>
<td>0.137069</td>
<td>3.968272</td>
<td>0.414664</td>
<td>0.137069</td>
<td>3.968272</td>
<td>1</td>
<td>True</td>
<td>6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>ExtraTreesEntr</td>
<td>0.659023</td>
<td>0.671624</td>
<td>roc_auc</td>
<td>0.412251</td>
<td>0.142047</td>
<td>3.836026</td>
<td>0.412251</td>
<td>0.142047</td>
<td>3.836026</td>
<td>1</td>
<td>True</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>RandomForestEntr</td>
<td>0.658832</td>
<td>0.671214</td>
<td>roc_auc</td>
<td>0.434995</td>
<td>0.154675</td>
<td>6.448632</td>
<td>0.434995</td>
<td>0.154675</td>
<td>6.448632</td>
<td>1</td>
<td>True</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>RandomForestGini</td>
<td>0.658697</td>
<td>0.671330</td>
<td>roc_auc</td>
<td>0.472667</td>
<td>0.157521</td>
<td>6.875059</td>
<td>0.472667</td>
<td>0.157521</td>
<td>6.875059</td>
<td>1</td>
<td>True</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="best-model" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Best Model</h1>
<p>Although <code>CatBoost</code> may not have the highest roc_auc score, the model generates very fast predictions with a very competitive roc_auc score.</p>
<p>Set the best model to <code>CatBoost</code>.</p>
<div id="eaaa921f" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1"></a>best_model_name <span class="op">=</span> <span class="st">'CatBoost'</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.set_model_best(best_model_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="check-probability-calibration" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Check Probability Calibration</h1>
<p>Measure how well the model scores align with the observed response rates in <code>test_data</code>.</p>
<div id="9b39e9ad" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb41-2"><a href="#cb41-2"></a></span>
<span id="cb41-3"><a href="#cb41-3"></a>cal_disp <span class="op">=</span> CalibrationDisplay.from_estimator(</span>
<span id="cb41-4"><a href="#cb41-4"></a>        estimator <span class="op">=</span> ag_model,</span>
<span id="cb41-5"><a href="#cb41-5"></a>        X <span class="op">=</span> test_data.drop(columns<span class="op">=</span>[label]),</span>
<span id="cb41-6"><a href="#cb41-6"></a>        y <span class="op">=</span> test_data[label],</span>
<span id="cb41-7"><a href="#cb41-7"></a>        n_bins <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb41-8"><a href="#cb41-8"></a>        name <span class="op">=</span> <span class="st">'Uncalib_CatBoost'</span>,</span>
<span id="cb41-9"><a href="#cb41-9"></a>        color <span class="op">=</span> <span class="st">'orange'</span></span>
<span id="cb41-10"><a href="#cb41-10"></a>    )</span>
<span id="cb41-11"><a href="#cb41-11"></a></span>
<span id="cb41-12"><a href="#cb41-12"></a>cal_disp.ax_.set_title(<span class="st">"Calibration Plot"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>Text(0.5, 1.0, 'Calibration Plot')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-30-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Calibrate the model scores to the observed response rates in <code>df_campaign_2</code>.</p>
<p>Calibration methods should avoid using the training data (due to the model scores being overfitted to the training data). The test data should be used for evaluation purposes only. Therefore, we will use <code>df_campaign_2</code> to calibrate the model.</p>
<p>Set up the data frames from <code>df_campaign_2</code>.</p>
<div id="cc01a797" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># Get the data ready</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>df_campaign_2_subset <span class="op">=</span> df_campaign_2[subset_cols].copy()</span>
<span id="cb43-3"><a href="#cb43-3"></a>df_campaign_2_subset[<span class="st">'last_prod_enq2'</span>] <span class="op">=</span> df_campaign_2_subset[<span class="st">'last_prod_enq2'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb43-4"><a href="#cb43-4"></a></span>
<span id="cb43-5"><a href="#cb43-5"></a><span class="co"># Prepare features and true labels</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>X_campaign2 <span class="op">=</span> df_campaign_2_subset.drop(columns<span class="op">=</span>[label])</span>
<span id="cb43-7"><a href="#cb43-7"></a>y_campaign2 <span class="op">=</span> df_campaign_2_subset[label]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Calibrate the model scores using <code>df_campaign_2</code> and <code>CalibratedClassifierCV</code>.</p>
<div id="2c89b808" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1"></a>cal_model <span class="op">=</span> CalibratedClassifierCV(</span>
<span id="cb44-2"><a href="#cb44-2"></a>    estimator <span class="op">=</span> ag_model,</span>
<span id="cb44-3"><a href="#cb44-3"></a>    method<span class="op">=</span><span class="st">'isotonic'</span>,</span>
<span id="cb44-4"><a href="#cb44-4"></a>    cv<span class="op">=</span><span class="st">"prefit"</span> <span class="co"># Use the fitted model from ag_model</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>)</span>
<span id="cb44-6"><a href="#cb44-6"></a></span>
<span id="cb44-7"><a href="#cb44-7"></a>global_set_seed()</span>
<span id="cb44-8"><a href="#cb44-8"></a></span>
<span id="cb44-9"><a href="#cb44-9"></a>cal_model.fit(X <span class="op">=</span> X_campaign2,</span>
<span id="cb44-10"><a href="#cb44-10"></a>            y <span class="op">=</span> y_campaign2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="31">
<style>#sk-container-id-2 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-2 {
  color: var(--sklearn-color-text);
}

#sk-container-id-2 pre {
  padding: 0;
}

#sk-container-id-2 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-2 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-2 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-2 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-2 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-2 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-2 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-2 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-2 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-2 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-2 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-2 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-2 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-2 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-2 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-2 div.sk-label label.sk-toggleable__label,
#sk-container-id-2 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-2 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-2 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-2 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-2 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-2 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-2 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-2 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-2 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-2 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>CalibratedClassifierCV(cv='prefit',
                       estimator=Pipeline(steps=[('replace_values',
                                                  FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                                                 ('autogluon',
                                                  AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN'],
                                                                                    'holdout_frac': 0.2,
                                                                                    'presets': 'medium_quality',
                                                                                    'time_limit': 270.0},
                                                                          label='response_flag',
                                                                          n_jobs=7,
                                                                          predictor_args={'eval_metric': 'roc_auc',
                                                                                          'path': 'Lab01_ag_models_NoTransform',
                                                                                          'problem_type': 'binary'}))]),
                       method='isotonic')</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-4" type="checkbox"><label for="sk-estimator-id-4" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;&nbsp;CalibratedClassifierCV<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.calibration.CalibratedClassifierCV.html">?<span>Documentation for CalibratedClassifierCV</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>CalibratedClassifierCV(cv='prefit',
                       estimator=Pipeline(steps=[('replace_values',
                                                  FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                                                 ('autogluon',
                                                  AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN'],
                                                                                    'holdout_frac': 0.2,
                                                                                    'presets': 'medium_quality',
                                                                                    'time_limit': 270.0},
                                                                          label='response_flag',
                                                                          n_jobs=7,
                                                                          predictor_args={'eval_metric': 'roc_auc',
                                                                                          'path': 'Lab01_ag_models_NoTransform',
                                                                                          'problem_type': 'binary'}))]),
                       method='isotonic')</pre></div> </div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox"><label for="sk-estimator-id-5" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">estimator: Pipeline</label><div class="sk-toggleable__content fitted"><pre>Pipeline(steps=[('replace_values',
                 FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                ('autogluon',
                 AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN'],
                                                   'holdout_frac': 0.2,
                                                   'presets': 'medium_quality',
                                                   'time_limit': 270.0},
                                         label='response_flag', n_jobs=7,
                                         predictor_args={'eval_metric': 'roc_auc',
                                                         'path': 'Lab01_ag_models_NoTransform',
                                                         'problem_type': 'binary'}))])</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-6" type="checkbox"><label for="sk-estimator-id-6" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;FunctionTransformer<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.preprocessing.FunctionTransformer.html">?<span>Documentation for FunctionTransformer</span></a></label><div class="sk-toggleable__content fitted"><pre>FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)</pre></div> </div></div><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-7" type="checkbox"><label for="sk-estimator-id-7" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">AutoGluonSklearnWrapper</label><div class="sk-toggleable__content fitted"><pre>AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN'],
                                  'holdout_frac': 0.2,
                                  'presets': 'medium_quality',
                                  'time_limit': 270.0},
                        label='response_flag', n_jobs=7,
                        predictor_args={'eval_metric': 'roc_auc',
                                        'path': 'Lab01_ag_models_NoTransform',
                                        'problem_type': 'binary'})</pre></div> </div></div></div></div></div></div></div></div></div></div></div>
</div>
</div>
<div id="3007008a" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb45-2"><a href="#cb45-2"></a></span>
<span id="cb45-3"><a href="#cb45-3"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb45-4"><a href="#cb45-4"></a></span>
<span id="cb45-5"><a href="#cb45-5"></a><span class="cf">for</span> estimator, name, color <span class="kw">in</span> [(ag_model, <span class="st">'Uncalib_CatBoost'</span>, <span class="st">'orange'</span>),</span>
<span id="cb45-6"><a href="#cb45-6"></a>          (cal_model, <span class="st">'Calib_CatBoost'</span>, <span class="st">'blue'</span>)]:</span>
<span id="cb45-7"><a href="#cb45-7"></a></span>
<span id="cb45-8"><a href="#cb45-8"></a>  CalibrationDisplay.from_estimator(</span>
<span id="cb45-9"><a href="#cb45-9"></a>      estimator <span class="op">=</span> estimator,</span>
<span id="cb45-10"><a href="#cb45-10"></a>      X <span class="op">=</span> test_data.drop(columns<span class="op">=</span>[label]),</span>
<span id="cb45-11"><a href="#cb45-11"></a>      y <span class="op">=</span> test_data[label],</span>
<span id="cb45-12"><a href="#cb45-12"></a>        n_bins <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb45-13"><a href="#cb45-13"></a>      name <span class="op">=</span> name,</span>
<span id="cb45-14"><a href="#cb45-14"></a>      color <span class="op">=</span> color,</span>
<span id="cb45-15"><a href="#cb45-15"></a>        ax <span class="op">=</span> ax</span>
<span id="cb45-16"><a href="#cb45-16"></a>    )</span>
<span id="cb45-17"><a href="#cb45-17"></a>    </span>
<span id="cb45-18"><a href="#cb45-18"></a>ax.set_title(<span class="st">"Calibration Plot"</span>)</span>
<span id="cb45-19"><a href="#cb45-19"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The calibration plot shows that the uncalibrated model is better than the calibrated model.</p>
<p>This occurred because CatBoost uses the <code>logloss</code> objective function when the model fits. The <code>logloss</code> function is called a proper scoring rule, which explicitly accounts for the calibration of the predicted probabilities.</p>
<p>In other models, like <code>RandomForest</code>, the predicted probabilities are based on the purity of the leaf nodes (i.e., Gini). This is not a proper scoring rule and can lead to poorly calibrated probabilities.</p>
<p>Going forward, we will use <code>ag_model</code> for predictions.</p>
</section>
<section id="permutation-feature-importance" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Permutation Feature Importance</h1>
<p>Using the best model, rank features from most important to least important.</p>
<p>Permutation feature importance measures how model performance degrades when a feature is randomly shuffled. Using <code>test_data</code> avoids overfitting and provides a more reliable estimate of each feature’s importance.</p>
<div id="7f1079ee" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a>best_feature_importance <span class="op">=</span> (ag_model</span>
<span id="cb46-2"><a href="#cb46-2"></a>                            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb46-3"><a href="#cb46-3"></a>                            .predictor</span>
<span id="cb46-4"><a href="#cb46-4"></a>                            .feature_importance(</span>
<span id="cb46-5"><a href="#cb46-5"></a>                                    data <span class="op">=</span> test_data, </span>
<span id="cb46-6"><a href="#cb46-6"></a>                                    model <span class="op">=</span> best_model_name,</span>
<span id="cb46-7"><a href="#cb46-7"></a>                                    subsample_size <span class="op">=</span> <span class="va">None</span>)</span>
<span id="cb46-8"><a href="#cb46-8"></a>                        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Computing feature importance via permutation shuffling for 5 features using 115206 rows with 5 shuffle sets...
    0.92s   = Expected runtime (0.18s per shuffle set)
    0.7s    = Actual runtime (Completed 5 of 5 shuffle sets)</code></pre>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1"></a>display(best_feature_importance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-perm-feature-importance" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="34">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-perm-feature-importance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;8: Permutation Feature Importance
</figcaption>
<div aria-describedby="tbl-perm-feature-importance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">importance</th>
<th data-quarto-table-cell-role="th">stddev</th>
<th data-quarto-table-cell-role="th">p_value</th>
<th data-quarto-table-cell-role="th">n</th>
<th data-quarto-table-cell-role="th">p99_high</th>
<th data-quarto-table-cell-role="th">p99_low</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">CC_utilization</td>
<td>0.039105</td>
<td>0.001118</td>
<td>8.016086e-08</td>
<td>5</td>
<td>0.041408</td>
<td>0.036803</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PL_utilization</td>
<td>0.013564</td>
<td>0.001458</td>
<td>1.578851e-05</td>
<td>5</td>
<td>0.016567</td>
<td>0.010562</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">PL_enq_L6m</td>
<td>0.012960</td>
<td>0.000779</td>
<td>1.561220e-06</td>
<td>5</td>
<td>0.014564</td>
<td>0.011355</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">CC_enq_L6m</td>
<td>0.006585</td>
<td>0.000598</td>
<td>8.072749e-06</td>
<td>5</td>
<td>0.007816</td>
<td>0.005354</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">last_prod_enq2</td>
<td>0.000552</td>
<td>0.000337</td>
<td>1.080965e-02</td>
<td>5</td>
<td>0.001247</td>
<td>-0.000143</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="partial-dependence-plots" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> Partial Dependence Plots</h1>
<p>Create a function that generates partial dependence plots for all features.</p>
<div id="8b3c8051" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1"></a><span class="kw">def</span> show_pdp(wrappedAGModel: BaseEstimator,</span>
<span id="cb49-2"><a href="#cb49-2"></a>            list_features: <span class="bu">list</span>,</span>
<span id="cb49-3"><a href="#cb49-3"></a>            list_categ_features: <span class="bu">list</span>,</span>
<span id="cb49-4"><a href="#cb49-4"></a>            df: pd.DataFrame,</span>
<span id="cb49-5"><a href="#cb49-5"></a>            xGTzero: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb49-6"><a href="#cb49-6"></a>            sampSize: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5000</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb49-7"><a href="#cb49-7"></a></span>
<span id="cb49-8"><a href="#cb49-8"></a>    N_JOBS <span class="op">=</span> num_jobs</span>
<span id="cb49-9"><a href="#cb49-9"></a></span>
<span id="cb49-10"><a href="#cb49-10"></a>    <span class="cf">for</span> feature <span class="kw">in</span> list_features:</span>
<span id="cb49-11"><a href="#cb49-11"></a>        fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb49-12"><a href="#cb49-12"></a>        ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>)</span>
<span id="cb49-13"><a href="#cb49-13"></a></span>
<span id="cb49-14"><a href="#cb49-14"></a>        plt.rcParams.update({<span class="st">'font.size'</span>: <span class="dv">16</span>})</span>
<span id="cb49-15"><a href="#cb49-15"></a></span>
<span id="cb49-16"><a href="#cb49-16"></a>        pdp_kwargs <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb49-17"><a href="#cb49-17"></a>            estimator<span class="op">=</span>wrappedAGModel,</span>
<span id="cb49-18"><a href="#cb49-18"></a>            X<span class="op">=</span>df.sample(sampSize, random_state<span class="op">=</span><span class="dv">2025</span>),</span>
<span id="cb49-19"><a href="#cb49-19"></a>            features<span class="op">=</span>[feature],</span>
<span id="cb49-20"><a href="#cb49-20"></a>            categorical_features<span class="op">=</span>list_categ_features,</span>
<span id="cb49-21"><a href="#cb49-21"></a>            method<span class="op">=</span><span class="st">'brute'</span>,</span>
<span id="cb49-22"><a href="#cb49-22"></a>            kind<span class="op">=</span><span class="st">"average"</span>,</span>
<span id="cb49-23"><a href="#cb49-23"></a>            percentiles<span class="op">=</span>(<span class="fl">0.0001</span>, <span class="fl">0.9999</span>),</span>
<span id="cb49-24"><a href="#cb49-24"></a>            grid_resolution<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb49-25"><a href="#cb49-25"></a>            ax<span class="op">=</span>ax,</span>
<span id="cb49-26"><a href="#cb49-26"></a>            random_state<span class="op">=</span><span class="dv">2025</span>,</span>
<span id="cb49-27"><a href="#cb49-27"></a>            n_jobs<span class="op">=</span>N_JOBS,</span>
<span id="cb49-28"><a href="#cb49-28"></a>        )</span>
<span id="cb49-29"><a href="#cb49-29"></a></span>
<span id="cb49-30"><a href="#cb49-30"></a>        _ <span class="op">=</span> PartialDependenceDisplay.from_estimator(<span class="op">**</span>pdp_kwargs)</span>
<span id="cb49-31"><a href="#cb49-31"></a></span>
<span id="cb49-32"><a href="#cb49-32"></a>        ax.set_title(<span class="ss">f"Partial Dependence for </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb49-33"><a href="#cb49-33"></a></span>
<span id="cb49-34"><a href="#cb49-34"></a>        <span class="co"># Set y-axis lower limit for all axes in the current figure</span></span>
<span id="cb49-35"><a href="#cb49-35"></a>        <span class="cf">for</span> a <span class="kw">in</span> fig.get_axes():</span>
<span id="cb49-36"><a href="#cb49-36"></a>            coordy <span class="op">=</span> a.get_ylim()</span>
<span id="cb49-37"><a href="#cb49-37"></a>            a.set_ylim(bottom<span class="op">=</span><span class="dv">0</span>, top<span class="op">=</span>coordy[<span class="dv">1</span>]<span class="op">*</span><span class="fl">1.1</span>)</span>
<span id="cb49-38"><a href="#cb49-38"></a></span>
<span id="cb49-39"><a href="#cb49-39"></a>        <span class="cf">if</span> xGTzero:</span>
<span id="cb49-40"><a href="#cb49-40"></a>            <span class="co"># Set x-axis from 0 to the max</span></span>
<span id="cb49-41"><a href="#cb49-41"></a>            <span class="cf">for</span> a <span class="kw">in</span> fig.get_axes():</span>
<span id="cb49-42"><a href="#cb49-42"></a>                max_val <span class="op">=</span> np.percentile(df[feature].values, <span class="fl">99.99</span>)</span>
<span id="cb49-43"><a href="#cb49-43"></a>                a.set_xlim(left<span class="op">=</span><span class="dv">0</span>, right<span class="op">=</span>max_val)</span>
<span id="cb49-44"><a href="#cb49-44"></a></span>
<span id="cb49-45"><a href="#cb49-45"></a>        plt.show()</span>
<span id="cb49-46"><a href="#cb49-46"></a>        plt.close(<span class="st">'all'</span>)  <span class="co"># Prevent figure overload</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="f6c3c906" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1"></a><span class="co"># Get all features from ag_model.predictor</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>all_features <span class="op">=</span> ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.features()</span>
<span id="cb50-3"><a href="#cb50-3"></a></span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="co"># Get categorical features from ag_model.predictor's feature metadata</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>categorical_features <span class="op">=</span> ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.feature_metadata.get_features(valid_raw_types<span class="op">=</span>[<span class="st">'category'</span>])</span>
<span id="cb50-6"><a href="#cb50-6"></a></span>
<span id="cb50-7"><a href="#cb50-7"></a><span class="co"># Get numeric features from ag_model.predictor's feature metadata</span></span>
<span id="cb50-8"><a href="#cb50-8"></a>numeric_features <span class="op">=</span> ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.feature_metadata.get_features(valid_raw_types<span class="op">=</span>[<span class="st">'int'</span>, <span class="st">'float'</span>, <span class="st">'int64'</span>, <span class="st">'float64'</span>, <span class="st">'int32'</span>, <span class="st">'float32'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Use partial dependence plots (PDP) to describe the relationships between features and predictions.</p>
<p>Unlike permutation feature importance, PDPs do not depend on the true labels. Instead, they show how the model’s predictions change as the feature values change.</p>
<div id="e8307e02" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb51-2"><a href="#cb51-2"></a></span>
<span id="cb51-3"><a href="#cb51-3"></a>show_pdp(wrappedAGModel <span class="op">=</span> ag_model,</span>
<span id="cb51-4"><a href="#cb51-4"></a>        list_features <span class="op">=</span> all_features, </span>
<span id="cb51-5"><a href="#cb51-5"></a>        list_categ_features <span class="op">=</span> categorical_features, </span>
<span id="cb51-6"><a href="#cb51-6"></a>    df <span class="op">=</span> train_data.drop(columns<span class="op">=</span>[label]),</span>
<span id="cb51-7"><a href="#cb51-7"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-38-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-38-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-38-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-38-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="qa-1" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="qa-1"><span class="header-section-number">13.1</span> Q&amp;A</h2>
<section id="question-6" class="level3" data-number="13.1.1">
<h3 data-number="13.1.1" class="anchored" data-anchor-id="question-6"><span class="header-section-number">13.1.1</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In <code>train_data</code>, what is the maximum value of <code>CC_utilization</code>?</p>
</div>
</div>
</section>
<section id="question-7" class="level3" data-number="13.1.2">
<h3 data-number="13.1.2" class="anchored" data-anchor-id="question-7"><span class="header-section-number">13.1.2</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>What would happen to the partial dependence plot if <code>train_data</code> included prospects with <code>CC_utilization</code> values greater than 100%?</p>
<p>The partial dependence curve would likely _____.</p>
<p>Check your answer by creating a copy of <code>train_data</code> and then adding <code>0.50</code> to all <code>CC_utilization</code> values. Then create the PDP for <code>CC_utilization</code>.</p>
</div>
</div>
</section>
</section>
<section id="more-pdp" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="more-pdp"><span class="header-section-number">13.2</span> More PDP</h2>
<p>Zoom-in on the plots where the feature values are greater than or equal to 0.</p>
<div id="faf4d64a" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb52-2"><a href="#cb52-2"></a></span>
<span id="cb52-3"><a href="#cb52-3"></a>show_pdp(wrappedAGModel <span class="op">=</span> ag_model,</span>
<span id="cb52-4"><a href="#cb52-4"></a>        list_features <span class="op">=</span> numeric_features, </span>
<span id="cb52-5"><a href="#cb52-5"></a>        list_categ_features <span class="op">=</span> categorical_features, </span>
<span id="cb52-6"><a href="#cb52-6"></a>    df <span class="op">=</span> train_data.drop(columns<span class="op">=</span>[label]), </span>
<span id="cb52-7"><a href="#cb52-7"></a>    xGTzero <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-39-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-39-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-39-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-39-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="accumulated-local-effects-plots" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> Accumulated Local Effects Plots</h1>
<div id="b0ceb47a" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1"></a><span class="kw">def</span> show_ale(wrappedAGModel: BaseEstimator,</span>
<span id="cb53-2"><a href="#cb53-2"></a>            list_features: <span class="bu">list</span>,</span>
<span id="cb53-3"><a href="#cb53-3"></a>            df: pd.DataFrame,</span>
<span id="cb53-4"><a href="#cb53-4"></a>            xGTzero: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb53-5"><a href="#cb53-5"></a>            sampSize: <span class="bu">int</span> <span class="op">=</span> <span class="dv">40000</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb53-6"><a href="#cb53-6"></a></span>
<span id="cb53-7"><a href="#cb53-7"></a>  <span class="kw">def</span> do_nothing(data):</span>
<span id="cb53-8"><a href="#cb53-8"></a>    <span class="cf">return</span> data</span>
<span id="cb53-9"><a href="#cb53-9"></a></span>
<span id="cb53-10"><a href="#cb53-10"></a>  <span class="cf">for</span> feature <span class="kw">in</span> list_features:</span>
<span id="cb53-11"><a href="#cb53-11"></a></span>
<span id="cb53-12"><a href="#cb53-12"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb53-13"><a href="#cb53-13"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>)</span>
<span id="cb53-14"><a href="#cb53-14"></a></span>
<span id="cb53-15"><a href="#cb53-15"></a>    plt.rcParams.update({<span class="st">'font.size'</span>: <span class="dv">12</span>})</span>
<span id="cb53-16"><a href="#cb53-16"></a></span>
<span id="cb53-17"><a href="#cb53-17"></a>    ale_eff <span class="op">=</span> ale(</span>
<span id="cb53-18"><a href="#cb53-18"></a>                X <span class="op">=</span> df.sample(sampSize, random_state<span class="op">=</span><span class="dv">2025</span>),</span>
<span id="cb53-19"><a href="#cb53-19"></a>                model <span class="op">=</span> wrappedAGModel,</span>
<span id="cb53-20"><a href="#cb53-20"></a>                feature <span class="op">=</span> [feature],</span>
<span id="cb53-21"><a href="#cb53-21"></a>                include_CI <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb53-22"><a href="#cb53-22"></a>                C<span class="op">=</span><span class="fl">0.9999</span>,</span>
<span id="cb53-23"><a href="#cb53-23"></a>                grid_size<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb53-24"><a href="#cb53-24"></a>                encode_fun<span class="op">=</span>do_nothing,</span>
<span id="cb53-25"><a href="#cb53-25"></a>                predictors<span class="op">=</span>wrappedAGModel.named_steps[<span class="st">'autogluon'</span>].predictor.features(),</span>
<span id="cb53-26"><a href="#cb53-26"></a>                fig<span class="op">=</span>fig,</span>
<span id="cb53-27"><a href="#cb53-27"></a>                ax<span class="op">=</span>ax</span>
<span id="cb53-28"><a href="#cb53-28"></a>                )</span>
<span id="cb53-29"><a href="#cb53-29"></a>    </span>
<span id="cb53-30"><a href="#cb53-30"></a>    <span class="cf">if</span> xGTzero:</span>
<span id="cb53-31"><a href="#cb53-31"></a>        <span class="co"># Set x-axis from 0 to the max</span></span>
<span id="cb53-32"><a href="#cb53-32"></a>        <span class="cf">for</span> a <span class="kw">in</span> fig.get_axes():</span>
<span id="cb53-33"><a href="#cb53-33"></a>            max_val <span class="op">=</span> np.percentile(df[feature].values, <span class="fl">99.99</span>)</span>
<span id="cb53-34"><a href="#cb53-34"></a>            a.set_xlim(left<span class="op">=</span><span class="dv">0</span>, right<span class="op">=</span>max_val)</span>
<span id="cb53-35"><a href="#cb53-35"></a></span>
<span id="cb53-36"><a href="#cb53-36"></a>    plt.show()</span>
<span id="cb53-37"><a href="#cb53-37"></a>    plt.close(<span class="st">'all'</span>)  <span class="co"># Prevent figure overload</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="3c2357c9" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a>show_ale(wrappedAGModel <span class="op">=</span> ag_model,</span>
<span id="cb54-4"><a href="#cb54-4"></a>        list_features <span class="op">=</span> all_features, </span>
<span id="cb54-5"><a href="#cb54-5"></a>        df <span class="op">=</span> train_data.drop(columns<span class="op">=</span>[label]), </span>
<span id="cb54-6"><a href="#cb54-6"></a>        xGTzero <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>PyALE._ALE_generic:INFO: Continuous feature detected.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-41-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>PyALE._ALE_generic:INFO: Continuous feature detected.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-41-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>PyALE._ALE_generic:INFO: categorical feature detected.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-41-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>PyALE._ALE_generic:INFO: Discrete feature detected.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-41-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>PyALE._ALE_generic:INFO: Discrete feature detected.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-41-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="50442f77" class="cell" data-execution_count="41">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb60-2"><a href="#cb60-2"></a></span>
<span id="cb60-3"><a href="#cb60-3"></a>show_ale(wrappedAGModel <span class="op">=</span> ag_model,</span>
<span id="cb60-4"><a href="#cb60-4"></a>        list_features <span class="op">=</span> numeric_features, </span>
<span id="cb60-5"><a href="#cb60-5"></a>        df <span class="op">=</span> train_data.drop(columns<span class="op">=</span>[label]), </span>
<span id="cb60-6"><a href="#cb60-6"></a>        xGTzero <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>PyALE._ALE_generic:INFO: Continuous feature detected.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-42-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>PyALE._ALE_generic:INFO: Continuous feature detected.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-42-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>PyALE._ALE_generic:INFO: Discrete feature detected.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-42-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>PyALE._ALE_generic:INFO: Discrete feature detected.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-42-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-evaluation" class="level1" data-number="15">
<h1 data-number="15"><span class="header-section-number">15</span> Model Evaluation</h1>
<p>Evaluate the model using <code>df_campaign_2</code>.</p>
<p>We will bin the predicted probabilities into 5 bins. For each bin, calculate the bin size, number of responses, and response rate. Also calculate the cumulative number of responses and cumulative response rate. Also calculate gain and lift.</p>
<div id="10f352de" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1"></a>y_probas <span class="op">=</span> ag_model.predict_proba(X_campaign2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="e3b2a2c5" class="cell" data-execution_count="43">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1"></a><span class="co"># Create DataFrame with predictions and actual values</span></span>
<span id="cb66-2"><a href="#cb66-2"></a>df_analysis <span class="op">=</span> pd.DataFrame({</span>
<span id="cb66-3"><a href="#cb66-3"></a>    <span class="st">'score'</span>: y_probas[:,<span class="dv">1</span>],</span>
<span id="cb66-4"><a href="#cb66-4"></a>    label: y_campaign2</span>
<span id="cb66-5"><a href="#cb66-5"></a>})</span>
<span id="cb66-6"><a href="#cb66-6"></a></span>
<span id="cb66-7"><a href="#cb66-7"></a><span class="co"># Create bins</span></span>
<span id="cb66-8"><a href="#cb66-8"></a>df_analysis[<span class="st">'bin'</span>] <span class="op">=</span> pd.qcut(df_analysis[<span class="st">'score'</span>], q<span class="op">=</span><span class="dv">5</span>, precision<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb66-9"><a href="#cb66-9"></a></span>
<span id="cb66-10"><a href="#cb66-10"></a><span class="co"># Group by bin and calculate metrics</span></span>
<span id="cb66-11"><a href="#cb66-11"></a>df_metrics <span class="op">=</span> (df_analysis</span>
<span id="cb66-12"><a href="#cb66-12"></a>            .groupby(<span class="st">'bin'</span>, observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb66-13"><a href="#cb66-13"></a>            .agg({</span>
<span id="cb66-14"><a href="#cb66-14"></a>                <span class="st">'score'</span>: [<span class="st">'mean'</span>, <span class="st">'count'</span>],</span>
<span id="cb66-15"><a href="#cb66-15"></a>                label: [<span class="st">'sum'</span>, <span class="st">'mean'</span>]</span>
<span id="cb66-16"><a href="#cb66-16"></a>            })</span>
<span id="cb66-17"><a href="#cb66-17"></a>            .sort_values(<span class="st">'bin'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb66-18"><a href="#cb66-18"></a>            .reset_index()</span>
<span id="cb66-19"><a href="#cb66-19"></a>            )</span>
<span id="cb66-20"><a href="#cb66-20"></a></span>
<span id="cb66-21"><a href="#cb66-21"></a><span class="co"># Rename columns</span></span>
<span id="cb66-22"><a href="#cb66-22"></a>df_metrics.columns <span class="op">=</span> [<span class="st">'bin_name'</span>,<span class="st">'avg_score'</span>,<span class="st">'prospects'</span>, <span class="st">'responses'</span>, <span class="st">'response_rate'</span>]</span>
<span id="cb66-23"><a href="#cb66-23"></a></span>
<span id="cb66-24"><a href="#cb66-24"></a>df_metrics[<span class="st">'exp_responses'</span>] <span class="op">=</span> df_metrics[<span class="st">'prospects'</span>] <span class="op">*</span> df_metrics[<span class="st">'avg_score'</span>]</span>
<span id="cb66-25"><a href="#cb66-25"></a></span>
<span id="cb66-26"><a href="#cb66-26"></a><span class="co"># Calculate cumulative metrics</span></span>
<span id="cb66-27"><a href="#cb66-27"></a>df_metrics[<span class="st">'cum_prospects'</span>] <span class="op">=</span> df_metrics[<span class="st">'prospects'</span>].cumsum()</span>
<span id="cb66-28"><a href="#cb66-28"></a>df_metrics[<span class="st">'cum_responses'</span>] <span class="op">=</span> df_metrics[<span class="st">'responses'</span>].cumsum()</span>
<span id="cb66-29"><a href="#cb66-29"></a>df_metrics[<span class="st">'cum_response_rate'</span>] <span class="op">=</span> df_metrics[<span class="st">'cum_responses'</span>] <span class="op">/</span> df_metrics[<span class="st">'cum_prospects'</span>]</span>
<span id="cb66-30"><a href="#cb66-30"></a></span>
<span id="cb66-31"><a href="#cb66-31"></a><span class="co"># Calculate baseline</span></span>
<span id="cb66-32"><a href="#cb66-32"></a>base_rate <span class="op">=</span> np.mean(y_campaign2)</span>
<span id="cb66-33"><a href="#cb66-33"></a>total_responses <span class="op">=</span> df_metrics[<span class="st">'responses'</span>].<span class="bu">sum</span>()</span>
<span id="cb66-34"><a href="#cb66-34"></a></span>
<span id="cb66-35"><a href="#cb66-35"></a><span class="co"># Calculate gain and lift</span></span>
<span id="cb66-36"><a href="#cb66-36"></a>df_metrics[<span class="st">'gain'</span>] <span class="op">=</span> df_metrics[<span class="st">'cum_responses'</span>] <span class="op">/</span> total_responses</span>
<span id="cb66-37"><a href="#cb66-37"></a>df_metrics[<span class="st">'lift'</span>] <span class="op">=</span> df_metrics[<span class="st">'cum_response_rate'</span>] <span class="op">/</span> base_rate</span>
<span id="cb66-38"><a href="#cb66-38"></a></span>
<span id="cb66-39"><a href="#cb66-39"></a><span class="co"># Reorder columns in a more intuitive order</span></span>
<span id="cb66-40"><a href="#cb66-40"></a>column_order <span class="op">=</span> [<span class="st">'bin_name'</span>, <span class="st">'avg_score'</span>,</span>
<span id="cb66-41"><a href="#cb66-41"></a>                <span class="st">'prospects'</span>, <span class="st">'exp_responses'</span>, <span class="st">'responses'</span>, <span class="st">'response_rate'</span>,</span>
<span id="cb66-42"><a href="#cb66-42"></a>                <span class="st">'cum_prospects'</span>, <span class="st">'cum_responses'</span>, <span class="st">'cum_response_rate'</span>,</span>
<span id="cb66-43"><a href="#cb66-43"></a>                <span class="st">'gain'</span>, <span class="st">'lift'</span>]</span>
<span id="cb66-44"><a href="#cb66-44"></a>df_metrics <span class="op">=</span> df_metrics[column_order]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="44">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1"></a>display(df_metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-metrics" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="44">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-metrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;9: Gain and Lift Table
</figcaption>
<div aria-describedby="tbl-metrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">bin_name</th>
<th data-quarto-table-cell-role="th">avg_score</th>
<th data-quarto-table-cell-role="th">prospects</th>
<th data-quarto-table-cell-role="th">exp_responses</th>
<th data-quarto-table-cell-role="th">responses</th>
<th data-quarto-table-cell-role="th">response_rate</th>
<th data-quarto-table-cell-role="th">cum_prospects</th>
<th data-quarto-table-cell-role="th">cum_responses</th>
<th data-quarto-table-cell-role="th">cum_response_rate</th>
<th data-quarto-table-cell-role="th">gain</th>
<th data-quarto-table-cell-role="th">lift</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>(0.052449, 0.99943]</td>
<td>0.159665</td>
<td>19191</td>
<td>3064.129188</td>
<td>3004.0</td>
<td>0.156532</td>
<td>19191</td>
<td>3004.0</td>
<td>0.156532</td>
<td>0.539705</td>
<td>2.700186</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>(0.032145, 0.052449]</td>
<td>0.038514</td>
<td>19010</td>
<td>732.157133</td>
<td>760.0</td>
<td>0.039979</td>
<td>38201</td>
<td>3764.0</td>
<td>0.098531</td>
<td>0.676249</td>
<td>1.699676</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>(0.029581, 0.032145]</td>
<td>0.031843</td>
<td>7470</td>
<td>237.866126</td>
<td>277.0</td>
<td>0.037082</td>
<td>45671</td>
<td>4041.0</td>
<td>0.088481</td>
<td>0.726015</td>
<td>1.526299</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>(0.029419, 0.029581]</td>
<td>0.029581</td>
<td>20349</td>
<td>601.939054</td>
<td>628.0</td>
<td>0.030861</td>
<td>66020</td>
<td>4669.0</td>
<td>0.070721</td>
<td>0.838843</td>
<td>1.219943</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>(0.029202, 0.029419]</td>
<td>0.029349</td>
<td>29994</td>
<td>880.279606</td>
<td>897.0</td>
<td>0.029906</td>
<td>96014</td>
<td>5566.0</td>
<td>0.057971</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<section id="qa-2" class="level2" data-number="15.1">
<h2 data-number="15.1" class="anchored" data-anchor-id="qa-2"><span class="header-section-number">15.1</span> Q&amp;A</h2>
<section id="question-8" class="level3" data-number="15.1.1">
<h3 data-number="15.1.1" class="anchored" data-anchor-id="question-8"><span class="header-section-number">15.1.1</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the first bin, how were the <code>19,197</code> prospects selected?</p>
</div>
</div>
</section>
<section id="question-9" class="level3" data-number="15.1.2">
<h3 data-number="15.1.2" class="anchored" data-anchor-id="question-9"><span class="header-section-number">15.1.2</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the first bin, <code>19,197</code> prospects were sent direct mail.</p>
<p>In the first bin, we expected _____ responses. The actual number of responses was _____.</p>
</div>
</div>
</section>
<section id="question-10" class="level3" data-number="15.1.3">
<h3 data-number="15.1.3" class="anchored" data-anchor-id="question-10"><span class="header-section-number">15.1.3</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Instead of using your model to select <code>19,197</code> prospects, suppose you randomly selected <code>19,197</code> prospects. How many of them would you expect to respond?</p>
</div>
</div>
</section>
<section id="question-11" class="level3" data-number="15.1.4">
<h3 data-number="15.1.4" class="anchored" data-anchor-id="question-11"><span class="header-section-number">15.1.4</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Compare the following two campaign strategies:</p>
<ol type="1">
<li><p>Select <code>19,197</code> prospects based on the highest model scores. The actual number of responses is <code>a</code>.</p></li>
<li><p>Randomly select <code>19,197</code> prospects. The expected number of responses is <code>b</code>.</p></li>
</ol>
<p>The ratio <span class="math inline">\(\frac{a}{b}\)</span> is ______. The value corresponds to the ______ in the first bin.</p>
</div>
</div>
</section>
<section id="question-12" class="level3" data-number="15.1.5">
<h3 data-number="15.1.5" class="anchored" data-anchor-id="question-12"><span class="header-section-number">15.1.5</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose the average cost of sending direct mail is $7.00 per prospect and the average revenue from a response is $100 per client.</p>
<p>The ROI of randomly selecting <code>19,197</code> prospects is: ____.</p>
<p>The ROI of selecting <code>19,197</code> prospects based on the highest model scores is: ____.</p>
</div>
</div>
</section>
<section id="question-13" class="level3" data-number="15.1.6">
<h3 data-number="15.1.6" class="anchored" data-anchor-id="question-13"><span class="header-section-number">15.1.6</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Compare the following two campaign strategies:</p>
<ol type="1">
<li><p>Select <code>38,225</code> prospects based on the highest model scores. The actual number of responses is <code>a</code>.</p></li>
<li><p>Randomly select <code>38,225</code> prospects. The expected number of responses is <code>b</code>.</p></li>
</ol>
<p>The ratio <span class="math inline">\(\frac{a}{b}\)</span> is _____. The value corresponds to the _____ in the _____ bin.</p>
</div>
</div>
</section>
<section id="question-14" class="level3" data-number="15.1.7">
<h3 data-number="15.1.7" class="anchored" data-anchor-id="question-14"><span class="header-section-number">15.1.7</span> Question</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose the average cost of sending direct mail is $7.00 per prospect and the average revenue from a response is $100 per client.</p>
<p>The ROI of randomly selecting <code>38,225</code> prospects is: ____.</p>
<p>The ROI of selecting <code>38,225</code> prospects based on the highest model scores is: ____.</p>
</div>
</div>
</section>
</section>
<section id="gain-and-lift-plots" class="level2" data-number="15.2">
<h2 data-number="15.2" class="anchored" data-anchor-id="gain-and-lift-plots"><span class="header-section-number">15.2</span> Gain and Lift Plots</h2>
<div id="d257047c" class="cell" data-execution_count="45">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb68-2"><a href="#cb68-2"></a>plt.plot([<span class="dv">0</span>] <span class="op">+</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df_metrics) <span class="op">+</span> <span class="dv">1</span>)), [<span class="dv">0</span>] <span class="op">+</span> <span class="bu">list</span>(df_metrics[<span class="st">'gain'</span>]), marker<span class="op">=</span><span class="st">'o'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb68-3"><a href="#cb68-3"></a>plt.plot([<span class="dv">0</span>, <span class="bu">len</span>(df_metrics)], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'--'</span>, color<span class="op">=</span><span class="st">'gray'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb68-4"><a href="#cb68-4"></a>plt.xlabel(<span class="st">'Bin (Highest to Lowest Probability)'</span>)</span>
<span id="cb68-5"><a href="#cb68-5"></a>plt.ylabel(<span class="st">'Gain'</span>)</span>
<span id="cb68-6"><a href="#cb68-6"></a>plt.title(<span class="st">'Gain Chart'</span>)</span>
<span id="cb68-7"><a href="#cb68-7"></a>plt.xticks(<span class="bu">range</span>(<span class="bu">len</span>(df_metrics) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb68-8"><a href="#cb68-8"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb68-9"><a href="#cb68-9"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-46-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="94aab32d" class="cell" data-execution_count="46">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb69-2"><a href="#cb69-2"></a>plt.plot(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df_metrics) <span class="op">+</span> <span class="dv">1</span>), df_metrics[<span class="st">'lift'</span>], marker<span class="op">=</span><span class="st">'o'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb69-3"><a href="#cb69-3"></a>plt.axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb69-4"><a href="#cb69-4"></a>plt.xlabel(<span class="st">'Bin (Highest to Lowest Probability)'</span>)</span>
<span id="cb69-5"><a href="#cb69-5"></a>plt.ylabel(<span class="st">'Lift'</span>)</span>
<span id="cb69-6"><a href="#cb69-6"></a>plt.title(<span class="st">'Lift Chart'</span>)</span>
<span id="cb69-7"><a href="#cb69-7"></a>plt.xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df_metrics) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb69-8"><a href="#cb69-8"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb69-9"><a href="#cb69-9"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-47-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="gain-and-lift-plots-automated" class="level2" data-number="15.3">
<h2 data-number="15.3" class="anchored" data-anchor-id="gain-and-lift-plots-automated"><span class="header-section-number">15.3</span> Gain and Lift Plots (Automated)</h2>
<div id="3cab2df8" class="cell" data-execution_count="47">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1"></a><span class="co"># Get probability predictions</span></span>
<span id="cb70-2"><a href="#cb70-2"></a>y_probas <span class="op">=</span> ag_model.predict_proba(X_campaign2)</span>
<span id="cb70-3"><a href="#cb70-3"></a></span>
<span id="cb70-4"><a href="#cb70-4"></a><span class="co"># Create cumulative gain plot</span></span>
<span id="cb70-5"><a href="#cb70-5"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb70-6"><a href="#cb70-6"></a></span>
<span id="cb70-7"><a href="#cb70-7"></a>plot_cumulative_gain(y_campaign2, y_probas)</span>
<span id="cb70-8"><a href="#cb70-8"></a></span>
<span id="cb70-9"><a href="#cb70-9"></a>plt.title(<span class="st">'Cumulative Gains Plot - Campaign 2'</span>)</span>
<span id="cb70-10"><a href="#cb70-10"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb70-11"><a href="#cb70-11"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 768x576 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-48-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1075e6e2" class="cell" data-execution_count="48">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1"></a><span class="co"># Create lift curve plot</span></span>
<span id="cb72-2"><a href="#cb72-2"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb72-3"><a href="#cb72-3"></a></span>
<span id="cb72-4"><a href="#cb72-4"></a>plot_lift_curve(y_campaign2, y_probas)</span>
<span id="cb72-5"><a href="#cb72-5"></a></span>
<span id="cb72-6"><a href="#cb72-6"></a>plt.title(<span class="st">'Lift Curve - Campaign 2'</span>)</span>
<span id="cb72-7"><a href="#cb72-7"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb72-8"><a href="#cb72-8"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 768x576 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Lab%2001_files/figure-html/cell-49-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="pick-a-threshold-to-maximize-f1-score" class="level1" data-number="16">
<h1 data-number="16"><span class="header-section-number">16</span> Pick a Threshold to Maximize F1 Score</h1>
<p>In campaign 3, we have a limited campaign budget. We want to maximize the number of responses while minimizing the number of prospects who are sent direct mail.</p>
<p>One approach is to select a threshold that maximizes the F1 score.</p>
<p>First, we check the F1 score for the default threshold of <code>0.5</code>.</p>
<div id="e3e0e884" class="cell" data-execution_count="49">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1"></a>df_leaders_f1 <span class="op">=</span> (ag_model</span>
<span id="cb74-2"><a href="#cb74-2"></a>            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb74-3"><a href="#cb74-3"></a>            .predictor</span>
<span id="cb74-4"><a href="#cb74-4"></a>            .leaderboard(</span>
<span id="cb74-5"><a href="#cb74-5"></a>                test_data, </span>
<span id="cb74-6"><a href="#cb74-6"></a>                extra_metrics<span class="op">=</span>[<span class="st">'f1'</span>, <span class="st">'precision'</span>, <span class="st">'recall'</span>])</span>
<span id="cb74-7"><a href="#cb74-7"></a>            )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\chiuw\miniforge3\envs\env_iml4finance_2026\Lib\site-packages\fastai\learner.py:455: UserWarning:

load_learner` uses Python's insecure pickle module, which can execute malicious arbitrary code when loading. Only load files you trust.
If you only need to load model weights and optimizer state, use the safe `Learner.load` instead.
</code></pre>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="50">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1"></a>display(df_leaders_f1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-ag-leaderboard-f1" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="50">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ag-leaderboard-f1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;10: Autogluon Leaderboard with F1 Score (Threshold = 0.5)
</figcaption>
<div aria-describedby="tbl-ag-leaderboard-f1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">score_test</th>
<th data-quarto-table-cell-role="th">f1</th>
<th data-quarto-table-cell-role="th">precision</th>
<th data-quarto-table-cell-role="th">recall</th>
<th data-quarto-table-cell-role="th">score_val</th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">pred_time_test</th>
<th data-quarto-table-cell-role="th">pred_time_val</th>
<th data-quarto-table-cell-role="th">fit_time</th>
<th data-quarto-table-cell-role="th">pred_time_test_marginal</th>
<th data-quarto-table-cell-role="th">pred_time_val_marginal</th>
<th data-quarto-table-cell-role="th">fit_time_marginal</th>
<th data-quarto-table-cell-role="th">stack_level</th>
<th data-quarto-table-cell-role="th">can_infer</th>
<th data-quarto-table-cell-role="th">fit_order</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>WeightedEnsemble_L2</td>
<td>0.720141</td>
<td>0.229322</td>
<td>0.773241</td>
<td>0.134624</td>
<td>0.719659</td>
<td>roc_auc</td>
<td>0.515219</td>
<td>0.180214</td>
<td>157.236423</td>
<td>0.004000</td>
<td>0.002999</td>
<td>0.717124</td>
<td>2</td>
<td>True</td>
<td>11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>CatBoost</td>
<td>0.719936</td>
<td>0.230057</td>
<td>0.770026</td>
<td>0.135229</td>
<td>0.718538</td>
<td>roc_auc</td>
<td>0.039025</td>
<td>0.008000</td>
<td>20.686615</td>
<td>0.039025</td>
<td>0.008000</td>
<td>20.686615</td>
<td>1</td>
<td>True</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>LightGBM</td>
<td>0.719203</td>
<td>0.235309</td>
<td>0.765833</td>
<td>0.139011</td>
<td>0.718404</td>
<td>roc_auc</td>
<td>0.058045</td>
<td>0.031034</td>
<td>0.725682</td>
<td>0.058045</td>
<td>0.031034</td>
<td>0.725682</td>
<td>1</td>
<td>True</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>NeuralNetTorch</td>
<td>0.718158</td>
<td>0.219614</td>
<td>0.796594</td>
<td>0.127363</td>
<td>0.718287</td>
<td>roc_auc</td>
<td>0.414149</td>
<td>0.138180</td>
<td>135.107002</td>
<td>0.414149</td>
<td>0.138180</td>
<td>135.107002</td>
<td>1</td>
<td>True</td>
<td>10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>NeuralNetFastAI</td>
<td>0.718123</td>
<td>0.222885</td>
<td>0.783045</td>
<td>0.129935</td>
<td>0.717316</td>
<td>roc_auc</td>
<td>0.569336</td>
<td>0.224352</td>
<td>82.045661</td>
<td>0.569336</td>
<td>0.224352</td>
<td>82.045661</td>
<td>1</td>
<td>True</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>XGBoost</td>
<td>0.717188</td>
<td>0.233231</td>
<td>0.758535</td>
<td>0.137801</td>
<td>0.717808</td>
<td>roc_auc</td>
<td>0.292733</td>
<td>0.050536</td>
<td>5.088922</td>
<td>0.292733</td>
<td>0.050536</td>
<td>5.088922</td>
<td>1</td>
<td>True</td>
<td>9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>LightGBMXT</td>
<td>0.717089</td>
<td>0.240102</td>
<td>0.758039</td>
<td>0.142641</td>
<td>0.717234</td>
<td>roc_auc</td>
<td>0.219711</td>
<td>0.114115</td>
<td>1.768851</td>
<td>0.219711</td>
<td>0.114115</td>
<td>1.768851</td>
<td>1</td>
<td>True</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>ExtraTreesGini</td>
<td>0.659221</td>
<td>0.237948</td>
<td>0.643333</td>
<td>0.145969</td>
<td>0.671457</td>
<td>roc_auc</td>
<td>0.412745</td>
<td>0.137069</td>
<td>3.968272</td>
<td>0.412745</td>
<td>0.137069</td>
<td>3.968272</td>
<td>1</td>
<td>True</td>
<td>6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>ExtraTreesEntr</td>
<td>0.659023</td>
<td>0.237108</td>
<td>0.642809</td>
<td>0.145364</td>
<td>0.671624</td>
<td>roc_auc</td>
<td>0.447843</td>
<td>0.142047</td>
<td>3.836026</td>
<td>0.447843</td>
<td>0.142047</td>
<td>3.836026</td>
<td>1</td>
<td>True</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>RandomForestEntr</td>
<td>0.658832</td>
<td>0.237948</td>
<td>0.643333</td>
<td>0.145969</td>
<td>0.671214</td>
<td>roc_auc</td>
<td>0.405392</td>
<td>0.154675</td>
<td>6.448632</td>
<td>0.405392</td>
<td>0.154675</td>
<td>6.448632</td>
<td>1</td>
<td>True</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>RandomForestGini</td>
<td>0.658697</td>
<td>0.237948</td>
<td>0.643333</td>
<td>0.145969</td>
<td>0.671330</td>
<td>roc_auc</td>
<td>0.451752</td>
<td>0.157521</td>
<td>6.875059</td>
<td>0.451752</td>
<td>0.157521</td>
<td>6.875059</td>
<td>1</td>
<td>True</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>In order to avoid overfitting, we will use <code>df_campaign_2</code> to select the threshold that maximizes the F1 score.</p>
<div id="fbdd19ec" class="cell" data-execution_count="51">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1"></a>best_threshold <span class="op">=</span> (ag_model</span>
<span id="cb77-2"><a href="#cb77-2"></a>                .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb77-3"><a href="#cb77-3"></a>                .predictor</span>
<span id="cb77-4"><a href="#cb77-4"></a>                .calibrate_decision_threshold(</span>
<span id="cb77-5"><a href="#cb77-5"></a>                data <span class="op">=</span> df_campaign_2,</span>
<span id="cb77-6"><a href="#cb77-6"></a>                metric <span class="op">=</span> <span class="st">'f1'</span>,</span>
<span id="cb77-7"><a href="#cb77-7"></a>                decision_thresholds <span class="op">=</span> <span class="dv">100</span>)</span>
<span id="cb77-8"><a href="#cb77-8"></a>                )</span>
<span id="cb77-9"><a href="#cb77-9"></a></span>
<span id="cb77-10"><a href="#cb77-10"></a>ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.set_decision_threshold(best_threshold)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Calibrating decision threshold to optimize metric f1 | Checking 201 thresholds...
Calibrating decision threshold via fine-grained search | Checking 38 thresholds...
    Base Threshold: 0.500   | val: 0.2374
    Best Threshold: 0.173   | val: 0.3367
Updating predictor.decision_threshold from 0.5 -&gt; 0.173
    This will impact how prediction probabilities are converted to predictions in binary classification.
    Prediction probabilities of the positive class &gt;0.173 will be predicted as the positive class (1). This can significantly impact metric scores.
    You can update this value via `predictor.set_decision_threshold`.
    You can calculate an optimal decision threshold on the validation data via `predictor.calibrate_decision_threshold()`.</code></pre>
</div>
</div>
<p>Finally, we check the F1 score for the new threshold.</p>
<div id="27e13c9b" class="cell" data-execution_count="52">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1"></a>df_leaders_f1_best <span class="op">=</span> (ag_model</span>
<span id="cb79-2"><a href="#cb79-2"></a>            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb79-3"><a href="#cb79-3"></a>            .predictor</span>
<span id="cb79-4"><a href="#cb79-4"></a>            .leaderboard(</span>
<span id="cb79-5"><a href="#cb79-5"></a>                test_data, </span>
<span id="cb79-6"><a href="#cb79-6"></a>                extra_metrics<span class="op">=</span>[<span class="st">'f1'</span>, <span class="st">'precision'</span>, <span class="st">'recall'</span>])</span>
<span id="cb79-7"><a href="#cb79-7"></a>            )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\chiuw\miniforge3\envs\env_iml4finance_2026\Lib\site-packages\fastai\learner.py:455: UserWarning:

load_learner` uses Python's insecure pickle module, which can execute malicious arbitrary code when loading. Only load files you trust.
If you only need to load model weights and optimizer state, use the safe `Learner.load` instead.
</code></pre>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="53">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1"></a>display(df_leaders_f1_best)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-ag-leaderboard-f1-best" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="53">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ag-leaderboard-f1-best-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;11: Autogluon Leaderboard with F1 Score (Best Threshold)
</figcaption>
<div aria-describedby="tbl-ag-leaderboard-f1-best-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">score_test</th>
<th data-quarto-table-cell-role="th">f1</th>
<th data-quarto-table-cell-role="th">precision</th>
<th data-quarto-table-cell-role="th">recall</th>
<th data-quarto-table-cell-role="th">score_val</th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">pred_time_test</th>
<th data-quarto-table-cell-role="th">pred_time_val</th>
<th data-quarto-table-cell-role="th">fit_time</th>
<th data-quarto-table-cell-role="th">pred_time_test_marginal</th>
<th data-quarto-table-cell-role="th">pred_time_val_marginal</th>
<th data-quarto-table-cell-role="th">fit_time_marginal</th>
<th data-quarto-table-cell-role="th">stack_level</th>
<th data-quarto-table-cell-role="th">can_infer</th>
<th data-quarto-table-cell-role="th">fit_order</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>WeightedEnsemble_L2</td>
<td>0.720141</td>
<td>0.332032</td>
<td>0.389454</td>
<td>0.289366</td>
<td>0.719659</td>
<td>roc_auc</td>
<td>0.573195</td>
<td>0.180214</td>
<td>157.236423</td>
<td>0.003001</td>
<td>0.002999</td>
<td>0.717124</td>
<td>2</td>
<td>True</td>
<td>11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>CatBoost</td>
<td>0.719936</td>
<td>0.331261</td>
<td>0.385993</td>
<td>0.290123</td>
<td>0.718538</td>
<td>roc_auc</td>
<td>0.078235</td>
<td>0.008000</td>
<td>20.686615</td>
<td>0.078235</td>
<td>0.008000</td>
<td>20.686615</td>
<td>1</td>
<td>True</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>LightGBM</td>
<td>0.719203</td>
<td>0.331743</td>
<td>0.388934</td>
<td>0.289215</td>
<td>0.718404</td>
<td>roc_auc</td>
<td>0.062055</td>
<td>0.031034</td>
<td>0.725682</td>
<td>0.062055</td>
<td>0.031034</td>
<td>0.725682</td>
<td>1</td>
<td>True</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>NeuralNetTorch</td>
<td>0.718158</td>
<td>0.326689</td>
<td>0.391792</td>
<td>0.280139</td>
<td>0.718287</td>
<td>roc_auc</td>
<td>0.429904</td>
<td>0.138180</td>
<td>135.107002</td>
<td>0.429904</td>
<td>0.138180</td>
<td>135.107002</td>
<td>1</td>
<td>True</td>
<td>10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>NeuralNetFastAI</td>
<td>0.718123</td>
<td>0.332283</td>
<td>0.394349</td>
<td>0.287097</td>
<td>0.717316</td>
<td>roc_auc</td>
<td>0.617984</td>
<td>0.224352</td>
<td>82.045661</td>
<td>0.617984</td>
<td>0.224352</td>
<td>82.045661</td>
<td>1</td>
<td>True</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>XGBoost</td>
<td>0.717188</td>
<td>0.330271</td>
<td>0.382002</td>
<td>0.290879</td>
<td>0.717808</td>
<td>roc_auc</td>
<td>0.098609</td>
<td>0.050536</td>
<td>5.088922</td>
<td>0.098609</td>
<td>0.050536</td>
<td>5.088922</td>
<td>1</td>
<td>True</td>
<td>9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>LightGBMXT</td>
<td>0.717089</td>
<td>0.331004</td>
<td>0.385295</td>
<td>0.290123</td>
<td>0.717234</td>
<td>roc_auc</td>
<td>0.206491</td>
<td>0.114115</td>
<td>1.768851</td>
<td>0.206491</td>
<td>0.114115</td>
<td>1.768851</td>
<td>1</td>
<td>True</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>ExtraTreesGini</td>
<td>0.659221</td>
<td>0.281903</td>
<td>0.270714</td>
<td>0.294055</td>
<td>0.671457</td>
<td>roc_auc</td>
<td>0.437138</td>
<td>0.137069</td>
<td>3.968272</td>
<td>0.437138</td>
<td>0.137069</td>
<td>3.968272</td>
<td>1</td>
<td>True</td>
<td>6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>ExtraTreesEntr</td>
<td>0.659023</td>
<td>0.281800</td>
<td>0.270526</td>
<td>0.294055</td>
<td>0.671624</td>
<td>roc_auc</td>
<td>0.431545</td>
<td>0.142047</td>
<td>3.836026</td>
<td>0.431545</td>
<td>0.142047</td>
<td>3.836026</td>
<td>1</td>
<td>True</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>RandomForestEntr</td>
<td>0.658832</td>
<td>0.282029</td>
<td>0.270691</td>
<td>0.294358</td>
<td>0.671214</td>
<td>roc_auc</td>
<td>0.449001</td>
<td>0.154675</td>
<td>6.448632</td>
<td>0.449001</td>
<td>0.154675</td>
<td>6.448632</td>
<td>1</td>
<td>True</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>RandomForestGini</td>
<td>0.658697</td>
<td>0.282029</td>
<td>0.270691</td>
<td>0.294358</td>
<td>0.671330</td>
<td>roc_auc</td>
<td>0.469581</td>
<td>0.157521</td>
<td>6.875059</td>
<td>0.469581</td>
<td>0.157521</td>
<td>6.875059</td>
<td>1</td>
<td>True</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="select-targets" class="level1" data-number="17">
<h1 data-number="17"><span class="header-section-number">17</span> Select Targets</h1>
<p>We randomly select <code>1,000</code> prospects as a control group. We will send direct mail to everyone in the control group. The control group gives us a baseline response rate.</p>
<div id="8c69bda2" class="cell" data-execution_count="54">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1"></a><span class="co"># Randomly select 1000 prospects for control group</span></span>
<span id="cb82-2"><a href="#cb82-2"></a>df_campaign_3_control_group <span class="op">=</span> df_campaign_3.sample(n<span class="op">=</span><span class="dv">1000</span>, random_state<span class="op">=</span><span class="dv">2025</span>)</span>
<span id="cb82-3"><a href="#cb82-3"></a></span>
<span id="cb82-4"><a href="#cb82-4"></a>df_campaign_3_control_group[<span class="st">'group_type'</span>] <span class="op">=</span> <span class="st">'control'</span></span>
<span id="cb82-5"><a href="#cb82-5"></a>df_campaign_3_control_group[<span class="st">'direct_mail_flag'</span>] <span class="op">=</span> <span class="st">'Y'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Create <code>df_campaign_3_treatment</code> by removing the control group from <code>df_campaign_3</code>.</p>
<div id="66043247" class="cell" data-execution_count="55">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1"></a>df_campaign_3_treatment <span class="op">=</span> df_campaign_3.drop(df_campaign_3_control_group.index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then, we send direct mail to all the prospects in <code>df_campaign_3_treatment</code> that exceed the best threshold. We are assuming that the prospects in <code>df_campaign_3_treatment</code> meet the other campaign selection criteria that were determined by the risk, strategy, and legal teams.</p>
<div id="f8ed600f" class="cell" data-execution_count="56">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1"></a>X_campaign3 <span class="op">=</span> df_campaign_3_treatment[subset_cols].copy()</span>
<span id="cb84-2"><a href="#cb84-2"></a>X_campaign3[<span class="st">'last_prod_enq2'</span>] <span class="op">=</span> X_campaign3[<span class="st">'last_prod_enq2'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb84-3"><a href="#cb84-3"></a></span>
<span id="cb84-4"><a href="#cb84-4"></a>preds <span class="op">=</span> ag_model.predict(X_campaign3.drop(columns<span class="op">=</span>[label]))</span>
<span id="cb84-5"><a href="#cb84-5"></a></span>
<span id="cb84-6"><a href="#cb84-6"></a>df_campaign_3_treatment[<span class="st">'direct_mail_flag'</span>] <span class="op">=</span> np.where(preds <span class="op">==</span> <span class="dv">1</span>, <span class="st">'Y'</span>, <span class="st">'N'</span>)</span>
<span id="cb84-7"><a href="#cb84-7"></a></span>
<span id="cb84-8"><a href="#cb84-8"></a><span class="co"># Filter to only keep prospects that will receive direct mail</span></span>
<span id="cb84-9"><a href="#cb84-9"></a>df_campaign_3_treatment_mail <span class="op">=</span> df_campaign_3_treatment[df_campaign_3_treatment[<span class="st">'direct_mail_flag'</span>] <span class="op">==</span> <span class="st">'Y'</span>].copy()</span>
<span id="cb84-10"><a href="#cb84-10"></a></span>
<span id="cb84-11"><a href="#cb84-11"></a>df_campaign_3_treatment_mail[<span class="st">'group_type'</span>] <span class="op">=</span> <span class="st">'treatment'</span></span>
<span id="cb84-12"><a href="#cb84-12"></a></span>
<span id="cb84-13"><a href="#cb84-13"></a><span class="co"># Append rows from controls and treatment into a single data frame</span></span>
<span id="cb84-14"><a href="#cb84-14"></a>keep_cols <span class="op">=</span> [<span class="st">'PROSPECTID'</span>, <span class="st">'campaign_id'</span>, <span class="st">'group_type'</span>, <span class="st">'direct_mail_flag'</span>]    </span>
<span id="cb84-15"><a href="#cb84-15"></a></span>
<span id="cb84-16"><a href="#cb84-16"></a>df_campaign_3_selected <span class="op">=</span> (pd.concat([</span>
<span id="cb84-17"><a href="#cb84-17"></a>        df_campaign_3_control_group[keep_cols], </span>
<span id="cb84-18"><a href="#cb84-18"></a>        df_campaign_3_treatment_mail[keep_cols]</span>
<span id="cb84-19"><a href="#cb84-19"></a>        ],</span>
<span id="cb84-20"><a href="#cb84-20"></a>    ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb84-21"><a href="#cb84-21"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="measure-campaign-effectiveness" class="level1" data-number="18">
<h1 data-number="18"><span class="header-section-number">18</span> Measure Campaign Effectiveness</h1>
<p>The file <code>campaign_eval.parquet</code> contains the results of the campaign. We will join the data set with df_campaign_3_selected to measure the effectiveness of the campaign.</p>
<div id="b1d02aa7" class="cell" data-execution_count="57">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1"></a>df_campaign_eval <span class="op">=</span> duckdb.query(<span class="st">"""</span></span>
<span id="cb85-2"><a href="#cb85-2"></a><span class="st">    SELECT SELECTED.*, EVAL.response_flag</span></span>
<span id="cb85-3"><a href="#cb85-3"></a><span class="st">    FROM read_parquet('../Data/cibil/campaign_eval.parquet') AS EVAL</span></span>
<span id="cb85-4"><a href="#cb85-4"></a><span class="st">    INNER JOIN df_campaign_3_selected AS SELECTED</span></span>
<span id="cb85-5"><a href="#cb85-5"></a><span class="st">    ON EVAL.PROSPECTID = SELECTED.PROSPECTID</span></span>
<span id="cb85-6"><a href="#cb85-6"></a><span class="st">    ORDER BY SELECTED.group_type, SELECTED.PROSPECTID</span></span>
<span id="cb85-7"><a href="#cb85-7"></a><span class="st">"""</span>).to_df()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="58">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1"></a>df_campaign_eval.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-campaign-top5-eval" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="58">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-campaign-top5-eval-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12: First 5 rows of df_campaign_eval
</figcaption>
<div aria-describedby="tbl-campaign-top5-eval-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="58">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PROSPECTID</th>
<th data-quarto-table-cell-role="th">campaign_id</th>
<th data-quarto-table-cell-role="th">group_type</th>
<th data-quarto-table-cell-role="th">direct_mail_flag</th>
<th data-quarto-table-cell-role="th">response_flag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>100499</td>
<td>3</td>
<td>control</td>
<td>Y</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>100766</td>
<td>3</td>
<td>control</td>
<td>Y</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>101075</td>
<td>3</td>
<td>control</td>
<td>Y</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>101324</td>
<td>3</td>
<td>control</td>
<td>Y</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>102182</td>
<td>3</td>
<td>control</td>
<td>Y</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>Summarize the results.</p>
<div id="82ef4e24" class="cell" data-execution_count="59">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1"></a>df_eval_agg <span class="op">=</span> (df_campaign_eval</span>
<span id="cb87-2"><a href="#cb87-2"></a>    .groupby([<span class="st">'group_type'</span>, <span class="st">'direct_mail_flag'</span>])</span>
<span id="cb87-3"><a href="#cb87-3"></a>    .agg({</span>
<span id="cb87-4"><a href="#cb87-4"></a>        <span class="st">'response_flag'</span>: [<span class="st">'count'</span>, <span class="st">'sum'</span>, <span class="st">'mean'</span>]</span>
<span id="cb87-5"><a href="#cb87-5"></a>    })</span>
<span id="cb87-6"><a href="#cb87-6"></a>    .reset_index()</span>
<span id="cb87-7"><a href="#cb87-7"></a>)</span>
<span id="cb87-8"><a href="#cb87-8"></a></span>
<span id="cb87-9"><a href="#cb87-9"></a>df_eval_agg.columns <span class="op">=</span> [<span class="st">'group_type'</span>, <span class="st">'direct_mail_flag'</span>, <span class="st">'prospects'</span>, <span class="st">'responses'</span>, <span class="st">'response_rate'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="60">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1"></a>display(df_eval_agg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-campaign-agg" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="60">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-campaign-agg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13: Campaign Effectiveness
</figcaption>
<div aria-describedby="tbl-campaign-agg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">group_type</th>
<th data-quarto-table-cell-role="th">direct_mail_flag</th>
<th data-quarto-table-cell-role="th">prospects</th>
<th data-quarto-table-cell-role="th">responses</th>
<th data-quarto-table-cell-role="th">response_rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>control</td>
<td>Y</td>
<td>1000</td>
<td>49</td>
<td>0.049000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>treatment</td>
<td>Y</td>
<td>4144</td>
<td>1594</td>
<td>0.384653</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="measure-campaign-roi" class="level1" data-number="19">
<h1 data-number="19"><span class="header-section-number">19</span> Measure Campaign ROI</h1>
<p>The treatment group has a much higher response rate than the control group. The ROI of the treatment group is also much higher than the ROI of the control group.</p>
<p>The ROI calculation is based on the following assumptions:</p>
<ul>
<li>The average cost depends on whether the prospect was sent direct mail:
<ul>
<li>Each prospect (regardless of whether they were sent direct mail) costs $1.00.</li>
<li>Each prospect that was sent direct mail incurs an <em>additional</em> $6.00 cost.</li>
</ul></li>
<li>The average revenue from a response is $100.00.</li>
</ul>
<p>In prior campaigns, the average cost was $7.00 per prospect because <em>all</em> prospects were sent direct mail. In this campaign, we are sending direct mail to only a subset of prospects.</p>
<div id="cb5b265f" class="cell" data-execution_count="61">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1"></a><span class="kw">def</span> calc_ROI(num_mailed, </span>
<span id="cb89-2"><a href="#cb89-2"></a>            num_responded, </span>
<span id="cb89-3"><a href="#cb89-3"></a>            avg_mail_cost, </span>
<span id="cb89-4"><a href="#cb89-4"></a>            avg_revenue, </span>
<span id="cb89-5"><a href="#cb89-5"></a>            num_prospects, </span>
<span id="cb89-6"><a href="#cb89-6"></a>            avg_prospect_cost):</span>
<span id="cb89-7"><a href="#cb89-7"></a>    total_cost <span class="op">=</span> (num_mailed <span class="op">*</span> avg_mail_cost) <span class="op">+</span> (num_prospects <span class="op">*</span> avg_prospect_cost)</span>
<span id="cb89-8"><a href="#cb89-8"></a>    total_revenue <span class="op">=</span> num_responded <span class="op">*</span> avg_revenue</span>
<span id="cb89-9"><a href="#cb89-9"></a>    roi <span class="op">=</span> (total_revenue <span class="op">-</span> total_cost) <span class="op">/</span> total_cost <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb89-10"><a href="#cb89-10"></a>    <span class="cf">return</span> roi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="b51ede0c" class="cell" data-execution_count="62">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1"></a>roi_control <span class="op">=</span> calc_ROI(num_mailed <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb90-2"><a href="#cb90-2"></a>                        num_responded <span class="op">=</span> <span class="dv">49</span>, </span>
<span id="cb90-3"><a href="#cb90-3"></a>                        avg_mail_cost <span class="op">=</span> <span class="dv">6</span>,</span>
<span id="cb90-4"><a href="#cb90-4"></a>                        avg_revenue <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb90-5"><a href="#cb90-5"></a>                        num_prospects <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb90-6"><a href="#cb90-6"></a>                        avg_prospect_cost <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb90-7"><a href="#cb90-7"></a></span>
<span id="cb90-8"><a href="#cb90-8"></a>roi_treatment <span class="op">=</span> calc_ROI(num_mailed <span class="op">=</span> <span class="dv">4338</span>,</span>
<span id="cb90-9"><a href="#cb90-9"></a>                        num_responded <span class="op">=</span> <span class="dv">1625</span>, </span>
<span id="cb90-10"><a href="#cb90-10"></a>                        avg_mail_cost <span class="op">=</span> <span class="dv">6</span>,</span>
<span id="cb90-11"><a href="#cb90-11"></a>                        avg_revenue <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb90-12"><a href="#cb90-12"></a>                        num_prospects <span class="op">=</span> <span class="dv">95889</span> <span class="op">-</span> <span class="dv">1000</span>,</span>
<span id="cb90-13"><a href="#cb90-13"></a>                        avg_prospect_cost <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb90-14"><a href="#cb90-14"></a></span>
<span id="cb90-15"><a href="#cb90-15"></a><span class="bu">print</span>(<span class="ss">f"Control Group ROI: </span><span class="sc">{</span>roi_control<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb90-16"><a href="#cb90-16"></a><span class="bu">print</span>(<span class="ss">f"Treatment Group ROI: </span><span class="sc">{</span>roi_treatment<span class="sc">:.2f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Control Group ROI: -30.00%
Treatment Group ROI: 34.39%</code></pre>
</div>
</div>
</section>
<section id="feature-reduction-methods" class="level1" data-number="20">
<h1 data-number="20"><span class="header-section-number">20</span> Feature Reduction Methods</h1>
<p>Up until now, we used only a small subset of the features.</p>
<div id="dfaf7963" class="cell" data-execution_count="63">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1"></a>display(subset_cols)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>['CC_utilization',
 'PL_utilization',
 'last_prod_enq2',
 'PL_enq_L6m',
 'CC_enq_L6m',
 'response_flag']</code></pre>
</div>
</div>
<p>We will now widen the data frames to include more features, and explore feature reduction methods.</p>
<p>We need to remove features that are protected by US law.</p>
<div id="f286a4c9" class="cell" data-execution_count="64">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1"></a>protected_features <span class="op">=</span> [<span class="st">'MARITALSTATUS'</span>, <span class="st">'AGE'</span>, <span class="st">'GENDER'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="35318d5f" class="cell" data-execution_count="65">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1"></a>train_data_wide <span class="op">=</span> df_campaign_1_train.copy().drop(columns<span class="op">=</span>protected_features)</span>
<span id="cb95-2"><a href="#cb95-2"></a>test_data_wide <span class="op">=</span> df_campaign_1_test.copy().drop(columns<span class="op">=</span>protected_features)</span>
<span id="cb95-3"><a href="#cb95-3"></a></span>
<span id="cb95-4"><a href="#cb95-4"></a>train_data_wide <span class="op">=</span> TabularDataset(train_data_wide)</span>
<span id="cb95-5"><a href="#cb95-5"></a>test_data_wide <span class="op">=</span> TabularDataset(test_data_wide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="66">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1"></a>train_data_wide.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-campaign-1-train-full" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="66">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-campaign-1-train-full-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;14: First 5 rows of train_data_wide
</figcaption>
<div aria-describedby="tbl-campaign-1-train-full-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="66">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PROSPECTID</th>
<th data-quarto-table-cell-role="th">campaign_id</th>
<th data-quarto-table-cell-role="th">response_flag</th>
<th data-quarto-table-cell-role="th">direct_mail_flag</th>
<th data-quarto-table-cell-role="th">time_since_recent_payment</th>
<th data-quarto-table-cell-role="th">time_since_first_deliquency</th>
<th data-quarto-table-cell-role="th">time_since_recent_deliquency</th>
<th data-quarto-table-cell-role="th">num_times_delinquent</th>
<th data-quarto-table-cell-role="th">max_delinquency_level</th>
<th data-quarto-table-cell-role="th">max_recent_level_of_deliq</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">CC_TL</th>
<th data-quarto-table-cell-role="th">Consumer_TL</th>
<th data-quarto-table-cell-role="th">Gold_TL</th>
<th data-quarto-table-cell-role="th">Home_TL</th>
<th data-quarto-table-cell-role="th">PL_TL</th>
<th data-quarto-table-cell-role="th">Secured_TL</th>
<th data-quarto-table-cell-role="th">Unsecured_TL</th>
<th data-quarto-table-cell-role="th">Other_TL</th>
<th data-quarto-table-cell-role="th">Age_Oldest_TL</th>
<th data-quarto-table-cell-role="th">Age_Newest_TL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">67481</td>
<td>101064</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>66</td>
<td>-1</td>
<td>-1</td>
<td>0</td>
<td>-1</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>6</td>
<td>6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">280237</td>
<td>420391</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>384</td>
<td>-1</td>
<td>-1</td>
<td>0</td>
<td>-1</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>26</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">364312</td>
<td>546485</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>32</td>
<td>-1</td>
<td>-1</td>
<td>0</td>
<td>-1</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>5</td>
<td>0</td>
<td>1</td>
<td>56</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">30357</td>
<td>45386</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>54</td>
<td>-1</td>
<td>-1</td>
<td>0</td>
<td>-1</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>13</td>
<td>13</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">266731</td>
<td>400138</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>27</td>
<td>11</td>
<td>11</td>
<td>1</td>
<td>8</td>
<td>8</td>
<td>...</td>
<td>3</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>6</td>
<td>0</td>
<td>126</td>
<td>2</td>
</tr>
</tbody>
</table>

<p>5 rows × 86 columns</p>
</div>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="67">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1"></a>test_data_wide.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-campaign-1-test-full" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="67">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-campaign-1-test-full-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;15: First 5 rows of test_data_wide
</figcaption>
<div aria-describedby="tbl-campaign-1-test-full-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="67">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PROSPECTID</th>
<th data-quarto-table-cell-role="th">campaign_id</th>
<th data-quarto-table-cell-role="th">response_flag</th>
<th data-quarto-table-cell-role="th">direct_mail_flag</th>
<th data-quarto-table-cell-role="th">time_since_recent_payment</th>
<th data-quarto-table-cell-role="th">time_since_first_deliquency</th>
<th data-quarto-table-cell-role="th">time_since_recent_deliquency</th>
<th data-quarto-table-cell-role="th">num_times_delinquent</th>
<th data-quarto-table-cell-role="th">max_delinquency_level</th>
<th data-quarto-table-cell-role="th">max_recent_level_of_deliq</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">CC_TL</th>
<th data-quarto-table-cell-role="th">Consumer_TL</th>
<th data-quarto-table-cell-role="th">Gold_TL</th>
<th data-quarto-table-cell-role="th">Home_TL</th>
<th data-quarto-table-cell-role="th">PL_TL</th>
<th data-quarto-table-cell-role="th">Secured_TL</th>
<th data-quarto-table-cell-role="th">Unsecured_TL</th>
<th data-quarto-table-cell-role="th">Other_TL</th>
<th data-quarto-table-cell-role="th">Age_Oldest_TL</th>
<th data-quarto-table-cell-role="th">Age_Newest_TL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">260332</td>
<td>390571</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>48</td>
<td>-1</td>
<td>-1</td>
<td>0</td>
<td>-1</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>2</td>
<td>0</td>
<td>13</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">233290</td>
<td>349954</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>23</td>
<td>-1</td>
<td>-1</td>
<td>0</td>
<td>-1</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>2</td>
<td>17</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">267945</td>
<td>401969</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>82</td>
<td>-1</td>
<td>-1</td>
<td>0</td>
<td>-1</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>7</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">249900</td>
<td>374888</td>
<td>1</td>
<td>0.0</td>
<td>Y</td>
<td>46</td>
<td>-1</td>
<td>-1</td>
<td>0</td>
<td>-1</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>4</td>
<td>1</td>
<td>8</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">277551</td>
<td>416382</td>
<td>1</td>
<td>1.0</td>
<td>Y</td>
<td>312</td>
<td>15</td>
<td>14</td>
<td>2</td>
<td>9</td>
<td>6</td>
<td>...</td>
<td>1</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>3</td>
<td>1</td>
<td>35</td>
<td>2</td>
</tr>
</tbody>
</table>

<p>5 rows × 86 columns</p>
</div>
</div>
</div>
</figure>
</div>
</div>
<section id="filter-based-methods" class="level2" data-number="20.1">
<h2 data-number="20.1" class="anchored" data-anchor-id="filter-based-methods"><span class="header-section-number">20.1</span> Filter-based Methods</h2>
<p>Filter-based methods select features by evaluating the relationship between each individual feature and the target outcome. The selected features are then fed into a machine learning algorithm like XGBoost. Filter-based methods:</p>
<ul>
<li>Rank features using statistical measures (correlation, mutual information, chi-square tests)</li>
<li>Select top-ranked features</li>
<li>Are computationally efficient</li>
<li>Consider each feature independently, potentially missing important feature interactions</li>
</ul>
<p>The chunk below creates a scikit-learn pipeline that uses <code>SelectKBest</code> to select the top 10 features based on mutual information. The top 10 features are then used to train an <code>autogluon</code> model.</p>
<div id="76cd07e6" class="cell" data-execution_count="68">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1"></a><span class="kw">class</span> IndexPreservingSelectKBest(BaseEstimator, TransformerMixin):</span>
<span id="cb98-2"><a href="#cb98-2"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, score_func<span class="op">=</span>mutual_info_classif, k<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb98-3"><a href="#cb98-3"></a>        <span class="va">self</span>.score_func <span class="op">=</span> score_func</span>
<span id="cb98-4"><a href="#cb98-4"></a>        <span class="va">self</span>.k <span class="op">=</span> k</span>
<span id="cb98-5"><a href="#cb98-5"></a>        <span class="va">self</span>.selector <span class="op">=</span> SelectKBest(score_func<span class="op">=</span>score_func, k<span class="op">=</span>k)</span>
<span id="cb98-6"><a href="#cb98-6"></a>        </span>
<span id="cb98-7"><a href="#cb98-7"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb98-8"><a href="#cb98-8"></a>        <span class="va">self</span>.selector.fit(X, y)</span>
<span id="cb98-9"><a href="#cb98-9"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb98-10"><a href="#cb98-10"></a>        </span>
<span id="cb98-11"><a href="#cb98-11"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb98-12"><a href="#cb98-12"></a>        <span class="co"># Transform while preserving index</span></span>
<span id="cb98-13"><a href="#cb98-13"></a>        Xt <span class="op">=</span> <span class="va">self</span>.selector.transform(X)</span>
<span id="cb98-14"><a href="#cb98-14"></a>        <span class="cf">return</span> pd.DataFrame(Xt, index<span class="op">=</span>X.index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="5aae9e8c" class="cell" data-execution_count="69">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1"></a><span class="co"># remove ag folder if exists</span></span>
<span id="cb99-2"><a href="#cb99-2"></a>filter_model_folder <span class="op">=</span> <span class="st">'Lab01_ag_models_FilterMethod'</span></span>
<span id="cb99-3"><a href="#cb99-3"></a>remove_ag_folder(filter_model_folder)</span>
<span id="cb99-4"><a href="#cb99-4"></a></span>
<span id="cb99-5"><a href="#cb99-5"></a><span class="co"># ensures that the output after is transformation is a data frame</span></span>
<span id="cb99-6"><a href="#cb99-6"></a>set_config(transform_output<span class="op">=</span><span class="st">"pandas"</span>)</span>
<span id="cb99-7"><a href="#cb99-7"></a></span>
<span id="cb99-8"><a href="#cb99-8"></a>ag_model_filter_method <span class="op">=</span> Pipeline([</span>
<span id="cb99-9"><a href="#cb99-9"></a>    (<span class="st">'replace_values'</span>, FunctionTransformer(replace_vals)),</span>
<span id="cb99-10"><a href="#cb99-10"></a>    (<span class="st">'ordinal_encoder'</span>, make_column_transformer(</span>
<span id="cb99-11"><a href="#cb99-11"></a>        (OrdinalEncoder(), make_column_selector(dtype_include<span class="op">=</span>[<span class="st">"object"</span>, <span class="st">"category"</span>])),</span>
<span id="cb99-12"><a href="#cb99-12"></a>        remainder<span class="op">=</span><span class="st">'passthrough'</span></span>
<span id="cb99-13"><a href="#cb99-13"></a>    )),</span>
<span id="cb99-14"><a href="#cb99-14"></a>    (<span class="st">'feature_selection'</span>, IndexPreservingSelectKBest(score_func<span class="op">=</span>mutual_info_classif, k<span class="op">=</span><span class="dv">10</span>)),</span>
<span id="cb99-15"><a href="#cb99-15"></a>    (<span class="st">'autogluon'</span>, AutoGluonSklearnWrapper(label<span class="op">=</span>label,</span>
<span id="cb99-16"><a href="#cb99-16"></a>                                    predictor_args<span class="op">=</span>{<span class="st">'problem_type'</span>: <span class="st">'binary'</span>,</span>
<span id="cb99-17"><a href="#cb99-17"></a>                                                    <span class="st">'eval_metric'</span>: <span class="st">'roc_auc'</span>,</span>
<span id="cb99-18"><a href="#cb99-18"></a>                                                    <span class="st">'path'</span>: filter_model_folder},</span>
<span id="cb99-19"><a href="#cb99-19"></a>                                    fit_args<span class="op">=</span>{<span class="st">'holdout_frac'</span>: <span class="fl">0.2</span>,</span>
<span id="cb99-20"><a href="#cb99-20"></a>                                                <span class="st">'excluded_model_types'</span>: [<span class="st">'KNN'</span>, <span class="st">'NN_TORCH'</span>],</span>
<span id="cb99-21"><a href="#cb99-21"></a>                                                <span class="st">'presets'</span>: <span class="st">'medium_quality'</span>,</span>
<span id="cb99-22"><a href="#cb99-22"></a>                                                <span class="st">'time_limit'</span>: <span class="dv">180</span><span class="op">*</span><span class="fl">1.5</span>}))</span>
<span id="cb99-23"><a href="#cb99-23"></a>])</span>
<span id="cb99-24"><a href="#cb99-24"></a></span>
<span id="cb99-25"><a href="#cb99-25"></a>global_set_seed()</span>
<span id="cb99-26"><a href="#cb99-26"></a></span>
<span id="cb99-27"><a href="#cb99-27"></a>ag_model_filter_method.fit( X <span class="op">=</span> train_data_wide.drop(</span>
<span id="cb99-28"><a href="#cb99-28"></a>                    columns<span class="op">=</span>[label] <span class="op">+</span> [<span class="st">'PROSPECTID'</span>, <span class="st">'campaign_id'</span>, <span class="st">'direct_mail_flag'</span>]),</span>
<span id="cb99-29"><a href="#cb99-29"></a>            y <span class="op">=</span> train_data_wide[label]</span>
<span id="cb99-30"><a href="#cb99-30"></a>            )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Verbosity: 2 (Standard Logging)
=================== System Info ===================
AutoGluon Version:  1.2
Python Version:     3.11.14
Operating System:   Windows
Platform Machine:   AMD64
Platform Version:   10.0.26200
CPU Count:          20
Memory Avail:       16.02 GB / 31.75 GB (50.4%)
Disk Space Avail:   620.03 GB / 951.67 GB (65.2%)
===================================================
Presets specified: ['medium_quality']
Beginning AutoGluon training ... Time limit = 270s
AutoGluon will save models to "C:\Users\chiuw\IML4Finance\Lectures\Lab01_ag_models_FilterMethod"
Train Data Rows:    268811
Train Data Columns: 10
Label Column:       response_flag
Problem Type:       binary
Preprocessing data ...
Selected class &lt;--&gt; label mapping:  class 1 = 1, class 0 = 0
Using Feature Generators to preprocess the data ...
Fitting AutoMLPipelineFeatureGenerator...
    Available Memory:                    16403.93 MB
    Train Data (Original)  Memory Usage: 20.51 MB (0.1% of available memory)
    Inferring data type of each feature based on column values. Set feature_metadata_in to manually specify special dtypes of the features.
    Stage 1 Generators:
        Fitting AsTypeFeatureGenerator...
    Stage 2 Generators:
        Fitting FillNaFeatureGenerator...
    Stage 3 Generators:
        Fitting IdentityFeatureGenerator...
    Stage 4 Generators:
        Fitting DropUniqueFeatureGenerator...
    Stage 5 Generators:
        Fitting DropDuplicatesFeatureGenerator...
    Types of features in original data (raw dtype, special dtypes):
        ('float', []) : 5 | ['ordinalencoder__last_prod_enq2', 'ordinalencoder__first_prod_enq2', 'remainder__CC_utilization', 'remainder__PL_utilization', 'remainder__max_unsec_exposure_inPct']
        ('int', [])   : 5 | ['remainder__CC_enq_L6m', 'remainder__PL_enq_L6m', 'remainder__PL_enq_L12m', 'remainder__enq_L12m', 'remainder__enq_L6m']
    Types of features in processed data (raw dtype, special dtypes):
        ('float', []) : 5 | ['ordinalencoder__last_prod_enq2', 'ordinalencoder__first_prod_enq2', 'remainder__CC_utilization', 'remainder__PL_utilization', 'remainder__max_unsec_exposure_inPct']
        ('int', [])   : 5 | ['remainder__CC_enq_L6m', 'remainder__PL_enq_L6m', 'remainder__PL_enq_L12m', 'remainder__enq_L12m', 'remainder__enq_L6m']
    0.2s = Fit runtime
    10 features in original data used to generate 10 features in processed data.
    Train Data (Processed) Memory Usage: 20.51 MB (0.1% of available memory)
Data preprocessing and feature engineering runtime = 0.26s ...
AutoGluon will gauge predictive performance using evaluation metric: 'roc_auc'
    This metric expects predicted probabilities rather than predicted class labels, so you'll need to use predict_proba() instead of predict()
    To change this, specify the eval_metric parameter of Predictor()
Automatically generating train/validation split with holdout_frac=0.2, Train Rows: 215048, Val Rows: 53763
User-specified model hyperparameters to be fit:
{
    'NN_TORCH': [{}],
    'GBM': [{'extra_trees': True, 'ag_args': {'name_suffix': 'XT'}}, {}, {'learning_rate': 0.03, 'num_leaves': 128, 'feature_fraction': 0.9, 'min_data_in_leaf': 3, 'ag_args': {'name_suffix': 'Large', 'priority': 0, 'hyperparameter_tune_kwargs': None}}],
    'CAT': [{}],
    'XGB': [{}],
    'FASTAI': [{}],
    'RF': [{'criterion': 'gini', 'ag_args': {'name_suffix': 'Gini', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'entropy', 'ag_args': {'name_suffix': 'Entr', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'squared_error', 'ag_args': {'name_suffix': 'MSE', 'problem_types': ['regression', 'quantile']}}],
    'XT': [{'criterion': 'gini', 'ag_args': {'name_suffix': 'Gini', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'entropy', 'ag_args': {'name_suffix': 'Entr', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'squared_error', 'ag_args': {'name_suffix': 'MSE', 'problem_types': ['regression', 'quantile']}}],
    'KNN': [{'weights': 'uniform', 'ag_args': {'name_suffix': 'Unif'}}, {'weights': 'distance', 'ag_args': {'name_suffix': 'Dist'}}],
}
Excluded models: ['NN_TORCH', 'KNN'] (Specified by `excluded_model_types`)
Fitting 10 L1 models, fit_strategy="sequential" ...
Fitting model: LightGBMXT ... Training model for up to 269.74s of the 269.74s of remaining time.
    0.7172   = Validation score   (roc_auc)
    0.89s    = Training   runtime
    0.05s    = Validation runtime
Fitting model: LightGBM ... Training model for up to 268.78s of the 268.77s of remaining time.
    0.7183   = Validation score   (roc_auc)
    0.68s    = Training   runtime
    0.03s    = Validation runtime
Fitting model: RandomForestGini ... Training model for up to 268.04s of the 268.04s of remaining time.
    0.6618   = Validation score   (roc_auc)
    12.03s   = Training   runtime
    0.28s    = Validation runtime
Fitting model: RandomForestEntr ... Training model for up to 254.97s of the 254.97s of remaining time.
    0.6624   = Validation score   (roc_auc)
    11.75s   = Training   runtime
    0.25s    = Validation runtime
Fitting model: CatBoost ... Training model for up to 242.63s of the 242.63s of remaining time.
    0.7186   = Validation score   (roc_auc)
    4.22s    = Training   runtime
    0.01s    = Validation runtime
Fitting model: ExtraTreesGini ... Training model for up to 238.37s of the 238.37s of remaining time.
    0.6617   = Validation score   (roc_auc)
    7.79s    = Training   runtime
    0.29s    = Validation runtime
Fitting model: ExtraTreesEntr ... Training model for up to 228.98s of the 228.98s of remaining time.
    0.6625   = Validation score   (roc_auc)
    7.66s    = Training   runtime
    0.29s    = Validation runtime
Fitting model: NeuralNetFastAI ... Training model for up to 220.51s of the 220.51s of remaining time.
C:\Users\chiuw\miniforge3\envs\env_iml4finance_2026\Lib\site-packages\autogluon\tabular\models\fastainn\tabular_nn_fastai.py:228: UserWarning:

Cannot set number of intraop threads after parallel work has started or after set_num_threads call when using native parallel backend (Triggered internally at C:\bld\libtorch_1741563144345\work\aten\src\ATen\ParallelNative.cpp:228.)

    0.7177   = Validation score   (roc_auc)
    78.13s   = Training   runtime
    0.2s     = Validation runtime
Fitting model: XGBoost ... Training model for up to 142.08s of the 142.08s of remaining time.
    0.7158   = Validation score   (roc_auc)
    0.79s    = Training   runtime
    0.03s    = Validation runtime
Fitting model: LightGBMLarge ... Training model for up to 141.23s of the 141.23s of remaining time.
    0.7156   = Validation score   (roc_auc)
    1.24s    = Training   runtime
    0.05s    = Validation runtime
Fitting model: WeightedEnsemble_L2 ... Training model for up to 269.74s of the 139.90s of remaining time.
    Ensemble Weights: {'LightGBMXT': 0.32, 'LightGBM': 0.16, 'CatBoost': 0.16, 'NeuralNetFastAI': 0.16, 'LightGBMLarge': 0.16, 'XGBoost': 0.04}
    0.7195   = Validation score   (roc_auc)
    1.08s    = Training   runtime
    0.0s     = Validation runtime
AutoGluon training complete, total runtime = 131.36s ... Best model: WeightedEnsemble_L2 | Estimated inference throughput: 144587.8 rows/s (53763 batch size)
TabularPredictor saved. To load, use: predictor = TabularPredictor.load("C:\Users\chiuw\IML4Finance\Lectures\Lab01_ag_models_FilterMethod")</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="69">
<style>#sk-container-id-3 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-3 {
  color: var(--sklearn-color-text);
}

#sk-container-id-3 pre {
  padding: 0;
}

#sk-container-id-3 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-3 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-3 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-3 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-3 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-3 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-3 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-3 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-3 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-3 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-3 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-3 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-3 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-3 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-3 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-3 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-3 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-3 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-3 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-3 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-3 div.sk-label label.sk-toggleable__label,
#sk-container-id-3 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-3 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-3 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-3 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-3 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-3 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-3 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-3 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-3 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-3 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-3 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-3" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[('replace_values',
                 FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                ('ordinal_encoder',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('ordinalencoder',
                                                  OrdinalEncoder(),
                                                  &lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A99EBB1D0&gt;)])),
                ('feature_selection', IndexPreservingSelectKBest()),
                ('autogluon',
                 AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN',
                                                                            'NN_TORCH'],
                                                   'holdout_frac': 0.2,
                                                   'presets': 'medium_quality',
                                                   'time_limit': 270.0},
                                         label='response_flag',
                                         predictor_args={'eval_metric': 'roc_auc',
                                                         'path': 'Lab01_ag_models_FilterMethod',
                                                         'problem_type': 'binary'}))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-8" type="checkbox"><label for="sk-estimator-id-8" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;&nbsp;Pipeline<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.pipeline.Pipeline.html">?<span>Documentation for Pipeline</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>Pipeline(steps=[('replace_values',
                 FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                ('ordinal_encoder',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('ordinalencoder',
                                                  OrdinalEncoder(),
                                                  &lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A99EBB1D0&gt;)])),
                ('feature_selection', IndexPreservingSelectKBest()),
                ('autogluon',
                 AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN',
                                                                            'NN_TORCH'],
                                                   'holdout_frac': 0.2,
                                                   'presets': 'medium_quality',
                                                   'time_limit': 270.0},
                                         label='response_flag',
                                         predictor_args={'eval_metric': 'roc_auc',
                                                         'path': 'Lab01_ag_models_FilterMethod',
                                                         'problem_type': 'binary'}))])</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-9" type="checkbox"><label for="sk-estimator-id-9" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;FunctionTransformer<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.preprocessing.FunctionTransformer.html">?<span>Documentation for FunctionTransformer</span></a></label><div class="sk-toggleable__content fitted"><pre>FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)</pre></div> </div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-10" type="checkbox"><label for="sk-estimator-id-10" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;ordinal_encoder: ColumnTransformer<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.compose.ColumnTransformer.html">?<span>Documentation for ordinal_encoder: ColumnTransformer</span></a></label><div class="sk-toggleable__content fitted"><pre>ColumnTransformer(remainder='passthrough',
                  transformers=[('ordinalencoder', OrdinalEncoder(),
                                 &lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A99EBB1D0&gt;)])</pre></div> </div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-11" type="checkbox"><label for="sk-estimator-id-11" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">ordinalencoder</label><div class="sk-toggleable__content fitted"><pre>&lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A99EBB1D0&gt;</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-12" type="checkbox"><label for="sk-estimator-id-12" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;OrdinalEncoder<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.preprocessing.OrdinalEncoder.html">?<span>Documentation for OrdinalEncoder</span></a></label><div class="sk-toggleable__content fitted"><pre>OrdinalEncoder()</pre></div> </div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-13" type="checkbox"><label for="sk-estimator-id-13" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">remainder</label><div class="sk-toggleable__content fitted"><pre>['time_since_recent_payment', 'time_since_first_deliquency', 'time_since_recent_deliquency', 'num_times_delinquent', 'max_delinquency_level', 'max_recent_level_of_deliq', 'num_deliq_6mts', 'num_deliq_12mts', 'num_deliq_6_12mts', 'max_deliq_6mts', 'max_deliq_12mts', 'num_times_30p_dpd', 'num_times_60p_dpd', 'num_std', 'num_std_6mts', 'num_std_12mts', 'num_sub', 'num_sub_6mts', 'num_sub_12mts', 'num_dbt', 'num_dbt_6mts', 'num_dbt_12mts', 'num_lss', 'num_lss_6mts', 'num_lss_12mts', 'recent_level_of_deliq', 'tot_enq', 'CC_enq', 'CC_enq_L6m', 'CC_enq_L12m', 'PL_enq', 'PL_enq_L6m', 'PL_enq_L12m', 'time_since_recent_enq', 'enq_L12m', 'enq_L6m', 'enq_L3m', 'NETMONTHLYINCOME', 'Time_With_Curr_Empr', 'pct_of_active_TLs_ever', 'pct_opened_TLs_L6m_of_L12m', 'pct_currentBal_all_TL', 'CC_utilization', 'CC_Flag', 'PL_utilization', 'PL_Flag', 'pct_PL_enq_L6m_of_L12m', 'pct_CC_enq_L6m_of_L12m', 'pct_PL_enq_L6m_of_ever', 'pct_CC_enq_L6m_of_ever', 'max_unsec_exposure_inPct', 'HL_Flag', 'GL_Flag', 'Credit_Score', 'Total_TL', 'Tot_Closed_TL', 'Tot_Active_TL', 'Total_TL_opened_L6M', 'Tot_TL_closed_L6M', 'pct_tl_open_L6M', 'pct_tl_closed_L6M', 'pct_active_tl', 'pct_closed_tl', 'Total_TL_opened_L12M', 'Tot_TL_closed_L12M', 'pct_tl_open_L12M', 'pct_tl_closed_L12M', 'Tot_Missed_Pmnt', 'Auto_TL', 'CC_TL', 'Consumer_TL', 'Gold_TL', 'Home_TL', 'PL_TL', 'Secured_TL', 'Unsecured_TL', 'Other_TL', 'Age_Oldest_TL', 'Age_Newest_TL']</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-14" type="checkbox"><label for="sk-estimator-id-14" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">passthrough</label><div class="sk-toggleable__content fitted"><pre>passthrough</pre></div> </div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-15" type="checkbox"><label for="sk-estimator-id-15" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">IndexPreservingSelectKBest</label><div class="sk-toggleable__content fitted"><pre>IndexPreservingSelectKBest()</pre></div> </div></div><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-16" type="checkbox"><label for="sk-estimator-id-16" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">AutoGluonSklearnWrapper</label><div class="sk-toggleable__content fitted"><pre>AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN', 'NN_TORCH'],
                                  'holdout_frac': 0.2,
                                  'presets': 'medium_quality',
                                  'time_limit': 270.0},
                        label='response_flag',
                        predictor_args={'eval_metric': 'roc_auc',
                                        'path': 'Lab01_ag_models_FilterMethod',
                                        'problem_type': 'binary'})</pre></div> </div></div></div></div></div></div>
</div>
</div>
<p>Check leaderboard using the test set.</p>
<div id="b2820132" class="cell" data-execution_count="70">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1"></a>preprocessed_test_data <span class="op">=</span> ag_model_filter_method[:<span class="op">-</span><span class="dv">1</span>].transform(test_data_wide)</span>
<span id="cb101-2"><a href="#cb101-2"></a></span>
<span id="cb101-3"><a href="#cb101-3"></a>preprocessed_test_data[label] <span class="op">=</span> test_data_wide[label]</span>
<span id="cb101-4"><a href="#cb101-4"></a></span>
<span id="cb101-5"><a href="#cb101-5"></a>df_leaders_filter_method <span class="op">=</span> ag_model_filter_method.named_steps[<span class="st">'autogluon'</span>].predictor.leaderboard(preprocessed_test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\chiuw\miniforge3\envs\env_iml4finance_2026\Lib\site-packages\fastai\learner.py:455: UserWarning:

load_learner` uses Python's insecure pickle module, which can execute malicious arbitrary code when loading. Only load files you trust.
If you only need to load model weights and optimizer state, use the safe `Learner.load` instead.
</code></pre>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="71">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1"></a>display(df_leaders_filter_method)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-ag-leaderboard-filter-method" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="71">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ag-leaderboard-filter-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;16: Autogluon Leaderboard (Filter-based Method)
</figcaption>
<div aria-describedby="tbl-ag-leaderboard-filter-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">score_test</th>
<th data-quarto-table-cell-role="th">score_val</th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">pred_time_test</th>
<th data-quarto-table-cell-role="th">pred_time_val</th>
<th data-quarto-table-cell-role="th">fit_time</th>
<th data-quarto-table-cell-role="th">pred_time_test_marginal</th>
<th data-quarto-table-cell-role="th">pred_time_val_marginal</th>
<th data-quarto-table-cell-role="th">fit_time_marginal</th>
<th data-quarto-table-cell-role="th">stack_level</th>
<th data-quarto-table-cell-role="th">can_infer</th>
<th data-quarto-table-cell-role="th">fit_order</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>CatBoost</td>
<td>0.720230</td>
<td>0.718564</td>
<td>roc_auc</td>
<td>0.047151</td>
<td>0.008015</td>
<td>4.215681</td>
<td>0.047151</td>
<td>0.008015</td>
<td>4.215681</td>
<td>1</td>
<td>True</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>LightGBMXT</td>
<td>0.719836</td>
<td>0.717213</td>
<td>roc_auc</td>
<td>0.092084</td>
<td>0.046533</td>
<td>0.888895</td>
<td>0.092084</td>
<td>0.046533</td>
<td>0.888895</td>
<td>1</td>
<td>True</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>WeightedEnsemble_L2</td>
<td>0.719066</td>
<td>0.719515</td>
<td>roc_auc</td>
<td>0.845520</td>
<td>0.371836</td>
<td>87.025204</td>
<td>0.008010</td>
<td>0.004520</td>
<td>1.082911</td>
<td>2</td>
<td>True</td>
<td>11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>NeuralNetFastAI</td>
<td>0.718594</td>
<td>0.717668</td>
<td>roc_auc</td>
<td>0.508099</td>
<td>0.200649</td>
<td>78.126983</td>
<td>0.508099</td>
<td>0.200649</td>
<td>78.126983</td>
<td>1</td>
<td>True</td>
<td>8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>LightGBM</td>
<td>0.716750</td>
<td>0.718267</td>
<td>roc_auc</td>
<td>0.055054</td>
<td>0.033538</td>
<td>0.675136</td>
<td>0.055054</td>
<td>0.033538</td>
<td>0.675136</td>
<td>1</td>
<td>True</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>XGBoost</td>
<td>0.715318</td>
<td>0.715768</td>
<td>roc_auc</td>
<td>0.057047</td>
<td>0.032029</td>
<td>0.794282</td>
<td>0.057047</td>
<td>0.032029</td>
<td>0.794282</td>
<td>1</td>
<td>True</td>
<td>9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>LightGBMLarge</td>
<td>0.713290</td>
<td>0.715587</td>
<td>roc_auc</td>
<td>0.078074</td>
<td>0.046552</td>
<td>1.241316</td>
<td>0.078074</td>
<td>0.046552</td>
<td>1.241316</td>
<td>1</td>
<td>True</td>
<td>10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>ExtraTreesEntr</td>
<td>0.645518</td>
<td>0.662506</td>
<td>roc_auc</td>
<td>0.996676</td>
<td>0.291339</td>
<td>7.663357</td>
<td>0.996676</td>
<td>0.291339</td>
<td>7.663357</td>
<td>1</td>
<td>True</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>ExtraTreesGini</td>
<td>0.645466</td>
<td>0.661684</td>
<td>roc_auc</td>
<td>0.957865</td>
<td>0.288254</td>
<td>7.793987</td>
<td>0.957865</td>
<td>0.288254</td>
<td>7.793987</td>
<td>1</td>
<td>True</td>
<td>6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>RandomForestEntr</td>
<td>0.645197</td>
<td>0.662392</td>
<td>roc_auc</td>
<td>0.827119</td>
<td>0.251787</td>
<td>11.749636</td>
<td>0.827119</td>
<td>0.251787</td>
<td>11.749636</td>
<td>1</td>
<td>True</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>RandomForestGini</td>
<td>0.644779</td>
<td>0.661831</td>
<td>roc_auc</td>
<td>0.813076</td>
<td>0.277757</td>
<td>12.026366</td>
<td>0.813076</td>
<td>0.277757</td>
<td>12.026366</td>
<td>1</td>
<td>True</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>Check permutation feature importance on the test set.</p>
<div id="f4edb111" class="cell" data-execution_count="72">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1"></a>best_feature_importance_filter <span class="op">=</span> (ag_model_filter_method</span>
<span id="cb104-2"><a href="#cb104-2"></a>                            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb104-3"><a href="#cb104-3"></a>                            .predictor</span>
<span id="cb104-4"><a href="#cb104-4"></a>                            .feature_importance(</span>
<span id="cb104-5"><a href="#cb104-5"></a>                                    data <span class="op">=</span> preprocessed_test_data, </span>
<span id="cb104-6"><a href="#cb104-6"></a>                                    model <span class="op">=</span> best_model_name,</span>
<span id="cb104-7"><a href="#cb104-7"></a>                                    subsample_size <span class="op">=</span> <span class="va">None</span>)</span>
<span id="cb104-8"><a href="#cb104-8"></a>                        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Computing feature importance via permutation shuffling for 10 features using 115206 rows with 5 shuffle sets...
    1.38s   = Expected runtime (0.28s per shuffle set)
    1.33s   = Actual runtime (Completed 5 of 5 shuffle sets)</code></pre>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="73">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1"></a>display(best_feature_importance_filter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-perm-feature-importance-filter-method" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="73">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-perm-feature-importance-filter-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;17: Permutation Feature Importance (Filter-based Method)
</figcaption>
<div aria-describedby="tbl-perm-feature-importance-filter-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">importance</th>
<th data-quarto-table-cell-role="th">stddev</th>
<th data-quarto-table-cell-role="th">p_value</th>
<th data-quarto-table-cell-role="th">n</th>
<th data-quarto-table-cell-role="th">p99_high</th>
<th data-quarto-table-cell-role="th">p99_low</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__CC_utilization</td>
<td>0.038659</td>
<td>0.000911</td>
<td>3.692611e-08</td>
<td>5</td>
<td>0.040534</td>
<td>0.036784</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__PL_utilization</td>
<td>0.011823</td>
<td>0.001608</td>
<td>4.007911e-05</td>
<td>5</td>
<td>0.015134</td>
<td>0.008512</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__PL_enq_L6m</td>
<td>0.008824</td>
<td>0.000987</td>
<td>1.850922e-05</td>
<td>5</td>
<td>0.010857</td>
<td>0.006791</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__CC_enq_L6m</td>
<td>0.007406</td>
<td>0.000304</td>
<td>3.417666e-07</td>
<td>5</td>
<td>0.008033</td>
<td>0.006779</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ordinalencoder__last_prod_enq2</td>
<td>0.001793</td>
<td>0.000737</td>
<td>2.775061e-03</td>
<td>5</td>
<td>0.003311</td>
<td>0.000275</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__max_unsec_exposure_inPct</td>
<td>0.001030</td>
<td>0.001227</td>
<td>6.682294e-02</td>
<td>5</td>
<td>0.003556</td>
<td>-0.001496</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__enq_L12m</td>
<td>0.000837</td>
<td>0.000907</td>
<td>5.393364e-02</td>
<td>5</td>
<td>0.002704</td>
<td>-0.001030</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__PL_enq_L12m</td>
<td>0.000740</td>
<td>0.001100</td>
<td>1.034674e-01</td>
<td>5</td>
<td>0.003004</td>
<td>-0.001524</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__enq_L6m</td>
<td>0.000171</td>
<td>0.000588</td>
<td>2.759743e-01</td>
<td>5</td>
<td>0.001381</td>
<td>-0.001040</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">ordinalencoder__first_prod_enq2</td>
<td>-0.001042</td>
<td>0.000792</td>
<td>9.788176e-01</td>
<td>5</td>
<td>0.000589</td>
<td>-0.002674</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="embedded-methods" class="level2" data-number="20.2">
<h2 data-number="20.2" class="anchored" data-anchor-id="embedded-methods"><span class="header-section-number">20.2</span> Embedded Methods</h2>
<p>Embedded methods integrate feature selection directly into the model training/fitting process:</p>
<ul>
<li>Select features while the model is being trained/fitted</li>
<li>Balance feature relevance with model performance</li>
<li>Have moderate computational cost</li>
<li>Examples: L1 regularization (Lasso), tree-based importance measures</li>
</ul>
<p>The chunk below creates a scikit-learn pipeline that uses <code>SelectFromModel</code> and the <code>ExtraTreesClassifier</code> to select the top features. The top features are then used to train an <code>autogluon</code> model.</p>
<div id="3db14bb3" class="cell" data-execution_count="74">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1"></a><span class="co"># remove ag folder if exists</span></span>
<span id="cb107-2"><a href="#cb107-2"></a>embedded_model_folder <span class="op">=</span> <span class="st">'Lab01_ag_models_EmbeddedMethod'</span></span>
<span id="cb107-3"><a href="#cb107-3"></a>remove_ag_folder(embedded_model_folder)</span>
<span id="cb107-4"><a href="#cb107-4"></a></span>
<span id="cb107-5"><a href="#cb107-5"></a>ag_model_embedded_method <span class="op">=</span> Pipeline([</span>
<span id="cb107-6"><a href="#cb107-6"></a>    (<span class="st">'replace_values'</span>, FunctionTransformer(replace_vals)),</span>
<span id="cb107-7"><a href="#cb107-7"></a>    (<span class="st">'ordinal_encoder'</span>, make_column_transformer(</span>
<span id="cb107-8"><a href="#cb107-8"></a>        (OrdinalEncoder(), make_column_selector(dtype_include<span class="op">=</span>[<span class="st">"object"</span>, <span class="st">"category"</span>])),</span>
<span id="cb107-9"><a href="#cb107-9"></a>        remainder<span class="op">=</span><span class="st">'passthrough'</span></span>
<span id="cb107-10"><a href="#cb107-10"></a>    )),</span>
<span id="cb107-11"><a href="#cb107-11"></a>    (<span class="st">'feature_selection'</span>, SelectFromModel(</span>
<span id="cb107-12"><a href="#cb107-12"></a>        ExtraTreesClassifier(random_state<span class="op">=</span><span class="dv">2025</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>, max_depth<span class="op">=</span><span class="dv">3</span>, n_jobs<span class="op">=</span>num_jobs),</span>
<span id="cb107-13"><a href="#cb107-13"></a>        threshold<span class="op">=</span><span class="fl">0.01</span></span>
<span id="cb107-14"><a href="#cb107-14"></a>    )),</span>
<span id="cb107-15"><a href="#cb107-15"></a>    (<span class="st">'autogluon'</span>, AutoGluonSklearnWrapper(label<span class="op">=</span>label,</span>
<span id="cb107-16"><a href="#cb107-16"></a>                                    predictor_args<span class="op">=</span>{<span class="st">'problem_type'</span>: <span class="st">'binary'</span>,</span>
<span id="cb107-17"><a href="#cb107-17"></a>                                                    <span class="st">'eval_metric'</span>: <span class="st">'roc_auc'</span>,</span>
<span id="cb107-18"><a href="#cb107-18"></a>                                                    <span class="st">'path'</span>: embedded_model_folder},</span>
<span id="cb107-19"><a href="#cb107-19"></a>                                    fit_args<span class="op">=</span>{<span class="st">'holdout_frac'</span>: <span class="fl">0.2</span>,</span>
<span id="cb107-20"><a href="#cb107-20"></a>                                                <span class="st">'excluded_model_types'</span>: [<span class="st">'KNN'</span>, <span class="st">'NN_TORCH'</span>],</span>
<span id="cb107-21"><a href="#cb107-21"></a>                                                <span class="st">'presets'</span>: <span class="st">'medium_quality'</span>,</span>
<span id="cb107-22"><a href="#cb107-22"></a>                                                <span class="st">'time_limit'</span>: <span class="dv">180</span><span class="op">*</span><span class="fl">1.5</span>}))</span>
<span id="cb107-23"><a href="#cb107-23"></a>])</span>
<span id="cb107-24"><a href="#cb107-24"></a></span>
<span id="cb107-25"><a href="#cb107-25"></a>global_set_seed()</span>
<span id="cb107-26"><a href="#cb107-26"></a></span>
<span id="cb107-27"><a href="#cb107-27"></a>ag_model_embedded_method.fit( X <span class="op">=</span> train_data_wide.drop(</span>
<span id="cb107-28"><a href="#cb107-28"></a>                    columns<span class="op">=</span>[label] <span class="op">+</span> [<span class="st">'PROSPECTID'</span>, <span class="st">'campaign_id'</span>, <span class="st">'direct_mail_flag'</span>]),</span>
<span id="cb107-29"><a href="#cb107-29"></a>            y <span class="op">=</span> train_data_wide[label]</span>
<span id="cb107-30"><a href="#cb107-30"></a>            )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Verbosity: 2 (Standard Logging)
=================== System Info ===================
AutoGluon Version:  1.2
Python Version:     3.11.14
Operating System:   Windows
Platform Machine:   AMD64
Platform Version:   10.0.26200
CPU Count:          20
Memory Avail:       15.86 GB / 31.75 GB (50.0%)
Disk Space Avail:   619.56 GB / 951.67 GB (65.1%)
===================================================
Presets specified: ['medium_quality']
Beginning AutoGluon training ... Time limit = 270s
AutoGluon will save models to "C:\Users\chiuw\IML4Finance\Lectures\Lab01_ag_models_EmbeddedMethod"
Train Data Rows:    268811
Train Data Columns: 19
Label Column:       response_flag
Problem Type:       binary
Preprocessing data ...
Selected class &lt;--&gt; label mapping:  class 1 = 1, class 0 = 0
Using Feature Generators to preprocess the data ...
Fitting AutoMLPipelineFeatureGenerator...
    Available Memory:                    16246.85 MB
    Train Data (Original)  Memory Usage: 38.97 MB (0.2% of available memory)
    Inferring data type of each feature based on column values. Set feature_metadata_in to manually specify special dtypes of the features.
    Stage 1 Generators:
        Fitting AsTypeFeatureGenerator...
            Note: Converting 2 features to boolean dtype as they only contain 2 unique values.
    Stage 2 Generators:
        Fitting FillNaFeatureGenerator...
    Stage 3 Generators:
        Fitting IdentityFeatureGenerator...
    Stage 4 Generators:
        Fitting DropUniqueFeatureGenerator...
    Stage 5 Generators:
        Fitting DropDuplicatesFeatureGenerator...
    Types of features in original data (raw dtype, special dtypes):
        ('float', []) :  6 | ['remainder__CC_utilization', 'remainder__PL_utilization', 'remainder__pct_PL_enq_L6m_of_L12m', 'remainder__pct_CC_enq_L6m_of_L12m', 'remainder__pct_PL_enq_L6m_of_ever', ...]
        ('int', [])   : 13 | ['remainder__tot_enq', 'remainder__CC_enq', 'remainder__CC_enq_L6m', 'remainder__CC_enq_L12m', 'remainder__PL_enq', ...]
    Types of features in processed data (raw dtype, special dtypes):
        ('float', [])     :  6 | ['remainder__CC_utilization', 'remainder__PL_utilization', 'remainder__pct_PL_enq_L6m_of_L12m', 'remainder__pct_CC_enq_L6m_of_L12m', 'remainder__pct_PL_enq_L6m_of_ever', ...]
        ('int', [])       : 11 | ['remainder__tot_enq', 'remainder__CC_enq', 'remainder__CC_enq_L6m', 'remainder__CC_enq_L12m', 'remainder__PL_enq', ...]
        ('int', ['bool']) :  2 | ['remainder__CC_Flag', 'remainder__PL_Flag']
    0.3s = Fit runtime
    19 features in original data used to generate 19 features in processed data.
    Train Data (Processed) Memory Usage: 35.38 MB (0.2% of available memory)
Data preprocessing and feature engineering runtime = 0.35s ...
AutoGluon will gauge predictive performance using evaluation metric: 'roc_auc'
    This metric expects predicted probabilities rather than predicted class labels, so you'll need to use predict_proba() instead of predict()
    To change this, specify the eval_metric parameter of Predictor()
Automatically generating train/validation split with holdout_frac=0.2, Train Rows: 215048, Val Rows: 53763
User-specified model hyperparameters to be fit:
{
    'NN_TORCH': [{}],
    'GBM': [{'extra_trees': True, 'ag_args': {'name_suffix': 'XT'}}, {}, {'learning_rate': 0.03, 'num_leaves': 128, 'feature_fraction': 0.9, 'min_data_in_leaf': 3, 'ag_args': {'name_suffix': 'Large', 'priority': 0, 'hyperparameter_tune_kwargs': None}}],
    'CAT': [{}],
    'XGB': [{}],
    'FASTAI': [{}],
    'RF': [{'criterion': 'gini', 'ag_args': {'name_suffix': 'Gini', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'entropy', 'ag_args': {'name_suffix': 'Entr', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'squared_error', 'ag_args': {'name_suffix': 'MSE', 'problem_types': ['regression', 'quantile']}}],
    'XT': [{'criterion': 'gini', 'ag_args': {'name_suffix': 'Gini', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'entropy', 'ag_args': {'name_suffix': 'Entr', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'squared_error', 'ag_args': {'name_suffix': 'MSE', 'problem_types': ['regression', 'quantile']}}],
    'KNN': [{'weights': 'uniform', 'ag_args': {'name_suffix': 'Unif'}}, {'weights': 'distance', 'ag_args': {'name_suffix': 'Dist'}}],
}
Excluded models: ['NN_TORCH', 'KNN'] (Specified by `excluded_model_types`)
Fitting 10 L1 models, fit_strategy="sequential" ...
Fitting model: LightGBMXT ... Training model for up to 269.65s of the 269.64s of remaining time.
    0.7174   = Validation score   (roc_auc)
    0.86s    = Training   runtime
    0.04s    = Validation runtime
Fitting model: LightGBM ... Training model for up to 268.71s of the 268.71s of remaining time.
    0.7189   = Validation score   (roc_auc)
    0.82s    = Training   runtime
    0.04s    = Validation runtime
Fitting model: RandomForestGini ... Training model for up to 267.83s of the 267.83s of remaining time.
    0.6581   = Validation score   (roc_auc)
    13.19s   = Training   runtime
    0.2s     = Validation runtime
Fitting model: RandomForestEntr ... Training model for up to 253.41s of the 253.41s of remaining time.
    0.6585   = Validation score   (roc_auc)
    12.78s   = Training   runtime
    0.2s     = Validation runtime
Fitting model: CatBoost ... Training model for up to 240.15s of the 240.15s of remaining time.
    0.7181   = Validation score   (roc_auc)
    4.0s     = Training   runtime
    0.01s    = Validation runtime
Fitting model: ExtraTreesGini ... Training model for up to 236.10s of the 236.10s of remaining time.
    0.6584   = Validation score   (roc_auc)
    9.49s    = Training   runtime
    0.25s    = Validation runtime
Fitting model: ExtraTreesEntr ... Training model for up to 225.17s of the 225.17s of remaining time.
    0.6584   = Validation score   (roc_auc)
    9.72s    = Training   runtime
    0.24s    = Validation runtime
Fitting model: NeuralNetFastAI ... Training model for up to 214.78s of the 214.77s of remaining time.
C:\Users\chiuw\miniforge3\envs\env_iml4finance_2026\Lib\site-packages\autogluon\tabular\models\fastainn\tabular_nn_fastai.py:228: UserWarning:

Cannot set number of intraop threads after parallel work has started or after set_num_threads call when using native parallel backend (Triggered internally at C:\bld\libtorch_1741563144345\work\aten\src\ATen\ParallelNative.cpp:228.)

    0.7173   = Validation score   (roc_auc)
    80.3s    = Training   runtime
    0.21s    = Validation runtime
Fitting model: XGBoost ... Training model for up to 134.18s of the 134.18s of remaining time.
    0.7176   = Validation score   (roc_auc)
    7.66s    = Training   runtime
    0.04s    = Validation runtime
Fitting model: LightGBMLarge ... Training model for up to 126.46s of the 126.46s of remaining time.
    0.7153   = Validation score   (roc_auc)
    1.44s    = Training   runtime
    0.06s    = Validation runtime
Fitting model: WeightedEnsemble_L2 ... Training model for up to 269.65s of the 124.92s of remaining time.
    Ensemble Weights: {'CatBoost': 0.333, 'XGBoost': 0.333, 'LightGBM': 0.25, 'LightGBMLarge': 0.083}
    0.72     = Validation score   (roc_auc)
    0.97s    = Training   runtime
    0.0s     = Validation runtime
AutoGluon training complete, total runtime = 146.23s ... Best model: WeightedEnsemble_L2 | Estimated inference throughput: 362893.5 rows/s (53763 batch size)
TabularPredictor saved. To load, use: predictor = TabularPredictor.load("C:\Users\chiuw\IML4Finance\Lectures\Lab01_ag_models_EmbeddedMethod")</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="74">
<style>#sk-container-id-4 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-4 {
  color: var(--sklearn-color-text);
}

#sk-container-id-4 pre {
  padding: 0;
}

#sk-container-id-4 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-4 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-4 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-4 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-4 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-4 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-4 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-4 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-4 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-4 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-4 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-4 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-4 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-4 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-4 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-4 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-4 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-4 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-4 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-4 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-4 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-4 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-4 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-4 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-4 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-4 div.sk-label label.sk-toggleable__label,
#sk-container-id-4 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-4 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-4 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-4 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-4 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-4 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-4 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-4 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-4 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-4 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-4 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-4 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-4 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-4" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[('replace_values',
                 FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                ('ordinal_encoder',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('ordinalencoder',
                                                  OrdinalEncoder(),
                                                  &lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A87D36850&gt;)])),
                ('feature_selection',
                 SelectFromModel(estimator=...ntropy',
                                                                max_depth=3,
                                                                n_jobs=7,
                                                                random_state=2025),
                                 threshold=0.01)),
                ('autogluon',
                 AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN',
                                                                            'NN_TORCH'],
                                                   'holdout_frac': 0.2,
                                                   'presets': 'medium_quality',
                                                   'time_limit': 270.0},
                                         label='response_flag',
                                         predictor_args={'eval_metric': 'roc_auc',
                                                         'path': 'Lab01_ag_models_EmbeddedMethod',
                                                         'problem_type': 'binary'}))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-17" type="checkbox"><label for="sk-estimator-id-17" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;&nbsp;Pipeline<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.pipeline.Pipeline.html">?<span>Documentation for Pipeline</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>Pipeline(steps=[('replace_values',
                 FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                ('ordinal_encoder',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('ordinalencoder',
                                                  OrdinalEncoder(),
                                                  &lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A87D36850&gt;)])),
                ('feature_selection',
                 SelectFromModel(estimator=...ntropy',
                                                                max_depth=3,
                                                                n_jobs=7,
                                                                random_state=2025),
                                 threshold=0.01)),
                ('autogluon',
                 AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN',
                                                                            'NN_TORCH'],
                                                   'holdout_frac': 0.2,
                                                   'presets': 'medium_quality',
                                                   'time_limit': 270.0},
                                         label='response_flag',
                                         predictor_args={'eval_metric': 'roc_auc',
                                                         'path': 'Lab01_ag_models_EmbeddedMethod',
                                                         'problem_type': 'binary'}))])</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-18" type="checkbox"><label for="sk-estimator-id-18" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;FunctionTransformer<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.preprocessing.FunctionTransformer.html">?<span>Documentation for FunctionTransformer</span></a></label><div class="sk-toggleable__content fitted"><pre>FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)</pre></div> </div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-19" type="checkbox"><label for="sk-estimator-id-19" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;ordinal_encoder: ColumnTransformer<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.compose.ColumnTransformer.html">?<span>Documentation for ordinal_encoder: ColumnTransformer</span></a></label><div class="sk-toggleable__content fitted"><pre>ColumnTransformer(remainder='passthrough',
                  transformers=[('ordinalencoder', OrdinalEncoder(),
                                 &lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A87D36850&gt;)])</pre></div> </div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-20" type="checkbox"><label for="sk-estimator-id-20" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">ordinalencoder</label><div class="sk-toggleable__content fitted"><pre>&lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A87D36850&gt;</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-21" type="checkbox"><label for="sk-estimator-id-21" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;OrdinalEncoder<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.preprocessing.OrdinalEncoder.html">?<span>Documentation for OrdinalEncoder</span></a></label><div class="sk-toggleable__content fitted"><pre>OrdinalEncoder()</pre></div> </div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-22" type="checkbox"><label for="sk-estimator-id-22" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">remainder</label><div class="sk-toggleable__content fitted"><pre>['time_since_recent_payment', 'time_since_first_deliquency', 'time_since_recent_deliquency', 'num_times_delinquent', 'max_delinquency_level', 'max_recent_level_of_deliq', 'num_deliq_6mts', 'num_deliq_12mts', 'num_deliq_6_12mts', 'max_deliq_6mts', 'max_deliq_12mts', 'num_times_30p_dpd', 'num_times_60p_dpd', 'num_std', 'num_std_6mts', 'num_std_12mts', 'num_sub', 'num_sub_6mts', 'num_sub_12mts', 'num_dbt', 'num_dbt_6mts', 'num_dbt_12mts', 'num_lss', 'num_lss_6mts', 'num_lss_12mts', 'recent_level_of_deliq', 'tot_enq', 'CC_enq', 'CC_enq_L6m', 'CC_enq_L12m', 'PL_enq', 'PL_enq_L6m', 'PL_enq_L12m', 'time_since_recent_enq', 'enq_L12m', 'enq_L6m', 'enq_L3m', 'NETMONTHLYINCOME', 'Time_With_Curr_Empr', 'pct_of_active_TLs_ever', 'pct_opened_TLs_L6m_of_L12m', 'pct_currentBal_all_TL', 'CC_utilization', 'CC_Flag', 'PL_utilization', 'PL_Flag', 'pct_PL_enq_L6m_of_L12m', 'pct_CC_enq_L6m_of_L12m', 'pct_PL_enq_L6m_of_ever', 'pct_CC_enq_L6m_of_ever', 'max_unsec_exposure_inPct', 'HL_Flag', 'GL_Flag', 'Credit_Score', 'Total_TL', 'Tot_Closed_TL', 'Tot_Active_TL', 'Total_TL_opened_L6M', 'Tot_TL_closed_L6M', 'pct_tl_open_L6M', 'pct_tl_closed_L6M', 'pct_active_tl', 'pct_closed_tl', 'Total_TL_opened_L12M', 'Tot_TL_closed_L12M', 'pct_tl_open_L12M', 'pct_tl_closed_L12M', 'Tot_Missed_Pmnt', 'Auto_TL', 'CC_TL', 'Consumer_TL', 'Gold_TL', 'Home_TL', 'PL_TL', 'Secured_TL', 'Unsecured_TL', 'Other_TL', 'Age_Oldest_TL', 'Age_Newest_TL']</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-23" type="checkbox"><label for="sk-estimator-id-23" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">passthrough</label><div class="sk-toggleable__content fitted"><pre>passthrough</pre></div> </div></div></div></div></div></div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-24" type="checkbox"><label for="sk-estimator-id-24" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;feature_selection: SelectFromModel<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.feature_selection.SelectFromModel.html">?<span>Documentation for feature_selection: SelectFromModel</span></a></label><div class="sk-toggleable__content fitted"><pre>SelectFromModel(estimator=ExtraTreesClassifier(criterion='entropy', max_depth=3,
                                               n_jobs=7, random_state=2025),
                threshold=0.01)</pre></div> </div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-25" type="checkbox"><label for="sk-estimator-id-25" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">estimator: ExtraTreesClassifier</label><div class="sk-toggleable__content fitted"><pre>ExtraTreesClassifier(criterion='entropy', max_depth=3, n_jobs=7,
                     random_state=2025)</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-26" type="checkbox"><label for="sk-estimator-id-26" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;ExtraTreesClassifier<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.ensemble.ExtraTreesClassifier.html">?<span>Documentation for ExtraTreesClassifier</span></a></label><div class="sk-toggleable__content fitted"><pre>ExtraTreesClassifier(criterion='entropy', max_depth=3, n_jobs=7,
                     random_state=2025)</pre></div> </div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-27" type="checkbox"><label for="sk-estimator-id-27" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">AutoGluonSklearnWrapper</label><div class="sk-toggleable__content fitted"><pre>AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN', 'NN_TORCH'],
                                  'holdout_frac': 0.2,
                                  'presets': 'medium_quality',
                                  'time_limit': 270.0},
                        label='response_flag',
                        predictor_args={'eval_metric': 'roc_auc',
                                        'path': 'Lab01_ag_models_EmbeddedMethod',
                                        'problem_type': 'binary'})</pre></div> </div></div></div></div></div></div>
</div>
</div>
<p>Check leaderboard using the test set.</p>
<div id="f8cd062e" class="cell" data-execution_count="75">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1"></a>preprocessed_test_data_embedded <span class="op">=</span> ag_model_embedded_method[:<span class="op">-</span><span class="dv">1</span>].transform(test_data_wide.drop(columns<span class="op">=</span>[label]))</span>
<span id="cb109-2"><a href="#cb109-2"></a>preprocessed_test_data_embedded[label] <span class="op">=</span> test_data_wide[label]</span>
<span id="cb109-3"><a href="#cb109-3"></a></span>
<span id="cb109-4"><a href="#cb109-4"></a>df_leaders_embedded_method <span class="op">=</span> ag_model_embedded_method.named_steps[<span class="st">'autogluon'</span>].predictor.leaderboard(preprocessed_test_data_embedded)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\chiuw\miniforge3\envs\env_iml4finance_2026\Lib\site-packages\fastai\learner.py:455: UserWarning:

load_learner` uses Python's insecure pickle module, which can execute malicious arbitrary code when loading. Only load files you trust.
If you only need to load model weights and optimizer state, use the safe `Learner.load` instead.
</code></pre>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="76">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1"></a>display(df_leaders_embedded_method)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-ag-leaderboard-embedded-method" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="76">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ag-leaderboard-embedded-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;18: Autogluon Leaderboard (Embedded Method)
</figcaption>
<div aria-describedby="tbl-ag-leaderboard-embedded-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">score_test</th>
<th data-quarto-table-cell-role="th">score_val</th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">pred_time_test</th>
<th data-quarto-table-cell-role="th">pred_time_val</th>
<th data-quarto-table-cell-role="th">fit_time</th>
<th data-quarto-table-cell-role="th">pred_time_test_marginal</th>
<th data-quarto-table-cell-role="th">pred_time_val_marginal</th>
<th data-quarto-table-cell-role="th">fit_time_marginal</th>
<th data-quarto-table-cell-role="th">stack_level</th>
<th data-quarto-table-cell-role="th">can_infer</th>
<th data-quarto-table-cell-role="th">fit_order</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>CatBoost</td>
<td>0.720119</td>
<td>0.718053</td>
<td>roc_auc</td>
<td>0.055235</td>
<td>0.006000</td>
<td>3.998330</td>
<td>0.055235</td>
<td>0.006000</td>
<td>3.998330</td>
<td>1</td>
<td>True</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>WeightedEnsemble_L2</td>
<td>0.719729</td>
<td>0.720039</td>
<td>roc_auc</td>
<td>0.294444</td>
<td>0.148151</td>
<td>14.899397</td>
<td>0.007509</td>
<td>0.003996</td>
<td>0.974444</td>
<td>2</td>
<td>True</td>
<td>11</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>LightGBMXT</td>
<td>0.719608</td>
<td>0.717409</td>
<td>roc_auc</td>
<td>0.065565</td>
<td>0.043264</td>
<td>0.862030</td>
<td>0.065565</td>
<td>0.043264</td>
<td>0.862030</td>
<td>1</td>
<td>True</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>NeuralNetFastAI</td>
<td>0.718933</td>
<td>0.717283</td>
<td>roc_auc</td>
<td>0.554340</td>
<td>0.212365</td>
<td>80.295736</td>
<td>0.554340</td>
<td>0.212365</td>
<td>80.295736</td>
<td>1</td>
<td>True</td>
<td>8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>XGBoost</td>
<td>0.718232</td>
<td>0.717625</td>
<td>roc_auc</td>
<td>0.078059</td>
<td>0.040533</td>
<td>7.663322</td>
<td>0.078059</td>
<td>0.040533</td>
<td>7.663322</td>
<td>1</td>
<td>True</td>
<td>9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>LightGBM</td>
<td>0.717891</td>
<td>0.718869</td>
<td>roc_auc</td>
<td>0.063059</td>
<td>0.037034</td>
<td>0.823213</td>
<td>0.063059</td>
<td>0.037034</td>
<td>0.823213</td>
<td>1</td>
<td>True</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>LightGBMLarge</td>
<td>0.714684</td>
<td>0.715336</td>
<td>roc_auc</td>
<td>0.090581</td>
<td>0.060588</td>
<td>1.440087</td>
<td>0.090581</td>
<td>0.060588</td>
<td>1.440087</td>
<td>1</td>
<td>True</td>
<td>10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>RandomForestEntr</td>
<td>0.641072</td>
<td>0.658545</td>
<td>roc_auc</td>
<td>0.670596</td>
<td>0.203558</td>
<td>12.777646</td>
<td>0.670596</td>
<td>0.203558</td>
<td>12.777646</td>
<td>1</td>
<td>True</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>RandomForestGini</td>
<td>0.640989</td>
<td>0.658138</td>
<td>roc_auc</td>
<td>0.668024</td>
<td>0.204787</td>
<td>13.190319</td>
<td>0.668024</td>
<td>0.204787</td>
<td>13.190319</td>
<td>1</td>
<td>True</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>ExtraTreesEntr</td>
<td>0.640861</td>
<td>0.658432</td>
<td>roc_auc</td>
<td>0.775148</td>
<td>0.236661</td>
<td>9.722812</td>
<td>0.775148</td>
<td>0.236661</td>
<td>9.722812</td>
<td>1</td>
<td>True</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>ExtraTreesGini</td>
<td>0.640847</td>
<td>0.658411</td>
<td>roc_auc</td>
<td>0.723736</td>
<td>0.247278</td>
<td>9.490252</td>
<td>0.723736</td>
<td>0.247278</td>
<td>9.490252</td>
<td>1</td>
<td>True</td>
<td>6</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>Check permutation feature importance on the test set.</p>
<div id="21e4d8d1" class="cell" data-execution_count="77">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1"></a>best_feature_importance_embedded <span class="op">=</span> (ag_model_embedded_method</span>
<span id="cb112-2"><a href="#cb112-2"></a>                            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb112-3"><a href="#cb112-3"></a>                            .predictor</span>
<span id="cb112-4"><a href="#cb112-4"></a>                            .feature_importance(</span>
<span id="cb112-5"><a href="#cb112-5"></a>                                    data <span class="op">=</span> preprocessed_test_data_embedded, </span>
<span id="cb112-6"><a href="#cb112-6"></a>                                    model <span class="op">=</span> best_model_name,</span>
<span id="cb112-7"><a href="#cb112-7"></a>                                    subsample_size <span class="op">=</span> <span class="va">None</span>)</span>
<span id="cb112-8"><a href="#cb112-8"></a>                        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Computing feature importance via permutation shuffling for 19 features using 115206 rows with 5 shuffle sets...
    2.85s   = Expected runtime (0.57s per shuffle set)
    3.23s   = Actual runtime (Completed 5 of 5 shuffle sets)</code></pre>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="78">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1"></a>display(best_feature_importance_embedded)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-perm-feature-importance-embedded-method" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="78">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-perm-feature-importance-embedded-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;19: Permutation Feature Importance (Embedded Method)
</figcaption>
<div aria-describedby="tbl-perm-feature-importance-embedded-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">importance</th>
<th data-quarto-table-cell-role="th">stddev</th>
<th data-quarto-table-cell-role="th">p_value</th>
<th data-quarto-table-cell-role="th">n</th>
<th data-quarto-table-cell-role="th">p99_high</th>
<th data-quarto-table-cell-role="th">p99_low</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__CC_utilization</td>
<td>0.033950</td>
<td>0.000779</td>
<td>3.319565e-08</td>
<td>5</td>
<td>0.035553</td>
<td>0.032347</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__PL_utilization</td>
<td>0.008997</td>
<td>0.002261</td>
<td>4.410034e-04</td>
<td>5</td>
<td>0.013652</td>
<td>0.004341</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__PL_enq_L6m</td>
<td>0.001748</td>
<td>0.000433</td>
<td>4.154747e-04</td>
<td>5</td>
<td>0.002639</td>
<td>0.000858</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__CC_enq_L6m</td>
<td>0.001714</td>
<td>0.000463</td>
<td>5.830631e-04</td>
<td>5</td>
<td>0.002668</td>
<td>0.000760</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__enq_L3m</td>
<td>0.001295</td>
<td>0.001301</td>
<td>4.506253e-02</td>
<td>5</td>
<td>0.003974</td>
<td>-0.001385</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__PL_Flag</td>
<td>0.001262</td>
<td>0.001500</td>
<td>6.647932e-02</td>
<td>5</td>
<td>0.004350</td>
<td>-0.001826</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__PL_enq_L12m</td>
<td>0.001072</td>
<td>0.000412</td>
<td>2.168635e-03</td>
<td>5</td>
<td>0.001919</td>
<td>0.000224</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__enq_L12m</td>
<td>0.001059</td>
<td>0.000438</td>
<td>2.842116e-03</td>
<td>5</td>
<td>0.001962</td>
<td>0.000156</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__pct_PL_enq_L6m_of_ever</td>
<td>0.001034</td>
<td>0.001238</td>
<td>6.769006e-02</td>
<td>5</td>
<td>0.003584</td>
<td>-0.001516</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__PL_enq</td>
<td>0.000891</td>
<td>0.000585</td>
<td>1.361296e-02</td>
<td>5</td>
<td>0.002096</td>
<td>-0.000315</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__pct_PL_enq_L6m_of_L12m</td>
<td>0.000660</td>
<td>0.000998</td>
<td>1.066201e-01</td>
<td>5</td>
<td>0.002716</td>
<td>-0.001395</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__enq_L6m</td>
<td>0.000596</td>
<td>0.000532</td>
<td>3.311858e-02</td>
<td>5</td>
<td>0.001691</td>
<td>-0.000498</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__tot_enq</td>
<td>0.000332</td>
<td>0.000620</td>
<td>1.484626e-01</td>
<td>5</td>
<td>0.001609</td>
<td>-0.000944</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__CC_enq_L12m</td>
<td>0.000264</td>
<td>0.000383</td>
<td>9.884905e-02</td>
<td>5</td>
<td>0.001053</td>
<td>-0.000524</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__CC_enq</td>
<td>0.000135</td>
<td>0.000387</td>
<td>2.397217e-01</td>
<td>5</td>
<td>0.000932</td>
<td>-0.000662</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__pct_CC_enq_L6m_of_ever</td>
<td>0.000028</td>
<td>0.000239</td>
<td>4.018126e-01</td>
<td>5</td>
<td>0.000520</td>
<td>-0.000463</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__CC_Flag</td>
<td>-0.000008</td>
<td>0.000784</td>
<td>5.086960e-01</td>
<td>5</td>
<td>0.001605</td>
<td>-0.001622</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__CC_TL</td>
<td>-0.000014</td>
<td>0.000836</td>
<td>5.141466e-01</td>
<td>5</td>
<td>0.001708</td>
<td>-0.001736</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__pct_CC_enq_L6m_of_L12m</td>
<td>-0.000193</td>
<td>0.000211</td>
<td>9.447788e-01</td>
<td>5</td>
<td>0.000242</td>
<td>-0.000629</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="wrapper-methods" class="level2" data-number="20.3">
<h2 data-number="20.3" class="anchored" data-anchor-id="wrapper-methods"><span class="header-section-number">20.3</span> Wrapper Methods</h2>
<p>Wrapper methods evaluate subsets of features by training models with different feature combinations using the same machine learning algorithm:</p>
<ul>
<li>Use the predictive performance of a model to evaluate feature subsets</li>
<li>Can capture feature interactions</li>
<li>Are computationally expensive</li>
<li>Examples: recursive feature elimination, forward/backward selection</li>
</ul>
<p>The chunk below creates a scikit-learn pipeline that uses forward selection (<code>SequentialFeatureSelector</code>) and <code>ExtraTreesClassifier</code> estimator to select the top features. The top features are then used to train an <code>autogluon</code> model.</p>
<div id="ce1a1ec1" class="cell" data-execution_count="79">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1"></a><span class="co"># remove ag folder if exists</span></span>
<span id="cb115-2"><a href="#cb115-2"></a>wrapper_model_folder <span class="op">=</span> <span class="st">'Lab01_ag_models_WrapperMethod'</span></span>
<span id="cb115-3"><a href="#cb115-3"></a>remove_ag_folder(wrapper_model_folder)</span>
<span id="cb115-4"><a href="#cb115-4"></a></span>
<span id="cb115-5"><a href="#cb115-5"></a>ag_model_wrapper_method <span class="op">=</span> Pipeline([</span>
<span id="cb115-6"><a href="#cb115-6"></a>    (<span class="st">'replace_values'</span>, FunctionTransformer(replace_vals)),</span>
<span id="cb115-7"><a href="#cb115-7"></a>    (<span class="st">'ordinal_encoder'</span>, make_column_transformer(</span>
<span id="cb115-8"><a href="#cb115-8"></a>        (OrdinalEncoder(), make_column_selector(dtype_include<span class="op">=</span>[<span class="st">"object"</span>, <span class="st">"category"</span>])),</span>
<span id="cb115-9"><a href="#cb115-9"></a>        remainder<span class="op">=</span><span class="st">'passthrough'</span></span>
<span id="cb115-10"><a href="#cb115-10"></a>    )),</span>
<span id="cb115-11"><a href="#cb115-11"></a>    (<span class="st">'feature_selection'</span>, SequentialFeatureSelector(</span>
<span id="cb115-12"><a href="#cb115-12"></a>        ExtraTreesClassifier(random_state<span class="op">=</span><span class="dv">2025</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>, max_depth<span class="op">=</span><span class="dv">3</span>, n_jobs<span class="op">=</span>num_jobs),</span>
<span id="cb115-13"><a href="#cb115-13"></a>    direction<span class="op">=</span><span class="st">'forward'</span>,</span>
<span id="cb115-14"><a href="#cb115-14"></a>    scoring<span class="op">=</span><span class="st">'roc_auc'</span>,</span>
<span id="cb115-15"><a href="#cb115-15"></a>    tol<span class="op">=</span><span class="fl">0.005</span>,</span>
<span id="cb115-16"><a href="#cb115-16"></a>    n_jobs<span class="op">=</span>num_jobs,</span>
<span id="cb115-17"><a href="#cb115-17"></a>    cv<span class="op">=</span><span class="dv">3</span></span>
<span id="cb115-18"><a href="#cb115-18"></a>    )),</span>
<span id="cb115-19"><a href="#cb115-19"></a>    (<span class="st">'autogluon'</span>, AutoGluonSklearnWrapper(label<span class="op">=</span>label,</span>
<span id="cb115-20"><a href="#cb115-20"></a>                                    predictor_args<span class="op">=</span>{<span class="st">'problem_type'</span>: <span class="st">'binary'</span>,</span>
<span id="cb115-21"><a href="#cb115-21"></a>                                                    <span class="st">'eval_metric'</span>: <span class="st">'roc_auc'</span>,</span>
<span id="cb115-22"><a href="#cb115-22"></a>                                                    <span class="st">'path'</span>: wrapper_model_folder},</span>
<span id="cb115-23"><a href="#cb115-23"></a>                                    fit_args<span class="op">=</span>{<span class="st">'holdout_frac'</span>: <span class="fl">0.2</span>,</span>
<span id="cb115-24"><a href="#cb115-24"></a>                                                <span class="st">'excluded_model_types'</span>: [<span class="st">'KNN'</span>, <span class="st">'NN_TORCH'</span>],</span>
<span id="cb115-25"><a href="#cb115-25"></a>                                                <span class="st">'presets'</span>: <span class="st">'medium_quality'</span>,</span>
<span id="cb115-26"><a href="#cb115-26"></a>                                                <span class="st">'time_limit'</span>: <span class="dv">180</span><span class="op">*</span><span class="fl">1.5</span>}))</span>
<span id="cb115-27"><a href="#cb115-27"></a>])</span>
<span id="cb115-28"><a href="#cb115-28"></a></span>
<span id="cb115-29"><a href="#cb115-29"></a>global_set_seed()</span>
<span id="cb115-30"><a href="#cb115-30"></a></span>
<span id="cb115-31"><a href="#cb115-31"></a>ag_model_wrapper_method.fit(</span>
<span id="cb115-32"><a href="#cb115-32"></a>    X<span class="op">=</span>train_data_wide.drop(columns<span class="op">=</span>[label] <span class="op">+</span> [<span class="st">'PROSPECTID'</span>, <span class="st">'campaign_id'</span>, <span class="st">'direct_mail_flag'</span>]),</span>
<span id="cb115-33"><a href="#cb115-33"></a>    y<span class="op">=</span>train_data_wide[label],</span>
<span id="cb115-34"><a href="#cb115-34"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Verbosity: 2 (Standard Logging)
=================== System Info ===================
AutoGluon Version:  1.2
Python Version:     3.11.14
Operating System:   Windows
Platform Machine:   AMD64
Platform Version:   10.0.26200
CPU Count:          20
Memory Avail:       17.21 GB / 31.75 GB (54.2%)
Disk Space Avail:   618.68 GB / 951.67 GB (65.0%)
===================================================
Presets specified: ['medium_quality']
Beginning AutoGluon training ... Time limit = 270s
AutoGluon will save models to "C:\Users\chiuw\IML4Finance\Lectures\Lab01_ag_models_WrapperMethod"
Train Data Rows:    268811
Train Data Columns: 4
Label Column:       response_flag
Problem Type:       binary
Preprocessing data ...
Selected class &lt;--&gt; label mapping:  class 1 = 1, class 0 = 0
Using Feature Generators to preprocess the data ...
Fitting AutoMLPipelineFeatureGenerator...
    Available Memory:                    17630.89 MB
    Train Data (Original)  Memory Usage: 8.20 MB (0.0% of available memory)
    Inferring data type of each feature based on column values. Set feature_metadata_in to manually specify special dtypes of the features.
    Stage 1 Generators:
        Fitting AsTypeFeatureGenerator...
    Stage 2 Generators:
        Fitting FillNaFeatureGenerator...
    Stage 3 Generators:
        Fitting IdentityFeatureGenerator...
    Stage 4 Generators:
        Fitting DropUniqueFeatureGenerator...
    Stage 5 Generators:
        Fitting DropDuplicatesFeatureGenerator...
    Types of features in original data (raw dtype, special dtypes):
        ('float', []) : 2 | ['remainder__CC_utilization', 'remainder__PL_utilization']
        ('int', [])   : 2 | ['remainder__CC_enq', 'remainder__PL_enq']
    Types of features in processed data (raw dtype, special dtypes):
        ('float', []) : 2 | ['remainder__CC_utilization', 'remainder__PL_utilization']
        ('int', [])   : 2 | ['remainder__CC_enq', 'remainder__PL_enq']
    0.2s = Fit runtime
    4 features in original data used to generate 4 features in processed data.
    Train Data (Processed) Memory Usage: 8.20 MB (0.0% of available memory)
Data preprocessing and feature engineering runtime = 0.21s ...
AutoGluon will gauge predictive performance using evaluation metric: 'roc_auc'
    This metric expects predicted probabilities rather than predicted class labels, so you'll need to use predict_proba() instead of predict()
    To change this, specify the eval_metric parameter of Predictor()
Automatically generating train/validation split with holdout_frac=0.2, Train Rows: 215048, Val Rows: 53763
User-specified model hyperparameters to be fit:
{
    'NN_TORCH': [{}],
    'GBM': [{'extra_trees': True, 'ag_args': {'name_suffix': 'XT'}}, {}, {'learning_rate': 0.03, 'num_leaves': 128, 'feature_fraction': 0.9, 'min_data_in_leaf': 3, 'ag_args': {'name_suffix': 'Large', 'priority': 0, 'hyperparameter_tune_kwargs': None}}],
    'CAT': [{}],
    'XGB': [{}],
    'FASTAI': [{}],
    'RF': [{'criterion': 'gini', 'ag_args': {'name_suffix': 'Gini', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'entropy', 'ag_args': {'name_suffix': 'Entr', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'squared_error', 'ag_args': {'name_suffix': 'MSE', 'problem_types': ['regression', 'quantile']}}],
    'XT': [{'criterion': 'gini', 'ag_args': {'name_suffix': 'Gini', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'entropy', 'ag_args': {'name_suffix': 'Entr', 'problem_types': ['binary', 'multiclass']}}, {'criterion': 'squared_error', 'ag_args': {'name_suffix': 'MSE', 'problem_types': ['regression', 'quantile']}}],
    'KNN': [{'weights': 'uniform', 'ag_args': {'name_suffix': 'Unif'}}, {'weights': 'distance', 'ag_args': {'name_suffix': 'Dist'}}],
}
Excluded models: ['NN_TORCH', 'KNN'] (Specified by `excluded_model_types`)
Fitting 10 L1 models, fit_strategy="sequential" ...
Fitting model: LightGBMXT ... Training model for up to 269.79s of the 269.79s of remaining time.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1000]  valid_set's binary_logloss: 0.186775
[2000]  valid_set's binary_logloss: 0.186373
[3000]  valid_set's binary_logloss: 0.186324
[4000]  valid_set's binary_logloss: 0.186345</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>    0.7147   = Validation score   (roc_auc)
    12.84s   = Training   runtime
    1.49s    = Validation runtime
Fitting model: LightGBM ... Training model for up to 255.22s of the 255.22s of remaining time.
    0.7146   = Validation score   (roc_auc)
    1.49s    = Training   runtime
    0.08s    = Validation runtime
Fitting model: RandomForestGini ... Training model for up to 253.60s of the 253.60s of remaining time.
    0.6736   = Validation score   (roc_auc)
    5.81s    = Training   runtime
    0.16s    = Validation runtime
Fitting model: RandomForestEntr ... Training model for up to 247.45s of the 247.45s of remaining time.
    0.6737   = Validation score   (roc_auc)
    5.66s    = Training   runtime
    0.15s    = Validation runtime
Fitting model: CatBoost ... Training model for up to 241.48s of the 241.47s of remaining time.
    0.7136   = Validation score   (roc_auc)
    38.65s   = Training   runtime
    0.01s    = Validation runtime
Fitting model: ExtraTreesGini ... Training model for up to 202.78s of the 202.77s of remaining time.
    0.6737   = Validation score   (roc_auc)
    3.68s    = Training   runtime
    0.15s    = Validation runtime
Fitting model: ExtraTreesEntr ... Training model for up to 198.69s of the 198.69s of remaining time.
    0.6737   = Validation score   (roc_auc)
    3.66s    = Training   runtime
    0.15s    = Validation runtime
Fitting model: NeuralNetFastAI ... Training model for up to 194.41s of the 194.41s of remaining time.
C:\Users\chiuw\miniforge3\envs\env_iml4finance_2026\Lib\site-packages\autogluon\tabular\models\fastainn\tabular_nn_fastai.py:228: UserWarning:

Cannot set number of intraop threads after parallel work has started or after set_num_threads call when using native parallel backend (Triggered internally at C:\bld\libtorch_1741563144345\work\aten\src\ATen\ParallelNative.cpp:228.)

    0.7146   = Validation score   (roc_auc)
    78.22s   = Training   runtime
    0.19s    = Validation runtime
Fitting model: XGBoost ... Training model for up to 115.91s of the 115.91s of remaining time.
    0.7136   = Validation score   (roc_auc)
    2.2s     = Training   runtime
    0.05s    = Validation runtime
Fitting model: LightGBMLarge ... Training model for up to 113.63s of the 113.63s of remaining time.
    0.7132   = Validation score   (roc_auc)
    1.47s    = Training   runtime
    0.04s    = Validation runtime
Fitting model: WeightedEnsemble_L2 ... Training model for up to 269.79s of the 112.07s of remaining time.
    Ensemble Weights: {'LightGBMXT': 0.455, 'NeuralNetFastAI': 0.364, 'CatBoost': 0.182}
    0.7162   = Validation score   (roc_auc)
    0.81s    = Training   runtime
    0.0s     = Validation runtime
AutoGluon training complete, total runtime = 158.87s ... Best model: WeightedEnsemble_L2 | Estimated inference throughput: 31727.3 rows/s (53763 batch size)
TabularPredictor saved. To load, use: predictor = TabularPredictor.load("C:\Users\chiuw\IML4Finance\Lectures\Lab01_ag_models_WrapperMethod")</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="79">
<style>#sk-container-id-5 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-5 {
  color: var(--sklearn-color-text);
}

#sk-container-id-5 pre {
  padding: 0;
}

#sk-container-id-5 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-5 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-5 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-5 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-5 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-5 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-5 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-5 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-5 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-5 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-5 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-5 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-5 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-5 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-5 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-5 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-5 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-5 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-5 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-5 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-5 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-5 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-5 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-5 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-5 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-5 div.sk-label label.sk-toggleable__label,
#sk-container-id-5 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-5 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-5 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-5 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-5 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-5 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-5 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-5 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-5 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-5 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-5 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-5 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-5 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-5" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[('replace_values',
                 FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                ('ordinal_encoder',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('ordinalencoder',
                                                  OrdinalEncoder(),
                                                  &lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A4165AA50&gt;)])),
                ('feature_selection',
                 SequentialFeatureSelector(...
                                                                          n_jobs=7,
                                                                          random_state=2025),
                                           n_jobs=7, scoring='roc_auc',
                                           tol=0.005)),
                ('autogluon',
                 AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN',
                                                                            'NN_TORCH'],
                                                   'holdout_frac': 0.2,
                                                   'presets': 'medium_quality',
                                                   'time_limit': 270.0},
                                         label='response_flag',
                                         predictor_args={'eval_metric': 'roc_auc',
                                                         'path': 'Lab01_ag_models_WrapperMethod',
                                                         'problem_type': 'binary'}))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-28" type="checkbox"><label for="sk-estimator-id-28" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;&nbsp;Pipeline<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.pipeline.Pipeline.html">?<span>Documentation for Pipeline</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>Pipeline(steps=[('replace_values',
                 FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)),
                ('ordinal_encoder',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('ordinalencoder',
                                                  OrdinalEncoder(),
                                                  &lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A4165AA50&gt;)])),
                ('feature_selection',
                 SequentialFeatureSelector(...
                                                                          n_jobs=7,
                                                                          random_state=2025),
                                           n_jobs=7, scoring='roc_auc',
                                           tol=0.005)),
                ('autogluon',
                 AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN',
                                                                            'NN_TORCH'],
                                                   'holdout_frac': 0.2,
                                                   'presets': 'medium_quality',
                                                   'time_limit': 270.0},
                                         label='response_flag',
                                         predictor_args={'eval_metric': 'roc_auc',
                                                         'path': 'Lab01_ag_models_WrapperMethod',
                                                         'problem_type': 'binary'}))])</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-29" type="checkbox"><label for="sk-estimator-id-29" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;FunctionTransformer<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.preprocessing.FunctionTransformer.html">?<span>Documentation for FunctionTransformer</span></a></label><div class="sk-toggleable__content fitted"><pre>FunctionTransformer(func=&lt;function replace_vals at 0x0000028A40BEFBA0&gt;)</pre></div> </div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-30" type="checkbox"><label for="sk-estimator-id-30" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;ordinal_encoder: ColumnTransformer<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.compose.ColumnTransformer.html">?<span>Documentation for ordinal_encoder: ColumnTransformer</span></a></label><div class="sk-toggleable__content fitted"><pre>ColumnTransformer(remainder='passthrough',
                  transformers=[('ordinalencoder', OrdinalEncoder(),
                                 &lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A4165AA50&gt;)])</pre></div> </div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-31" type="checkbox"><label for="sk-estimator-id-31" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">ordinalencoder</label><div class="sk-toggleable__content fitted"><pre>&lt;sklearn.compose._column_transformer.make_column_selector object at 0x0000028A4165AA50&gt;</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-32" type="checkbox"><label for="sk-estimator-id-32" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;OrdinalEncoder<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.preprocessing.OrdinalEncoder.html">?<span>Documentation for OrdinalEncoder</span></a></label><div class="sk-toggleable__content fitted"><pre>OrdinalEncoder()</pre></div> </div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-33" type="checkbox"><label for="sk-estimator-id-33" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">remainder</label><div class="sk-toggleable__content fitted"><pre>['time_since_recent_payment', 'time_since_first_deliquency', 'time_since_recent_deliquency', 'num_times_delinquent', 'max_delinquency_level', 'max_recent_level_of_deliq', 'num_deliq_6mts', 'num_deliq_12mts', 'num_deliq_6_12mts', 'max_deliq_6mts', 'max_deliq_12mts', 'num_times_30p_dpd', 'num_times_60p_dpd', 'num_std', 'num_std_6mts', 'num_std_12mts', 'num_sub', 'num_sub_6mts', 'num_sub_12mts', 'num_dbt', 'num_dbt_6mts', 'num_dbt_12mts', 'num_lss', 'num_lss_6mts', 'num_lss_12mts', 'recent_level_of_deliq', 'tot_enq', 'CC_enq', 'CC_enq_L6m', 'CC_enq_L12m', 'PL_enq', 'PL_enq_L6m', 'PL_enq_L12m', 'time_since_recent_enq', 'enq_L12m', 'enq_L6m', 'enq_L3m', 'NETMONTHLYINCOME', 'Time_With_Curr_Empr', 'pct_of_active_TLs_ever', 'pct_opened_TLs_L6m_of_L12m', 'pct_currentBal_all_TL', 'CC_utilization', 'CC_Flag', 'PL_utilization', 'PL_Flag', 'pct_PL_enq_L6m_of_L12m', 'pct_CC_enq_L6m_of_L12m', 'pct_PL_enq_L6m_of_ever', 'pct_CC_enq_L6m_of_ever', 'max_unsec_exposure_inPct', 'HL_Flag', 'GL_Flag', 'Credit_Score', 'Total_TL', 'Tot_Closed_TL', 'Tot_Active_TL', 'Total_TL_opened_L6M', 'Tot_TL_closed_L6M', 'pct_tl_open_L6M', 'pct_tl_closed_L6M', 'pct_active_tl', 'pct_closed_tl', 'Total_TL_opened_L12M', 'Tot_TL_closed_L12M', 'pct_tl_open_L12M', 'pct_tl_closed_L12M', 'Tot_Missed_Pmnt', 'Auto_TL', 'CC_TL', 'Consumer_TL', 'Gold_TL', 'Home_TL', 'PL_TL', 'Secured_TL', 'Unsecured_TL', 'Other_TL', 'Age_Oldest_TL', 'Age_Newest_TL']</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-34" type="checkbox"><label for="sk-estimator-id-34" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">passthrough</label><div class="sk-toggleable__content fitted"><pre>passthrough</pre></div> </div></div></div></div></div></div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-35" type="checkbox"><label for="sk-estimator-id-35" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;feature_selection: SequentialFeatureSelector<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.feature_selection.SequentialFeatureSelector.html">?<span>Documentation for feature_selection: SequentialFeatureSelector</span></a></label><div class="sk-toggleable__content fitted"><pre>SequentialFeatureSelector(cv=3,
                          estimator=ExtraTreesClassifier(criterion='entropy',
                                                         max_depth=3, n_jobs=7,
                                                         random_state=2025),
                          n_jobs=7, scoring='roc_auc', tol=0.005)</pre></div> </div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-36" type="checkbox"><label for="sk-estimator-id-36" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">estimator: ExtraTreesClassifier</label><div class="sk-toggleable__content fitted"><pre>ExtraTreesClassifier(criterion='entropy', max_depth=3, n_jobs=7,
                     random_state=2025)</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-37" type="checkbox"><label for="sk-estimator-id-37" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;ExtraTreesClassifier<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.ensemble.ExtraTreesClassifier.html">?<span>Documentation for ExtraTreesClassifier</span></a></label><div class="sk-toggleable__content fitted"><pre>ExtraTreesClassifier(criterion='entropy', max_depth=3, n_jobs=7,
                     random_state=2025)</pre></div> </div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-38" type="checkbox"><label for="sk-estimator-id-38" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">AutoGluonSklearnWrapper</label><div class="sk-toggleable__content fitted"><pre>AutoGluonSklearnWrapper(fit_args={'excluded_model_types': ['KNN', 'NN_TORCH'],
                                  'holdout_frac': 0.2,
                                  'presets': 'medium_quality',
                                  'time_limit': 270.0},
                        label='response_flag',
                        predictor_args={'eval_metric': 'roc_auc',
                                        'path': 'Lab01_ag_models_WrapperMethod',
                                        'problem_type': 'binary'})</pre></div> </div></div></div></div></div></div>
</div>
</div>
<p>Check leaderboard using the test set.</p>
<div id="6e268477" class="cell" data-execution_count="80">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1"></a>preprocessed_test_data_wrapper <span class="op">=</span> ag_model_wrapper_method[:<span class="op">-</span><span class="dv">1</span>].transform(test_data_wide.drop(columns<span class="op">=</span>[label] <span class="op">+</span> [<span class="st">'PROSPECTID'</span>, <span class="st">'campaign_id'</span>, <span class="st">'direct_mail_flag'</span>]))</span>
<span id="cb119-2"><a href="#cb119-2"></a>preprocessed_test_data_wrapper[label] <span class="op">=</span> test_data_wide[label]</span>
<span id="cb119-3"><a href="#cb119-3"></a></span>
<span id="cb119-4"><a href="#cb119-4"></a>df_leaders_wrapper_method <span class="op">=</span> ag_model_wrapper_method.named_steps[<span class="st">'autogluon'</span>].predictor.leaderboard(preprocessed_test_data_wrapper)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\chiuw\miniforge3\envs\env_iml4finance_2026\Lib\site-packages\fastai\learner.py:455: UserWarning:

load_learner` uses Python's insecure pickle module, which can execute malicious arbitrary code when loading. Only load files you trust.
If you only need to load model weights and optimizer state, use the safe `Learner.load` instead.
</code></pre>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="81">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1"></a>display(df_leaders_wrapper_method)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-ag-leaderboard-wrapper-method" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="81">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ag-leaderboard-wrapper-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;20: Autogluon Leaderboard (Wrapper Method)
</figcaption>
<div aria-describedby="tbl-ag-leaderboard-wrapper-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">score_test</th>
<th data-quarto-table-cell-role="th">score_val</th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">pred_time_test</th>
<th data-quarto-table-cell-role="th">pred_time_val</th>
<th data-quarto-table-cell-role="th">fit_time</th>
<th data-quarto-table-cell-role="th">pred_time_test_marginal</th>
<th data-quarto-table-cell-role="th">pred_time_val_marginal</th>
<th data-quarto-table-cell-role="th">fit_time_marginal</th>
<th data-quarto-table-cell-role="th">stack_level</th>
<th data-quarto-table-cell-role="th">can_infer</th>
<th data-quarto-table-cell-role="th">fit_order</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>NeuralNetFastAI</td>
<td>0.716058</td>
<td>0.714642</td>
<td>roc_auc</td>
<td>0.530353</td>
<td>0.191592</td>
<td>78.218460</td>
<td>0.530353</td>
<td>0.191592</td>
<td>78.218460</td>
<td>1</td>
<td>True</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>WeightedEnsemble_L2</td>
<td>0.715977</td>
<td>0.716173</td>
<td>roc_auc</td>
<td>3.747617</td>
<td>1.694535</td>
<td>130.511111</td>
<td>0.006000</td>
<td>0.002996</td>
<td>0.809701</td>
<td>2</td>
<td>True</td>
<td>11</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>LightGBM</td>
<td>0.715426</td>
<td>0.714604</td>
<td>roc_auc</td>
<td>0.178691</td>
<td>0.080085</td>
<td>1.488037</td>
<td>0.178691</td>
<td>0.080085</td>
<td>1.488037</td>
<td>1</td>
<td>True</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>LightGBMLarge</td>
<td>0.714423</td>
<td>0.713207</td>
<td>roc_auc</td>
<td>0.090094</td>
<td>0.042032</td>
<td>1.472047</td>
<td>0.090094</td>
<td>0.042032</td>
<td>1.472047</td>
<td>1</td>
<td>True</td>
<td>10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>LightGBMXT</td>
<td>0.713640</td>
<td>0.714709</td>
<td>roc_auc</td>
<td>3.154645</td>
<td>1.488947</td>
<td>12.836679</td>
<td>3.154645</td>
<td>1.488947</td>
<td>12.836679</td>
<td>1</td>
<td>True</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>CatBoost</td>
<td>0.713377</td>
<td>0.713649</td>
<td>roc_auc</td>
<td>0.056619</td>
<td>0.011000</td>
<td>38.646271</td>
<td>0.056619</td>
<td>0.011000</td>
<td>38.646271</td>
<td>1</td>
<td>True</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>XGBoost</td>
<td>0.712255</td>
<td>0.713619</td>
<td>roc_auc</td>
<td>0.099571</td>
<td>0.050549</td>
<td>2.204111</td>
<td>0.099571</td>
<td>0.050549</td>
<td>2.204111</td>
<td>1</td>
<td>True</td>
<td>9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>RandomForestEntr</td>
<td>0.665614</td>
<td>0.673709</td>
<td>roc_auc</td>
<td>0.399739</td>
<td>0.147899</td>
<td>5.659458</td>
<td>0.399739</td>
<td>0.147899</td>
<td>5.659458</td>
<td>1</td>
<td>True</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>ExtraTreesGini</td>
<td>0.665580</td>
<td>0.673681</td>
<td>roc_auc</td>
<td>0.422422</td>
<td>0.149507</td>
<td>3.683177</td>
<td>0.422422</td>
<td>0.149507</td>
<td>3.683177</td>
<td>1</td>
<td>True</td>
<td>6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>RandomForestGini</td>
<td>0.665566</td>
<td>0.673578</td>
<td>roc_auc</td>
<td>0.407080</td>
<td>0.155230</td>
<td>5.812095</td>
<td>0.407080</td>
<td>0.155230</td>
<td>5.812095</td>
<td>1</td>
<td>True</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>ExtraTreesEntr</td>
<td>0.665319</td>
<td>0.673693</td>
<td>roc_auc</td>
<td>0.397114</td>
<td>0.146412</td>
<td>3.660611</td>
<td>0.397114</td>
<td>0.146412</td>
<td>3.660611</td>
<td>1</td>
<td>True</td>
<td>7</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>Check permutation feature importance on the test set.</p>
<div id="b71cbb1a" class="cell" data-execution_count="82">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1"></a>best_feature_importance_wrapper <span class="op">=</span> (ag_model_wrapper_method</span>
<span id="cb122-2"><a href="#cb122-2"></a>                            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb122-3"><a href="#cb122-3"></a>                            .predictor</span>
<span id="cb122-4"><a href="#cb122-4"></a>                            .feature_importance(</span>
<span id="cb122-5"><a href="#cb122-5"></a>                                    data <span class="op">=</span> preprocessed_test_data_wrapper, </span>
<span id="cb122-6"><a href="#cb122-6"></a>                                    model <span class="op">=</span> best_model_name,</span>
<span id="cb122-7"><a href="#cb122-7"></a>                                    subsample_size <span class="op">=</span> <span class="va">None</span>)</span>
<span id="cb122-8"><a href="#cb122-8"></a>                        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Computing feature importance via permutation shuffling for 4 features using 115206 rows with 5 shuffle sets...
    0.85s   = Expected runtime (0.17s per shuffle set)
    0.7s    = Actual runtime (Completed 5 of 5 shuffle sets)</code></pre>
</div>
</div>
<div class="cell" data-tbl-number="true" data-execution_count="83">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1"></a>display(best_feature_importance_wrapper)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-perm-feature-importance-wrapper-method" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-number="true" data-execution_count="83">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-perm-feature-importance-wrapper-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;21: Permutation Feature Importance (Wrapper Method)
</figcaption>
<div aria-describedby="tbl-perm-feature-importance-wrapper-method-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">importance</th>
<th data-quarto-table-cell-role="th">stddev</th>
<th data-quarto-table-cell-role="th">p_value</th>
<th data-quarto-table-cell-role="th">n</th>
<th data-quarto-table-cell-role="th">p99_high</th>
<th data-quarto-table-cell-role="th">p99_low</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__CC_utilization</td>
<td>0.036414</td>
<td>0.001404</td>
<td>2.647194e-07</td>
<td>5</td>
<td>0.039305</td>
<td>0.033523</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__PL_enq</td>
<td>0.024591</td>
<td>0.001298</td>
<td>9.275409e-07</td>
<td>5</td>
<td>0.027263</td>
<td>0.021919</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">remainder__CC_enq</td>
<td>0.012435</td>
<td>0.001160</td>
<td>8.996076e-06</td>
<td>5</td>
<td>0.014824</td>
<td>0.010045</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">remainder__PL_utilization</td>
<td>0.011548</td>
<td>0.002096</td>
<td>1.248269e-04</td>
<td>5</td>
<td>0.015864</td>
<td>0.007231</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb125" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb125-1"><a href="#cb125-1"></a><span class="co">---</span></span>
<span id="cb125-2"><a href="#cb125-2"></a><span class="an">title:</span><span class="co"> "Lab 01: Prescreening Model"</span></span>
<span id="cb125-3"><a href="#cb125-3"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb125-4"><a href="#cb125-4"></a><span class="co">    html:</span></span>
<span id="cb125-5"><a href="#cb125-5"></a><span class="co">        toc: true</span></span>
<span id="cb125-6"><a href="#cb125-6"></a><span class="co">        code-fold: true</span></span>
<span id="cb125-7"><a href="#cb125-7"></a><span class="co">        code-tools: true</span></span>
<span id="cb125-8"><a href="#cb125-8"></a><span class="co">        code-line-numbers: true</span></span>
<span id="cb125-9"><a href="#cb125-9"></a><span class="co">        page-layout: full</span></span>
<span id="cb125-10"><a href="#cb125-10"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb125-11"><a href="#cb125-11"></a><span class="co">---</span></span>
<span id="cb125-12"><a href="#cb125-12"></a></span>
<span id="cb125-13"><a href="#cb125-13"></a><span class="fu"># Import Python Libraries</span></span>
<span id="cb125-14"><a href="#cb125-14"></a></span>
<span id="cb125-17"><a href="#cb125-17"></a><span class="in">```{python}</span></span>
<span id="cb125-18"><a href="#cb125-18"></a><span class="co"># System utilities</span></span>
<span id="cb125-19"><a href="#cb125-19"></a><span class="im">import</span> os</span>
<span id="cb125-20"><a href="#cb125-20"></a><span class="im">import</span> shutil</span>
<span id="cb125-21"><a href="#cb125-21"></a><span class="im">import</span> random</span>
<span id="cb125-22"><a href="#cb125-22"></a><span class="im">import</span> torch</span>
<span id="cb125-23"><a href="#cb125-23"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb125-24"><a href="#cb125-24"></a><span class="im">import</span> psutil</span>
<span id="cb125-25"><a href="#cb125-25"></a></span>
<span id="cb125-26"><a href="#cb125-26"></a><span class="co"># Set n_jobs to half the number of physical cores</span></span>
<span id="cb125-27"><a href="#cb125-27"></a>num_jobs <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">int</span>(psutil.cpu_count(logical<span class="op">=</span><span class="va">False</span>) <span class="op">/</span> <span class="dv">2</span>))</span>
<span id="cb125-28"><a href="#cb125-28"></a></span>
<span id="cb125-29"><a href="#cb125-29"></a><span class="co"># Data manipulation and visualization</span></span>
<span id="cb125-30"><a href="#cb125-30"></a><span class="im">import</span> duckdb</span>
<span id="cb125-31"><a href="#cb125-31"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb125-32"><a href="#cb125-32"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb125-33"><a href="#cb125-33"></a></span>
<span id="cb125-34"><a href="#cb125-34"></a><span class="co"># Machine learning - scikit-learn</span></span>
<span id="cb125-35"><a href="#cb125-35"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, ClassifierMixin, TransformerMixin</span>
<span id="cb125-36"><a href="#cb125-36"></a><span class="im">from</span> sklearn.utils.validation <span class="im">import</span> check_is_fitted, check_X_y, check_array</span>
<span id="cb125-37"><a href="#cb125-37"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb125-38"><a href="#cb125-38"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb125-39"><a href="#cb125-39"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> FunctionTransformer, OrdinalEncoder</span>
<span id="cb125-40"><a href="#cb125-40"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> CalibrationDisplay, CalibratedClassifierCV</span>
<span id="cb125-41"><a href="#cb125-41"></a><span class="im">from</span> sklearn.feature_selection <span class="im">import</span> SelectKBest, SelectFromModel, SequentialFeatureSelector, mutual_info_classif</span>
<span id="cb125-42"><a href="#cb125-42"></a><span class="im">from</span> sklearn.inspection <span class="im">import</span> PartialDependenceDisplay</span>
<span id="cb125-43"><a href="#cb125-43"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> make_column_transformer, make_column_selector</span>
<span id="cb125-44"><a href="#cb125-44"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> ExtraTreesClassifier</span>
<span id="cb125-45"><a href="#cb125-45"></a><span class="im">from</span> sklearn <span class="im">import</span> set_config</span>
<span id="cb125-46"><a href="#cb125-46"></a></span>
<span id="cb125-47"><a href="#cb125-47"></a><span class="co"># Specialized ML libraries</span></span>
<span id="cb125-48"><a href="#cb125-48"></a><span class="im">from</span> autogluon.tabular <span class="im">import</span> TabularPredictor, TabularDataset</span>
<span id="cb125-49"><a href="#cb125-49"></a><span class="im">from</span> ydata_profiling <span class="im">import</span> ProfileReport</span>
<span id="cb125-50"><a href="#cb125-50"></a><span class="im">from</span> scikitplot.metrics <span class="im">import</span> plot_cumulative_gain, plot_lift_curve</span>
<span id="cb125-51"><a href="#cb125-51"></a><span class="im">from</span> PyALE <span class="im">import</span> ale</span>
<span id="cb125-52"><a href="#cb125-52"></a><span class="in">```</span></span>
<span id="cb125-53"><a href="#cb125-53"></a></span>
<span id="cb125-54"><a href="#cb125-54"></a><span class="fu"># Read Data</span></span>
<span id="cb125-55"><a href="#cb125-55"></a></span>
<span id="cb125-56"><a href="#cb125-56"></a>Text and CSV files are common data formats in universities. However, in companies, data is often stored in databases (like SQL Server, PostgreSQL, Snowflake, or DataBricks).</span>
<span id="cb125-57"><a href="#cb125-57"></a></span>
<span id="cb125-58"><a href="#cb125-58"></a>In the lab, we will use the <span class="in">`duckdb`</span> library to process data as if we were using a database.</span>
<span id="cb125-59"><a href="#cb125-59"></a></span>
<span id="cb125-60"><a href="#cb125-60"></a>The code loads two parquet files into tables:</span>
<span id="cb125-61"><a href="#cb125-61"></a></span>
<span id="cb125-62"><a href="#cb125-62"></a><span class="ss">-   </span><span class="in">`prospects.parquet`</span>: Contains data about potential clients.</span>
<span id="cb125-63"><a href="#cb125-63"></a><span class="ss">-   </span><span class="in">`campaign_history.parquet`</span>: Contains data about past prescreening campaigns.</span>
<span id="cb125-64"><a href="#cb125-64"></a></span>
<span id="cb125-67"><a href="#cb125-67"></a><span class="in">```{python}</span></span>
<span id="cb125-68"><a href="#cb125-68"></a>tbl_prospects <span class="op">=</span> duckdb.query(<span class="st">"""</span></span>
<span id="cb125-69"><a href="#cb125-69"></a><span class="st">    SELECT *</span></span>
<span id="cb125-70"><a href="#cb125-70"></a><span class="st">    FROM '../Data/cibil/prospects.parquet'</span></span>
<span id="cb125-71"><a href="#cb125-71"></a><span class="st">    """</span>)</span>
<span id="cb125-72"><a href="#cb125-72"></a></span>
<span id="cb125-73"><a href="#cb125-73"></a>tbl_campaign_history <span class="op">=</span> duckdb.query(<span class="st">"""</span></span>
<span id="cb125-74"><a href="#cb125-74"></a><span class="st">    SELECT * </span></span>
<span id="cb125-75"><a href="#cb125-75"></a><span class="st">    FROM '../Data/cibil/campaign_history.parquet'</span></span>
<span id="cb125-76"><a href="#cb125-76"></a><span class="st">    """</span>)</span>
<span id="cb125-77"><a href="#cb125-77"></a><span class="in">```</span></span>
<span id="cb125-78"><a href="#cb125-78"></a></span>
<span id="cb125-79"><a href="#cb125-79"></a>Show the column names from <span class="in">`tbl_prospects`</span> and refer to the data dictionary (<span class="in">`../Data/cibil/Data Dictionary.xlsx`</span>) for column definitions.</span>
<span id="cb125-80"><a href="#cb125-80"></a></span>
<span id="cb125-83"><a href="#cb125-83"></a><span class="in">```{python}</span></span>
<span id="cb125-84"><a href="#cb125-84"></a><span class="co">#| label: tbl-meta-prospects</span></span>
<span id="cb125-85"><a href="#cb125-85"></a><span class="co">#| tbl-cap: "Metadata for tbl_prospects"</span></span>
<span id="cb125-86"><a href="#cb125-86"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-87"><a href="#cb125-87"></a></span>
<span id="cb125-88"><a href="#cb125-88"></a>duckdb.sql(<span class="st">"""</span></span>
<span id="cb125-89"><a href="#cb125-89"></a><span class="st">    SELECT column_name, column_type</span></span>
<span id="cb125-90"><a href="#cb125-90"></a><span class="st">    FROM</span></span>
<span id="cb125-91"><a href="#cb125-91"></a><span class="st">    (DESCRIBE SELECT * FROM tbl_prospects)</span></span>
<span id="cb125-92"><a href="#cb125-92"></a><span class="st">    """</span>).show(max_rows<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb125-93"><a href="#cb125-93"></a><span class="in">```</span></span>
<span id="cb125-94"><a href="#cb125-94"></a></span>
<span id="cb125-95"><a href="#cb125-95"></a>Show the column names from <span class="in">`tbl_campaign_history`</span>. The columns are defined as follows:</span>
<span id="cb125-96"><a href="#cb125-96"></a></span>
<span id="cb125-97"><a href="#cb125-97"></a><span class="ss">-   </span><span class="in">`PROSPECTID`</span>: Unique identifier for each potential client.</span>
<span id="cb125-98"><a href="#cb125-98"></a><span class="ss">-   </span><span class="in">`CAMPAIGNID`</span>: Unique identifier for each prescreening campaign. There are two historical campaigns and a current campaign (<span class="in">`campaign_id = '3'`</span>).</span>
<span id="cb125-99"><a href="#cb125-99"></a><span class="ss">-   </span><span class="in">`response_flag`</span>: Indicates whether the prospect responded to the campaign (1 for yes, 0 for no). For <span class="in">`campaign_id = '3'`</span>, the flag is <span class="in">`NULL`</span>.</span>
<span id="cb125-100"><a href="#cb125-100"></a><span class="ss">-   </span><span class="in">`direct_mail_flag`</span>: Indicates whether the prospect was targeted in the campaign (Y for yes, N for no). For <span class="in">`campaign_id = '3'`</span>, the flag is <span class="in">`NULL`</span>.</span>
<span id="cb125-101"><a href="#cb125-101"></a></span>
<span id="cb125-104"><a href="#cb125-104"></a><span class="in">```{python}</span></span>
<span id="cb125-105"><a href="#cb125-105"></a><span class="co">#| label: tbl-meta-campaigns</span></span>
<span id="cb125-106"><a href="#cb125-106"></a><span class="co">#| tbl-cap: "Metadata for tbl_campaign_history"</span></span>
<span id="cb125-107"><a href="#cb125-107"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-108"><a href="#cb125-108"></a></span>
<span id="cb125-109"><a href="#cb125-109"></a>duckdb.sql(<span class="st">"""</span></span>
<span id="cb125-110"><a href="#cb125-110"></a><span class="st">    SELECT column_name, column_type</span></span>
<span id="cb125-111"><a href="#cb125-111"></a><span class="st">    FROM</span></span>
<span id="cb125-112"><a href="#cb125-112"></a><span class="st">    (DESCRIBE SELECT * FROM tbl_campaign_history)</span></span>
<span id="cb125-113"><a href="#cb125-113"></a><span class="st">    """</span>).show()</span>
<span id="cb125-114"><a href="#cb125-114"></a><span class="in">```</span></span>
<span id="cb125-115"><a href="#cb125-115"></a></span>
<span id="cb125-116"><a href="#cb125-116"></a><span class="fu"># Peek at the Tables</span></span>
<span id="cb125-117"><a href="#cb125-117"></a></span>
<span id="cb125-118"><a href="#cb125-118"></a><span class="fu">## Data Checks</span></span>
<span id="cb125-119"><a href="#cb125-119"></a></span>
<span id="cb125-120"><a href="#cb125-120"></a>Look at the first 5 rows of each table.</span>
<span id="cb125-121"><a href="#cb125-121"></a></span>
<span id="cb125-124"><a href="#cb125-124"></a><span class="in">```{python}</span></span>
<span id="cb125-125"><a href="#cb125-125"></a><span class="co">#| label: tbl-top5-prospects</span></span>
<span id="cb125-126"><a href="#cb125-126"></a><span class="co">#| tbl-cap: "First 5 rows of tbl_prospects"</span></span>
<span id="cb125-127"><a href="#cb125-127"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-128"><a href="#cb125-128"></a></span>
<span id="cb125-129"><a href="#cb125-129"></a>duckdb.sql(<span class="st">"""</span></span>
<span id="cb125-130"><a href="#cb125-130"></a><span class="st">    SELECT *</span></span>
<span id="cb125-131"><a href="#cb125-131"></a><span class="st">    FROM tbl_prospects</span></span>
<span id="cb125-132"><a href="#cb125-132"></a><span class="st">    LIMIT 5</span></span>
<span id="cb125-133"><a href="#cb125-133"></a><span class="st">"""</span>).show()</span>
<span id="cb125-134"><a href="#cb125-134"></a><span class="in">```</span></span>
<span id="cb125-135"><a href="#cb125-135"></a></span>
<span id="cb125-138"><a href="#cb125-138"></a><span class="in">```{python}</span></span>
<span id="cb125-139"><a href="#cb125-139"></a><span class="co">#| label: tbl-top5-campaigns</span></span>
<span id="cb125-140"><a href="#cb125-140"></a><span class="co">#| tbl-cap: "First 5 rows of tbl_campaign_history"</span></span>
<span id="cb125-141"><a href="#cb125-141"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-142"><a href="#cb125-142"></a></span>
<span id="cb125-143"><a href="#cb125-143"></a>duckdb.sql(<span class="st">"""</span></span>
<span id="cb125-144"><a href="#cb125-144"></a><span class="st">    SELECT *</span></span>
<span id="cb125-145"><a href="#cb125-145"></a><span class="st">    FROM tbl_campaign_history</span></span>
<span id="cb125-146"><a href="#cb125-146"></a><span class="st">    LIMIT 5</span></span>
<span id="cb125-147"><a href="#cb125-147"></a><span class="st">"""</span>).show()</span>
<span id="cb125-148"><a href="#cb125-148"></a><span class="in">```</span></span>
<span id="cb125-149"><a href="#cb125-149"></a></span>
<span id="cb125-150"><a href="#cb125-150"></a>Aggregate the <span class="in">`tbl_campaign_history`</span> table to see how many prospects were targeted and responded to each campaign.</span>
<span id="cb125-151"><a href="#cb125-151"></a></span>
<span id="cb125-154"><a href="#cb125-154"></a><span class="in">```{python}</span></span>
<span id="cb125-155"><a href="#cb125-155"></a><span class="co">#| label: tbl-campaign-history</span></span>
<span id="cb125-156"><a href="#cb125-156"></a><span class="co">#| tbl-cap: "Campaign History"</span></span>
<span id="cb125-157"><a href="#cb125-157"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-158"><a href="#cb125-158"></a></span>
<span id="cb125-159"><a href="#cb125-159"></a>duckdb.sql(<span class="st">"""</span></span>
<span id="cb125-160"><a href="#cb125-160"></a><span class="st">    SELECT campaign_id, </span></span>
<span id="cb125-161"><a href="#cb125-161"></a><span class="st">            COUNT(*) AS num_prospects,</span></span>
<span id="cb125-162"><a href="#cb125-162"></a><span class="st">            SUM(CASE WHEN direct_mail_flag = 'Y'</span></span>
<span id="cb125-163"><a href="#cb125-163"></a><span class="st">            THEN 1 </span></span>
<span id="cb125-164"><a href="#cb125-164"></a><span class="st">            ELSE 0 END) AS num_direct_mails,</span></span>
<span id="cb125-165"><a href="#cb125-165"></a><span class="st">            SUM(CASE WHEN response_flag = 1 </span></span>
<span id="cb125-166"><a href="#cb125-166"></a><span class="st">            THEN 1 </span></span>
<span id="cb125-167"><a href="#cb125-167"></a><span class="st">            ELSE 0 END) AS num_responses</span></span>
<span id="cb125-168"><a href="#cb125-168"></a><span class="st">    FROM tbl_campaign_history</span></span>
<span id="cb125-169"><a href="#cb125-169"></a><span class="st">    GROUP BY campaign_id</span></span>
<span id="cb125-170"><a href="#cb125-170"></a><span class="st">    ORDER BY campaign_id</span></span>
<span id="cb125-171"><a href="#cb125-171"></a><span class="st">"""</span>).show()</span>
<span id="cb125-172"><a href="#cb125-172"></a><span class="in">```</span></span>
<span id="cb125-173"><a href="#cb125-173"></a></span>
<span id="cb125-174"><a href="#cb125-174"></a><span class="fu">## Q&amp;A</span></span>
<span id="cb125-175"><a href="#cb125-175"></a></span>
<span id="cb125-176"><a href="#cb125-176"></a><span class="fu">### Question</span></span>
<span id="cb125-177"><a href="#cb125-177"></a></span>
<span id="cb125-178"><a href="#cb125-178"></a>::: callout-note</span>
<span id="cb125-179"><a href="#cb125-179"></a>In campaign 1, what percentage of prospects were sent direct mail?</span>
<span id="cb125-180"><a href="#cb125-180"></a>:::</span>
<span id="cb125-181"><a href="#cb125-181"></a></span>
<span id="cb125-182"><a href="#cb125-182"></a><span class="fu">### Question</span></span>
<span id="cb125-183"><a href="#cb125-183"></a></span>
<span id="cb125-184"><a href="#cb125-184"></a>::: callout-note</span>
<span id="cb125-185"><a href="#cb125-185"></a>In campaign 1, what was the response rate among prospects who were sent direct mail?</span>
<span id="cb125-186"><a href="#cb125-186"></a>:::</span>
<span id="cb125-187"><a href="#cb125-187"></a></span>
<span id="cb125-188"><a href="#cb125-188"></a><span class="fu">### Question</span></span>
<span id="cb125-189"><a href="#cb125-189"></a></span>
<span id="cb125-190"><a href="#cb125-190"></a>::: callout-note</span>
<span id="cb125-191"><a href="#cb125-191"></a>Suppose the average cost of sending direct mail is \$7.00 per prospect. What was the total cost of campaign 1?</span>
<span id="cb125-192"><a href="#cb125-192"></a>:::</span>
<span id="cb125-193"><a href="#cb125-193"></a></span>
<span id="cb125-194"><a href="#cb125-194"></a><span class="fu">### Question</span></span>
<span id="cb125-195"><a href="#cb125-195"></a></span>
<span id="cb125-196"><a href="#cb125-196"></a>::: callout-note</span>
<span id="cb125-197"><a href="#cb125-197"></a>Suppose the average revenue from a response is \$100 per client. What was the total revenue of campaign 1?</span>
<span id="cb125-198"><a href="#cb125-198"></a>:::</span>
<span id="cb125-199"><a href="#cb125-199"></a></span>
<span id="cb125-200"><a href="#cb125-200"></a><span class="fu">### Question</span></span>
<span id="cb125-201"><a href="#cb125-201"></a></span>
<span id="cb125-202"><a href="#cb125-202"></a>::: callout-note</span>
<span id="cb125-203"><a href="#cb125-203"></a>The return on investment (ROI) of the campaign is:</span>
<span id="cb125-204"><a href="#cb125-204"></a></span>
<span id="cb125-205"><a href="#cb125-205"></a>$$ROI = \frac{TotalRevenue - TotalCost}{TotalCost} \times 100$$</span>
<span id="cb125-206"><a href="#cb125-206"></a></span>
<span id="cb125-207"><a href="#cb125-207"></a>What was the ROI of campaign 1?</span>
<span id="cb125-208"><a href="#cb125-208"></a>:::</span>
<span id="cb125-209"><a href="#cb125-209"></a></span>
<span id="cb125-210"><a href="#cb125-210"></a><span class="fu">### Question</span></span>
<span id="cb125-211"><a href="#cb125-211"></a></span>
<span id="cb125-212"><a href="#cb125-212"></a>::: callout-note</span>
<span id="cb125-213"><a href="#cb125-213"></a>What was the ROI of campaign 2?</span>
<span id="cb125-214"><a href="#cb125-214"></a>:::</span>
<span id="cb125-215"><a href="#cb125-215"></a></span>
<span id="cb125-216"><a href="#cb125-216"></a><span class="fu"># Merge the Tables</span></span>
<span id="cb125-217"><a href="#cb125-217"></a></span>
<span id="cb125-218"><a href="#cb125-218"></a>Merge the tables (<span class="in">`tbl_prospects`</span> and <span class="in">`tbl_campaign_history`</span>) to create a new table (<span class="in">`tbl_merged`</span>) that contains all columns from both tables. Use a left join to keep all rows from <span class="in">`tbl_prospects`</span>.</span>
<span id="cb125-219"><a href="#cb125-219"></a></span>
<span id="cb125-222"><a href="#cb125-222"></a><span class="in">```{python}</span></span>
<span id="cb125-223"><a href="#cb125-223"></a>tbl_merged <span class="op">=</span> duckdb.query(<span class="st">"""</span></span>
<span id="cb125-224"><a href="#cb125-224"></a><span class="st">    SELECT c.*, p.*</span></span>
<span id="cb125-225"><a href="#cb125-225"></a><span class="st">    FROM tbl_campaign_history AS c</span></span>
<span id="cb125-226"><a href="#cb125-226"></a><span class="st">    RIGHT JOIN tbl_prospects AS p</span></span>
<span id="cb125-227"><a href="#cb125-227"></a><span class="st">    ON p.prospectid = c.prospectid</span></span>
<span id="cb125-228"><a href="#cb125-228"></a><span class="st">    ORDER BY c.campaign_id, CAST(p.prospectid AS INT)</span></span>
<span id="cb125-229"><a href="#cb125-229"></a><span class="st">"""</span>)</span>
<span id="cb125-230"><a href="#cb125-230"></a><span class="in">```</span></span>
<span id="cb125-231"><a href="#cb125-231"></a></span>
<span id="cb125-232"><a href="#cb125-232"></a>Convert <span class="in">`tbl_merged`</span> to a Pandas DataFrame and display the first 5 rows.</span>
<span id="cb125-233"><a href="#cb125-233"></a></span>
<span id="cb125-236"><a href="#cb125-236"></a><span class="in">```{python}</span></span>
<span id="cb125-237"><a href="#cb125-237"></a>df_merged <span class="op">=</span> tbl_merged.to_df()</span>
<span id="cb125-238"><a href="#cb125-238"></a><span class="in">```</span></span>
<span id="cb125-239"><a href="#cb125-239"></a></span>
<span id="cb125-242"><a href="#cb125-242"></a><span class="in">```{python}</span></span>
<span id="cb125-243"><a href="#cb125-243"></a><span class="co">#| label: tbl-top5-merged</span></span>
<span id="cb125-244"><a href="#cb125-244"></a><span class="co">#| tbl-cap: "First 5 rows of df_merged"</span></span>
<span id="cb125-245"><a href="#cb125-245"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-246"><a href="#cb125-246"></a></span>
<span id="cb125-247"><a href="#cb125-247"></a>df_merged.head()</span>
<span id="cb125-248"><a href="#cb125-248"></a><span class="in">```</span></span>
<span id="cb125-249"><a href="#cb125-249"></a></span>
<span id="cb125-250"><a href="#cb125-250"></a>Remove the <span class="in">`PROSPECTID_1`</span> column from <span class="in">`df_merged`</span>.</span>
<span id="cb125-251"><a href="#cb125-251"></a></span>
<span id="cb125-254"><a href="#cb125-254"></a><span class="in">```{python}</span></span>
<span id="cb125-255"><a href="#cb125-255"></a>df_merged <span class="op">=</span> df_merged.drop(columns<span class="op">=</span>[<span class="st">'PROSPECTID_1'</span>])</span>
<span id="cb125-256"><a href="#cb125-256"></a><span class="in">```</span></span>
<span id="cb125-257"><a href="#cb125-257"></a></span>
<span id="cb125-258"><a href="#cb125-258"></a>Check the shapes of each data frame to ensure no rows were lost during the merge.</span>
<span id="cb125-259"><a href="#cb125-259"></a></span>
<span id="cb125-262"><a href="#cb125-262"></a><span class="in">```{python}</span></span>
<span id="cb125-263"><a href="#cb125-263"></a>display(tbl_prospects.shape)</span>
<span id="cb125-264"><a href="#cb125-264"></a></span>
<span id="cb125-265"><a href="#cb125-265"></a>display(tbl_campaign_history.shape)</span>
<span id="cb125-266"><a href="#cb125-266"></a></span>
<span id="cb125-267"><a href="#cb125-267"></a>display(df_merged.shape)</span>
<span id="cb125-268"><a href="#cb125-268"></a><span class="in">```</span></span>
<span id="cb125-269"><a href="#cb125-269"></a></span>
<span id="cb125-270"><a href="#cb125-270"></a><span class="fu"># Split the Data</span></span>
<span id="cb125-271"><a href="#cb125-271"></a></span>
<span id="cb125-272"><a href="#cb125-272"></a>Split the data by <span class="in">`campaign_id`</span> into three separate DataFrames: <span class="in">`df_campaign_1`</span>, <span class="in">`df_campaign_2`</span>, and <span class="in">`df_campaign_3`</span>.</span>
<span id="cb125-273"><a href="#cb125-273"></a></span>
<span id="cb125-276"><a href="#cb125-276"></a><span class="in">```{python}</span></span>
<span id="cb125-277"><a href="#cb125-277"></a>df_campaign_1 <span class="op">=</span> df_merged[df_merged[<span class="st">'campaign_id'</span>] <span class="op">==</span> <span class="st">'1'</span>].copy()</span>
<span id="cb125-278"><a href="#cb125-278"></a>df_campaign_2 <span class="op">=</span> df_merged[df_merged[<span class="st">'campaign_id'</span>] <span class="op">==</span> <span class="st">'2'</span>].copy()</span>
<span id="cb125-279"><a href="#cb125-279"></a>df_campaign_3 <span class="op">=</span> df_merged[df_merged[<span class="st">'campaign_id'</span>] <span class="op">==</span> <span class="st">'3'</span>].copy()</span>
<span id="cb125-280"><a href="#cb125-280"></a><span class="in">```</span></span>
<span id="cb125-281"><a href="#cb125-281"></a></span>
<span id="cb125-282"><a href="#cb125-282"></a>We will train the model only on <span class="in">`df_campaign_1`</span>. We evaluate the model using <span class="in">`df_campaign_2`</span> and <span class="in">`df_campaign_3`</span>.</span>
<span id="cb125-283"><a href="#cb125-283"></a></span>
<span id="cb125-284"><a href="#cb125-284"></a>Split <span class="in">`df_campaign_1`</span> into <span class="in">`df_campaign_1_train`</span> and <span class="in">`df_campaign_1_test`</span> using a 70/30 split.</span>
<span id="cb125-285"><a href="#cb125-285"></a></span>
<span id="cb125-288"><a href="#cb125-288"></a><span class="in">```{python}</span></span>
<span id="cb125-289"><a href="#cb125-289"></a>df_campaign_1_train, df_campaign_1_test <span class="op">=</span> train_test_split(</span>
<span id="cb125-290"><a href="#cb125-290"></a>    df_campaign_1,</span>
<span id="cb125-291"><a href="#cb125-291"></a>    test_size<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb125-292"><a href="#cb125-292"></a>    random_state<span class="op">=</span><span class="dv">2025</span>,</span>
<span id="cb125-293"><a href="#cb125-293"></a>    stratify<span class="op">=</span>df_campaign_1[<span class="st">'response_flag'</span>]</span>
<span id="cb125-294"><a href="#cb125-294"></a>)</span>
<span id="cb125-295"><a href="#cb125-295"></a><span class="in">```</span></span>
<span id="cb125-296"><a href="#cb125-296"></a></span>
<span id="cb125-299"><a href="#cb125-299"></a><span class="in">```{python}</span></span>
<span id="cb125-300"><a href="#cb125-300"></a>display(<span class="ss">f"Train data response rate: </span><span class="sc">{</span>df_campaign_1_train[<span class="st">'response_flag'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.3f}</span><span class="ss">%"</span>)</span>
<span id="cb125-301"><a href="#cb125-301"></a>display(<span class="ss">f"Test data response rate: </span><span class="sc">{</span>df_campaign_1_test[<span class="st">'response_flag'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.3f}</span><span class="ss">%"</span>)</span>
<span id="cb125-302"><a href="#cb125-302"></a><span class="in">```</span></span>
<span id="cb125-303"><a href="#cb125-303"></a></span>
<span id="cb125-304"><a href="#cb125-304"></a><span class="fu"># Exploratory Data Analysis</span></span>
<span id="cb125-305"><a href="#cb125-305"></a></span>
<span id="cb125-306"><a href="#cb125-306"></a>Use the <span class="in">`ydata_profiling`</span> library to compare <span class="in">`df_campaign_1_train`</span> and <span class="in">`df_campaign_1_test`</span>.</span>
<span id="cb125-307"><a href="#cb125-307"></a></span>
<span id="cb125-310"><a href="#cb125-310"></a><span class="in">```{python}</span></span>
<span id="cb125-311"><a href="#cb125-311"></a>p_frac <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb125-312"><a href="#cb125-312"></a></span>
<span id="cb125-313"><a href="#cb125-313"></a>train_data_profile <span class="op">=</span> ProfileReport(</span>
<span id="cb125-314"><a href="#cb125-314"></a>            df_campaign_1_train.sample(frac<span class="op">=</span>p_frac, random_state<span class="op">=</span><span class="dv">2025</span>), </span>
<span id="cb125-315"><a href="#cb125-315"></a>            title<span class="op">=</span><span class="st">"Train"</span>,</span>
<span id="cb125-316"><a href="#cb125-316"></a>            progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb125-317"><a href="#cb125-317"></a>            duplicates<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb125-318"><a href="#cb125-318"></a>            interactions<span class="op">=</span><span class="va">None</span></span>
<span id="cb125-319"><a href="#cb125-319"></a>            )</span>
<span id="cb125-320"><a href="#cb125-320"></a></span>
<span id="cb125-321"><a href="#cb125-321"></a>test_data_profile <span class="op">=</span> ProfileReport(</span>
<span id="cb125-322"><a href="#cb125-322"></a>            df_campaign_1_test.sample(frac<span class="op">=</span>p_frac, random_state<span class="op">=</span><span class="dv">2025</span>), </span>
<span id="cb125-323"><a href="#cb125-323"></a>            title<span class="op">=</span><span class="st">"Test"</span>,</span>
<span id="cb125-324"><a href="#cb125-324"></a>            progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb125-325"><a href="#cb125-325"></a>            duplicates<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb125-326"><a href="#cb125-326"></a>            interactions<span class="op">=</span><span class="va">None</span></span>
<span id="cb125-327"><a href="#cb125-327"></a>            )</span>
<span id="cb125-328"><a href="#cb125-328"></a></span>
<span id="cb125-329"><a href="#cb125-329"></a>compare_profile <span class="op">=</span> train_data_profile.compare(test_data_profile)</span>
<span id="cb125-330"><a href="#cb125-330"></a></span>
<span id="cb125-331"><a href="#cb125-331"></a>compare_profile.to_file(<span class="st">"Lab01_eda_report_ydata.html"</span>)</span>
<span id="cb125-332"><a href="#cb125-332"></a></span>
<span id="cb125-333"><a href="#cb125-333"></a><span class="co"># compare_profile.to_notebook_iframe()</span></span>
<span id="cb125-334"><a href="#cb125-334"></a><span class="in">```</span></span>
<span id="cb125-335"><a href="#cb125-335"></a></span>
<span id="cb125-336"><a href="#cb125-336"></a>Many of the columns contain a special value called <span class="in">`-99999`</span>.</span>
<span id="cb125-337"><a href="#cb125-337"></a></span>
<span id="cb125-338"><a href="#cb125-338"></a><span class="fu"># Replace -99999 with -1</span></span>
<span id="cb125-339"><a href="#cb125-339"></a></span>
<span id="cb125-340"><a href="#cb125-340"></a>Replace <span class="in">`-99999`</span> with <span class="in">`-1`</span> in the <span class="in">`df_campaign_1_train`</span> and <span class="in">`df_campaign_1_test`</span> data frames.</span>
<span id="cb125-341"><a href="#cb125-341"></a></span>
<span id="cb125-342"><a href="#cb125-342"></a>Leaving the special value untreated would *not* cause problems for the models, but would make the PDP and ALE plots difficult to interpret.</span>
<span id="cb125-343"><a href="#cb125-343"></a></span>
<span id="cb125-346"><a href="#cb125-346"></a><span class="in">```{python}</span></span>
<span id="cb125-347"><a href="#cb125-347"></a>df_campaign_1_train <span class="op">=</span> df_campaign_1_train.replace(<span class="op">-</span><span class="dv">99999</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb125-348"><a href="#cb125-348"></a>df_campaign_1_test <span class="op">=</span> df_campaign_1_test.replace(<span class="op">-</span><span class="dv">99999</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb125-349"><a href="#cb125-349"></a><span class="in">```</span></span>
<span id="cb125-350"><a href="#cb125-350"></a></span>
<span id="cb125-353"><a href="#cb125-353"></a><span class="in">```{python}</span></span>
<span id="cb125-354"><a href="#cb125-354"></a>train_data_profile_1 <span class="op">=</span> ProfileReport(</span>
<span id="cb125-355"><a href="#cb125-355"></a>            df_campaign_1_train.sample(frac<span class="op">=</span>p_frac, random_state<span class="op">=</span><span class="dv">2025</span>), </span>
<span id="cb125-356"><a href="#cb125-356"></a>            title<span class="op">=</span><span class="st">"Train"</span>,</span>
<span id="cb125-357"><a href="#cb125-357"></a>            progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb125-358"><a href="#cb125-358"></a>            duplicates<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb125-359"><a href="#cb125-359"></a>            interactions<span class="op">=</span><span class="va">None</span></span>
<span id="cb125-360"><a href="#cb125-360"></a>            )</span>
<span id="cb125-361"><a href="#cb125-361"></a></span>
<span id="cb125-362"><a href="#cb125-362"></a>test_data_profile_1 <span class="op">=</span> ProfileReport(</span>
<span id="cb125-363"><a href="#cb125-363"></a>            df_campaign_1_test.sample(frac<span class="op">=</span>p_frac, random_state<span class="op">=</span><span class="dv">2025</span>), </span>
<span id="cb125-364"><a href="#cb125-364"></a>            title<span class="op">=</span><span class="st">"Test"</span>,</span>
<span id="cb125-365"><a href="#cb125-365"></a>            progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb125-366"><a href="#cb125-366"></a>            duplicates<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb125-367"><a href="#cb125-367"></a>            interactions<span class="op">=</span><span class="va">None</span></span>
<span id="cb125-368"><a href="#cb125-368"></a>            )</span>
<span id="cb125-369"><a href="#cb125-369"></a></span>
<span id="cb125-370"><a href="#cb125-370"></a>compare_profile_1 <span class="op">=</span> train_data_profile_1.compare(test_data_profile_1)</span>
<span id="cb125-371"><a href="#cb125-371"></a></span>
<span id="cb125-372"><a href="#cb125-372"></a>compare_profile_1.to_file(<span class="st">"Lab01_eda_report_ydata_1.html"</span>)</span>
<span id="cb125-373"><a href="#cb125-373"></a></span>
<span id="cb125-374"><a href="#cb125-374"></a><span class="co"># compare_profile.to_notebook_iframe()</span></span>
<span id="cb125-375"><a href="#cb125-375"></a><span class="in">```</span></span>
<span id="cb125-376"><a href="#cb125-376"></a></span>
<span id="cb125-377"><a href="#cb125-377"></a><span class="fu"># Subset the features</span></span>
<span id="cb125-378"><a href="#cb125-378"></a></span>
<span id="cb125-379"><a href="#cb125-379"></a>The <span class="in">`df_campaign_1_train`</span> and <span class="in">`df_campaign_1_test`</span> data frames are very wide and the columns are highly collinear. We will subset the columns to make the data more manageable.</span>
<span id="cb125-380"><a href="#cb125-380"></a></span>
<span id="cb125-383"><a href="#cb125-383"></a><span class="in">```{python}</span></span>
<span id="cb125-384"><a href="#cb125-384"></a>subset_cols <span class="op">=</span> [<span class="st">'CC_utilization'</span>, </span>
<span id="cb125-385"><a href="#cb125-385"></a>        <span class="st">'PL_utilization'</span>, </span>
<span id="cb125-386"><a href="#cb125-386"></a>        <span class="st">'last_prod_enq2'</span>, </span>
<span id="cb125-387"><a href="#cb125-387"></a>        <span class="st">'PL_enq_L6m'</span>, </span>
<span id="cb125-388"><a href="#cb125-388"></a>        <span class="st">'CC_enq_L6m'</span>,</span>
<span id="cb125-389"><a href="#cb125-389"></a>        <span class="st">'response_flag'</span>]</span>
<span id="cb125-390"><a href="#cb125-390"></a></span>
<span id="cb125-391"><a href="#cb125-391"></a>df_campaign_1_train_subset <span class="op">=</span> df_campaign_1_train[subset_cols].copy()</span>
<span id="cb125-392"><a href="#cb125-392"></a></span>
<span id="cb125-393"><a href="#cb125-393"></a>df_campaign_1_test_subset <span class="op">=</span> df_campaign_1_test[subset_cols].copy()</span>
<span id="cb125-394"><a href="#cb125-394"></a><span class="in">```</span></span>
<span id="cb125-395"><a href="#cb125-395"></a></span>
<span id="cb125-396"><a href="#cb125-396"></a>Convert <span class="in">`last_prod_enq2`</span> to a categorical variable.</span>
<span id="cb125-397"><a href="#cb125-397"></a></span>
<span id="cb125-400"><a href="#cb125-400"></a><span class="in">```{python}</span></span>
<span id="cb125-401"><a href="#cb125-401"></a>df_campaign_1_train_subset[<span class="st">'last_prod_enq2'</span>] <span class="op">=</span> df_campaign_1_train_subset[<span class="st">'last_prod_enq2'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb125-402"><a href="#cb125-402"></a>df_campaign_1_test_subset[<span class="st">'last_prod_enq2'</span>] <span class="op">=</span> df_campaign_1_test_subset[<span class="st">'last_prod_enq2'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb125-403"><a href="#cb125-403"></a><span class="in">```</span></span>
<span id="cb125-404"><a href="#cb125-404"></a></span>
<span id="cb125-405"><a href="#cb125-405"></a>We will revisit the full data frames later in the course. For now, we will use the data frames with subsetted columns.</span>
<span id="cb125-406"><a href="#cb125-406"></a></span>
<span id="cb125-407"><a href="#cb125-407"></a><span class="fu"># Supervised Learning</span></span>
<span id="cb125-408"><a href="#cb125-408"></a></span>
<span id="cb125-409"><a href="#cb125-409"></a>Create a function that sets random seed values.</span>
<span id="cb125-410"><a href="#cb125-410"></a></span>
<span id="cb125-413"><a href="#cb125-413"></a><span class="in">```{python}</span></span>
<span id="cb125-414"><a href="#cb125-414"></a><span class="kw">def</span> global_set_seed(seed_value<span class="op">=</span><span class="dv">2025</span>):</span>
<span id="cb125-415"><a href="#cb125-415"></a>    random.seed(seed_value)</span>
<span id="cb125-416"><a href="#cb125-416"></a>    np.random.seed(seed_value)</span>
<span id="cb125-417"><a href="#cb125-417"></a>    torch.manual_seed(seed_value)</span>
<span id="cb125-418"><a href="#cb125-418"></a><span class="in">```</span></span>
<span id="cb125-419"><a href="#cb125-419"></a></span>
<span id="cb125-420"><a href="#cb125-420"></a>Create a scikit-learn compatible wrapper for <span class="in">`autogluon`</span>.</span>
<span id="cb125-421"><a href="#cb125-421"></a></span>
<span id="cb125-424"><a href="#cb125-424"></a><span class="in">```{python}</span></span>
<span id="cb125-425"><a href="#cb125-425"></a><span class="kw">class</span> AutoGluonSklearnWrapper(ClassifierMixin, BaseEstimator):</span>
<span id="cb125-426"><a href="#cb125-426"></a>    <span class="co">"""</span></span>
<span id="cb125-427"><a href="#cb125-427"></a><span class="co">    Scikit-learn compatible wrapper for AutoGluon TabularPredictor</span></span>
<span id="cb125-428"><a href="#cb125-428"></a><span class="co">    </span></span>
<span id="cb125-429"><a href="#cb125-429"></a><span class="co">    Inherits from scikit-learn's BaseEstimator and ClassifierMixin to provide</span></span>
<span id="cb125-430"><a href="#cb125-430"></a><span class="co">    full compatibility with scikit-learn tools like PartialDependenceDisplay().</span></span>
<span id="cb125-431"><a href="#cb125-431"></a><span class="co">    </span></span>
<span id="cb125-432"><a href="#cb125-432"></a><span class="co">    Parameters</span></span>
<span id="cb125-433"><a href="#cb125-433"></a><span class="co">    ----------</span></span>
<span id="cb125-434"><a href="#cb125-434"></a><span class="co">    label : str</span></span>
<span id="cb125-435"><a href="#cb125-435"></a><span class="co">        Name of the target column</span></span>
<span id="cb125-436"><a href="#cb125-436"></a></span>
<span id="cb125-437"><a href="#cb125-437"></a><span class="co">    **predictor_args : dict</span></span>
<span id="cb125-438"><a href="#cb125-438"></a><span class="co">        Additional arguments passed to TabularPredictor()</span></span>
<span id="cb125-439"><a href="#cb125-439"></a><span class="co">        (e.g., problem_type, eval_metric, path)</span></span>
<span id="cb125-440"><a href="#cb125-440"></a></span>
<span id="cb125-441"><a href="#cb125-441"></a><span class="co">    **fit_args : dict</span></span>
<span id="cb125-442"><a href="#cb125-442"></a><span class="co">        Additional arguments passed to TabularPredictor.fit() method</span></span>
<span id="cb125-443"><a href="#cb125-443"></a><span class="co">        (e.g., holdout_frac, presets, time_limit, excluded_model_types)</span></span>
<span id="cb125-444"><a href="#cb125-444"></a></span>
<span id="cb125-445"><a href="#cb125-445"></a></span>
<span id="cb125-446"><a href="#cb125-446"></a><span class="co">    Attributes</span></span>
<span id="cb125-447"><a href="#cb125-447"></a><span class="co">    ----------</span></span>
<span id="cb125-448"><a href="#cb125-448"></a><span class="co">    predictor : TabularPredictor</span></span>
<span id="cb125-449"><a href="#cb125-449"></a><span class="co">        The trained AutoGluon predictor</span></span>
<span id="cb125-450"><a href="#cb125-450"></a></span>
<span id="cb125-451"><a href="#cb125-451"></a><span class="co">    classes_ : ndarray</span></span>
<span id="cb125-452"><a href="#cb125-452"></a><span class="co">        Class labels (for classification tasks)</span></span>
<span id="cb125-453"><a href="#cb125-453"></a></span>
<span id="cb125-454"><a href="#cb125-454"></a><span class="co">    n_features_in_ : int</span></span>
<span id="cb125-455"><a href="#cb125-455"></a><span class="co">        Number of features seen during fit</span></span>
<span id="cb125-456"><a href="#cb125-456"></a></span>
<span id="cb125-457"><a href="#cb125-457"></a><span class="co">    feature_names_ : list</span></span>
<span id="cb125-458"><a href="#cb125-458"></a><span class="co">        Feature names inferred during fitting</span></span>
<span id="cb125-459"><a href="#cb125-459"></a></span>
<span id="cb125-460"><a href="#cb125-460"></a><span class="co">    is_fitted_ : bool</span></span>
<span id="cb125-461"><a href="#cb125-461"></a><span class="co">        Whether the estimator has been fitted</span></span>
<span id="cb125-462"><a href="#cb125-462"></a><span class="co">    """</span></span>
<span id="cb125-463"><a href="#cb125-463"></a>    _estimator_type <span class="op">=</span> <span class="st">"classifier"</span></span>
<span id="cb125-464"><a href="#cb125-464"></a></span>
<span id="cb125-465"><a href="#cb125-465"></a>    <span class="kw">def</span> _more_tags(<span class="va">self</span>):</span>
<span id="cb125-466"><a href="#cb125-466"></a>        <span class="cf">return</span> {<span class="st">"estimator_type"</span>: <span class="st">"classifier"</span>}</span>
<span id="cb125-467"><a href="#cb125-467"></a></span>
<span id="cb125-468"><a href="#cb125-468"></a>    <span class="kw">def</span> __sklearn_tags__(<span class="va">self</span>):</span>
<span id="cb125-469"><a href="#cb125-469"></a>        tags <span class="op">=</span> <span class="bu">super</span>().__sklearn_tags__()</span>
<span id="cb125-470"><a href="#cb125-470"></a>        tags.estimator_type <span class="op">=</span> <span class="st">"classifier"</span></span>
<span id="cb125-471"><a href="#cb125-471"></a>        <span class="cf">return</span> tags</span>
<span id="cb125-472"><a href="#cb125-472"></a>    </span>
<span id="cb125-473"><a href="#cb125-473"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, label, predictor_args<span class="op">=</span><span class="va">None</span>, fit_args<span class="op">=</span><span class="va">None</span>, n_jobs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb125-474"><a href="#cb125-474"></a>        <span class="va">self</span>.label <span class="op">=</span> label</span>
<span id="cb125-475"><a href="#cb125-475"></a>        <span class="va">self</span>.predictor_args <span class="op">=</span> predictor_args <span class="cf">if</span> predictor_args <span class="cf">else</span> {}</span>
<span id="cb125-476"><a href="#cb125-476"></a>        <span class="va">self</span>.fit_args <span class="op">=</span> fit_args <span class="cf">if</span> fit_args <span class="cf">else</span> {}</span>
<span id="cb125-477"><a href="#cb125-477"></a>        <span class="va">self</span>.n_jobs <span class="op">=</span> n_jobs</span>
<span id="cb125-478"><a href="#cb125-478"></a></span>
<span id="cb125-479"><a href="#cb125-479"></a>    <span class="kw">def</span> _validate_features(<span class="va">self</span>, X):</span>
<span id="cb125-480"><a href="#cb125-480"></a>        <span class="co">"""Validate feature names/counts and return a DataFrame with training features."""</span></span>
<span id="cb125-481"><a href="#cb125-481"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(X, <span class="st">"columns"</span>):</span>
<span id="cb125-482"><a href="#cb125-482"></a>            cols <span class="op">=</span> <span class="bu">list</span>(X.columns)</span>
<span id="cb125-483"><a href="#cb125-483"></a>            <span class="cf">if</span> cols <span class="op">!=</span> <span class="va">self</span>.feature_names_:</span>
<span id="cb125-484"><a href="#cb125-484"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Feature names do not match training data."</span>)</span>
<span id="cb125-485"><a href="#cb125-485"></a>            <span class="cf">return</span> X.copy()</span>
<span id="cb125-486"><a href="#cb125-486"></a></span>
<span id="cb125-487"><a href="#cb125-487"></a>        <span class="cf">if</span> X.shape[<span class="dv">1</span>] <span class="op">!=</span> <span class="bu">len</span>(<span class="va">self</span>.feature_names_):</span>
<span id="cb125-488"><a href="#cb125-488"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Number of features does not match training data."</span>)</span>
<span id="cb125-489"><a href="#cb125-489"></a></span>
<span id="cb125-490"><a href="#cb125-490"></a>        <span class="cf">return</span> pd.DataFrame(X, columns<span class="op">=</span><span class="va">self</span>.feature_names_)</span>
<span id="cb125-491"><a href="#cb125-491"></a></span>
<span id="cb125-492"><a href="#cb125-492"></a>    <span class="kw">def</span> __sklearn_is_fitted__(<span class="va">self</span>):</span>
<span id="cb125-493"><a href="#cb125-493"></a>        <span class="co">"""Official scikit-learn API for checking fitted status"""</span></span>
<span id="cb125-494"><a href="#cb125-494"></a>        <span class="cf">return</span> <span class="bu">getattr</span>(<span class="va">self</span>, <span class="st">"is_fitted_"</span>, <span class="va">False</span>)</span>
<span id="cb125-495"><a href="#cb125-495"></a></span>
<span id="cb125-496"><a href="#cb125-496"></a>    <span class="kw">def</span> __getstate__(<span class="va">self</span>):</span>
<span id="cb125-497"><a href="#cb125-497"></a>        <span class="co">"""Make the wrapper pickle-friendly for joblib/Parallel."""</span></span>
<span id="cb125-498"><a href="#cb125-498"></a>        state <span class="op">=</span> <span class="va">self</span>.__dict__.copy()</span>
<span id="cb125-499"><a href="#cb125-499"></a>        predictor_path <span class="op">=</span> state.get(<span class="st">"predictor_path_"</span>, <span class="va">None</span>)</span>
<span id="cb125-500"><a href="#cb125-500"></a>        predictor <span class="op">=</span> state.get(<span class="st">"predictor_"</span>, <span class="va">None</span>)</span>
<span id="cb125-501"><a href="#cb125-501"></a>        <span class="cf">if</span> predictor_path <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> predictor <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb125-502"><a href="#cb125-502"></a>            predictor_path <span class="op">=</span> predictor.path</span>
<span id="cb125-503"><a href="#cb125-503"></a>        <span class="cf">if</span> predictor_path <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb125-504"><a href="#cb125-504"></a>            state[<span class="st">"predictor_path_"</span>] <span class="op">=</span> os.path.abspath(predictor_path)</span>
<span id="cb125-505"><a href="#cb125-505"></a>        state[<span class="st">"predictor_"</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb125-506"><a href="#cb125-506"></a>        <span class="cf">return</span> state</span>
<span id="cb125-507"><a href="#cb125-507"></a></span>
<span id="cb125-508"><a href="#cb125-508"></a>    <span class="kw">def</span> __setstate__(<span class="va">self</span>, state):</span>
<span id="cb125-509"><a href="#cb125-509"></a>        <span class="co">"""Restore predictor on unpickle."""</span></span>
<span id="cb125-510"><a href="#cb125-510"></a>        <span class="va">self</span>.__dict__.update(state)</span>
<span id="cb125-511"><a href="#cb125-511"></a>        predictor_path <span class="op">=</span> <span class="va">self</span>.__dict__.get(<span class="st">"predictor_path_"</span>, <span class="va">None</span>)</span>
<span id="cb125-512"><a href="#cb125-512"></a>        <span class="cf">if</span> predictor_path:</span>
<span id="cb125-513"><a href="#cb125-513"></a>            <span class="va">self</span>.predictor_ <span class="op">=</span> TabularPredictor.load(predictor_path)</span>
<span id="cb125-514"><a href="#cb125-514"></a>        <span class="va">self</span>.is_fitted_ <span class="op">=</span> predictor_path <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb125-515"><a href="#cb125-515"></a></span>
<span id="cb125-516"><a href="#cb125-516"></a>    <span class="at">@property</span></span>
<span id="cb125-517"><a href="#cb125-517"></a>    <span class="kw">def</span> predictor(<span class="va">self</span>):</span>
<span id="cb125-518"><a href="#cb125-518"></a>        <span class="co">"""Backward-compatible access to the fitted AutoGluon predictor."""</span></span>
<span id="cb125-519"><a href="#cb125-519"></a>        <span class="cf">return</span> <span class="bu">getattr</span>(<span class="va">self</span>, <span class="st">"predictor_"</span>, <span class="va">None</span>)</span>
<span id="cb125-520"><a href="#cb125-520"></a></span>
<span id="cb125-521"><a href="#cb125-521"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>, sample_weight<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb125-522"><a href="#cb125-522"></a>        <span class="co">"""</span></span>
<span id="cb125-523"><a href="#cb125-523"></a><span class="co">        Fit AutoGluon model using scikit-learn interface</span></span>
<span id="cb125-524"><a href="#cb125-524"></a><span class="co">        </span></span>
<span id="cb125-525"><a href="#cb125-525"></a><span class="co">        Parameters</span></span>
<span id="cb125-526"><a href="#cb125-526"></a><span class="co">        ----------</span></span>
<span id="cb125-527"><a href="#cb125-527"></a><span class="co">        X : {array-like, sparse matrix} of shape (n_samples, n_features)</span></span>
<span id="cb125-528"><a href="#cb125-528"></a><span class="co">            Training data</span></span>
<span id="cb125-529"><a href="#cb125-529"></a><span class="co">        y : array-like of shape (n_samples,)</span></span>
<span id="cb125-530"><a href="#cb125-530"></a><span class="co">            Target values</span></span>
<span id="cb125-531"><a href="#cb125-531"></a></span>
<span id="cb125-532"><a href="#cb125-532"></a><span class="co">        sample_weight : array-like of shape (n_samples,), optional</span></span>
<span id="cb125-533"><a href="#cb125-533"></a><span class="co">            Sample weights to pass to AutoGluon if configured</span></span>
<span id="cb125-534"><a href="#cb125-534"></a><span class="co">            </span></span>
<span id="cb125-535"><a href="#cb125-535"></a><span class="co">        Returns</span></span>
<span id="cb125-536"><a href="#cb125-536"></a><span class="co">        -------</span></span>
<span id="cb125-537"><a href="#cb125-537"></a><span class="co">        self : object</span></span>
<span id="cb125-538"><a href="#cb125-538"></a><span class="co">            Fitted estimator</span></span>
<span id="cb125-539"><a href="#cb125-539"></a><span class="co">        """</span></span>
<span id="cb125-540"><a href="#cb125-540"></a>        X_checked, y_checked <span class="op">=</span> check_X_y(X, y, accept_sparse<span class="op">=</span><span class="va">False</span>, dtype<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb125-541"><a href="#cb125-541"></a>        y <span class="op">=</span> y_checked</span>
<span id="cb125-542"><a href="#cb125-542"></a></span>
<span id="cb125-543"><a href="#cb125-543"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(X, <span class="st">"columns"</span>):</span>
<span id="cb125-544"><a href="#cb125-544"></a>            <span class="va">self</span>.feature_names_ <span class="op">=</span> <span class="bu">list</span>(X.columns)</span>
<span id="cb125-545"><a href="#cb125-545"></a>            train_df <span class="op">=</span> X.copy()</span>
<span id="cb125-546"><a href="#cb125-546"></a>        <span class="cf">else</span>:</span>
<span id="cb125-547"><a href="#cb125-547"></a>            <span class="va">self</span>.feature_names_ <span class="op">=</span> [<span class="ss">f"feat_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(X_checked.shape[<span class="dv">1</span>])]</span>
<span id="cb125-548"><a href="#cb125-548"></a>            train_df <span class="op">=</span> pd.DataFrame(X_checked, columns<span class="op">=</span><span class="va">self</span>.feature_names_)</span>
<span id="cb125-549"><a href="#cb125-549"></a></span>
<span id="cb125-550"><a href="#cb125-550"></a>        <span class="va">self</span>.n_features_in_ <span class="op">=</span> train_df.shape[<span class="dv">1</span>]</span>
<span id="cb125-551"><a href="#cb125-551"></a></span>
<span id="cb125-552"><a href="#cb125-552"></a>        predictor_args <span class="op">=</span> <span class="bu">dict</span>(<span class="va">self</span>.predictor_args)</span>
<span id="cb125-553"><a href="#cb125-553"></a>        <span class="cf">if</span> sample_weight <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb125-554"><a href="#cb125-554"></a>            weight_col <span class="op">=</span> predictor_args.get(<span class="st">"sample_weight"</span>)</span>
<span id="cb125-555"><a href="#cb125-555"></a>            <span class="cf">if</span> weight_col <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb125-556"><a href="#cb125-556"></a>                weight_col <span class="op">=</span> <span class="st">"sample_weight"</span></span>
<span id="cb125-557"><a href="#cb125-557"></a>                predictor_args[<span class="st">"sample_weight"</span>] <span class="op">=</span> weight_col</span>
<span id="cb125-558"><a href="#cb125-558"></a>            train_df[weight_col] <span class="op">=</span> sample_weight</span>
<span id="cb125-559"><a href="#cb125-559"></a></span>
<span id="cb125-560"><a href="#cb125-560"></a>        train_df[<span class="va">self</span>.label] <span class="op">=</span> y</span>
<span id="cb125-561"><a href="#cb125-561"></a>        train_data <span class="op">=</span> TabularDataset(train_df)</span>
<span id="cb125-562"><a href="#cb125-562"></a></span>
<span id="cb125-563"><a href="#cb125-563"></a>        fit_args <span class="op">=</span> <span class="bu">dict</span>(<span class="va">self</span>.fit_args)</span>
<span id="cb125-564"><a href="#cb125-564"></a>        <span class="cf">if</span> <span class="va">self</span>.n_jobs <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> fit_args.get(<span class="st">"num_cpus"</span>) <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb125-565"><a href="#cb125-565"></a>            fit_args[<span class="st">"num_cpus"</span>] <span class="op">=</span> <span class="va">self</span>.n_jobs</span>
<span id="cb125-566"><a href="#cb125-566"></a></span>
<span id="cb125-567"><a href="#cb125-567"></a>        <span class="va">self</span>.predictor_ <span class="op">=</span> TabularPredictor(</span>
<span id="cb125-568"><a href="#cb125-568"></a>            label<span class="op">=</span><span class="va">self</span>.label,</span>
<span id="cb125-569"><a href="#cb125-569"></a>            <span class="op">**</span>predictor_args</span>
<span id="cb125-570"><a href="#cb125-570"></a>        ).fit(train_data, <span class="op">**</span>fit_args)</span>
<span id="cb125-571"><a href="#cb125-571"></a></span>
<span id="cb125-572"><a href="#cb125-572"></a>        <span class="va">self</span>.predictor_path_ <span class="op">=</span> os.path.abspath(<span class="va">self</span>.predictor_.path)</span>
<span id="cb125-573"><a href="#cb125-573"></a></span>
<span id="cb125-574"><a href="#cb125-574"></a>        <span class="cf">if</span> <span class="va">self</span>.predictor_.problem_type <span class="kw">in</span> [<span class="st">'binary'</span>, <span class="st">'multiclass'</span>]:</span>
<span id="cb125-575"><a href="#cb125-575"></a>            <span class="va">self</span>.classes_ <span class="op">=</span> np.array(<span class="va">self</span>.predictor_.class_labels)</span>
<span id="cb125-576"><a href="#cb125-576"></a></span>
<span id="cb125-577"><a href="#cb125-577"></a>        <span class="va">self</span>.is_fitted_ <span class="op">=</span> <span class="va">True</span></span>
<span id="cb125-578"><a href="#cb125-578"></a></span>
<span id="cb125-579"><a href="#cb125-579"></a>        <span class="cf">return</span> <span class="va">self</span> </span>
<span id="cb125-580"><a href="#cb125-580"></a></span>
<span id="cb125-581"><a href="#cb125-581"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, X):</span>
<span id="cb125-582"><a href="#cb125-582"></a>        <span class="co">"""</span></span>
<span id="cb125-583"><a href="#cb125-583"></a><span class="co">        Make class predictions</span></span>
<span id="cb125-584"><a href="#cb125-584"></a><span class="co">        </span></span>
<span id="cb125-585"><a href="#cb125-585"></a><span class="co">        Parameters</span></span>
<span id="cb125-586"><a href="#cb125-586"></a><span class="co">        ----------</span></span>
<span id="cb125-587"><a href="#cb125-587"></a><span class="co">        X : {array-like, sparse matrix} of shape (n_samples, n_features)</span></span>
<span id="cb125-588"><a href="#cb125-588"></a><span class="co">            Input data</span></span>
<span id="cb125-589"><a href="#cb125-589"></a><span class="co">            </span></span>
<span id="cb125-590"><a href="#cb125-590"></a><span class="co">        Returns</span></span>
<span id="cb125-591"><a href="#cb125-591"></a><span class="co">        -------</span></span>
<span id="cb125-592"><a href="#cb125-592"></a><span class="co">        y_pred : ndarray of shape (n_samples,)</span></span>
<span id="cb125-593"><a href="#cb125-593"></a><span class="co">            Predicted class labels</span></span>
<span id="cb125-594"><a href="#cb125-594"></a><span class="co">        """</span></span>
<span id="cb125-595"><a href="#cb125-595"></a>        check_is_fitted(<span class="va">self</span>)</span>
<span id="cb125-596"><a href="#cb125-596"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(X, <span class="st">"columns"</span>):</span>
<span id="cb125-597"><a href="#cb125-597"></a>            check_array(X, accept_sparse<span class="op">=</span><span class="va">False</span>, dtype<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb125-598"><a href="#cb125-598"></a>            df <span class="op">=</span> <span class="va">self</span>._validate_features(X)</span>
<span id="cb125-599"><a href="#cb125-599"></a>        <span class="cf">else</span>:</span>
<span id="cb125-600"><a href="#cb125-600"></a>            X_checked <span class="op">=</span> check_array(X, accept_sparse<span class="op">=</span><span class="va">False</span>, dtype<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb125-601"><a href="#cb125-601"></a>            df <span class="op">=</span> <span class="va">self</span>._validate_features(X_checked)</span>
<span id="cb125-602"><a href="#cb125-602"></a></span>
<span id="cb125-603"><a href="#cb125-603"></a>        <span class="cf">return</span> <span class="va">self</span>.predictor_.predict(TabularDataset(df)).values</span>
<span id="cb125-604"><a href="#cb125-604"></a></span>
<span id="cb125-605"><a href="#cb125-605"></a>    <span class="kw">def</span> predict_proba(<span class="va">self</span>, X):</span>
<span id="cb125-606"><a href="#cb125-606"></a>        <span class="co">"""</span></span>
<span id="cb125-607"><a href="#cb125-607"></a><span class="co">        Predict class probabilities</span></span>
<span id="cb125-608"><a href="#cb125-608"></a><span class="co">        </span></span>
<span id="cb125-609"><a href="#cb125-609"></a><span class="co">        Parameters</span></span>
<span id="cb125-610"><a href="#cb125-610"></a><span class="co">        ----------</span></span>
<span id="cb125-611"><a href="#cb125-611"></a><span class="co">        X : {array-like, sparse matrix} of shape (n_samples, n_features)</span></span>
<span id="cb125-612"><a href="#cb125-612"></a><span class="co">            Input data</span></span>
<span id="cb125-613"><a href="#cb125-613"></a><span class="co">            </span></span>
<span id="cb125-614"><a href="#cb125-614"></a><span class="co">        Returns</span></span>
<span id="cb125-615"><a href="#cb125-615"></a><span class="co">        -------</span></span>
<span id="cb125-616"><a href="#cb125-616"></a><span class="co">        proba : ndarray of shape (n_samples, n_classes)</span></span>
<span id="cb125-617"><a href="#cb125-617"></a><span class="co">            Class probabilities</span></span>
<span id="cb125-618"><a href="#cb125-618"></a><span class="co">        """</span></span>
<span id="cb125-619"><a href="#cb125-619"></a>        check_is_fitted(<span class="va">self</span>)</span>
<span id="cb125-620"><a href="#cb125-620"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(X, <span class="st">"columns"</span>):</span>
<span id="cb125-621"><a href="#cb125-621"></a>            check_array(X, accept_sparse<span class="op">=</span><span class="va">False</span>, dtype<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb125-622"><a href="#cb125-622"></a>            df <span class="op">=</span> <span class="va">self</span>._validate_features(X)</span>
<span id="cb125-623"><a href="#cb125-623"></a>        <span class="cf">else</span>:</span>
<span id="cb125-624"><a href="#cb125-624"></a>            X_checked <span class="op">=</span> check_array(X, accept_sparse<span class="op">=</span><span class="va">False</span>, dtype<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb125-625"><a href="#cb125-625"></a>            df <span class="op">=</span> <span class="va">self</span>._validate_features(X_checked)</span>
<span id="cb125-626"><a href="#cb125-626"></a></span>
<span id="cb125-627"><a href="#cb125-627"></a>        <span class="cf">return</span> <span class="va">self</span>.predictor_.predict_proba(TabularDataset(df)).values</span>
<span id="cb125-628"><a href="#cb125-628"></a></span>
<span id="cb125-629"><a href="#cb125-629"></a><span class="in">```</span></span>
<span id="cb125-630"><a href="#cb125-630"></a></span>
<span id="cb125-631"><a href="#cb125-631"></a>Use the standard scikit-learn stack to keep the lab dependency-light and portable.</span>
<span id="cb125-632"><a href="#cb125-632"></a></span>
<span id="cb125-633"><a href="#cb125-633"></a>Setup data frames for <span class="in">`autogluon`</span>.</span>
<span id="cb125-634"><a href="#cb125-634"></a></span>
<span id="cb125-637"><a href="#cb125-637"></a><span class="in">```{python}</span></span>
<span id="cb125-638"><a href="#cb125-638"></a>label <span class="op">=</span> <span class="st">'response_flag'</span></span>
<span id="cb125-639"><a href="#cb125-639"></a></span>
<span id="cb125-640"><a href="#cb125-640"></a>train_data <span class="op">=</span> TabularDataset(df_campaign_1_train_subset)</span>
<span id="cb125-641"><a href="#cb125-641"></a>test_data <span class="op">=</span> TabularDataset(df_campaign_1_test_subset)</span>
<span id="cb125-642"><a href="#cb125-642"></a><span class="in">```</span></span>
<span id="cb125-643"><a href="#cb125-643"></a></span>
<span id="cb125-644"><a href="#cb125-644"></a>Remove the model folder if it already exists.</span>
<span id="cb125-645"><a href="#cb125-645"></a></span>
<span id="cb125-648"><a href="#cb125-648"></a><span class="in">```{python}</span></span>
<span id="cb125-649"><a href="#cb125-649"></a>model_folder <span class="op">=</span> <span class="st">'Lab01_ag_models_NoTransform'</span></span>
<span id="cb125-650"><a href="#cb125-650"></a></span>
<span id="cb125-651"><a href="#cb125-651"></a><span class="kw">def</span> remove_ag_folder(mdl_folder: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb125-652"><a href="#cb125-652"></a>    <span class="co">"""</span></span>
<span id="cb125-653"><a href="#cb125-653"></a><span class="co">    Remove the AutoGluon model folder if it exists</span></span>
<span id="cb125-654"><a href="#cb125-654"></a><span class="co">    """</span></span>
<span id="cb125-655"><a href="#cb125-655"></a>    <span class="cf">if</span> os.path.exists(mdl_folder):</span>
<span id="cb125-656"><a href="#cb125-656"></a>        shutil.rmtree(mdl_folder)</span>
<span id="cb125-657"><a href="#cb125-657"></a></span>
<span id="cb125-658"><a href="#cb125-658"></a>remove_ag_folder(model_folder)</span>
<span id="cb125-659"><a href="#cb125-659"></a></span>
<span id="cb125-660"><a href="#cb125-660"></a><span class="in">```</span></span>
<span id="cb125-661"><a href="#cb125-661"></a></span>
<span id="cb125-662"><a href="#cb125-662"></a>The code below trains multiple machine learning models using <span class="in">`autogluon`</span> and evaluates them using the ROC AUC metric (on a validation set that is derived from <span class="in">`train_data`</span>).</span>
<span id="cb125-663"><a href="#cb125-663"></a></span>
<span id="cb125-664"><a href="#cb125-664"></a>Hyperparameter tuning is set to <span class="in">`medium_quality`</span> to reduce compute time. The allotted training time is set to <span class="in">`180`</span> seconds. In real-world situations, you should use a better preset (<span class="in">`good_quality`</span>) and a longer training time (<span class="in">`3600`</span>).</span>
<span id="cb125-665"><a href="#cb125-665"></a></span>
<span id="cb125-666"><a href="#cb125-666"></a>Create a scikit-learn pipeline that replaces <span class="in">`-99999`</span> with <span class="in">`-1`</span> and trains <span class="in">`autogluon`</span> models.</span>
<span id="cb125-667"><a href="#cb125-667"></a></span>
<span id="cb125-670"><a href="#cb125-670"></a><span class="in">```{python}</span></span>
<span id="cb125-671"><a href="#cb125-671"></a><span class="kw">def</span> replace_vals(X: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb125-672"><a href="#cb125-672"></a>  <span class="cf">return</span> X.replace(<span class="op">-</span><span class="dv">99999</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb125-673"><a href="#cb125-673"></a></span>
<span id="cb125-674"><a href="#cb125-674"></a>ag_model <span class="op">=</span> Pipeline([</span>
<span id="cb125-675"><a href="#cb125-675"></a>    (<span class="st">'replace_values'</span>, FunctionTransformer(replace_vals)),</span>
<span id="cb125-676"><a href="#cb125-676"></a>    (<span class="st">'autogluon'</span>, AutoGluonSklearnWrapper(label<span class="op">=</span>label,</span>
<span id="cb125-677"><a href="#cb125-677"></a>                                    predictor_args<span class="op">=</span>{<span class="st">'problem_type'</span>: <span class="st">'binary'</span>,</span>
<span id="cb125-678"><a href="#cb125-678"></a>                                                    <span class="st">'eval_metric'</span>: <span class="st">'roc_auc'</span>,</span>
<span id="cb125-679"><a href="#cb125-679"></a>                                                    <span class="st">'path'</span>: model_folder},</span>
<span id="cb125-680"><a href="#cb125-680"></a>                                    fit_args<span class="op">=</span>{<span class="st">'holdout_frac'</span>: <span class="fl">0.2</span>,</span>
<span id="cb125-681"><a href="#cb125-681"></a>                                                <span class="st">'excluded_model_types'</span>: [<span class="st">'KNN'</span>],</span>
<span id="cb125-682"><a href="#cb125-682"></a>                                                <span class="st">'presets'</span>: <span class="st">'medium_quality'</span>,</span>
<span id="cb125-683"><a href="#cb125-683"></a>                                                <span class="st">'time_limit'</span>: <span class="dv">180</span><span class="op">*</span><span class="fl">1.5</span>},</span>
<span id="cb125-684"><a href="#cb125-684"></a>                                    n_jobs<span class="op">=</span>num_jobs))</span>
<span id="cb125-685"><a href="#cb125-685"></a>])</span>
<span id="cb125-686"><a href="#cb125-686"></a></span>
<span id="cb125-687"><a href="#cb125-687"></a>global_set_seed()</span>
<span id="cb125-688"><a href="#cb125-688"></a></span>
<span id="cb125-689"><a href="#cb125-689"></a>ag_model.fit( X <span class="op">=</span> train_data.drop(columns<span class="op">=</span>[label]),</span>
<span id="cb125-690"><a href="#cb125-690"></a>            y <span class="op">=</span> train_data[label]</span>
<span id="cb125-691"><a href="#cb125-691"></a>            )</span>
<span id="cb125-692"><a href="#cb125-692"></a><span class="in">```</span></span>
<span id="cb125-693"><a href="#cb125-693"></a></span>
<span id="cb125-694"><a href="#cb125-694"></a>The attribute <span class="in">`ag_model.named_steps['autogluon'].predictor`</span> contains the original fit object from <span class="in">`autogluon`</span>.</span>
<span id="cb125-695"><a href="#cb125-695"></a></span>
<span id="cb125-696"><a href="#cb125-696"></a>Generate a leaderboard to see the performance of each model on <span class="in">`test_data`</span>.</span>
<span id="cb125-697"><a href="#cb125-697"></a></span>
<span id="cb125-700"><a href="#cb125-700"></a><span class="in">```{python}</span></span>
<span id="cb125-701"><a href="#cb125-701"></a>df_leaders <span class="op">=</span> ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.leaderboard(test_data)</span>
<span id="cb125-702"><a href="#cb125-702"></a><span class="in">```</span></span>
<span id="cb125-703"><a href="#cb125-703"></a></span>
<span id="cb125-706"><a href="#cb125-706"></a><span class="in">```{python}</span></span>
<span id="cb125-707"><a href="#cb125-707"></a><span class="co">#| label: tbl-ag-leaderboard</span></span>
<span id="cb125-708"><a href="#cb125-708"></a><span class="co">#| tbl-cap: "Autogluon Leaderboard"</span></span>
<span id="cb125-709"><a href="#cb125-709"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-710"><a href="#cb125-710"></a></span>
<span id="cb125-711"><a href="#cb125-711"></a>display(df_leaders)</span>
<span id="cb125-712"><a href="#cb125-712"></a><span class="in">```</span></span>
<span id="cb125-713"><a href="#cb125-713"></a></span>
<span id="cb125-714"><a href="#cb125-714"></a><span class="fu"># Best Model</span></span>
<span id="cb125-715"><a href="#cb125-715"></a></span>
<span id="cb125-716"><a href="#cb125-716"></a>Although <span class="in">`CatBoost`</span> may not have the highest roc_auc score, the model generates very fast predictions with a very competitive roc_auc score.</span>
<span id="cb125-717"><a href="#cb125-717"></a></span>
<span id="cb125-718"><a href="#cb125-718"></a>Set the best model to <span class="in">`CatBoost`</span>.</span>
<span id="cb125-719"><a href="#cb125-719"></a></span>
<span id="cb125-722"><a href="#cb125-722"></a><span class="in">```{python}</span></span>
<span id="cb125-723"><a href="#cb125-723"></a>best_model_name <span class="op">=</span> <span class="st">'CatBoost'</span></span>
<span id="cb125-724"><a href="#cb125-724"></a>ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.set_model_best(best_model_name)</span>
<span id="cb125-725"><a href="#cb125-725"></a><span class="in">```</span></span>
<span id="cb125-726"><a href="#cb125-726"></a></span>
<span id="cb125-727"><a href="#cb125-727"></a><span class="fu"># Check Probability Calibration</span></span>
<span id="cb125-728"><a href="#cb125-728"></a></span>
<span id="cb125-729"><a href="#cb125-729"></a>Measure how well the model scores align with the observed response rates in <span class="in">`test_data`</span>.</span>
<span id="cb125-730"><a href="#cb125-730"></a></span>
<span id="cb125-733"><a href="#cb125-733"></a><span class="in">```{python}</span></span>
<span id="cb125-734"><a href="#cb125-734"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb125-735"><a href="#cb125-735"></a></span>
<span id="cb125-736"><a href="#cb125-736"></a>cal_disp <span class="op">=</span> CalibrationDisplay.from_estimator(</span>
<span id="cb125-737"><a href="#cb125-737"></a>        estimator <span class="op">=</span> ag_model,</span>
<span id="cb125-738"><a href="#cb125-738"></a>        X <span class="op">=</span> test_data.drop(columns<span class="op">=</span>[label]),</span>
<span id="cb125-739"><a href="#cb125-739"></a>        y <span class="op">=</span> test_data[label],</span>
<span id="cb125-740"><a href="#cb125-740"></a>        n_bins <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb125-741"><a href="#cb125-741"></a>        name <span class="op">=</span> <span class="st">'Uncalib_CatBoost'</span>,</span>
<span id="cb125-742"><a href="#cb125-742"></a>        color <span class="op">=</span> <span class="st">'orange'</span></span>
<span id="cb125-743"><a href="#cb125-743"></a>    )</span>
<span id="cb125-744"><a href="#cb125-744"></a></span>
<span id="cb125-745"><a href="#cb125-745"></a>cal_disp.ax_.set_title(<span class="st">"Calibration Plot"</span>)</span>
<span id="cb125-746"><a href="#cb125-746"></a><span class="in">```</span></span>
<span id="cb125-747"><a href="#cb125-747"></a></span>
<span id="cb125-748"><a href="#cb125-748"></a>Calibrate the model scores to the observed response rates in <span class="in">`df_campaign_2`</span>.</span>
<span id="cb125-749"><a href="#cb125-749"></a></span>
<span id="cb125-750"><a href="#cb125-750"></a>Calibration methods should avoid using the training data (due to the model scores being overfitted to the training data). The test data should be used for evaluation purposes only. Therefore, we will use <span class="in">`df_campaign_2`</span> to calibrate the model.</span>
<span id="cb125-751"><a href="#cb125-751"></a></span>
<span id="cb125-752"><a href="#cb125-752"></a>Set up the data frames from <span class="in">`df_campaign_2`</span>.</span>
<span id="cb125-753"><a href="#cb125-753"></a></span>
<span id="cb125-756"><a href="#cb125-756"></a><span class="in">```{python}</span></span>
<span id="cb125-757"><a href="#cb125-757"></a><span class="co"># Get the data ready</span></span>
<span id="cb125-758"><a href="#cb125-758"></a>df_campaign_2_subset <span class="op">=</span> df_campaign_2[subset_cols].copy()</span>
<span id="cb125-759"><a href="#cb125-759"></a>df_campaign_2_subset[<span class="st">'last_prod_enq2'</span>] <span class="op">=</span> df_campaign_2_subset[<span class="st">'last_prod_enq2'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb125-760"><a href="#cb125-760"></a></span>
<span id="cb125-761"><a href="#cb125-761"></a><span class="co"># Prepare features and true labels</span></span>
<span id="cb125-762"><a href="#cb125-762"></a>X_campaign2 <span class="op">=</span> df_campaign_2_subset.drop(columns<span class="op">=</span>[label])</span>
<span id="cb125-763"><a href="#cb125-763"></a>y_campaign2 <span class="op">=</span> df_campaign_2_subset[label]</span>
<span id="cb125-764"><a href="#cb125-764"></a><span class="in">```</span></span>
<span id="cb125-765"><a href="#cb125-765"></a></span>
<span id="cb125-766"><a href="#cb125-766"></a>Calibrate the model scores using <span class="in">`df_campaign_2`</span> and <span class="in">`CalibratedClassifierCV`</span>.</span>
<span id="cb125-767"><a href="#cb125-767"></a></span>
<span id="cb125-770"><a href="#cb125-770"></a><span class="in">```{python}</span></span>
<span id="cb125-771"><a href="#cb125-771"></a>cal_model <span class="op">=</span> CalibratedClassifierCV(</span>
<span id="cb125-772"><a href="#cb125-772"></a>    estimator <span class="op">=</span> ag_model,</span>
<span id="cb125-773"><a href="#cb125-773"></a>    method<span class="op">=</span><span class="st">'isotonic'</span>,</span>
<span id="cb125-774"><a href="#cb125-774"></a>    cv<span class="op">=</span><span class="st">"prefit"</span> <span class="co"># Use the fitted model from ag_model</span></span>
<span id="cb125-775"><a href="#cb125-775"></a>)</span>
<span id="cb125-776"><a href="#cb125-776"></a></span>
<span id="cb125-777"><a href="#cb125-777"></a>global_set_seed()</span>
<span id="cb125-778"><a href="#cb125-778"></a></span>
<span id="cb125-779"><a href="#cb125-779"></a>cal_model.fit(X <span class="op">=</span> X_campaign2,</span>
<span id="cb125-780"><a href="#cb125-780"></a>            y <span class="op">=</span> y_campaign2)</span>
<span id="cb125-781"><a href="#cb125-781"></a><span class="in">```</span></span>
<span id="cb125-782"><a href="#cb125-782"></a></span>
<span id="cb125-785"><a href="#cb125-785"></a><span class="in">```{python}</span></span>
<span id="cb125-786"><a href="#cb125-786"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb125-787"><a href="#cb125-787"></a></span>
<span id="cb125-788"><a href="#cb125-788"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb125-789"><a href="#cb125-789"></a></span>
<span id="cb125-790"><a href="#cb125-790"></a><span class="cf">for</span> estimator, name, color <span class="kw">in</span> [(ag_model, <span class="st">'Uncalib_CatBoost'</span>, <span class="st">'orange'</span>),</span>
<span id="cb125-791"><a href="#cb125-791"></a>          (cal_model, <span class="st">'Calib_CatBoost'</span>, <span class="st">'blue'</span>)]:</span>
<span id="cb125-792"><a href="#cb125-792"></a></span>
<span id="cb125-793"><a href="#cb125-793"></a>  CalibrationDisplay.from_estimator(</span>
<span id="cb125-794"><a href="#cb125-794"></a>      estimator <span class="op">=</span> estimator,</span>
<span id="cb125-795"><a href="#cb125-795"></a>      X <span class="op">=</span> test_data.drop(columns<span class="op">=</span>[label]),</span>
<span id="cb125-796"><a href="#cb125-796"></a>      y <span class="op">=</span> test_data[label],</span>
<span id="cb125-797"><a href="#cb125-797"></a>        n_bins <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb125-798"><a href="#cb125-798"></a>      name <span class="op">=</span> name,</span>
<span id="cb125-799"><a href="#cb125-799"></a>      color <span class="op">=</span> color,</span>
<span id="cb125-800"><a href="#cb125-800"></a>        ax <span class="op">=</span> ax</span>
<span id="cb125-801"><a href="#cb125-801"></a>    )</span>
<span id="cb125-802"><a href="#cb125-802"></a>    </span>
<span id="cb125-803"><a href="#cb125-803"></a>ax.set_title(<span class="st">"Calibration Plot"</span>)</span>
<span id="cb125-804"><a href="#cb125-804"></a>plt.show()</span>
<span id="cb125-805"><a href="#cb125-805"></a><span class="in">```</span></span>
<span id="cb125-806"><a href="#cb125-806"></a></span>
<span id="cb125-807"><a href="#cb125-807"></a>The calibration plot shows that the uncalibrated model is better than the calibrated model.</span>
<span id="cb125-808"><a href="#cb125-808"></a></span>
<span id="cb125-809"><a href="#cb125-809"></a>This occurred because CatBoost uses the <span class="in">`logloss`</span> objective function when the model fits. The <span class="in">`logloss`</span> function is called a proper scoring rule, which explicitly accounts for the calibration of the predicted probabilities.</span>
<span id="cb125-810"><a href="#cb125-810"></a></span>
<span id="cb125-811"><a href="#cb125-811"></a>In other models, like <span class="in">`RandomForest`</span>, the predicted probabilities are based on the purity of the leaf nodes (i.e., Gini). This is not a proper scoring rule and can lead to poorly calibrated probabilities.</span>
<span id="cb125-812"><a href="#cb125-812"></a></span>
<span id="cb125-813"><a href="#cb125-813"></a>Going forward, we will use <span class="in">`ag_model`</span> for predictions.</span>
<span id="cb125-814"><a href="#cb125-814"></a></span>
<span id="cb125-815"><a href="#cb125-815"></a><span class="fu"># Permutation Feature Importance</span></span>
<span id="cb125-816"><a href="#cb125-816"></a></span>
<span id="cb125-817"><a href="#cb125-817"></a>Using the best model, rank features from most important to least important.</span>
<span id="cb125-818"><a href="#cb125-818"></a></span>
<span id="cb125-819"><a href="#cb125-819"></a>Permutation feature importance measures how model performance degrades when a feature is randomly shuffled. Using <span class="in">`test_data`</span> avoids overfitting and provides a more reliable estimate of each feature's importance.</span>
<span id="cb125-820"><a href="#cb125-820"></a></span>
<span id="cb125-823"><a href="#cb125-823"></a><span class="in">```{python}</span></span>
<span id="cb125-824"><a href="#cb125-824"></a>best_feature_importance <span class="op">=</span> (ag_model</span>
<span id="cb125-825"><a href="#cb125-825"></a>                            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb125-826"><a href="#cb125-826"></a>                            .predictor</span>
<span id="cb125-827"><a href="#cb125-827"></a>                            .feature_importance(</span>
<span id="cb125-828"><a href="#cb125-828"></a>                                    data <span class="op">=</span> test_data, </span>
<span id="cb125-829"><a href="#cb125-829"></a>                                    model <span class="op">=</span> best_model_name,</span>
<span id="cb125-830"><a href="#cb125-830"></a>                                    subsample_size <span class="op">=</span> <span class="va">None</span>)</span>
<span id="cb125-831"><a href="#cb125-831"></a>                        )</span>
<span id="cb125-832"><a href="#cb125-832"></a><span class="in">```</span></span>
<span id="cb125-833"><a href="#cb125-833"></a></span>
<span id="cb125-836"><a href="#cb125-836"></a><span class="in">```{python}</span></span>
<span id="cb125-837"><a href="#cb125-837"></a><span class="co">#| label: tbl-perm-feature-importance</span></span>
<span id="cb125-838"><a href="#cb125-838"></a><span class="co">#| tbl-cap: "Permutation Feature Importance"</span></span>
<span id="cb125-839"><a href="#cb125-839"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-840"><a href="#cb125-840"></a></span>
<span id="cb125-841"><a href="#cb125-841"></a>display(best_feature_importance)</span>
<span id="cb125-842"><a href="#cb125-842"></a><span class="in">```</span></span>
<span id="cb125-843"><a href="#cb125-843"></a></span>
<span id="cb125-844"><a href="#cb125-844"></a><span class="fu"># Partial Dependence Plots</span></span>
<span id="cb125-845"><a href="#cb125-845"></a></span>
<span id="cb125-846"><a href="#cb125-846"></a>Create a function that generates partial dependence plots for all features.</span>
<span id="cb125-847"><a href="#cb125-847"></a></span>
<span id="cb125-850"><a href="#cb125-850"></a><span class="in">```{python}</span></span>
<span id="cb125-851"><a href="#cb125-851"></a><span class="kw">def</span> show_pdp(wrappedAGModel: BaseEstimator,</span>
<span id="cb125-852"><a href="#cb125-852"></a>            list_features: <span class="bu">list</span>,</span>
<span id="cb125-853"><a href="#cb125-853"></a>            list_categ_features: <span class="bu">list</span>,</span>
<span id="cb125-854"><a href="#cb125-854"></a>            df: pd.DataFrame,</span>
<span id="cb125-855"><a href="#cb125-855"></a>            xGTzero: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb125-856"><a href="#cb125-856"></a>            sampSize: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5000</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb125-857"><a href="#cb125-857"></a></span>
<span id="cb125-858"><a href="#cb125-858"></a>    N_JOBS <span class="op">=</span> num_jobs</span>
<span id="cb125-859"><a href="#cb125-859"></a></span>
<span id="cb125-860"><a href="#cb125-860"></a>    <span class="cf">for</span> feature <span class="kw">in</span> list_features:</span>
<span id="cb125-861"><a href="#cb125-861"></a>        fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb125-862"><a href="#cb125-862"></a>        ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>)</span>
<span id="cb125-863"><a href="#cb125-863"></a></span>
<span id="cb125-864"><a href="#cb125-864"></a>        plt.rcParams.update({<span class="st">'font.size'</span>: <span class="dv">16</span>})</span>
<span id="cb125-865"><a href="#cb125-865"></a></span>
<span id="cb125-866"><a href="#cb125-866"></a>        pdp_kwargs <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb125-867"><a href="#cb125-867"></a>            estimator<span class="op">=</span>wrappedAGModel,</span>
<span id="cb125-868"><a href="#cb125-868"></a>            X<span class="op">=</span>df.sample(sampSize, random_state<span class="op">=</span><span class="dv">2025</span>),</span>
<span id="cb125-869"><a href="#cb125-869"></a>            features<span class="op">=</span>[feature],</span>
<span id="cb125-870"><a href="#cb125-870"></a>            categorical_features<span class="op">=</span>list_categ_features,</span>
<span id="cb125-871"><a href="#cb125-871"></a>            method<span class="op">=</span><span class="st">'brute'</span>,</span>
<span id="cb125-872"><a href="#cb125-872"></a>            kind<span class="op">=</span><span class="st">"average"</span>,</span>
<span id="cb125-873"><a href="#cb125-873"></a>            percentiles<span class="op">=</span>(<span class="fl">0.0001</span>, <span class="fl">0.9999</span>),</span>
<span id="cb125-874"><a href="#cb125-874"></a>            grid_resolution<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb125-875"><a href="#cb125-875"></a>            ax<span class="op">=</span>ax,</span>
<span id="cb125-876"><a href="#cb125-876"></a>            random_state<span class="op">=</span><span class="dv">2025</span>,</span>
<span id="cb125-877"><a href="#cb125-877"></a>            n_jobs<span class="op">=</span>N_JOBS,</span>
<span id="cb125-878"><a href="#cb125-878"></a>        )</span>
<span id="cb125-879"><a href="#cb125-879"></a></span>
<span id="cb125-880"><a href="#cb125-880"></a>        _ <span class="op">=</span> PartialDependenceDisplay.from_estimator(<span class="op">**</span>pdp_kwargs)</span>
<span id="cb125-881"><a href="#cb125-881"></a></span>
<span id="cb125-882"><a href="#cb125-882"></a>        ax.set_title(<span class="ss">f"Partial Dependence for </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb125-883"><a href="#cb125-883"></a></span>
<span id="cb125-884"><a href="#cb125-884"></a>        <span class="co"># Set y-axis lower limit for all axes in the current figure</span></span>
<span id="cb125-885"><a href="#cb125-885"></a>        <span class="cf">for</span> a <span class="kw">in</span> fig.get_axes():</span>
<span id="cb125-886"><a href="#cb125-886"></a>            coordy <span class="op">=</span> a.get_ylim()</span>
<span id="cb125-887"><a href="#cb125-887"></a>            a.set_ylim(bottom<span class="op">=</span><span class="dv">0</span>, top<span class="op">=</span>coordy[<span class="dv">1</span>]<span class="op">*</span><span class="fl">1.1</span>)</span>
<span id="cb125-888"><a href="#cb125-888"></a></span>
<span id="cb125-889"><a href="#cb125-889"></a>        <span class="cf">if</span> xGTzero:</span>
<span id="cb125-890"><a href="#cb125-890"></a>            <span class="co"># Set x-axis from 0 to the max</span></span>
<span id="cb125-891"><a href="#cb125-891"></a>            <span class="cf">for</span> a <span class="kw">in</span> fig.get_axes():</span>
<span id="cb125-892"><a href="#cb125-892"></a>                max_val <span class="op">=</span> np.percentile(df[feature].values, <span class="fl">99.99</span>)</span>
<span id="cb125-893"><a href="#cb125-893"></a>                a.set_xlim(left<span class="op">=</span><span class="dv">0</span>, right<span class="op">=</span>max_val)</span>
<span id="cb125-894"><a href="#cb125-894"></a></span>
<span id="cb125-895"><a href="#cb125-895"></a>        plt.show()</span>
<span id="cb125-896"><a href="#cb125-896"></a>        plt.close(<span class="st">'all'</span>)  <span class="co"># Prevent figure overload</span></span>
<span id="cb125-897"><a href="#cb125-897"></a></span>
<span id="cb125-898"><a href="#cb125-898"></a><span class="in">```</span></span>
<span id="cb125-899"><a href="#cb125-899"></a></span>
<span id="cb125-902"><a href="#cb125-902"></a><span class="in">```{python}</span></span>
<span id="cb125-903"><a href="#cb125-903"></a><span class="co"># Get all features from ag_model.predictor</span></span>
<span id="cb125-904"><a href="#cb125-904"></a>all_features <span class="op">=</span> ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.features()</span>
<span id="cb125-905"><a href="#cb125-905"></a></span>
<span id="cb125-906"><a href="#cb125-906"></a><span class="co"># Get categorical features from ag_model.predictor's feature metadata</span></span>
<span id="cb125-907"><a href="#cb125-907"></a>categorical_features <span class="op">=</span> ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.feature_metadata.get_features(valid_raw_types<span class="op">=</span>[<span class="st">'category'</span>])</span>
<span id="cb125-908"><a href="#cb125-908"></a></span>
<span id="cb125-909"><a href="#cb125-909"></a><span class="co"># Get numeric features from ag_model.predictor's feature metadata</span></span>
<span id="cb125-910"><a href="#cb125-910"></a>numeric_features <span class="op">=</span> ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.feature_metadata.get_features(valid_raw_types<span class="op">=</span>[<span class="st">'int'</span>, <span class="st">'float'</span>, <span class="st">'int64'</span>, <span class="st">'float64'</span>, <span class="st">'int32'</span>, <span class="st">'float32'</span>])</span>
<span id="cb125-911"><a href="#cb125-911"></a><span class="in">```</span></span>
<span id="cb125-912"><a href="#cb125-912"></a></span>
<span id="cb125-913"><a href="#cb125-913"></a>Use partial dependence plots (PDP) to describe the relationships between features and predictions.</span>
<span id="cb125-914"><a href="#cb125-914"></a></span>
<span id="cb125-915"><a href="#cb125-915"></a>Unlike permutation feature importance, PDPs do not depend on the true labels. Instead, they show how the model's predictions change as the feature values change.</span>
<span id="cb125-916"><a href="#cb125-916"></a></span>
<span id="cb125-919"><a href="#cb125-919"></a><span class="in">```{python}</span></span>
<span id="cb125-920"><a href="#cb125-920"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb125-921"><a href="#cb125-921"></a></span>
<span id="cb125-922"><a href="#cb125-922"></a>show_pdp(wrappedAGModel <span class="op">=</span> ag_model,</span>
<span id="cb125-923"><a href="#cb125-923"></a>        list_features <span class="op">=</span> all_features, </span>
<span id="cb125-924"><a href="#cb125-924"></a>        list_categ_features <span class="op">=</span> categorical_features, </span>
<span id="cb125-925"><a href="#cb125-925"></a>    df <span class="op">=</span> train_data.drop(columns<span class="op">=</span>[label]),</span>
<span id="cb125-926"><a href="#cb125-926"></a>        )</span>
<span id="cb125-927"><a href="#cb125-927"></a><span class="in">```</span></span>
<span id="cb125-928"><a href="#cb125-928"></a></span>
<span id="cb125-929"><a href="#cb125-929"></a><span class="fu">## Q&amp;A</span></span>
<span id="cb125-930"><a href="#cb125-930"></a></span>
<span id="cb125-931"><a href="#cb125-931"></a><span class="fu">### Question</span></span>
<span id="cb125-932"><a href="#cb125-932"></a></span>
<span id="cb125-933"><a href="#cb125-933"></a>::: callout-note</span>
<span id="cb125-934"><a href="#cb125-934"></a>In <span class="in">`train_data`</span>, what is the maximum value of <span class="in">`CC_utilization`</span>?</span>
<span id="cb125-935"><a href="#cb125-935"></a>:::</span>
<span id="cb125-936"><a href="#cb125-936"></a></span>
<span id="cb125-937"><a href="#cb125-937"></a><span class="fu">### Question</span></span>
<span id="cb125-938"><a href="#cb125-938"></a></span>
<span id="cb125-939"><a href="#cb125-939"></a>::: callout-note</span>
<span id="cb125-940"><a href="#cb125-940"></a>What would happen to the partial dependence plot if <span class="in">`train_data`</span> included prospects with <span class="in">`CC_utilization`</span> values greater than 100%?</span>
<span id="cb125-941"><a href="#cb125-941"></a></span>
<span id="cb125-942"><a href="#cb125-942"></a>The partial dependence curve would likely <span class="sc">\_\_\_\_\_</span>.</span>
<span id="cb125-943"><a href="#cb125-943"></a></span>
<span id="cb125-944"><a href="#cb125-944"></a>Check your answer by creating a copy of <span class="in">`train_data`</span> and then adding <span class="in">`0.50`</span> to all <span class="in">`CC_utilization`</span> values. Then create the PDP for <span class="in">`CC_utilization`</span>.</span>
<span id="cb125-945"><a href="#cb125-945"></a>:::</span>
<span id="cb125-946"><a href="#cb125-946"></a></span>
<span id="cb125-947"><a href="#cb125-947"></a><span class="fu">## More PDP</span></span>
<span id="cb125-948"><a href="#cb125-948"></a></span>
<span id="cb125-949"><a href="#cb125-949"></a>Zoom-in on the plots where the feature values are greater than or equal to 0.</span>
<span id="cb125-950"><a href="#cb125-950"></a></span>
<span id="cb125-953"><a href="#cb125-953"></a><span class="in">```{python}</span></span>
<span id="cb125-954"><a href="#cb125-954"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb125-955"><a href="#cb125-955"></a></span>
<span id="cb125-956"><a href="#cb125-956"></a>show_pdp(wrappedAGModel <span class="op">=</span> ag_model,</span>
<span id="cb125-957"><a href="#cb125-957"></a>        list_features <span class="op">=</span> numeric_features, </span>
<span id="cb125-958"><a href="#cb125-958"></a>        list_categ_features <span class="op">=</span> categorical_features, </span>
<span id="cb125-959"><a href="#cb125-959"></a>    df <span class="op">=</span> train_data.drop(columns<span class="op">=</span>[label]), </span>
<span id="cb125-960"><a href="#cb125-960"></a>    xGTzero <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb125-961"><a href="#cb125-961"></a></span>
<span id="cb125-962"><a href="#cb125-962"></a><span class="in">```</span></span>
<span id="cb125-963"><a href="#cb125-963"></a></span>
<span id="cb125-964"><a href="#cb125-964"></a><span class="fu"># Accumulated Local Effects Plots</span></span>
<span id="cb125-965"><a href="#cb125-965"></a></span>
<span id="cb125-968"><a href="#cb125-968"></a><span class="in">```{python}</span></span>
<span id="cb125-969"><a href="#cb125-969"></a><span class="kw">def</span> show_ale(wrappedAGModel: BaseEstimator,</span>
<span id="cb125-970"><a href="#cb125-970"></a>            list_features: <span class="bu">list</span>,</span>
<span id="cb125-971"><a href="#cb125-971"></a>            df: pd.DataFrame,</span>
<span id="cb125-972"><a href="#cb125-972"></a>            xGTzero: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb125-973"><a href="#cb125-973"></a>            sampSize: <span class="bu">int</span> <span class="op">=</span> <span class="dv">40000</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb125-974"><a href="#cb125-974"></a></span>
<span id="cb125-975"><a href="#cb125-975"></a>  <span class="kw">def</span> do_nothing(data):</span>
<span id="cb125-976"><a href="#cb125-976"></a>    <span class="cf">return</span> data</span>
<span id="cb125-977"><a href="#cb125-977"></a></span>
<span id="cb125-978"><a href="#cb125-978"></a>  <span class="cf">for</span> feature <span class="kw">in</span> list_features:</span>
<span id="cb125-979"><a href="#cb125-979"></a></span>
<span id="cb125-980"><a href="#cb125-980"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb125-981"><a href="#cb125-981"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>)</span>
<span id="cb125-982"><a href="#cb125-982"></a></span>
<span id="cb125-983"><a href="#cb125-983"></a>    plt.rcParams.update({<span class="st">'font.size'</span>: <span class="dv">12</span>})</span>
<span id="cb125-984"><a href="#cb125-984"></a></span>
<span id="cb125-985"><a href="#cb125-985"></a>    ale_eff <span class="op">=</span> ale(</span>
<span id="cb125-986"><a href="#cb125-986"></a>                X <span class="op">=</span> df.sample(sampSize, random_state<span class="op">=</span><span class="dv">2025</span>),</span>
<span id="cb125-987"><a href="#cb125-987"></a>                model <span class="op">=</span> wrappedAGModel,</span>
<span id="cb125-988"><a href="#cb125-988"></a>                feature <span class="op">=</span> [feature],</span>
<span id="cb125-989"><a href="#cb125-989"></a>                include_CI <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb125-990"><a href="#cb125-990"></a>                C<span class="op">=</span><span class="fl">0.9999</span>,</span>
<span id="cb125-991"><a href="#cb125-991"></a>                grid_size<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb125-992"><a href="#cb125-992"></a>                encode_fun<span class="op">=</span>do_nothing,</span>
<span id="cb125-993"><a href="#cb125-993"></a>                predictors<span class="op">=</span>wrappedAGModel.named_steps[<span class="st">'autogluon'</span>].predictor.features(),</span>
<span id="cb125-994"><a href="#cb125-994"></a>                fig<span class="op">=</span>fig,</span>
<span id="cb125-995"><a href="#cb125-995"></a>                ax<span class="op">=</span>ax</span>
<span id="cb125-996"><a href="#cb125-996"></a>                )</span>
<span id="cb125-997"><a href="#cb125-997"></a>    </span>
<span id="cb125-998"><a href="#cb125-998"></a>    <span class="cf">if</span> xGTzero:</span>
<span id="cb125-999"><a href="#cb125-999"></a>        <span class="co"># Set x-axis from 0 to the max</span></span>
<span id="cb125-1000"><a href="#cb125-1000"></a>        <span class="cf">for</span> a <span class="kw">in</span> fig.get_axes():</span>
<span id="cb125-1001"><a href="#cb125-1001"></a>            max_val <span class="op">=</span> np.percentile(df[feature].values, <span class="fl">99.99</span>)</span>
<span id="cb125-1002"><a href="#cb125-1002"></a>            a.set_xlim(left<span class="op">=</span><span class="dv">0</span>, right<span class="op">=</span>max_val)</span>
<span id="cb125-1003"><a href="#cb125-1003"></a></span>
<span id="cb125-1004"><a href="#cb125-1004"></a>    plt.show()</span>
<span id="cb125-1005"><a href="#cb125-1005"></a>    plt.close(<span class="st">'all'</span>)  <span class="co"># Prevent figure overload</span></span>
<span id="cb125-1006"><a href="#cb125-1006"></a></span>
<span id="cb125-1007"><a href="#cb125-1007"></a><span class="in">```</span></span>
<span id="cb125-1008"><a href="#cb125-1008"></a></span>
<span id="cb125-1011"><a href="#cb125-1011"></a><span class="in">```{python}</span></span>
<span id="cb125-1012"><a href="#cb125-1012"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb125-1013"><a href="#cb125-1013"></a></span>
<span id="cb125-1014"><a href="#cb125-1014"></a>show_ale(wrappedAGModel <span class="op">=</span> ag_model,</span>
<span id="cb125-1015"><a href="#cb125-1015"></a>        list_features <span class="op">=</span> all_features, </span>
<span id="cb125-1016"><a href="#cb125-1016"></a>        df <span class="op">=</span> train_data.drop(columns<span class="op">=</span>[label]), </span>
<span id="cb125-1017"><a href="#cb125-1017"></a>        xGTzero <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb125-1018"><a href="#cb125-1018"></a><span class="in">```</span></span>
<span id="cb125-1019"><a href="#cb125-1019"></a></span>
<span id="cb125-1022"><a href="#cb125-1022"></a><span class="in">```{python}</span></span>
<span id="cb125-1023"><a href="#cb125-1023"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb125-1024"><a href="#cb125-1024"></a></span>
<span id="cb125-1025"><a href="#cb125-1025"></a>show_ale(wrappedAGModel <span class="op">=</span> ag_model,</span>
<span id="cb125-1026"><a href="#cb125-1026"></a>        list_features <span class="op">=</span> numeric_features, </span>
<span id="cb125-1027"><a href="#cb125-1027"></a>        df <span class="op">=</span> train_data.drop(columns<span class="op">=</span>[label]), </span>
<span id="cb125-1028"><a href="#cb125-1028"></a>        xGTzero <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb125-1029"><a href="#cb125-1029"></a><span class="in">```</span></span>
<span id="cb125-1030"><a href="#cb125-1030"></a></span>
<span id="cb125-1031"><a href="#cb125-1031"></a><span class="fu"># Model Evaluation</span></span>
<span id="cb125-1032"><a href="#cb125-1032"></a></span>
<span id="cb125-1033"><a href="#cb125-1033"></a>Evaluate the model using <span class="in">`df_campaign_2`</span>.</span>
<span id="cb125-1034"><a href="#cb125-1034"></a></span>
<span id="cb125-1035"><a href="#cb125-1035"></a>We will bin the predicted probabilities into 5 bins. For each bin, calculate the bin size, number of responses, and response rate. Also calculate the cumulative number of responses and cumulative response rate. Also calculate gain and lift.</span>
<span id="cb125-1036"><a href="#cb125-1036"></a></span>
<span id="cb125-1039"><a href="#cb125-1039"></a><span class="in">```{python}</span></span>
<span id="cb125-1040"><a href="#cb125-1040"></a>y_probas <span class="op">=</span> ag_model.predict_proba(X_campaign2)</span>
<span id="cb125-1041"><a href="#cb125-1041"></a><span class="in">```</span></span>
<span id="cb125-1042"><a href="#cb125-1042"></a></span>
<span id="cb125-1045"><a href="#cb125-1045"></a><span class="in">```{python}</span></span>
<span id="cb125-1046"><a href="#cb125-1046"></a><span class="co"># Create DataFrame with predictions and actual values</span></span>
<span id="cb125-1047"><a href="#cb125-1047"></a>df_analysis <span class="op">=</span> pd.DataFrame({</span>
<span id="cb125-1048"><a href="#cb125-1048"></a>    <span class="st">'score'</span>: y_probas[:,<span class="dv">1</span>],</span>
<span id="cb125-1049"><a href="#cb125-1049"></a>    label: y_campaign2</span>
<span id="cb125-1050"><a href="#cb125-1050"></a>})</span>
<span id="cb125-1051"><a href="#cb125-1051"></a></span>
<span id="cb125-1052"><a href="#cb125-1052"></a><span class="co"># Create bins</span></span>
<span id="cb125-1053"><a href="#cb125-1053"></a>df_analysis[<span class="st">'bin'</span>] <span class="op">=</span> pd.qcut(df_analysis[<span class="st">'score'</span>], q<span class="op">=</span><span class="dv">5</span>, precision<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb125-1054"><a href="#cb125-1054"></a></span>
<span id="cb125-1055"><a href="#cb125-1055"></a><span class="co"># Group by bin and calculate metrics</span></span>
<span id="cb125-1056"><a href="#cb125-1056"></a>df_metrics <span class="op">=</span> (df_analysis</span>
<span id="cb125-1057"><a href="#cb125-1057"></a>            .groupby(<span class="st">'bin'</span>, observed<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb125-1058"><a href="#cb125-1058"></a>            .agg({</span>
<span id="cb125-1059"><a href="#cb125-1059"></a>                <span class="st">'score'</span>: [<span class="st">'mean'</span>, <span class="st">'count'</span>],</span>
<span id="cb125-1060"><a href="#cb125-1060"></a>                label: [<span class="st">'sum'</span>, <span class="st">'mean'</span>]</span>
<span id="cb125-1061"><a href="#cb125-1061"></a>            })</span>
<span id="cb125-1062"><a href="#cb125-1062"></a>            .sort_values(<span class="st">'bin'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb125-1063"><a href="#cb125-1063"></a>            .reset_index()</span>
<span id="cb125-1064"><a href="#cb125-1064"></a>            )</span>
<span id="cb125-1065"><a href="#cb125-1065"></a></span>
<span id="cb125-1066"><a href="#cb125-1066"></a><span class="co"># Rename columns</span></span>
<span id="cb125-1067"><a href="#cb125-1067"></a>df_metrics.columns <span class="op">=</span> [<span class="st">'bin_name'</span>,<span class="st">'avg_score'</span>,<span class="st">'prospects'</span>, <span class="st">'responses'</span>, <span class="st">'response_rate'</span>]</span>
<span id="cb125-1068"><a href="#cb125-1068"></a></span>
<span id="cb125-1069"><a href="#cb125-1069"></a>df_metrics[<span class="st">'exp_responses'</span>] <span class="op">=</span> df_metrics[<span class="st">'prospects'</span>] <span class="op">*</span> df_metrics[<span class="st">'avg_score'</span>]</span>
<span id="cb125-1070"><a href="#cb125-1070"></a></span>
<span id="cb125-1071"><a href="#cb125-1071"></a><span class="co"># Calculate cumulative metrics</span></span>
<span id="cb125-1072"><a href="#cb125-1072"></a>df_metrics[<span class="st">'cum_prospects'</span>] <span class="op">=</span> df_metrics[<span class="st">'prospects'</span>].cumsum()</span>
<span id="cb125-1073"><a href="#cb125-1073"></a>df_metrics[<span class="st">'cum_responses'</span>] <span class="op">=</span> df_metrics[<span class="st">'responses'</span>].cumsum()</span>
<span id="cb125-1074"><a href="#cb125-1074"></a>df_metrics[<span class="st">'cum_response_rate'</span>] <span class="op">=</span> df_metrics[<span class="st">'cum_responses'</span>] <span class="op">/</span> df_metrics[<span class="st">'cum_prospects'</span>]</span>
<span id="cb125-1075"><a href="#cb125-1075"></a></span>
<span id="cb125-1076"><a href="#cb125-1076"></a><span class="co"># Calculate baseline</span></span>
<span id="cb125-1077"><a href="#cb125-1077"></a>base_rate <span class="op">=</span> np.mean(y_campaign2)</span>
<span id="cb125-1078"><a href="#cb125-1078"></a>total_responses <span class="op">=</span> df_metrics[<span class="st">'responses'</span>].<span class="bu">sum</span>()</span>
<span id="cb125-1079"><a href="#cb125-1079"></a></span>
<span id="cb125-1080"><a href="#cb125-1080"></a><span class="co"># Calculate gain and lift</span></span>
<span id="cb125-1081"><a href="#cb125-1081"></a>df_metrics[<span class="st">'gain'</span>] <span class="op">=</span> df_metrics[<span class="st">'cum_responses'</span>] <span class="op">/</span> total_responses</span>
<span id="cb125-1082"><a href="#cb125-1082"></a>df_metrics[<span class="st">'lift'</span>] <span class="op">=</span> df_metrics[<span class="st">'cum_response_rate'</span>] <span class="op">/</span> base_rate</span>
<span id="cb125-1083"><a href="#cb125-1083"></a></span>
<span id="cb125-1084"><a href="#cb125-1084"></a><span class="co"># Reorder columns in a more intuitive order</span></span>
<span id="cb125-1085"><a href="#cb125-1085"></a>column_order <span class="op">=</span> [<span class="st">'bin_name'</span>, <span class="st">'avg_score'</span>,</span>
<span id="cb125-1086"><a href="#cb125-1086"></a>                <span class="st">'prospects'</span>, <span class="st">'exp_responses'</span>, <span class="st">'responses'</span>, <span class="st">'response_rate'</span>,</span>
<span id="cb125-1087"><a href="#cb125-1087"></a>                <span class="st">'cum_prospects'</span>, <span class="st">'cum_responses'</span>, <span class="st">'cum_response_rate'</span>,</span>
<span id="cb125-1088"><a href="#cb125-1088"></a>                <span class="st">'gain'</span>, <span class="st">'lift'</span>]</span>
<span id="cb125-1089"><a href="#cb125-1089"></a>df_metrics <span class="op">=</span> df_metrics[column_order]</span>
<span id="cb125-1090"><a href="#cb125-1090"></a><span class="in">```</span></span>
<span id="cb125-1091"><a href="#cb125-1091"></a></span>
<span id="cb125-1094"><a href="#cb125-1094"></a><span class="in">```{python}</span></span>
<span id="cb125-1095"><a href="#cb125-1095"></a><span class="co">#| label: tbl-metrics</span></span>
<span id="cb125-1096"><a href="#cb125-1096"></a><span class="co">#| tbl-cap: "Gain and Lift Table"</span></span>
<span id="cb125-1097"><a href="#cb125-1097"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1098"><a href="#cb125-1098"></a></span>
<span id="cb125-1099"><a href="#cb125-1099"></a>display(df_metrics)</span>
<span id="cb125-1100"><a href="#cb125-1100"></a><span class="in">```</span></span>
<span id="cb125-1101"><a href="#cb125-1101"></a></span>
<span id="cb125-1102"><a href="#cb125-1102"></a><span class="fu">## Q&amp;A</span></span>
<span id="cb125-1103"><a href="#cb125-1103"></a></span>
<span id="cb125-1104"><a href="#cb125-1104"></a><span class="fu">### Question</span></span>
<span id="cb125-1105"><a href="#cb125-1105"></a></span>
<span id="cb125-1106"><a href="#cb125-1106"></a>::: callout-note</span>
<span id="cb125-1107"><a href="#cb125-1107"></a>In the first bin, how were the <span class="in">`19,197`</span> prospects selected?</span>
<span id="cb125-1108"><a href="#cb125-1108"></a>:::</span>
<span id="cb125-1109"><a href="#cb125-1109"></a></span>
<span id="cb125-1110"><a href="#cb125-1110"></a><span class="fu">### Question</span></span>
<span id="cb125-1111"><a href="#cb125-1111"></a></span>
<span id="cb125-1112"><a href="#cb125-1112"></a>::: callout-note</span>
<span id="cb125-1113"><a href="#cb125-1113"></a>In the first bin, <span class="in">`19,197`</span> prospects were sent direct mail.</span>
<span id="cb125-1114"><a href="#cb125-1114"></a></span>
<span id="cb125-1115"><a href="#cb125-1115"></a>In the first bin, we expected <span class="sc">\_\_\_\_\_</span> responses. The actual number of responses was <span class="sc">\_\_\_\_\_</span>.</span>
<span id="cb125-1116"><a href="#cb125-1116"></a>:::</span>
<span id="cb125-1117"><a href="#cb125-1117"></a></span>
<span id="cb125-1118"><a href="#cb125-1118"></a><span class="fu">### Question</span></span>
<span id="cb125-1119"><a href="#cb125-1119"></a></span>
<span id="cb125-1120"><a href="#cb125-1120"></a>::: callout-note</span>
<span id="cb125-1121"><a href="#cb125-1121"></a>Instead of using your model to select <span class="in">`19,197`</span> prospects, suppose you randomly selected <span class="in">`19,197`</span> prospects. How many of them would you expect to respond?</span>
<span id="cb125-1122"><a href="#cb125-1122"></a>:::</span>
<span id="cb125-1123"><a href="#cb125-1123"></a></span>
<span id="cb125-1124"><a href="#cb125-1124"></a><span class="fu">### Question</span></span>
<span id="cb125-1125"><a href="#cb125-1125"></a></span>
<span id="cb125-1126"><a href="#cb125-1126"></a>::: callout-note</span>
<span id="cb125-1127"><a href="#cb125-1127"></a>Compare the following two campaign strategies:</span>
<span id="cb125-1128"><a href="#cb125-1128"></a></span>
<span id="cb125-1129"><a href="#cb125-1129"></a>(1) Select <span class="in">`19,197`</span> prospects based on the highest model scores. The actual number of responses is <span class="in">`a`</span>.</span>
<span id="cb125-1130"><a href="#cb125-1130"></a></span>
<span id="cb125-1131"><a href="#cb125-1131"></a>(2) Randomly select <span class="in">`19,197`</span> prospects. The expected number of responses is <span class="in">`b`</span>.</span>
<span id="cb125-1132"><a href="#cb125-1132"></a></span>
<span id="cb125-1133"><a href="#cb125-1133"></a>The ratio $\frac{a}{b}$ is <span class="sc">\_\_\_\_\_\_</span>. The value corresponds to the <span class="sc">\_\_\_\_\_\_</span> in the first bin.</span>
<span id="cb125-1134"><a href="#cb125-1134"></a>:::</span>
<span id="cb125-1135"><a href="#cb125-1135"></a></span>
<span id="cb125-1136"><a href="#cb125-1136"></a><span class="fu">### Question</span></span>
<span id="cb125-1137"><a href="#cb125-1137"></a></span>
<span id="cb125-1138"><a href="#cb125-1138"></a>::: callout-note</span>
<span id="cb125-1139"><a href="#cb125-1139"></a>Suppose the average cost of sending direct mail is \$7.00 per prospect and the average revenue from a response is \$100 per client.</span>
<span id="cb125-1140"><a href="#cb125-1140"></a></span>
<span id="cb125-1141"><a href="#cb125-1141"></a>The ROI of randomly selecting <span class="in">`19,197`</span> prospects is: <span class="sc">\_\_\_\_</span>.</span>
<span id="cb125-1142"><a href="#cb125-1142"></a></span>
<span id="cb125-1143"><a href="#cb125-1143"></a>The ROI of selecting <span class="in">`19,197`</span> prospects based on the highest model scores is: <span class="sc">\_\_\_\_</span>.</span>
<span id="cb125-1144"><a href="#cb125-1144"></a>:::</span>
<span id="cb125-1145"><a href="#cb125-1145"></a></span>
<span id="cb125-1146"><a href="#cb125-1146"></a><span class="fu">### Question</span></span>
<span id="cb125-1147"><a href="#cb125-1147"></a></span>
<span id="cb125-1148"><a href="#cb125-1148"></a>::: callout-note</span>
<span id="cb125-1149"><a href="#cb125-1149"></a>Compare the following two campaign strategies:</span>
<span id="cb125-1150"><a href="#cb125-1150"></a></span>
<span id="cb125-1151"><a href="#cb125-1151"></a>(1) Select <span class="in">`38,225`</span> prospects based on the highest model scores. The actual number of responses is <span class="in">`a`</span>.</span>
<span id="cb125-1152"><a href="#cb125-1152"></a></span>
<span id="cb125-1153"><a href="#cb125-1153"></a>(2) Randomly select <span class="in">`38,225`</span> prospects. The expected number of responses is <span class="in">`b`</span>.</span>
<span id="cb125-1154"><a href="#cb125-1154"></a></span>
<span id="cb125-1155"><a href="#cb125-1155"></a>The ratio $\frac{a}{b}$ is <span class="sc">\_\_\_\_\_</span>. The value corresponds to the <span class="sc">\_\_\_\_\_</span> in the <span class="sc">\_\_\_\_\_</span> bin.</span>
<span id="cb125-1156"><a href="#cb125-1156"></a>:::</span>
<span id="cb125-1157"><a href="#cb125-1157"></a></span>
<span id="cb125-1158"><a href="#cb125-1158"></a><span class="fu">### Question</span></span>
<span id="cb125-1159"><a href="#cb125-1159"></a></span>
<span id="cb125-1160"><a href="#cb125-1160"></a>::: callout-note</span>
<span id="cb125-1161"><a href="#cb125-1161"></a>Suppose the average cost of sending direct mail is \$7.00 per prospect and the average revenue from a response is \$100 per client.</span>
<span id="cb125-1162"><a href="#cb125-1162"></a></span>
<span id="cb125-1163"><a href="#cb125-1163"></a>The ROI of randomly selecting <span class="in">`38,225`</span> prospects is: <span class="sc">\_\_\_\_</span>.</span>
<span id="cb125-1164"><a href="#cb125-1164"></a></span>
<span id="cb125-1165"><a href="#cb125-1165"></a>The ROI of selecting <span class="in">`38,225`</span> prospects based on the highest model scores is: <span class="sc">\_\_\_\_</span>.</span>
<span id="cb125-1166"><a href="#cb125-1166"></a>:::</span>
<span id="cb125-1167"><a href="#cb125-1167"></a></span>
<span id="cb125-1168"><a href="#cb125-1168"></a><span class="fu">## Gain and Lift Plots</span></span>
<span id="cb125-1169"><a href="#cb125-1169"></a></span>
<span id="cb125-1172"><a href="#cb125-1172"></a><span class="in">```{python}</span></span>
<span id="cb125-1173"><a href="#cb125-1173"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb125-1174"><a href="#cb125-1174"></a>plt.plot([<span class="dv">0</span>] <span class="op">+</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df_metrics) <span class="op">+</span> <span class="dv">1</span>)), [<span class="dv">0</span>] <span class="op">+</span> <span class="bu">list</span>(df_metrics[<span class="st">'gain'</span>]), marker<span class="op">=</span><span class="st">'o'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb125-1175"><a href="#cb125-1175"></a>plt.plot([<span class="dv">0</span>, <span class="bu">len</span>(df_metrics)], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'--'</span>, color<span class="op">=</span><span class="st">'gray'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb125-1176"><a href="#cb125-1176"></a>plt.xlabel(<span class="st">'Bin (Highest to Lowest Probability)'</span>)</span>
<span id="cb125-1177"><a href="#cb125-1177"></a>plt.ylabel(<span class="st">'Gain'</span>)</span>
<span id="cb125-1178"><a href="#cb125-1178"></a>plt.title(<span class="st">'Gain Chart'</span>)</span>
<span id="cb125-1179"><a href="#cb125-1179"></a>plt.xticks(<span class="bu">range</span>(<span class="bu">len</span>(df_metrics) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb125-1180"><a href="#cb125-1180"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb125-1181"><a href="#cb125-1181"></a>plt.show()</span>
<span id="cb125-1182"><a href="#cb125-1182"></a><span class="in">```</span></span>
<span id="cb125-1183"><a href="#cb125-1183"></a></span>
<span id="cb125-1186"><a href="#cb125-1186"></a><span class="in">```{python}</span></span>
<span id="cb125-1187"><a href="#cb125-1187"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb125-1188"><a href="#cb125-1188"></a>plt.plot(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df_metrics) <span class="op">+</span> <span class="dv">1</span>), df_metrics[<span class="st">'lift'</span>], marker<span class="op">=</span><span class="st">'o'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb125-1189"><a href="#cb125-1189"></a>plt.axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb125-1190"><a href="#cb125-1190"></a>plt.xlabel(<span class="st">'Bin (Highest to Lowest Probability)'</span>)</span>
<span id="cb125-1191"><a href="#cb125-1191"></a>plt.ylabel(<span class="st">'Lift'</span>)</span>
<span id="cb125-1192"><a href="#cb125-1192"></a>plt.title(<span class="st">'Lift Chart'</span>)</span>
<span id="cb125-1193"><a href="#cb125-1193"></a>plt.xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df_metrics) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb125-1194"><a href="#cb125-1194"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb125-1195"><a href="#cb125-1195"></a>plt.show()</span>
<span id="cb125-1196"><a href="#cb125-1196"></a><span class="in">```</span></span>
<span id="cb125-1197"><a href="#cb125-1197"></a></span>
<span id="cb125-1198"><a href="#cb125-1198"></a><span class="fu">## Gain and Lift Plots (Automated)</span></span>
<span id="cb125-1199"><a href="#cb125-1199"></a></span>
<span id="cb125-1202"><a href="#cb125-1202"></a><span class="in">```{python}</span></span>
<span id="cb125-1203"><a href="#cb125-1203"></a><span class="co"># Get probability predictions</span></span>
<span id="cb125-1204"><a href="#cb125-1204"></a>y_probas <span class="op">=</span> ag_model.predict_proba(X_campaign2)</span>
<span id="cb125-1205"><a href="#cb125-1205"></a></span>
<span id="cb125-1206"><a href="#cb125-1206"></a><span class="co"># Create cumulative gain plot</span></span>
<span id="cb125-1207"><a href="#cb125-1207"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb125-1208"><a href="#cb125-1208"></a></span>
<span id="cb125-1209"><a href="#cb125-1209"></a>plot_cumulative_gain(y_campaign2, y_probas)</span>
<span id="cb125-1210"><a href="#cb125-1210"></a></span>
<span id="cb125-1211"><a href="#cb125-1211"></a>plt.title(<span class="st">'Cumulative Gains Plot - Campaign 2'</span>)</span>
<span id="cb125-1212"><a href="#cb125-1212"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb125-1213"><a href="#cb125-1213"></a>plt.show()</span>
<span id="cb125-1214"><a href="#cb125-1214"></a><span class="in">```</span></span>
<span id="cb125-1215"><a href="#cb125-1215"></a></span>
<span id="cb125-1218"><a href="#cb125-1218"></a><span class="in">```{python}</span></span>
<span id="cb125-1219"><a href="#cb125-1219"></a><span class="co"># Create lift curve plot</span></span>
<span id="cb125-1220"><a href="#cb125-1220"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb125-1221"><a href="#cb125-1221"></a></span>
<span id="cb125-1222"><a href="#cb125-1222"></a>plot_lift_curve(y_campaign2, y_probas)</span>
<span id="cb125-1223"><a href="#cb125-1223"></a></span>
<span id="cb125-1224"><a href="#cb125-1224"></a>plt.title(<span class="st">'Lift Curve - Campaign 2'</span>)</span>
<span id="cb125-1225"><a href="#cb125-1225"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb125-1226"><a href="#cb125-1226"></a>plt.show()</span>
<span id="cb125-1227"><a href="#cb125-1227"></a><span class="in">```</span></span>
<span id="cb125-1228"><a href="#cb125-1228"></a></span>
<span id="cb125-1229"><a href="#cb125-1229"></a><span class="fu"># Pick a Threshold to Maximize F1 Score</span></span>
<span id="cb125-1230"><a href="#cb125-1230"></a></span>
<span id="cb125-1231"><a href="#cb125-1231"></a>In campaign 3, we have a limited campaign budget. We want to maximize the number of responses while minimizing the number of prospects who are sent direct mail.</span>
<span id="cb125-1232"><a href="#cb125-1232"></a></span>
<span id="cb125-1233"><a href="#cb125-1233"></a>One approach is to select a threshold that maximizes the F1 score.</span>
<span id="cb125-1234"><a href="#cb125-1234"></a></span>
<span id="cb125-1235"><a href="#cb125-1235"></a>First, we check the F1 score for the default threshold of <span class="in">`0.5`</span>.</span>
<span id="cb125-1236"><a href="#cb125-1236"></a></span>
<span id="cb125-1239"><a href="#cb125-1239"></a><span class="in">```{python}</span></span>
<span id="cb125-1240"><a href="#cb125-1240"></a>df_leaders_f1 <span class="op">=</span> (ag_model</span>
<span id="cb125-1241"><a href="#cb125-1241"></a>            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb125-1242"><a href="#cb125-1242"></a>            .predictor</span>
<span id="cb125-1243"><a href="#cb125-1243"></a>            .leaderboard(</span>
<span id="cb125-1244"><a href="#cb125-1244"></a>                test_data, </span>
<span id="cb125-1245"><a href="#cb125-1245"></a>                extra_metrics<span class="op">=</span>[<span class="st">'f1'</span>, <span class="st">'precision'</span>, <span class="st">'recall'</span>])</span>
<span id="cb125-1246"><a href="#cb125-1246"></a>            )</span>
<span id="cb125-1247"><a href="#cb125-1247"></a></span>
<span id="cb125-1248"><a href="#cb125-1248"></a><span class="in">```</span></span>
<span id="cb125-1249"><a href="#cb125-1249"></a></span>
<span id="cb125-1252"><a href="#cb125-1252"></a><span class="in">```{python}</span></span>
<span id="cb125-1253"><a href="#cb125-1253"></a><span class="co">#| label: tbl-ag-leaderboard-f1</span></span>
<span id="cb125-1254"><a href="#cb125-1254"></a><span class="co">#| tbl-cap: "Autogluon Leaderboard with F1 Score (Threshold = 0.5)"</span></span>
<span id="cb125-1255"><a href="#cb125-1255"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1256"><a href="#cb125-1256"></a></span>
<span id="cb125-1257"><a href="#cb125-1257"></a>display(df_leaders_f1)</span>
<span id="cb125-1258"><a href="#cb125-1258"></a><span class="in">```</span></span>
<span id="cb125-1259"><a href="#cb125-1259"></a></span>
<span id="cb125-1260"><a href="#cb125-1260"></a>In order to avoid overfitting, we will use <span class="in">`df_campaign_2`</span> to select the threshold that maximizes the F1 score.</span>
<span id="cb125-1261"><a href="#cb125-1261"></a></span>
<span id="cb125-1264"><a href="#cb125-1264"></a><span class="in">```{python}</span></span>
<span id="cb125-1265"><a href="#cb125-1265"></a>best_threshold <span class="op">=</span> (ag_model</span>
<span id="cb125-1266"><a href="#cb125-1266"></a>                .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb125-1267"><a href="#cb125-1267"></a>                .predictor</span>
<span id="cb125-1268"><a href="#cb125-1268"></a>                .calibrate_decision_threshold(</span>
<span id="cb125-1269"><a href="#cb125-1269"></a>                data <span class="op">=</span> df_campaign_2,</span>
<span id="cb125-1270"><a href="#cb125-1270"></a>                metric <span class="op">=</span> <span class="st">'f1'</span>,</span>
<span id="cb125-1271"><a href="#cb125-1271"></a>                decision_thresholds <span class="op">=</span> <span class="dv">100</span>)</span>
<span id="cb125-1272"><a href="#cb125-1272"></a>                )</span>
<span id="cb125-1273"><a href="#cb125-1273"></a></span>
<span id="cb125-1274"><a href="#cb125-1274"></a>ag_model.named_steps[<span class="st">'autogluon'</span>].predictor.set_decision_threshold(best_threshold)</span>
<span id="cb125-1275"><a href="#cb125-1275"></a><span class="in">```</span></span>
<span id="cb125-1276"><a href="#cb125-1276"></a></span>
<span id="cb125-1277"><a href="#cb125-1277"></a>Finally, we check the F1 score for the new threshold.</span>
<span id="cb125-1278"><a href="#cb125-1278"></a></span>
<span id="cb125-1281"><a href="#cb125-1281"></a><span class="in">```{python}</span></span>
<span id="cb125-1282"><a href="#cb125-1282"></a>df_leaders_f1_best <span class="op">=</span> (ag_model</span>
<span id="cb125-1283"><a href="#cb125-1283"></a>            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb125-1284"><a href="#cb125-1284"></a>            .predictor</span>
<span id="cb125-1285"><a href="#cb125-1285"></a>            .leaderboard(</span>
<span id="cb125-1286"><a href="#cb125-1286"></a>                test_data, </span>
<span id="cb125-1287"><a href="#cb125-1287"></a>                extra_metrics<span class="op">=</span>[<span class="st">'f1'</span>, <span class="st">'precision'</span>, <span class="st">'recall'</span>])</span>
<span id="cb125-1288"><a href="#cb125-1288"></a>            )</span>
<span id="cb125-1289"><a href="#cb125-1289"></a><span class="in">```</span></span>
<span id="cb125-1290"><a href="#cb125-1290"></a></span>
<span id="cb125-1293"><a href="#cb125-1293"></a><span class="in">```{python}</span></span>
<span id="cb125-1294"><a href="#cb125-1294"></a><span class="co">#| label: tbl-ag-leaderboard-f1-best</span></span>
<span id="cb125-1295"><a href="#cb125-1295"></a><span class="co">#| tbl-cap: "Autogluon Leaderboard with F1 Score (Best Threshold)"</span></span>
<span id="cb125-1296"><a href="#cb125-1296"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1297"><a href="#cb125-1297"></a></span>
<span id="cb125-1298"><a href="#cb125-1298"></a>display(df_leaders_f1_best)</span>
<span id="cb125-1299"><a href="#cb125-1299"></a><span class="in">```</span></span>
<span id="cb125-1300"><a href="#cb125-1300"></a></span>
<span id="cb125-1301"><a href="#cb125-1301"></a><span class="fu"># Select Targets</span></span>
<span id="cb125-1302"><a href="#cb125-1302"></a></span>
<span id="cb125-1303"><a href="#cb125-1303"></a>We randomly select <span class="in">`1,000`</span> prospects as a control group. We will send direct mail to everyone in the control group. The control group gives us a baseline response rate.</span>
<span id="cb125-1304"><a href="#cb125-1304"></a></span>
<span id="cb125-1307"><a href="#cb125-1307"></a><span class="in">```{python}</span></span>
<span id="cb125-1308"><a href="#cb125-1308"></a><span class="co"># Randomly select 1000 prospects for control group</span></span>
<span id="cb125-1309"><a href="#cb125-1309"></a>df_campaign_3_control_group <span class="op">=</span> df_campaign_3.sample(n<span class="op">=</span><span class="dv">1000</span>, random_state<span class="op">=</span><span class="dv">2025</span>)</span>
<span id="cb125-1310"><a href="#cb125-1310"></a></span>
<span id="cb125-1311"><a href="#cb125-1311"></a>df_campaign_3_control_group[<span class="st">'group_type'</span>] <span class="op">=</span> <span class="st">'control'</span></span>
<span id="cb125-1312"><a href="#cb125-1312"></a>df_campaign_3_control_group[<span class="st">'direct_mail_flag'</span>] <span class="op">=</span> <span class="st">'Y'</span></span>
<span id="cb125-1313"><a href="#cb125-1313"></a><span class="in">```</span></span>
<span id="cb125-1314"><a href="#cb125-1314"></a></span>
<span id="cb125-1315"><a href="#cb125-1315"></a>Create <span class="in">`df_campaign_3_treatment`</span> by removing the control group from <span class="in">`df_campaign_3`</span>.</span>
<span id="cb125-1316"><a href="#cb125-1316"></a></span>
<span id="cb125-1319"><a href="#cb125-1319"></a><span class="in">```{python}</span></span>
<span id="cb125-1320"><a href="#cb125-1320"></a>df_campaign_3_treatment <span class="op">=</span> df_campaign_3.drop(df_campaign_3_control_group.index)</span>
<span id="cb125-1321"><a href="#cb125-1321"></a><span class="in">```</span></span>
<span id="cb125-1322"><a href="#cb125-1322"></a></span>
<span id="cb125-1323"><a href="#cb125-1323"></a>Then, we send direct mail to all the prospects in <span class="in">`df_campaign_3_treatment`</span> that exceed the best threshold. We are assuming that the prospects in <span class="in">`df_campaign_3_treatment`</span> meet the other campaign selection criteria that were determined by the risk, strategy, and legal teams.</span>
<span id="cb125-1324"><a href="#cb125-1324"></a></span>
<span id="cb125-1327"><a href="#cb125-1327"></a><span class="in">```{python}</span></span>
<span id="cb125-1328"><a href="#cb125-1328"></a>X_campaign3 <span class="op">=</span> df_campaign_3_treatment[subset_cols].copy()</span>
<span id="cb125-1329"><a href="#cb125-1329"></a>X_campaign3[<span class="st">'last_prod_enq2'</span>] <span class="op">=</span> X_campaign3[<span class="st">'last_prod_enq2'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb125-1330"><a href="#cb125-1330"></a></span>
<span id="cb125-1331"><a href="#cb125-1331"></a>preds <span class="op">=</span> ag_model.predict(X_campaign3.drop(columns<span class="op">=</span>[label]))</span>
<span id="cb125-1332"><a href="#cb125-1332"></a></span>
<span id="cb125-1333"><a href="#cb125-1333"></a>df_campaign_3_treatment[<span class="st">'direct_mail_flag'</span>] <span class="op">=</span> np.where(preds <span class="op">==</span> <span class="dv">1</span>, <span class="st">'Y'</span>, <span class="st">'N'</span>)</span>
<span id="cb125-1334"><a href="#cb125-1334"></a></span>
<span id="cb125-1335"><a href="#cb125-1335"></a><span class="co"># Filter to only keep prospects that will receive direct mail</span></span>
<span id="cb125-1336"><a href="#cb125-1336"></a>df_campaign_3_treatment_mail <span class="op">=</span> df_campaign_3_treatment[df_campaign_3_treatment[<span class="st">'direct_mail_flag'</span>] <span class="op">==</span> <span class="st">'Y'</span>].copy()</span>
<span id="cb125-1337"><a href="#cb125-1337"></a></span>
<span id="cb125-1338"><a href="#cb125-1338"></a>df_campaign_3_treatment_mail[<span class="st">'group_type'</span>] <span class="op">=</span> <span class="st">'treatment'</span></span>
<span id="cb125-1339"><a href="#cb125-1339"></a></span>
<span id="cb125-1340"><a href="#cb125-1340"></a><span class="co"># Append rows from controls and treatment into a single data frame</span></span>
<span id="cb125-1341"><a href="#cb125-1341"></a>keep_cols <span class="op">=</span> [<span class="st">'PROSPECTID'</span>, <span class="st">'campaign_id'</span>, <span class="st">'group_type'</span>, <span class="st">'direct_mail_flag'</span>]    </span>
<span id="cb125-1342"><a href="#cb125-1342"></a></span>
<span id="cb125-1343"><a href="#cb125-1343"></a>df_campaign_3_selected <span class="op">=</span> (pd.concat([</span>
<span id="cb125-1344"><a href="#cb125-1344"></a>        df_campaign_3_control_group[keep_cols], </span>
<span id="cb125-1345"><a href="#cb125-1345"></a>        df_campaign_3_treatment_mail[keep_cols]</span>
<span id="cb125-1346"><a href="#cb125-1346"></a>        ],</span>
<span id="cb125-1347"><a href="#cb125-1347"></a>    ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb125-1348"><a href="#cb125-1348"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb125-1349"><a href="#cb125-1349"></a><span class="in">```</span></span>
<span id="cb125-1350"><a href="#cb125-1350"></a></span>
<span id="cb125-1351"><a href="#cb125-1351"></a><span class="fu"># Measure Campaign Effectiveness</span></span>
<span id="cb125-1352"><a href="#cb125-1352"></a></span>
<span id="cb125-1353"><a href="#cb125-1353"></a>The file <span class="in">`campaign_eval.parquet`</span> contains the results of the campaign. We will join the data set with df_campaign_3_selected to measure the effectiveness of the campaign.</span>
<span id="cb125-1354"><a href="#cb125-1354"></a></span>
<span id="cb125-1357"><a href="#cb125-1357"></a><span class="in">```{python}</span></span>
<span id="cb125-1358"><a href="#cb125-1358"></a>df_campaign_eval <span class="op">=</span> duckdb.query(<span class="st">"""</span></span>
<span id="cb125-1359"><a href="#cb125-1359"></a><span class="st">    SELECT SELECTED.*, EVAL.response_flag</span></span>
<span id="cb125-1360"><a href="#cb125-1360"></a><span class="st">    FROM read_parquet('../Data/cibil/campaign_eval.parquet') AS EVAL</span></span>
<span id="cb125-1361"><a href="#cb125-1361"></a><span class="st">    INNER JOIN df_campaign_3_selected AS SELECTED</span></span>
<span id="cb125-1362"><a href="#cb125-1362"></a><span class="st">    ON EVAL.PROSPECTID = SELECTED.PROSPECTID</span></span>
<span id="cb125-1363"><a href="#cb125-1363"></a><span class="st">    ORDER BY SELECTED.group_type, SELECTED.PROSPECTID</span></span>
<span id="cb125-1364"><a href="#cb125-1364"></a><span class="st">"""</span>).to_df()</span>
<span id="cb125-1365"><a href="#cb125-1365"></a><span class="in">```</span></span>
<span id="cb125-1366"><a href="#cb125-1366"></a></span>
<span id="cb125-1369"><a href="#cb125-1369"></a><span class="in">```{python}</span></span>
<span id="cb125-1370"><a href="#cb125-1370"></a><span class="co">#| label: tbl-campaign-top5-eval</span></span>
<span id="cb125-1371"><a href="#cb125-1371"></a><span class="co">#| tbl-cap: "First 5 rows of df_campaign_eval"</span></span>
<span id="cb125-1372"><a href="#cb125-1372"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1373"><a href="#cb125-1373"></a></span>
<span id="cb125-1374"><a href="#cb125-1374"></a>df_campaign_eval.head()</span>
<span id="cb125-1375"><a href="#cb125-1375"></a><span class="in">```</span></span>
<span id="cb125-1376"><a href="#cb125-1376"></a></span>
<span id="cb125-1377"><a href="#cb125-1377"></a>Summarize the results.</span>
<span id="cb125-1378"><a href="#cb125-1378"></a></span>
<span id="cb125-1381"><a href="#cb125-1381"></a><span class="in">```{python}</span></span>
<span id="cb125-1382"><a href="#cb125-1382"></a>df_eval_agg <span class="op">=</span> (df_campaign_eval</span>
<span id="cb125-1383"><a href="#cb125-1383"></a>    .groupby([<span class="st">'group_type'</span>, <span class="st">'direct_mail_flag'</span>])</span>
<span id="cb125-1384"><a href="#cb125-1384"></a>    .agg({</span>
<span id="cb125-1385"><a href="#cb125-1385"></a>        <span class="st">'response_flag'</span>: [<span class="st">'count'</span>, <span class="st">'sum'</span>, <span class="st">'mean'</span>]</span>
<span id="cb125-1386"><a href="#cb125-1386"></a>    })</span>
<span id="cb125-1387"><a href="#cb125-1387"></a>    .reset_index()</span>
<span id="cb125-1388"><a href="#cb125-1388"></a>)</span>
<span id="cb125-1389"><a href="#cb125-1389"></a></span>
<span id="cb125-1390"><a href="#cb125-1390"></a>df_eval_agg.columns <span class="op">=</span> [<span class="st">'group_type'</span>, <span class="st">'direct_mail_flag'</span>, <span class="st">'prospects'</span>, <span class="st">'responses'</span>, <span class="st">'response_rate'</span>]</span>
<span id="cb125-1391"><a href="#cb125-1391"></a><span class="in">```</span></span>
<span id="cb125-1392"><a href="#cb125-1392"></a></span>
<span id="cb125-1395"><a href="#cb125-1395"></a><span class="in">```{python}</span></span>
<span id="cb125-1396"><a href="#cb125-1396"></a><span class="co">#| label: tbl-campaign-agg</span></span>
<span id="cb125-1397"><a href="#cb125-1397"></a><span class="co">#| tbl-cap: "Campaign Effectiveness"</span></span>
<span id="cb125-1398"><a href="#cb125-1398"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1399"><a href="#cb125-1399"></a></span>
<span id="cb125-1400"><a href="#cb125-1400"></a>display(df_eval_agg)</span>
<span id="cb125-1401"><a href="#cb125-1401"></a><span class="in">```</span></span>
<span id="cb125-1402"><a href="#cb125-1402"></a></span>
<span id="cb125-1403"><a href="#cb125-1403"></a><span class="fu"># Measure Campaign ROI</span></span>
<span id="cb125-1404"><a href="#cb125-1404"></a></span>
<span id="cb125-1405"><a href="#cb125-1405"></a>The treatment group has a much higher response rate than the control group. The ROI of the treatment group is also much higher than the ROI of the control group.</span>
<span id="cb125-1406"><a href="#cb125-1406"></a></span>
<span id="cb125-1407"><a href="#cb125-1407"></a>The ROI calculation is based on the following assumptions:</span>
<span id="cb125-1408"><a href="#cb125-1408"></a></span>
<span id="cb125-1409"><a href="#cb125-1409"></a><span class="ss">-   </span>The average cost depends on whether the prospect was sent direct mail:</span>
<span id="cb125-1410"><a href="#cb125-1410"></a><span class="ss">    -   </span>Each prospect (regardless of whether they were sent direct mail) costs \$1.00.</span>
<span id="cb125-1411"><a href="#cb125-1411"></a><span class="ss">    -   </span>Each prospect that was sent direct mail incurs an *additional* \$6.00 cost.</span>
<span id="cb125-1412"><a href="#cb125-1412"></a><span class="ss">-   </span>The average revenue from a response is \$100.00.</span>
<span id="cb125-1413"><a href="#cb125-1413"></a></span>
<span id="cb125-1414"><a href="#cb125-1414"></a>In prior campaigns, the average cost was \$7.00 per prospect because *all* prospects were sent direct mail. In this campaign, we are sending direct mail to only a subset of prospects.</span>
<span id="cb125-1415"><a href="#cb125-1415"></a></span>
<span id="cb125-1418"><a href="#cb125-1418"></a><span class="in">```{python}</span></span>
<span id="cb125-1419"><a href="#cb125-1419"></a><span class="kw">def</span> calc_ROI(num_mailed, </span>
<span id="cb125-1420"><a href="#cb125-1420"></a>            num_responded, </span>
<span id="cb125-1421"><a href="#cb125-1421"></a>            avg_mail_cost, </span>
<span id="cb125-1422"><a href="#cb125-1422"></a>            avg_revenue, </span>
<span id="cb125-1423"><a href="#cb125-1423"></a>            num_prospects, </span>
<span id="cb125-1424"><a href="#cb125-1424"></a>            avg_prospect_cost):</span>
<span id="cb125-1425"><a href="#cb125-1425"></a>    total_cost <span class="op">=</span> (num_mailed <span class="op">*</span> avg_mail_cost) <span class="op">+</span> (num_prospects <span class="op">*</span> avg_prospect_cost)</span>
<span id="cb125-1426"><a href="#cb125-1426"></a>    total_revenue <span class="op">=</span> num_responded <span class="op">*</span> avg_revenue</span>
<span id="cb125-1427"><a href="#cb125-1427"></a>    roi <span class="op">=</span> (total_revenue <span class="op">-</span> total_cost) <span class="op">/</span> total_cost <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb125-1428"><a href="#cb125-1428"></a>    <span class="cf">return</span> roi</span>
<span id="cb125-1429"><a href="#cb125-1429"></a><span class="in">```</span></span>
<span id="cb125-1430"><a href="#cb125-1430"></a></span>
<span id="cb125-1433"><a href="#cb125-1433"></a><span class="in">```{python}</span></span>
<span id="cb125-1434"><a href="#cb125-1434"></a>roi_control <span class="op">=</span> calc_ROI(num_mailed <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb125-1435"><a href="#cb125-1435"></a>                        num_responded <span class="op">=</span> <span class="dv">49</span>, </span>
<span id="cb125-1436"><a href="#cb125-1436"></a>                        avg_mail_cost <span class="op">=</span> <span class="dv">6</span>,</span>
<span id="cb125-1437"><a href="#cb125-1437"></a>                        avg_revenue <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb125-1438"><a href="#cb125-1438"></a>                        num_prospects <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb125-1439"><a href="#cb125-1439"></a>                        avg_prospect_cost <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb125-1440"><a href="#cb125-1440"></a></span>
<span id="cb125-1441"><a href="#cb125-1441"></a>roi_treatment <span class="op">=</span> calc_ROI(num_mailed <span class="op">=</span> <span class="dv">4338</span>,</span>
<span id="cb125-1442"><a href="#cb125-1442"></a>                        num_responded <span class="op">=</span> <span class="dv">1625</span>, </span>
<span id="cb125-1443"><a href="#cb125-1443"></a>                        avg_mail_cost <span class="op">=</span> <span class="dv">6</span>,</span>
<span id="cb125-1444"><a href="#cb125-1444"></a>                        avg_revenue <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb125-1445"><a href="#cb125-1445"></a>                        num_prospects <span class="op">=</span> <span class="dv">95889</span> <span class="op">-</span> <span class="dv">1000</span>,</span>
<span id="cb125-1446"><a href="#cb125-1446"></a>                        avg_prospect_cost <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb125-1447"><a href="#cb125-1447"></a></span>
<span id="cb125-1448"><a href="#cb125-1448"></a><span class="bu">print</span>(<span class="ss">f"Control Group ROI: </span><span class="sc">{</span>roi_control<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb125-1449"><a href="#cb125-1449"></a><span class="bu">print</span>(<span class="ss">f"Treatment Group ROI: </span><span class="sc">{</span>roi_treatment<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb125-1450"><a href="#cb125-1450"></a><span class="in">```</span></span>
<span id="cb125-1451"><a href="#cb125-1451"></a></span>
<span id="cb125-1452"><a href="#cb125-1452"></a><span class="fu"># Feature Reduction Methods</span></span>
<span id="cb125-1453"><a href="#cb125-1453"></a></span>
<span id="cb125-1454"><a href="#cb125-1454"></a>Up until now, we used only a small subset of the features.</span>
<span id="cb125-1455"><a href="#cb125-1455"></a></span>
<span id="cb125-1458"><a href="#cb125-1458"></a><span class="in">```{python}</span></span>
<span id="cb125-1459"><a href="#cb125-1459"></a>display(subset_cols)</span>
<span id="cb125-1460"><a href="#cb125-1460"></a><span class="in">```</span></span>
<span id="cb125-1461"><a href="#cb125-1461"></a></span>
<span id="cb125-1462"><a href="#cb125-1462"></a>We will now widen the data frames to include more features, and explore feature reduction methods.</span>
<span id="cb125-1463"><a href="#cb125-1463"></a></span>
<span id="cb125-1464"><a href="#cb125-1464"></a>We need to remove features that are protected by US law.</span>
<span id="cb125-1465"><a href="#cb125-1465"></a></span>
<span id="cb125-1468"><a href="#cb125-1468"></a><span class="in">```{python}</span></span>
<span id="cb125-1469"><a href="#cb125-1469"></a>protected_features <span class="op">=</span> [<span class="st">'MARITALSTATUS'</span>, <span class="st">'AGE'</span>, <span class="st">'GENDER'</span>]</span>
<span id="cb125-1470"><a href="#cb125-1470"></a><span class="in">```</span></span>
<span id="cb125-1471"><a href="#cb125-1471"></a></span>
<span id="cb125-1474"><a href="#cb125-1474"></a><span class="in">```{python}</span></span>
<span id="cb125-1475"><a href="#cb125-1475"></a>train_data_wide <span class="op">=</span> df_campaign_1_train.copy().drop(columns<span class="op">=</span>protected_features)</span>
<span id="cb125-1476"><a href="#cb125-1476"></a>test_data_wide <span class="op">=</span> df_campaign_1_test.copy().drop(columns<span class="op">=</span>protected_features)</span>
<span id="cb125-1477"><a href="#cb125-1477"></a></span>
<span id="cb125-1478"><a href="#cb125-1478"></a>train_data_wide <span class="op">=</span> TabularDataset(train_data_wide)</span>
<span id="cb125-1479"><a href="#cb125-1479"></a>test_data_wide <span class="op">=</span> TabularDataset(test_data_wide)</span>
<span id="cb125-1480"><a href="#cb125-1480"></a><span class="in">```</span></span>
<span id="cb125-1481"><a href="#cb125-1481"></a></span>
<span id="cb125-1484"><a href="#cb125-1484"></a><span class="in">```{python}</span></span>
<span id="cb125-1485"><a href="#cb125-1485"></a><span class="co">#| label: tbl-campaign-1-train-full</span></span>
<span id="cb125-1486"><a href="#cb125-1486"></a><span class="co">#| tbl-cap: "First 5 rows of train_data_wide"</span></span>
<span id="cb125-1487"><a href="#cb125-1487"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1488"><a href="#cb125-1488"></a></span>
<span id="cb125-1489"><a href="#cb125-1489"></a></span>
<span id="cb125-1490"><a href="#cb125-1490"></a>train_data_wide.head()</span>
<span id="cb125-1491"><a href="#cb125-1491"></a><span class="in">```</span></span>
<span id="cb125-1492"><a href="#cb125-1492"></a></span>
<span id="cb125-1495"><a href="#cb125-1495"></a><span class="in">```{python}</span></span>
<span id="cb125-1496"><a href="#cb125-1496"></a><span class="co">#| label: tbl-campaign-1-test-full</span></span>
<span id="cb125-1497"><a href="#cb125-1497"></a><span class="co">#| tbl-cap: "First 5 rows of test_data_wide"</span></span>
<span id="cb125-1498"><a href="#cb125-1498"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1499"><a href="#cb125-1499"></a></span>
<span id="cb125-1500"><a href="#cb125-1500"></a></span>
<span id="cb125-1501"><a href="#cb125-1501"></a>test_data_wide.head()</span>
<span id="cb125-1502"><a href="#cb125-1502"></a><span class="in">```</span></span>
<span id="cb125-1503"><a href="#cb125-1503"></a></span>
<span id="cb125-1504"><a href="#cb125-1504"></a><span class="fu">## Filter-based Methods</span></span>
<span id="cb125-1505"><a href="#cb125-1505"></a></span>
<span id="cb125-1506"><a href="#cb125-1506"></a>Filter-based methods select features by evaluating the relationship between each individual feature and the target outcome. The selected features are then fed into a machine learning algorithm like XGBoost. Filter-based methods:</span>
<span id="cb125-1507"><a href="#cb125-1507"></a></span>
<span id="cb125-1508"><a href="#cb125-1508"></a><span class="ss">-   </span>Rank features using statistical measures (correlation, mutual information, chi-square tests)</span>
<span id="cb125-1509"><a href="#cb125-1509"></a><span class="ss">-   </span>Select top-ranked features</span>
<span id="cb125-1510"><a href="#cb125-1510"></a><span class="ss">-   </span>Are computationally efficient</span>
<span id="cb125-1511"><a href="#cb125-1511"></a><span class="ss">-   </span>Consider each feature independently, potentially missing important feature interactions</span>
<span id="cb125-1512"><a href="#cb125-1512"></a></span>
<span id="cb125-1513"><a href="#cb125-1513"></a>The chunk below creates a scikit-learn pipeline that uses <span class="in">`SelectKBest`</span> to select the top 10 features based on mutual information. The top 10 features are then used to train an <span class="in">`autogluon`</span> model.</span>
<span id="cb125-1514"><a href="#cb125-1514"></a></span>
<span id="cb125-1517"><a href="#cb125-1517"></a><span class="in">```{python}</span></span>
<span id="cb125-1518"><a href="#cb125-1518"></a><span class="kw">class</span> IndexPreservingSelectKBest(BaseEstimator, TransformerMixin):</span>
<span id="cb125-1519"><a href="#cb125-1519"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, score_func<span class="op">=</span>mutual_info_classif, k<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb125-1520"><a href="#cb125-1520"></a>        <span class="va">self</span>.score_func <span class="op">=</span> score_func</span>
<span id="cb125-1521"><a href="#cb125-1521"></a>        <span class="va">self</span>.k <span class="op">=</span> k</span>
<span id="cb125-1522"><a href="#cb125-1522"></a>        <span class="va">self</span>.selector <span class="op">=</span> SelectKBest(score_func<span class="op">=</span>score_func, k<span class="op">=</span>k)</span>
<span id="cb125-1523"><a href="#cb125-1523"></a>        </span>
<span id="cb125-1524"><a href="#cb125-1524"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb125-1525"><a href="#cb125-1525"></a>        <span class="va">self</span>.selector.fit(X, y)</span>
<span id="cb125-1526"><a href="#cb125-1526"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb125-1527"><a href="#cb125-1527"></a>        </span>
<span id="cb125-1528"><a href="#cb125-1528"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb125-1529"><a href="#cb125-1529"></a>        <span class="co"># Transform while preserving index</span></span>
<span id="cb125-1530"><a href="#cb125-1530"></a>        Xt <span class="op">=</span> <span class="va">self</span>.selector.transform(X)</span>
<span id="cb125-1531"><a href="#cb125-1531"></a>        <span class="cf">return</span> pd.DataFrame(Xt, index<span class="op">=</span>X.index)</span>
<span id="cb125-1532"><a href="#cb125-1532"></a><span class="in">```</span></span>
<span id="cb125-1533"><a href="#cb125-1533"></a></span>
<span id="cb125-1536"><a href="#cb125-1536"></a><span class="in">```{python}</span></span>
<span id="cb125-1537"><a href="#cb125-1537"></a><span class="co"># remove ag folder if exists</span></span>
<span id="cb125-1538"><a href="#cb125-1538"></a>filter_model_folder <span class="op">=</span> <span class="st">'Lab01_ag_models_FilterMethod'</span></span>
<span id="cb125-1539"><a href="#cb125-1539"></a>remove_ag_folder(filter_model_folder)</span>
<span id="cb125-1540"><a href="#cb125-1540"></a></span>
<span id="cb125-1541"><a href="#cb125-1541"></a><span class="co"># ensures that the output after is transformation is a data frame</span></span>
<span id="cb125-1542"><a href="#cb125-1542"></a>set_config(transform_output<span class="op">=</span><span class="st">"pandas"</span>)</span>
<span id="cb125-1543"><a href="#cb125-1543"></a></span>
<span id="cb125-1544"><a href="#cb125-1544"></a>ag_model_filter_method <span class="op">=</span> Pipeline([</span>
<span id="cb125-1545"><a href="#cb125-1545"></a>    (<span class="st">'replace_values'</span>, FunctionTransformer(replace_vals)),</span>
<span id="cb125-1546"><a href="#cb125-1546"></a>    (<span class="st">'ordinal_encoder'</span>, make_column_transformer(</span>
<span id="cb125-1547"><a href="#cb125-1547"></a>        (OrdinalEncoder(), make_column_selector(dtype_include<span class="op">=</span>[<span class="st">"object"</span>, <span class="st">"category"</span>])),</span>
<span id="cb125-1548"><a href="#cb125-1548"></a>        remainder<span class="op">=</span><span class="st">'passthrough'</span></span>
<span id="cb125-1549"><a href="#cb125-1549"></a>    )),</span>
<span id="cb125-1550"><a href="#cb125-1550"></a>    (<span class="st">'feature_selection'</span>, IndexPreservingSelectKBest(score_func<span class="op">=</span>mutual_info_classif, k<span class="op">=</span><span class="dv">10</span>)),</span>
<span id="cb125-1551"><a href="#cb125-1551"></a>    (<span class="st">'autogluon'</span>, AutoGluonSklearnWrapper(label<span class="op">=</span>label,</span>
<span id="cb125-1552"><a href="#cb125-1552"></a>                                    predictor_args<span class="op">=</span>{<span class="st">'problem_type'</span>: <span class="st">'binary'</span>,</span>
<span id="cb125-1553"><a href="#cb125-1553"></a>                                                    <span class="st">'eval_metric'</span>: <span class="st">'roc_auc'</span>,</span>
<span id="cb125-1554"><a href="#cb125-1554"></a>                                                    <span class="st">'path'</span>: filter_model_folder},</span>
<span id="cb125-1555"><a href="#cb125-1555"></a>                                    fit_args<span class="op">=</span>{<span class="st">'holdout_frac'</span>: <span class="fl">0.2</span>,</span>
<span id="cb125-1556"><a href="#cb125-1556"></a>                                                <span class="st">'excluded_model_types'</span>: [<span class="st">'KNN'</span>, <span class="st">'NN_TORCH'</span>],</span>
<span id="cb125-1557"><a href="#cb125-1557"></a>                                                <span class="st">'presets'</span>: <span class="st">'medium_quality'</span>,</span>
<span id="cb125-1558"><a href="#cb125-1558"></a>                                                <span class="st">'time_limit'</span>: <span class="dv">180</span><span class="op">*</span><span class="fl">1.5</span>}))</span>
<span id="cb125-1559"><a href="#cb125-1559"></a>])</span>
<span id="cb125-1560"><a href="#cb125-1560"></a></span>
<span id="cb125-1561"><a href="#cb125-1561"></a>global_set_seed()</span>
<span id="cb125-1562"><a href="#cb125-1562"></a></span>
<span id="cb125-1563"><a href="#cb125-1563"></a>ag_model_filter_method.fit( X <span class="op">=</span> train_data_wide.drop(</span>
<span id="cb125-1564"><a href="#cb125-1564"></a>                    columns<span class="op">=</span>[label] <span class="op">+</span> [<span class="st">'PROSPECTID'</span>, <span class="st">'campaign_id'</span>, <span class="st">'direct_mail_flag'</span>]),</span>
<span id="cb125-1565"><a href="#cb125-1565"></a>            y <span class="op">=</span> train_data_wide[label]</span>
<span id="cb125-1566"><a href="#cb125-1566"></a>            )</span>
<span id="cb125-1567"><a href="#cb125-1567"></a><span class="in">```</span></span>
<span id="cb125-1568"><a href="#cb125-1568"></a></span>
<span id="cb125-1569"><a href="#cb125-1569"></a>Check leaderboard using the test set.</span>
<span id="cb125-1570"><a href="#cb125-1570"></a></span>
<span id="cb125-1573"><a href="#cb125-1573"></a><span class="in">```{python}</span></span>
<span id="cb125-1574"><a href="#cb125-1574"></a>preprocessed_test_data <span class="op">=</span> ag_model_filter_method[:<span class="op">-</span><span class="dv">1</span>].transform(test_data_wide)</span>
<span id="cb125-1575"><a href="#cb125-1575"></a></span>
<span id="cb125-1576"><a href="#cb125-1576"></a>preprocessed_test_data[label] <span class="op">=</span> test_data_wide[label]</span>
<span id="cb125-1577"><a href="#cb125-1577"></a></span>
<span id="cb125-1578"><a href="#cb125-1578"></a>df_leaders_filter_method <span class="op">=</span> ag_model_filter_method.named_steps[<span class="st">'autogluon'</span>].predictor.leaderboard(preprocessed_test_data)</span>
<span id="cb125-1579"><a href="#cb125-1579"></a><span class="in">```</span></span>
<span id="cb125-1580"><a href="#cb125-1580"></a></span>
<span id="cb125-1583"><a href="#cb125-1583"></a><span class="in">```{python}</span></span>
<span id="cb125-1584"><a href="#cb125-1584"></a><span class="co">#| label: tbl-ag-leaderboard-filter-method</span></span>
<span id="cb125-1585"><a href="#cb125-1585"></a><span class="co">#| tbl-cap: "Autogluon Leaderboard (Filter-based Method)"</span></span>
<span id="cb125-1586"><a href="#cb125-1586"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1587"><a href="#cb125-1587"></a></span>
<span id="cb125-1588"><a href="#cb125-1588"></a></span>
<span id="cb125-1589"><a href="#cb125-1589"></a>display(df_leaders_filter_method)</span>
<span id="cb125-1590"><a href="#cb125-1590"></a><span class="in">```</span></span>
<span id="cb125-1591"><a href="#cb125-1591"></a></span>
<span id="cb125-1592"><a href="#cb125-1592"></a>Check permutation feature importance on the test set.</span>
<span id="cb125-1593"><a href="#cb125-1593"></a></span>
<span id="cb125-1596"><a href="#cb125-1596"></a><span class="in">```{python}</span></span>
<span id="cb125-1597"><a href="#cb125-1597"></a>best_feature_importance_filter <span class="op">=</span> (ag_model_filter_method</span>
<span id="cb125-1598"><a href="#cb125-1598"></a>                            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb125-1599"><a href="#cb125-1599"></a>                            .predictor</span>
<span id="cb125-1600"><a href="#cb125-1600"></a>                            .feature_importance(</span>
<span id="cb125-1601"><a href="#cb125-1601"></a>                                    data <span class="op">=</span> preprocessed_test_data, </span>
<span id="cb125-1602"><a href="#cb125-1602"></a>                                    model <span class="op">=</span> best_model_name,</span>
<span id="cb125-1603"><a href="#cb125-1603"></a>                                    subsample_size <span class="op">=</span> <span class="va">None</span>)</span>
<span id="cb125-1604"><a href="#cb125-1604"></a>                        )</span>
<span id="cb125-1605"><a href="#cb125-1605"></a></span>
<span id="cb125-1606"><a href="#cb125-1606"></a><span class="in">```</span></span>
<span id="cb125-1607"><a href="#cb125-1607"></a></span>
<span id="cb125-1610"><a href="#cb125-1610"></a><span class="in">```{python}</span></span>
<span id="cb125-1611"><a href="#cb125-1611"></a><span class="co">#| label: tbl-perm-feature-importance-filter-method</span></span>
<span id="cb125-1612"><a href="#cb125-1612"></a><span class="co">#| tbl-cap: "Permutation Feature Importance (Filter-based Method)"</span></span>
<span id="cb125-1613"><a href="#cb125-1613"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1614"><a href="#cb125-1614"></a></span>
<span id="cb125-1615"><a href="#cb125-1615"></a></span>
<span id="cb125-1616"><a href="#cb125-1616"></a>display(best_feature_importance_filter)</span>
<span id="cb125-1617"><a href="#cb125-1617"></a><span class="in">```</span></span>
<span id="cb125-1618"><a href="#cb125-1618"></a></span>
<span id="cb125-1619"><a href="#cb125-1619"></a><span class="fu">## Embedded Methods</span></span>
<span id="cb125-1620"><a href="#cb125-1620"></a></span>
<span id="cb125-1621"><a href="#cb125-1621"></a>Embedded methods integrate feature selection directly into the model training/fitting process:</span>
<span id="cb125-1622"><a href="#cb125-1622"></a></span>
<span id="cb125-1623"><a href="#cb125-1623"></a><span class="ss">-   </span>Select features while the model is being trained/fitted</span>
<span id="cb125-1624"><a href="#cb125-1624"></a><span class="ss">-   </span>Balance feature relevance with model performance</span>
<span id="cb125-1625"><a href="#cb125-1625"></a><span class="ss">-   </span>Have moderate computational cost</span>
<span id="cb125-1626"><a href="#cb125-1626"></a><span class="ss">-   </span>Examples: L1 regularization (Lasso), tree-based importance measures</span>
<span id="cb125-1627"><a href="#cb125-1627"></a></span>
<span id="cb125-1628"><a href="#cb125-1628"></a>The chunk below creates a scikit-learn pipeline that uses <span class="in">`SelectFromModel`</span> and the <span class="in">`ExtraTreesClassifier`</span> to select the top features. The top features are then used to train an <span class="in">`autogluon`</span> model.</span>
<span id="cb125-1629"><a href="#cb125-1629"></a></span>
<span id="cb125-1632"><a href="#cb125-1632"></a><span class="in">```{python}</span></span>
<span id="cb125-1633"><a href="#cb125-1633"></a><span class="co"># remove ag folder if exists</span></span>
<span id="cb125-1634"><a href="#cb125-1634"></a>embedded_model_folder <span class="op">=</span> <span class="st">'Lab01_ag_models_EmbeddedMethod'</span></span>
<span id="cb125-1635"><a href="#cb125-1635"></a>remove_ag_folder(embedded_model_folder)</span>
<span id="cb125-1636"><a href="#cb125-1636"></a></span>
<span id="cb125-1637"><a href="#cb125-1637"></a>ag_model_embedded_method <span class="op">=</span> Pipeline([</span>
<span id="cb125-1638"><a href="#cb125-1638"></a>    (<span class="st">'replace_values'</span>, FunctionTransformer(replace_vals)),</span>
<span id="cb125-1639"><a href="#cb125-1639"></a>    (<span class="st">'ordinal_encoder'</span>, make_column_transformer(</span>
<span id="cb125-1640"><a href="#cb125-1640"></a>        (OrdinalEncoder(), make_column_selector(dtype_include<span class="op">=</span>[<span class="st">"object"</span>, <span class="st">"category"</span>])),</span>
<span id="cb125-1641"><a href="#cb125-1641"></a>        remainder<span class="op">=</span><span class="st">'passthrough'</span></span>
<span id="cb125-1642"><a href="#cb125-1642"></a>    )),</span>
<span id="cb125-1643"><a href="#cb125-1643"></a>    (<span class="st">'feature_selection'</span>, SelectFromModel(</span>
<span id="cb125-1644"><a href="#cb125-1644"></a>        ExtraTreesClassifier(random_state<span class="op">=</span><span class="dv">2025</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>, max_depth<span class="op">=</span><span class="dv">3</span>, n_jobs<span class="op">=</span>num_jobs),</span>
<span id="cb125-1645"><a href="#cb125-1645"></a>        threshold<span class="op">=</span><span class="fl">0.01</span></span>
<span id="cb125-1646"><a href="#cb125-1646"></a>    )),</span>
<span id="cb125-1647"><a href="#cb125-1647"></a>    (<span class="st">'autogluon'</span>, AutoGluonSklearnWrapper(label<span class="op">=</span>label,</span>
<span id="cb125-1648"><a href="#cb125-1648"></a>                                    predictor_args<span class="op">=</span>{<span class="st">'problem_type'</span>: <span class="st">'binary'</span>,</span>
<span id="cb125-1649"><a href="#cb125-1649"></a>                                                    <span class="st">'eval_metric'</span>: <span class="st">'roc_auc'</span>,</span>
<span id="cb125-1650"><a href="#cb125-1650"></a>                                                    <span class="st">'path'</span>: embedded_model_folder},</span>
<span id="cb125-1651"><a href="#cb125-1651"></a>                                    fit_args<span class="op">=</span>{<span class="st">'holdout_frac'</span>: <span class="fl">0.2</span>,</span>
<span id="cb125-1652"><a href="#cb125-1652"></a>                                                <span class="st">'excluded_model_types'</span>: [<span class="st">'KNN'</span>, <span class="st">'NN_TORCH'</span>],</span>
<span id="cb125-1653"><a href="#cb125-1653"></a>                                                <span class="st">'presets'</span>: <span class="st">'medium_quality'</span>,</span>
<span id="cb125-1654"><a href="#cb125-1654"></a>                                                <span class="st">'time_limit'</span>: <span class="dv">180</span><span class="op">*</span><span class="fl">1.5</span>}))</span>
<span id="cb125-1655"><a href="#cb125-1655"></a>])</span>
<span id="cb125-1656"><a href="#cb125-1656"></a></span>
<span id="cb125-1657"><a href="#cb125-1657"></a>global_set_seed()</span>
<span id="cb125-1658"><a href="#cb125-1658"></a></span>
<span id="cb125-1659"><a href="#cb125-1659"></a>ag_model_embedded_method.fit( X <span class="op">=</span> train_data_wide.drop(</span>
<span id="cb125-1660"><a href="#cb125-1660"></a>                    columns<span class="op">=</span>[label] <span class="op">+</span> [<span class="st">'PROSPECTID'</span>, <span class="st">'campaign_id'</span>, <span class="st">'direct_mail_flag'</span>]),</span>
<span id="cb125-1661"><a href="#cb125-1661"></a>            y <span class="op">=</span> train_data_wide[label]</span>
<span id="cb125-1662"><a href="#cb125-1662"></a>            )</span>
<span id="cb125-1663"><a href="#cb125-1663"></a><span class="in">```</span></span>
<span id="cb125-1664"><a href="#cb125-1664"></a></span>
<span id="cb125-1665"><a href="#cb125-1665"></a>Check leaderboard using the test set.</span>
<span id="cb125-1666"><a href="#cb125-1666"></a></span>
<span id="cb125-1669"><a href="#cb125-1669"></a><span class="in">```{python}</span></span>
<span id="cb125-1670"><a href="#cb125-1670"></a>preprocessed_test_data_embedded <span class="op">=</span> ag_model_embedded_method[:<span class="op">-</span><span class="dv">1</span>].transform(test_data_wide.drop(columns<span class="op">=</span>[label]))</span>
<span id="cb125-1671"><a href="#cb125-1671"></a>preprocessed_test_data_embedded[label] <span class="op">=</span> test_data_wide[label]</span>
<span id="cb125-1672"><a href="#cb125-1672"></a></span>
<span id="cb125-1673"><a href="#cb125-1673"></a>df_leaders_embedded_method <span class="op">=</span> ag_model_embedded_method.named_steps[<span class="st">'autogluon'</span>].predictor.leaderboard(preprocessed_test_data_embedded)</span>
<span id="cb125-1674"><a href="#cb125-1674"></a><span class="in">```</span></span>
<span id="cb125-1675"><a href="#cb125-1675"></a></span>
<span id="cb125-1678"><a href="#cb125-1678"></a><span class="in">```{python}</span></span>
<span id="cb125-1679"><a href="#cb125-1679"></a><span class="co">#| label: tbl-ag-leaderboard-embedded-method</span></span>
<span id="cb125-1680"><a href="#cb125-1680"></a><span class="co">#| tbl-cap: "Autogluon Leaderboard (Embedded Method)"</span></span>
<span id="cb125-1681"><a href="#cb125-1681"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1682"><a href="#cb125-1682"></a></span>
<span id="cb125-1683"><a href="#cb125-1683"></a></span>
<span id="cb125-1684"><a href="#cb125-1684"></a>display(df_leaders_embedded_method)</span>
<span id="cb125-1685"><a href="#cb125-1685"></a><span class="in">```</span></span>
<span id="cb125-1686"><a href="#cb125-1686"></a></span>
<span id="cb125-1687"><a href="#cb125-1687"></a>Check permutation feature importance on the test set.</span>
<span id="cb125-1688"><a href="#cb125-1688"></a></span>
<span id="cb125-1691"><a href="#cb125-1691"></a><span class="in">```{python}</span></span>
<span id="cb125-1692"><a href="#cb125-1692"></a>best_feature_importance_embedded <span class="op">=</span> (ag_model_embedded_method</span>
<span id="cb125-1693"><a href="#cb125-1693"></a>                            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb125-1694"><a href="#cb125-1694"></a>                            .predictor</span>
<span id="cb125-1695"><a href="#cb125-1695"></a>                            .feature_importance(</span>
<span id="cb125-1696"><a href="#cb125-1696"></a>                                    data <span class="op">=</span> preprocessed_test_data_embedded, </span>
<span id="cb125-1697"><a href="#cb125-1697"></a>                                    model <span class="op">=</span> best_model_name,</span>
<span id="cb125-1698"><a href="#cb125-1698"></a>                                    subsample_size <span class="op">=</span> <span class="va">None</span>)</span>
<span id="cb125-1699"><a href="#cb125-1699"></a>                        )</span>
<span id="cb125-1700"><a href="#cb125-1700"></a><span class="in">```</span></span>
<span id="cb125-1701"><a href="#cb125-1701"></a></span>
<span id="cb125-1704"><a href="#cb125-1704"></a><span class="in">```{python}</span></span>
<span id="cb125-1705"><a href="#cb125-1705"></a><span class="co">#| label: tbl-perm-feature-importance-embedded-method</span></span>
<span id="cb125-1706"><a href="#cb125-1706"></a><span class="co">#| tbl-cap: "Permutation Feature Importance (Embedded Method)"</span></span>
<span id="cb125-1707"><a href="#cb125-1707"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1708"><a href="#cb125-1708"></a></span>
<span id="cb125-1709"><a href="#cb125-1709"></a></span>
<span id="cb125-1710"><a href="#cb125-1710"></a>display(best_feature_importance_embedded)</span>
<span id="cb125-1711"><a href="#cb125-1711"></a><span class="in">```</span></span>
<span id="cb125-1712"><a href="#cb125-1712"></a></span>
<span id="cb125-1713"><a href="#cb125-1713"></a><span class="fu">## Wrapper Methods</span></span>
<span id="cb125-1714"><a href="#cb125-1714"></a></span>
<span id="cb125-1715"><a href="#cb125-1715"></a>Wrapper methods evaluate subsets of features by training models with different feature combinations using the same machine learning algorithm:</span>
<span id="cb125-1716"><a href="#cb125-1716"></a></span>
<span id="cb125-1717"><a href="#cb125-1717"></a><span class="ss">-   </span>Use the predictive performance of a model to evaluate feature subsets</span>
<span id="cb125-1718"><a href="#cb125-1718"></a><span class="ss">-   </span>Can capture feature interactions</span>
<span id="cb125-1719"><a href="#cb125-1719"></a><span class="ss">-   </span>Are computationally expensive</span>
<span id="cb125-1720"><a href="#cb125-1720"></a><span class="ss">-   </span>Examples: recursive feature elimination, forward/backward selection</span>
<span id="cb125-1721"><a href="#cb125-1721"></a></span>
<span id="cb125-1722"><a href="#cb125-1722"></a>The chunk below creates a scikit-learn pipeline that uses forward selection (<span class="in">`SequentialFeatureSelector`</span>) and <span class="in">`ExtraTreesClassifier`</span> estimator to select the top features. The top features are then used to train an <span class="in">`autogluon`</span> model.</span>
<span id="cb125-1723"><a href="#cb125-1723"></a></span>
<span id="cb125-1726"><a href="#cb125-1726"></a><span class="in">```{python}</span></span>
<span id="cb125-1727"><a href="#cb125-1727"></a><span class="co"># remove ag folder if exists</span></span>
<span id="cb125-1728"><a href="#cb125-1728"></a>wrapper_model_folder <span class="op">=</span> <span class="st">'Lab01_ag_models_WrapperMethod'</span></span>
<span id="cb125-1729"><a href="#cb125-1729"></a>remove_ag_folder(wrapper_model_folder)</span>
<span id="cb125-1730"><a href="#cb125-1730"></a></span>
<span id="cb125-1731"><a href="#cb125-1731"></a>ag_model_wrapper_method <span class="op">=</span> Pipeline([</span>
<span id="cb125-1732"><a href="#cb125-1732"></a>    (<span class="st">'replace_values'</span>, FunctionTransformer(replace_vals)),</span>
<span id="cb125-1733"><a href="#cb125-1733"></a>    (<span class="st">'ordinal_encoder'</span>, make_column_transformer(</span>
<span id="cb125-1734"><a href="#cb125-1734"></a>        (OrdinalEncoder(), make_column_selector(dtype_include<span class="op">=</span>[<span class="st">"object"</span>, <span class="st">"category"</span>])),</span>
<span id="cb125-1735"><a href="#cb125-1735"></a>        remainder<span class="op">=</span><span class="st">'passthrough'</span></span>
<span id="cb125-1736"><a href="#cb125-1736"></a>    )),</span>
<span id="cb125-1737"><a href="#cb125-1737"></a>    (<span class="st">'feature_selection'</span>, SequentialFeatureSelector(</span>
<span id="cb125-1738"><a href="#cb125-1738"></a>        ExtraTreesClassifier(random_state<span class="op">=</span><span class="dv">2025</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>, max_depth<span class="op">=</span><span class="dv">3</span>, n_jobs<span class="op">=</span>num_jobs),</span>
<span id="cb125-1739"><a href="#cb125-1739"></a>    direction<span class="op">=</span><span class="st">'forward'</span>,</span>
<span id="cb125-1740"><a href="#cb125-1740"></a>    scoring<span class="op">=</span><span class="st">'roc_auc'</span>,</span>
<span id="cb125-1741"><a href="#cb125-1741"></a>    tol<span class="op">=</span><span class="fl">0.005</span>,</span>
<span id="cb125-1742"><a href="#cb125-1742"></a>    n_jobs<span class="op">=</span>num_jobs,</span>
<span id="cb125-1743"><a href="#cb125-1743"></a>    cv<span class="op">=</span><span class="dv">3</span></span>
<span id="cb125-1744"><a href="#cb125-1744"></a>    )),</span>
<span id="cb125-1745"><a href="#cb125-1745"></a>    (<span class="st">'autogluon'</span>, AutoGluonSklearnWrapper(label<span class="op">=</span>label,</span>
<span id="cb125-1746"><a href="#cb125-1746"></a>                                    predictor_args<span class="op">=</span>{<span class="st">'problem_type'</span>: <span class="st">'binary'</span>,</span>
<span id="cb125-1747"><a href="#cb125-1747"></a>                                                    <span class="st">'eval_metric'</span>: <span class="st">'roc_auc'</span>,</span>
<span id="cb125-1748"><a href="#cb125-1748"></a>                                                    <span class="st">'path'</span>: wrapper_model_folder},</span>
<span id="cb125-1749"><a href="#cb125-1749"></a>                                    fit_args<span class="op">=</span>{<span class="st">'holdout_frac'</span>: <span class="fl">0.2</span>,</span>
<span id="cb125-1750"><a href="#cb125-1750"></a>                                                <span class="st">'excluded_model_types'</span>: [<span class="st">'KNN'</span>, <span class="st">'NN_TORCH'</span>],</span>
<span id="cb125-1751"><a href="#cb125-1751"></a>                                                <span class="st">'presets'</span>: <span class="st">'medium_quality'</span>,</span>
<span id="cb125-1752"><a href="#cb125-1752"></a>                                                <span class="st">'time_limit'</span>: <span class="dv">180</span><span class="op">*</span><span class="fl">1.5</span>}))</span>
<span id="cb125-1753"><a href="#cb125-1753"></a>])</span>
<span id="cb125-1754"><a href="#cb125-1754"></a></span>
<span id="cb125-1755"><a href="#cb125-1755"></a>global_set_seed()</span>
<span id="cb125-1756"><a href="#cb125-1756"></a></span>
<span id="cb125-1757"><a href="#cb125-1757"></a>ag_model_wrapper_method.fit(</span>
<span id="cb125-1758"><a href="#cb125-1758"></a>    X<span class="op">=</span>train_data_wide.drop(columns<span class="op">=</span>[label] <span class="op">+</span> [<span class="st">'PROSPECTID'</span>, <span class="st">'campaign_id'</span>, <span class="st">'direct_mail_flag'</span>]),</span>
<span id="cb125-1759"><a href="#cb125-1759"></a>    y<span class="op">=</span>train_data_wide[label],</span>
<span id="cb125-1760"><a href="#cb125-1760"></a>)</span>
<span id="cb125-1761"><a href="#cb125-1761"></a><span class="in">```</span></span>
<span id="cb125-1762"><a href="#cb125-1762"></a></span>
<span id="cb125-1763"><a href="#cb125-1763"></a>Check leaderboard using the test set.</span>
<span id="cb125-1764"><a href="#cb125-1764"></a></span>
<span id="cb125-1767"><a href="#cb125-1767"></a><span class="in">```{python}</span></span>
<span id="cb125-1768"><a href="#cb125-1768"></a>preprocessed_test_data_wrapper <span class="op">=</span> ag_model_wrapper_method[:<span class="op">-</span><span class="dv">1</span>].transform(test_data_wide.drop(columns<span class="op">=</span>[label] <span class="op">+</span> [<span class="st">'PROSPECTID'</span>, <span class="st">'campaign_id'</span>, <span class="st">'direct_mail_flag'</span>]))</span>
<span id="cb125-1769"><a href="#cb125-1769"></a>preprocessed_test_data_wrapper[label] <span class="op">=</span> test_data_wide[label]</span>
<span id="cb125-1770"><a href="#cb125-1770"></a></span>
<span id="cb125-1771"><a href="#cb125-1771"></a>df_leaders_wrapper_method <span class="op">=</span> ag_model_wrapper_method.named_steps[<span class="st">'autogluon'</span>].predictor.leaderboard(preprocessed_test_data_wrapper)</span>
<span id="cb125-1772"><a href="#cb125-1772"></a><span class="in">```</span></span>
<span id="cb125-1773"><a href="#cb125-1773"></a></span>
<span id="cb125-1776"><a href="#cb125-1776"></a><span class="in">```{python}</span></span>
<span id="cb125-1777"><a href="#cb125-1777"></a><span class="co">#| label: tbl-ag-leaderboard-wrapper-method</span></span>
<span id="cb125-1778"><a href="#cb125-1778"></a><span class="co">#| tbl-cap: "Autogluon Leaderboard (Wrapper Method)"</span></span>
<span id="cb125-1779"><a href="#cb125-1779"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1780"><a href="#cb125-1780"></a></span>
<span id="cb125-1781"><a href="#cb125-1781"></a></span>
<span id="cb125-1782"><a href="#cb125-1782"></a>display(df_leaders_wrapper_method)</span>
<span id="cb125-1783"><a href="#cb125-1783"></a><span class="in">```</span></span>
<span id="cb125-1784"><a href="#cb125-1784"></a></span>
<span id="cb125-1785"><a href="#cb125-1785"></a>Check permutation feature importance on the test set.</span>
<span id="cb125-1786"><a href="#cb125-1786"></a></span>
<span id="cb125-1789"><a href="#cb125-1789"></a><span class="in">```{python}</span></span>
<span id="cb125-1790"><a href="#cb125-1790"></a>best_feature_importance_wrapper <span class="op">=</span> (ag_model_wrapper_method</span>
<span id="cb125-1791"><a href="#cb125-1791"></a>                            .named_steps[<span class="st">'autogluon'</span>]</span>
<span id="cb125-1792"><a href="#cb125-1792"></a>                            .predictor</span>
<span id="cb125-1793"><a href="#cb125-1793"></a>                            .feature_importance(</span>
<span id="cb125-1794"><a href="#cb125-1794"></a>                                    data <span class="op">=</span> preprocessed_test_data_wrapper, </span>
<span id="cb125-1795"><a href="#cb125-1795"></a>                                    model <span class="op">=</span> best_model_name,</span>
<span id="cb125-1796"><a href="#cb125-1796"></a>                                    subsample_size <span class="op">=</span> <span class="va">None</span>)</span>
<span id="cb125-1797"><a href="#cb125-1797"></a>                        )</span>
<span id="cb125-1798"><a href="#cb125-1798"></a><span class="in">```</span></span>
<span id="cb125-1799"><a href="#cb125-1799"></a></span>
<span id="cb125-1802"><a href="#cb125-1802"></a><span class="in">```{python}</span></span>
<span id="cb125-1803"><a href="#cb125-1803"></a><span class="co">#| label: tbl-perm-feature-importance-wrapper-method</span></span>
<span id="cb125-1804"><a href="#cb125-1804"></a><span class="co">#| tbl-cap: "Permutation Feature Importance (Wrapper Method)"</span></span>
<span id="cb125-1805"><a href="#cb125-1805"></a><span class="co">#| tbl-number: true</span></span>
<span id="cb125-1806"><a href="#cb125-1806"></a></span>
<span id="cb125-1807"><a href="#cb125-1807"></a></span>
<span id="cb125-1808"><a href="#cb125-1808"></a>display(best_feature_importance_wrapper)</span>
<span id="cb125-1809"><a href="#cb125-1809"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>