<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.41">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lab 03: Counterfactuals &amp; SHAP</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="Lab 03_files/libs/clipboard/clipboard.min.js"></script>
<script src="Lab 03_files/libs/quarto-html/quarto.js"></script>
<script src="Lab 03_files/libs/quarto-html/popper.min.js"></script>
<script src="Lab 03_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Lab 03_files/libs/quarto-html/anchor.min.js"></script>
<link href="Lab 03_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Lab 03_files/libs/quarto-html/quarto-syntax-highlighting-48ffa3e5b9d089919c6712c39e5b00f2.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Lab 03_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Lab 03_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Lab 03_files/libs/bootstrap/bootstrap-b29227339076a9cddc7448887e597caa.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#load-data-and-pre-trained-model" id="toc-load-data-and-pre-trained-model" class="nav-link" data-scroll-target="#load-data-and-pre-trained-model"><span class="header-section-number">2</span> Load Data and Pre-trained Model</a></li>
  <li><a href="#counterfactual-explanations" id="toc-counterfactual-explanations" class="nav-link" data-scroll-target="#counterfactual-explanations"><span class="header-section-number">3</span> Counterfactual Explanations</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="header-section-number">3.1</span> Overview</a></li>
  <li><a href="#counterfactual-explainer" id="toc-counterfactual-explainer" class="nav-link" data-scroll-target="#counterfactual-explainer"><span class="header-section-number">3.2</span> Counterfactual Explainer</a></li>
  <li><a href="#counterfactual-explanations-1" id="toc-counterfactual-explanations-1" class="nav-link" data-scroll-target="#counterfactual-explanations-1"><span class="header-section-number">3.3</span> Counterfactual Explanations</a></li>
  </ul></li>
  <li><a href="#generate-adverse-action-codes" id="toc-generate-adverse-action-codes" class="nav-link" data-scroll-target="#generate-adverse-action-codes"><span class="header-section-number">4</span> Generate Adverse Action Codes</a></li>
  <li><a href="#improved-adverse-action-codes" id="toc-improved-adverse-action-codes" class="nav-link" data-scroll-target="#improved-adverse-action-codes"><span class="header-section-number">5</span> Improved Adverse Action Codes</a></li>
  <li><a href="#shap-values" id="toc-shap-values" class="nav-link" data-scroll-target="#shap-values"><span class="header-section-number">6</span> SHAP Values</a>
  <ul class="collapse">
  <li><a href="#concept" id="toc-concept" class="nav-link" data-scroll-target="#concept"><span class="header-section-number">6.1</span> Concept</a></li>
  <li><a href="#setup-shap-explainer" id="toc-setup-shap-explainer" class="nav-link" data-scroll-target="#setup-shap-explainer"><span class="header-section-number">6.2</span> Setup SHAP Explainer</a></li>
  <li><a href="#local-interpretability-waterfall-plots" id="toc-local-interpretability-waterfall-plots" class="nav-link" data-scroll-target="#local-interpretability-waterfall-plots"><span class="header-section-number">6.3</span> Local Interpretability (Waterfall Plots)</a></li>
  </ul></li>
  <li><a href="#local-adverse-action-codes" id="toc-local-adverse-action-codes" class="nav-link" data-scroll-target="#local-adverse-action-codes"><span class="header-section-number">7</span> Local Adverse Action Codes</a></li>
  <li><a href="#concluding-remarks-for-adverse-action-codes" id="toc-concluding-remarks-for-adverse-action-codes" class="nav-link" data-scroll-target="#concluding-remarks-for-adverse-action-codes"><span class="header-section-number">8</span> Concluding Remarks for Adverse Action Codes</a></li>
  <li><a href="#other-uses-of-shap-values" id="toc-other-uses-of-shap-values" class="nav-link" data-scroll-target="#other-uses-of-shap-values"><span class="header-section-number">9</span> Other Uses of SHAP Values</a>
  <ul class="collapse">
  <li><a href="#global-interpretability-summary-plots" id="toc-global-interpretability-summary-plots" class="nav-link" data-scroll-target="#global-interpretability-summary-plots"><span class="header-section-number">9.1</span> Global Interpretability (Summary Plots)</a></li>
  <li><a href="#shap-dependence-plots" id="toc-shap-dependence-plots" class="nav-link" data-scroll-target="#shap-dependence-plots"><span class="header-section-number">9.2</span> SHAP Dependence Plots</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Lab 03: Counterfactuals &amp; SHAP</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta column-page-left">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>The lab will examine two interpretability techniques:</p>
<ol type="1">
<li>Counterfactual Explanations</li>
<li>SHAP (SHapley Additive exPlanations)</li>
</ol>
<p>We will use counterfactual explanations to provide actionable feedback to applicants whose applications were rejected by the model. This is a requirement in the US for credit decisions.</p>
<p>We will use SHAP for both local (individual applicant) and global (overall feature importance) model explanations. SHAP values are versatile, offering alternatives to methods like permutation feature importance, partial dependence plots, ICE plots, and ALE plots.</p>
<div id="setup-imports" class="cell" data-message="false" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># System utilities</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> shutil</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> random</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> warnings</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">import</span> time</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="im">import</span> gc</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="im">import</span> psutil</span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co"># Data manipulation and visualization</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="im">from</span> IPython.display <span class="im">import</span> display <span class="co"># Explicit import for display</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="im">from</span> scipy <span class="im">import</span> stats, special</span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="im">from</span> sklearn.feature_selection <span class="im">import</span> mutual_info_classif</span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="im">import</span> re</span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="im">import</span> duckdb</span>
<span id="cb1-20"><a href="#cb1-20"></a></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="co"># Machine learning - scikit-learn</span></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression, LogisticRegressionCV</span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_auc_score, f1_score, confusion_matrix, classification_report</span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder, StandardScaler, OneHotEncoder</span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="im">from</span> sklearn.inspection <span class="im">import</span> PartialDependenceDisplay</span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, ClassifierMixin</span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="im">from</span> sklearn.utils.validation <span class="im">import</span> check_is_fitted, check_X_y, check_array</span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="im">from</span> sklearn <span class="im">import</span> set_config</span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="im">import</span> torch</span>
<span id="cb1-34"><a href="#cb1-34"></a></span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="co"># Specialized ML libraries</span></span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="im">from</span> autogluon.tabular <span class="im">import</span> TabularPredictor, TabularDataset</span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="im">from</span> autogluon.common.features.feature_metadata <span class="im">import</span> FeatureMetadata <span class="co"># For monotonic constraints</span></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="im">import</span> shap</span>
<span id="cb1-39"><a href="#cb1-39"></a><span class="im">from</span> ydata_profiling <span class="im">import</span> ProfileReport</span>
<span id="cb1-40"><a href="#cb1-40"></a></span>
<span id="cb1-41"><a href="#cb1-41"></a><span class="co"># Counterfactual Explanations (optional, install if needed: pip install dice-ml)</span></span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="cf">try</span>:</span>
<span id="cb1-43"><a href="#cb1-43"></a>    <span class="im">import</span> dice_ml</span>
<span id="cb1-44"><a href="#cb1-44"></a>    <span class="im">from</span> dice_ml.utils <span class="im">import</span> helpers <span class="co"># Helper functions for DICE</span></span>
<span id="cb1-45"><a href="#cb1-45"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb1-46"><a href="#cb1-46"></a>    <span class="bu">print</span>(<span class="st">"""</span></span>
<span id="cb1-47"><a href="#cb1-47"></a><span class="st">    </span></span>
<span id="cb1-48"><a href="#cb1-48"></a><span class="st">    dice-ml not found. You need to update your conda env by running:</span></span>
<span id="cb1-49"><a href="#cb1-49"></a><span class="st">    </span></span>
<span id="cb1-50"><a href="#cb1-50"></a><span class="st">    conda activate env_AutoGluon_202502</span></span>
<span id="cb1-51"><a href="#cb1-51"></a><span class="st">    conda install -c conda-forge dice-ml</span></span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="st">    </span></span>
<span id="cb1-53"><a href="#cb1-53"></a><span class="st">    """</span>)</span>
<span id="cb1-54"><a href="#cb1-54"></a>    dice_ml <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-55"><a href="#cb1-55"></a></span>
<span id="cb1-56"><a href="#cb1-56"></a><span class="co"># Settings</span></span>
<span id="cb1-57"><a href="#cb1-57"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="dv">50</span>)</span>
<span id="cb1-58"><a href="#cb1-58"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">100</span>)</span>
<span id="cb1-59"><a href="#cb1-59"></a>warnings.filterwarnings(<span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>) <span class="co"># Suppress specific FutureWarnings</span></span>
<span id="cb1-60"><a href="#cb1-60"></a>set_config(transform_output<span class="op">=</span><span class="st">"pandas"</span>) <span class="co"># Set sklearn output to pandas</span></span>
<span id="cb1-61"><a href="#cb1-61"></a></span>
<span id="cb1-62"><a href="#cb1-62"></a><span class="kw">def</span> global_set_seed(seed_value<span class="op">=</span><span class="dv">2025</span>):</span>
<span id="cb1-63"><a href="#cb1-63"></a>    random.seed(seed_value)</span>
<span id="cb1-64"><a href="#cb1-64"></a>    np.random.seed(seed_value)</span>
<span id="cb1-65"><a href="#cb1-65"></a>    torch.manual_seed(seed_value)</span>
<span id="cb1-66"><a href="#cb1-66"></a></span>
<span id="cb1-67"><a href="#cb1-67"></a>global_set_seed(<span class="dv">2025</span>)</span>
<span id="cb1-68"><a href="#cb1-68"></a></span>
<span id="cb1-69"><a href="#cb1-69"></a><span class="bu">print</span>(<span class="st">"Libraries imported successfully."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Libraries imported successfully.</code></pre>
</div>
</div>
<div id="helper-functions" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">class</span> AutoGluonSklearnWrapper(BaseEstimator, ClassifierMixin):</span>
<span id="cb3-2"><a href="#cb3-2"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">    Scikit-learn compatible wrapper for AutoGluon TabularPredictor</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">    </span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">    Inherits from scikit-learn's BaseEstimator and ClassifierMixin to provide</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">    full compatibility with scikit-learn tools like PartialDependenceDisplay().</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">    </span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co">    Parameters</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">    ----------</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">    label : str</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">        Name of the target column</span></span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co">    **predictor_args : dict</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co">        Additional arguments passed to TabularPredictor()</span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co">        (e.g., problem_type, eval_metric, path)</span></span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">    **fit_args : dict</span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co">        Additional arguments passed to TabularPredictor.fit() method</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co">        (e.g., holdout_frac, presets, time_limit, excluded_model_types)</span></span>
<span id="cb3-20"><a href="#cb3-20"></a></span>
<span id="cb3-21"><a href="#cb3-21"></a></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="co">    Attributes</span></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="co">    ----------</span></span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="co">    predictor : TabularPredictor</span></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="co">        The trained AutoGluon predictor</span></span>
<span id="cb3-26"><a href="#cb3-26"></a></span>
<span id="cb3-27"><a href="#cb3-27"></a><span class="co">    classes_ : ndarray</span></span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="co">        Class labels (for classification tasks)</span></span>
<span id="cb3-29"><a href="#cb3-29"></a></span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="co">    n_features_in_ : int</span></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="co">        Number of features seen during fit</span></span>
<span id="cb3-32"><a href="#cb3-32"></a></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="co">    feature_names_ : list</span></span>
<span id="cb3-34"><a href="#cb3-34"></a><span class="co">        Feature names inferred during fitting</span></span>
<span id="cb3-35"><a href="#cb3-35"></a></span>
<span id="cb3-36"><a href="#cb3-36"></a><span class="co">    is_fitted_ : bool</span></span>
<span id="cb3-37"><a href="#cb3-37"></a><span class="co">        Whether the estimator has been fitted</span></span>
<span id="cb3-38"><a href="#cb3-38"></a><span class="co">    """</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>    </span>
<span id="cb3-40"><a href="#cb3-40"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, label, predictor_args<span class="op">=</span><span class="va">None</span>, fit_args<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb3-41"><a href="#cb3-41"></a>        <span class="va">self</span>.label <span class="op">=</span> label</span>
<span id="cb3-42"><a href="#cb3-42"></a>        <span class="va">self</span>.predictor_args <span class="op">=</span> predictor_args <span class="cf">if</span> predictor_args <span class="cf">else</span> {}</span>
<span id="cb3-43"><a href="#cb3-43"></a>        <span class="va">self</span>.fit_args <span class="op">=</span> fit_args <span class="cf">if</span> fit_args <span class="cf">else</span> {}</span>
<span id="cb3-44"><a href="#cb3-44"></a>        <span class="va">self</span>.predictor <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-45"><a href="#cb3-45"></a>        <span class="va">self</span>.classes_ <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>        <span class="va">self</span>.n_features_in_ <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>        <span class="va">self</span>.feature_names_ <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-48"><a href="#cb3-48"></a>        <span class="va">self</span>.is_fitted_ <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-49"><a href="#cb3-49"></a></span>
<span id="cb3-50"><a href="#cb3-50"></a>    <span class="kw">def</span> __sklearn_is_fitted__(<span class="va">self</span>):</span>
<span id="cb3-51"><a href="#cb3-51"></a>        <span class="co">"""Official scikit-learn API for checking fitted status"""</span></span>
<span id="cb3-52"><a href="#cb3-52"></a>        <span class="cf">return</span> <span class="va">self</span>.is_fitted_</span>
<span id="cb3-53"><a href="#cb3-53"></a></span>
<span id="cb3-54"><a href="#cb3-54"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y, sample_weight<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb3-55"><a href="#cb3-55"></a>        <span class="co">"""</span></span>
<span id="cb3-56"><a href="#cb3-56"></a><span class="co">        Fit AutoGluon model using scikit-learn interface.</span></span>
<span id="cb3-57"><a href="#cb3-57"></a><span class="co">        If sample_weight is provided, it is added as a column to X for AutoGluon.</span></span>
<span id="cb3-58"><a href="#cb3-58"></a><span class="co">        """</span></span>
<span id="cb3-59"><a href="#cb3-59"></a>        <span class="va">self</span>._check_feature_names(X, reset<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-60"><a href="#cb3-60"></a>        <span class="va">self</span>._check_n_features(X, reset<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-61"><a href="#cb3-61"></a></span>
<span id="cb3-62"><a href="#cb3-62"></a>        <span class="co"># Convert to DataFrame with preserved feature names</span></span>
<span id="cb3-63"><a href="#cb3-63"></a>        train_data <span class="op">=</span> pd.DataFrame(X, columns<span class="op">=</span><span class="va">self</span>.feature_names_)</span>
<span id="cb3-64"><a href="#cb3-64"></a>        train_data[<span class="va">self</span>.label] <span class="op">=</span> y</span>
<span id="cb3-65"><a href="#cb3-65"></a></span>
<span id="cb3-66"><a href="#cb3-66"></a>        <span class="co"># If sample_weight is provided, add it as a column (name must match predictor_args['sample_weight'])</span></span>
<span id="cb3-67"><a href="#cb3-67"></a>        weight_col_name <span class="op">=</span> <span class="va">self</span>.predictor_args.get(<span class="st">'sample_weight'</span>, <span class="va">None</span>)</span>
<span id="cb3-68"><a href="#cb3-68"></a>        <span class="cf">if</span> sample_weight <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb3-69"><a href="#cb3-69"></a>            <span class="cf">if</span> weight_col_name:</span>
<span id="cb3-70"><a href="#cb3-70"></a>                train_data[weight_col_name] <span class="op">=</span> sample_weight</span>
<span id="cb3-71"><a href="#cb3-71"></a>            <span class="cf">else</span>:</span>
<span id="cb3-72"><a href="#cb3-72"></a>                <span class="bu">print</span>(<span class="st">"Warning: sample_weight provided to fit, but 'sample_weight' key not found in predictor_args. Weights will be ignored by AutoGluon."</span>)</span>
<span id="cb3-73"><a href="#cb3-73"></a></span>
<span id="cb3-74"><a href="#cb3-74"></a>        train_data <span class="op">=</span> TabularDataset(train_data)</span>
<span id="cb3-75"><a href="#cb3-75"></a></span>
<span id="cb3-76"><a href="#cb3-76"></a>        <span class="co"># Remove sample_weight from fit_args if present (TabularPredictor.fit does not accept it)</span></span>
<span id="cb3-77"><a href="#cb3-77"></a>        fit_args_clean <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="va">self</span>.fit_args.items() <span class="cf">if</span> k <span class="op">!=</span> <span class="st">'sample_weight'</span>}</span>
<span id="cb3-78"><a href="#cb3-78"></a></span>
<span id="cb3-79"><a href="#cb3-79"></a>        <span class="va">self</span>.predictor <span class="op">=</span> TabularPredictor(</span>
<span id="cb3-80"><a href="#cb3-80"></a>            label<span class="op">=</span><span class="va">self</span>.label,</span>
<span id="cb3-81"><a href="#cb3-81"></a>            <span class="op">**</span><span class="va">self</span>.predictor_args</span>
<span id="cb3-82"><a href="#cb3-82"></a>        ).fit(train_data, <span class="op">**</span>fit_args_clean)</span>
<span id="cb3-83"><a href="#cb3-83"></a></span>
<span id="cb3-84"><a href="#cb3-84"></a>        <span class="cf">if</span> <span class="va">self</span>.predictor.problem_type <span class="kw">in</span> [<span class="st">'binary'</span>, <span class="st">'multiclass'</span>]:</span>
<span id="cb3-85"><a href="#cb3-85"></a>            <span class="va">self</span>.classes_ <span class="op">=</span> np.array(<span class="va">self</span>.predictor.class_labels)</span>
<span id="cb3-86"><a href="#cb3-86"></a></span>
<span id="cb3-87"><a href="#cb3-87"></a>        <span class="va">self</span>.is_fitted_ <span class="op">=</span> <span class="va">True</span></span>
<span id="cb3-88"><a href="#cb3-88"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb3-89"><a href="#cb3-89"></a></span>
<span id="cb3-90"><a href="#cb3-90"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, X):</span>
<span id="cb3-91"><a href="#cb3-91"></a>        <span class="co">"""</span></span>
<span id="cb3-92"><a href="#cb3-92"></a><span class="co">        Make class predictions</span></span>
<span id="cb3-93"><a href="#cb3-93"></a><span class="co">        </span></span>
<span id="cb3-94"><a href="#cb3-94"></a><span class="co">        Parameters</span></span>
<span id="cb3-95"><a href="#cb3-95"></a><span class="co">        ----------</span></span>
<span id="cb3-96"><a href="#cb3-96"></a><span class="co">        X : {array-like, sparse matrix} of shape (n_samples, n_features)</span></span>
<span id="cb3-97"><a href="#cb3-97"></a><span class="co">            Input data</span></span>
<span id="cb3-98"><a href="#cb3-98"></a><span class="co">            </span></span>
<span id="cb3-99"><a href="#cb3-99"></a><span class="co">        Returns</span></span>
<span id="cb3-100"><a href="#cb3-100"></a><span class="co">        -------</span></span>
<span id="cb3-101"><a href="#cb3-101"></a><span class="co">        y_pred : ndarray of shape (n_samples,)</span></span>
<span id="cb3-102"><a href="#cb3-102"></a><span class="co">            Predicted class labels</span></span>
<span id="cb3-103"><a href="#cb3-103"></a><span class="co">        """</span></span>
<span id="cb3-104"><a href="#cb3-104"></a>        check_is_fitted(<span class="va">self</span>)</span>
<span id="cb3-105"><a href="#cb3-105"></a>        <span class="va">self</span>._check_feature_names(X)</span>
<span id="cb3-106"><a href="#cb3-106"></a>        <span class="va">self</span>._check_n_features(X)</span>
<span id="cb3-107"><a href="#cb3-107"></a></span>
<span id="cb3-108"><a href="#cb3-108"></a>        df <span class="op">=</span> pd.DataFrame(X, columns<span class="op">=</span><span class="va">self</span>.feature_names_)</span>
<span id="cb3-109"><a href="#cb3-109"></a>        df <span class="op">=</span> TabularDataset(df)</span>
<span id="cb3-110"><a href="#cb3-110"></a></span>
<span id="cb3-111"><a href="#cb3-111"></a>        <span class="cf">return</span> <span class="va">self</span>.predictor.predict(df).values</span>
<span id="cb3-112"><a href="#cb3-112"></a></span>
<span id="cb3-113"><a href="#cb3-113"></a>    <span class="kw">def</span> predict_proba(<span class="va">self</span>, X):</span>
<span id="cb3-114"><a href="#cb3-114"></a>        <span class="co">"""</span></span>
<span id="cb3-115"><a href="#cb3-115"></a><span class="co">        Predict class probabilities</span></span>
<span id="cb3-116"><a href="#cb3-116"></a><span class="co">        </span></span>
<span id="cb3-117"><a href="#cb3-117"></a><span class="co">        Parameters</span></span>
<span id="cb3-118"><a href="#cb3-118"></a><span class="co">        ----------</span></span>
<span id="cb3-119"><a href="#cb3-119"></a><span class="co">        X : {array-like, sparse matrix} of shape (n_samples, n_features)</span></span>
<span id="cb3-120"><a href="#cb3-120"></a><span class="co">            Input data</span></span>
<span id="cb3-121"><a href="#cb3-121"></a><span class="co">            </span></span>
<span id="cb3-122"><a href="#cb3-122"></a><span class="co">        Returns</span></span>
<span id="cb3-123"><a href="#cb3-123"></a><span class="co">        -------</span></span>
<span id="cb3-124"><a href="#cb3-124"></a><span class="co">        proba : ndarray of shape (n_samples, n_classes)</span></span>
<span id="cb3-125"><a href="#cb3-125"></a><span class="co">            Class probabilities</span></span>
<span id="cb3-126"><a href="#cb3-126"></a><span class="co">        """</span></span>
<span id="cb3-127"><a href="#cb3-127"></a>        check_is_fitted(<span class="va">self</span>)</span>
<span id="cb3-128"><a href="#cb3-128"></a>        <span class="va">self</span>._check_feature_names(X)</span>
<span id="cb3-129"><a href="#cb3-129"></a>        <span class="va">self</span>._check_n_features(X)</span>
<span id="cb3-130"><a href="#cb3-130"></a></span>
<span id="cb3-131"><a href="#cb3-131"></a>        df <span class="op">=</span> pd.DataFrame(X, columns<span class="op">=</span><span class="va">self</span>.feature_names_)</span>
<span id="cb3-132"><a href="#cb3-132"></a>        df <span class="op">=</span> TabularDataset(df)</span>
<span id="cb3-133"><a href="#cb3-133"></a></span>
<span id="cb3-134"><a href="#cb3-134"></a>        <span class="cf">return</span> <span class="va">self</span>.predictor.predict_proba(df).values</span>
<span id="cb3-135"><a href="#cb3-135"></a></span>
<span id="cb3-136"><a href="#cb3-136"></a>    <span class="kw">def</span> get_params(<span class="va">self</span>, deep<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb3-137"><a href="#cb3-137"></a>        <span class="co">"""Get parameters for this estimator"""</span></span>
<span id="cb3-138"><a href="#cb3-138"></a>        <span class="cf">return</span> {</span>
<span id="cb3-139"><a href="#cb3-139"></a>            <span class="st">'label'</span>: <span class="va">self</span>.label,</span>
<span id="cb3-140"><a href="#cb3-140"></a>            <span class="st">'predictor_args'</span>: <span class="va">self</span>.predictor_args,</span>
<span id="cb3-141"><a href="#cb3-141"></a>            <span class="st">'fit_args'</span>: <span class="va">self</span>.fit_args</span>
<span id="cb3-142"><a href="#cb3-142"></a>        }</span>
<span id="cb3-143"><a href="#cb3-143"></a></span>
<span id="cb3-144"><a href="#cb3-144"></a>    <span class="kw">def</span> set_params(<span class="va">self</span>, <span class="op">**</span>params):</span>
<span id="cb3-145"><a href="#cb3-145"></a>        <span class="co">"""Set parameters for this estimator"""</span></span>
<span id="cb3-146"><a href="#cb3-146"></a>        <span class="cf">for</span> param, value <span class="kw">in</span> params.items():</span>
<span id="cb3-147"><a href="#cb3-147"></a>            <span class="cf">if</span> param <span class="op">==</span> <span class="st">'label'</span>:</span>
<span id="cb3-148"><a href="#cb3-148"></a>                <span class="va">self</span>.label <span class="op">=</span> value</span>
<span id="cb3-149"><a href="#cb3-149"></a>            <span class="cf">else</span>:</span>
<span id="cb3-150"><a href="#cb3-150"></a>                <span class="va">self</span>.predictor_args[param] <span class="op">=</span> value</span>
<span id="cb3-151"><a href="#cb3-151"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb3-152"><a href="#cb3-152"></a></span>
<span id="cb3-153"><a href="#cb3-153"></a>    <span class="kw">def</span> _check_n_features(<span class="va">self</span>, X, reset<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb3-154"><a href="#cb3-154"></a>        <span class="co">"""Validate number of features"""</span></span>
<span id="cb3-155"><a href="#cb3-155"></a>        n_features <span class="op">=</span> X.shape[<span class="dv">1</span>]</span>
<span id="cb3-156"><a href="#cb3-156"></a>        <span class="cf">if</span> reset:</span>
<span id="cb3-157"><a href="#cb3-157"></a>            <span class="va">self</span>.n_features_in_ <span class="op">=</span> n_features</span>
<span id="cb3-158"><a href="#cb3-158"></a>        <span class="cf">elif</span> n_features <span class="op">!=</span> <span class="va">self</span>.n_features_in_:</span>
<span id="cb3-159"><a href="#cb3-159"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Expected </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>n_features_in_<span class="sc">}</span><span class="ss"> features, got </span><span class="sc">{</span>n_features<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-160"><a href="#cb3-160"></a></span>
<span id="cb3-161"><a href="#cb3-161"></a>    <span class="kw">def</span> _check_feature_names(<span class="va">self</span>, X, reset<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb3-162"><a href="#cb3-162"></a>        <span class="co">"""Validate feature names (AutoGluon requirement)"""</span></span>
<span id="cb3-163"><a href="#cb3-163"></a>        <span class="cf">if</span> reset:</span>
<span id="cb3-164"><a href="#cb3-164"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(X, np.ndarray):</span>
<span id="cb3-165"><a href="#cb3-165"></a>                <span class="va">self</span>.feature_names_ <span class="op">=</span> [<span class="ss">f'feat_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(X.shape[<span class="dv">1</span>])]</span>
<span id="cb3-166"><a href="#cb3-166"></a>            <span class="cf">else</span>:</span>
<span id="cb3-167"><a href="#cb3-167"></a>                <span class="va">self</span>.feature_names_ <span class="op">=</span> X.columns.tolist()</span>
<span id="cb3-168"><a href="#cb3-168"></a>        <span class="cf">elif</span> <span class="bu">hasattr</span>(X, <span class="st">'columns'</span>):</span>
<span id="cb3-169"><a href="#cb3-169"></a>            <span class="cf">if</span> <span class="bu">list</span>(X.columns) <span class="op">!=</span> <span class="va">self</span>.feature_names_:</span>
<span id="cb3-170"><a href="#cb3-170"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Feature names mismatch between fit and predict"</span>)</span>
<span id="cb3-171"><a href="#cb3-171"></a></span>
<span id="cb3-172"><a href="#cb3-172"></a><span class="kw">def</span> load_autogluon(folder_path: <span class="bu">str</span>, persist_model: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>) <span class="op">-&gt;</span> AutoGluonSklearnWrapper:</span>
<span id="cb3-173"><a href="#cb3-173"></a>    <span class="co">"""</span></span>
<span id="cb3-174"><a href="#cb3-174"></a><span class="co">    Loads a pre-trained AutoGluon TabularPredictor from a specified path</span></span>
<span id="cb3-175"><a href="#cb3-175"></a><span class="co">    into an AutoGluonSklearnWrapper instance.</span></span>
<span id="cb3-176"><a href="#cb3-176"></a></span>
<span id="cb3-177"><a href="#cb3-177"></a><span class="co">    Parameters</span></span>
<span id="cb3-178"><a href="#cb3-178"></a><span class="co">    ----------</span></span>
<span id="cb3-179"><a href="#cb3-179"></a><span class="co">    folder_path : str</span></span>
<span id="cb3-180"><a href="#cb3-180"></a><span class="co">        The path to the directory containing the saved AutoGluon predictor.</span></span>
<span id="cb3-181"><a href="#cb3-181"></a><span class="co">    persist_model : bool, default=False</span></span>
<span id="cb3-182"><a href="#cb3-182"></a><span class="co">        If True, calls predictor.persist() after loading to potentially</span></span>
<span id="cb3-183"><a href="#cb3-183"></a><span class="co">        speed up future predictions by loading models into memory.</span></span>
<span id="cb3-184"><a href="#cb3-184"></a></span>
<span id="cb3-185"><a href="#cb3-185"></a><span class="co">    Returns</span></span>
<span id="cb3-186"><a href="#cb3-186"></a><span class="co">    -------</span></span>
<span id="cb3-187"><a href="#cb3-187"></a><span class="co">    AutoGluonSklearnWrapper</span></span>
<span id="cb3-188"><a href="#cb3-188"></a><span class="co">        An instance of the wrapper containing the loaded predictor and its metadata.</span></span>
<span id="cb3-189"><a href="#cb3-189"></a></span>
<span id="cb3-190"><a href="#cb3-190"></a><span class="co">    Raises</span></span>
<span id="cb3-191"><a href="#cb3-191"></a><span class="co">    ------</span></span>
<span id="cb3-192"><a href="#cb3-192"></a><span class="co">    FileNotFoundError</span></span>
<span id="cb3-193"><a href="#cb3-193"></a><span class="co">        If the specified folder_path does not exist or doesn't contain a valid predictor.</span></span>
<span id="cb3-194"><a href="#cb3-194"></a><span class="co">    Exception</span></span>
<span id="cb3-195"><a href="#cb3-195"></a><span class="co">        If any other error occurs during loading or processing.</span></span>
<span id="cb3-196"><a href="#cb3-196"></a><span class="co">    """</span></span>
<span id="cb3-197"><a href="#cb3-197"></a>    <span class="cf">try</span>:</span>
<span id="cb3-198"><a href="#cb3-198"></a>        <span class="bu">print</span>(<span class="ss">f"Loading AutoGluon predictor from: </span><span class="sc">{</span>folder_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-199"><a href="#cb3-199"></a>        predictor <span class="op">=</span> TabularPredictor.load(folder_path)</span>
<span id="cb3-200"><a href="#cb3-200"></a>        <span class="bu">print</span>(<span class="st">"Predictor loaded successfully."</span>)</span>
<span id="cb3-201"><a href="#cb3-201"></a></span>
<span id="cb3-202"><a href="#cb3-202"></a>        <span class="co"># Extract metadata from the loaded predictor</span></span>
<span id="cb3-203"><a href="#cb3-203"></a>        label <span class="op">=</span> predictor.label</span>
<span id="cb3-204"><a href="#cb3-204"></a>        feature_names <span class="op">=</span> predictor.feature_metadata_in.get_features() <span class="co"># Get feature names used during training</span></span>
<span id="cb3-205"><a href="#cb3-205"></a>        n_features <span class="op">=</span> <span class="bu">len</span>(feature_names)</span>
<span id="cb3-206"><a href="#cb3-206"></a>        classes <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-207"><a href="#cb3-207"></a>        <span class="cf">if</span> predictor.problem_type <span class="kw">in</span> [<span class="st">'binary'</span>, <span class="st">'multiclass'</span>]:</span>
<span id="cb3-208"><a href="#cb3-208"></a>            classes <span class="op">=</span> np.array(predictor.class_labels)</span>
<span id="cb3-209"><a href="#cb3-209"></a></span>
<span id="cb3-210"><a href="#cb3-210"></a>        <span class="co"># Instantiate the wrapper</span></span>
<span id="cb3-211"><a href="#cb3-211"></a>        <span class="co"># Note: predictor_args and fit_args used during original training aren't easily accessible</span></span>
<span id="cb3-212"><a href="#cb3-212"></a>        <span class="co"># We initialize them as empty dicts here.</span></span>
<span id="cb3-213"><a href="#cb3-213"></a>        wrapper <span class="op">=</span> AutoGluonSklearnWrapper(label<span class="op">=</span>label, predictor_args<span class="op">=</span>{}, fit_args<span class="op">=</span>{})</span>
<span id="cb3-214"><a href="#cb3-214"></a></span>
<span id="cb3-215"><a href="#cb3-215"></a>        <span class="co"># Assign the loaded predictor and metadata to the wrapper</span></span>
<span id="cb3-216"><a href="#cb3-216"></a>        wrapper.predictor <span class="op">=</span> predictor</span>
<span id="cb3-217"><a href="#cb3-217"></a>        wrapper.classes_ <span class="op">=</span> classes</span>
<span id="cb3-218"><a href="#cb3-218"></a>        wrapper.n_features_in_ <span class="op">=</span> n_features</span>
<span id="cb3-219"><a href="#cb3-219"></a>        wrapper.feature_names_ <span class="op">=</span> feature_names</span>
<span id="cb3-220"><a href="#cb3-220"></a>        wrapper.is_fitted_ <span class="op">=</span> <span class="va">True</span> <span class="co"># Mark as fitted</span></span>
<span id="cb3-221"><a href="#cb3-221"></a></span>
<span id="cb3-222"><a href="#cb3-222"></a>        <span class="co"># Optionally persist the model</span></span>
<span id="cb3-223"><a href="#cb3-223"></a>        <span class="cf">if</span> persist_model:</span>
<span id="cb3-224"><a href="#cb3-224"></a>            <span class="bu">print</span>(<span class="st">"Persisting predictor models in memory..."</span>)</span>
<span id="cb3-225"><a href="#cb3-225"></a>            <span class="co"># This loads models into memory for faster predictions, requires sufficient RAM</span></span>
<span id="cb3-226"><a href="#cb3-226"></a>            wrapper.predictor.persist()</span>
<span id="cb3-227"><a href="#cb3-227"></a>            <span class="bu">print</span>(<span class="st">"Predictor models persisted."</span>)</span>
<span id="cb3-228"><a href="#cb3-228"></a></span>
<span id="cb3-229"><a href="#cb3-229"></a>        <span class="bu">print</span>(<span class="st">"AutoGluonSklearnWrapper created and populated successfully."</span>)</span>
<span id="cb3-230"><a href="#cb3-230"></a>        <span class="cf">return</span> wrapper</span>
<span id="cb3-231"><a href="#cb3-231"></a></span>
<span id="cb3-232"><a href="#cb3-232"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb3-233"><a href="#cb3-233"></a>        <span class="bu">print</span>(<span class="ss">f"Error: Predictor directory not found at </span><span class="sc">{</span>folder_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-234"><a href="#cb3-234"></a>        <span class="cf">raise</span></span>
<span id="cb3-235"><a href="#cb3-235"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb3-236"><a href="#cb3-236"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred while loading the predictor or creating the wrapper: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-237"><a href="#cb3-237"></a>        <span class="im">import</span> traceback</span>
<span id="cb3-238"><a href="#cb3-238"></a>        traceback.print_exc()</span>
<span id="cb3-239"><a href="#cb3-239"></a>        <span class="cf">raise</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-data-and-pre-trained-model" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Load Data and Pre-trained Model</h1>
<div id="load-data" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>df_ttd_train <span class="op">=</span> pd.read_parquet(<span class="st">"../Data/lendingclub/lendingclub_ttd_train.parquet"</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a>df_ttd_test <span class="op">=</span> pd.read_parquet(<span class="st">"../Data/lendingclub/lendingclub_ttd_test_cloning.parquet"</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a>df_ttd_test_noCloning <span class="op">=</span> pd.read_parquet(<span class="st">"../Data/lendingclub/lendingclub_ttd_test_noCloning.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="load-model" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>model_path <span class="op">=</span> <span class="st">"Lab02_ag_models_TTD_Constrained"</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a>AutoGluon_TTD_model <span class="op">=</span> load_autogluon(</span>
<span id="cb5-4"><a href="#cb5-4"></a>    folder_path<span class="op">=</span>model_path,</span>
<span id="cb5-5"><a href="#cb5-5"></a>    persist_model<span class="op">=</span><span class="va">True</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loading AutoGluon predictor from: Lab02_ag_models_TTD_Constrained
Predictor loaded successfully.
Persisting predictor models in memory...
Predictor models persisted.
AutoGluonSklearnWrapper created and populated successfully.</code></pre>
</div>
</div>
</section>
<section id="counterfactual-explanations" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Counterfactual Explanations</h1>
<section id="overview" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">3.1</span> Overview</h2>
<p><strong>Concept:</strong> Counterfactual explanations identify the minimal changes needed to alter a predicted label. For example, if an applicant is rejected, a counterfactual explanation would suggest how their features could be adjusted to achieve approval.</p>
<p>First, we need to score the training and test sets to identify the applicants that were accepted and rejected by the model. Note that this is different than the default flag, which is the target variable. The model decision is based on the <strong>predicted</strong> probability of default (PD) and a threshold.</p>
<p>Also keep in mind that <code>model_rejection = 1</code> means the applicant was rejected by the model, while <code>model_rejection = 0</code> means the applicant was accepted.</p>
<p>Crucially, <code>model_rejection</code> represents the model’s lending decision, which may not match the actual <code>default_flag</code>.</p>
<div id="score-data" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># append predicted labels to the training and test sets</span></span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a>df_ttd_train[<span class="st">'model_rejection'</span>] <span class="op">=</span> AutoGluon_TTD_model.predict(</span>
<span id="cb7-4"><a href="#cb7-4"></a>    df_ttd_train[AutoGluon_TTD_model.feature_names_]</span>
<span id="cb7-5"><a href="#cb7-5"></a>)</span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a>df_ttd_test[<span class="st">'model_rejection'</span>] <span class="op">=</span> AutoGluon_TTD_model.predict(</span>
<span id="cb7-8"><a href="#cb7-8"></a>    df_ttd_test[AutoGluon_TTD_model.feature_names_]</span>
<span id="cb7-9"><a href="#cb7-9"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a>keep_cols <span class="op">=</span> AutoGluon_TTD_model.feature_names_ <span class="op">+</span> [<span class="st">'model_rejection'</span>]</span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a>display(df_ttd_train[keep_cols].sample(<span class="dv">20</span>, random_state<span class="op">=</span><span class="dv">2024</span>).head(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-training-decisions" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="6">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-training-decisions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Training set decisions
</figcaption>
<div aria-describedby="tbl-training-decisions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_amnt</th>
<th data-quarto-table-cell-role="th">dti</th>
<th data-quarto-table-cell-role="th">credit_score</th>
<th data-quarto-table-cell-role="th">emp_length</th>
<th data-quarto-table-cell-role="th">model_rejection</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1701897</td>
<td>9000.0</td>
<td>7.240000</td>
<td>541.0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1147716</td>
<td>30000.0</td>
<td>30.879999</td>
<td>667.0</td>
<td>10</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1316786</td>
<td>13000.0</td>
<td>34.110001</td>
<td>697.0</td>
<td>10</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1935671</td>
<td>25000.0</td>
<td>100.000000</td>
<td>541.0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">165783</td>
<td>7800.0</td>
<td>16.690001</td>
<td>732.0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">977238</td>
<td>35000.0</td>
<td>8.620000</td>
<td>662.0</td>
<td>5</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1213747</td>
<td>25000.0</td>
<td>19.270000</td>
<td>672.0</td>
<td>3</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">566132</td>
<td>20000.0</td>
<td>18.559999</td>
<td>682.0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1307476</td>
<td>12000.0</td>
<td>22.920000</td>
<td>727.0</td>
<td>5</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">370591</td>
<td>4800.0</td>
<td>3.950000</td>
<td>762.0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>display(df_ttd_test[keep_cols].sample(<span class="dv">20</span>, random_state<span class="op">=</span><span class="dv">2024</span>).head(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-test-decisions" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="7">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-test-decisions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Test set decisions
</figcaption>
<div aria-describedby="tbl-test-decisions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_amnt</th>
<th data-quarto-table-cell-role="th">dti</th>
<th data-quarto-table-cell-role="th">credit_score</th>
<th data-quarto-table-cell-role="th">emp_length</th>
<th data-quarto-table-cell-role="th">model_rejection</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">527597</td>
<td>10000.0</td>
<td>4.350000</td>
<td>541.0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">471114</td>
<td>1000.0</td>
<td>63.500000</td>
<td>591.0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">313564</td>
<td>8000.0</td>
<td>5.110000</td>
<td>697.0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">286396</td>
<td>12000.0</td>
<td>15.070000</td>
<td>772.0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">377238</td>
<td>24000.0</td>
<td>15.290000</td>
<td>687.0</td>
<td>5</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">370279</td>
<td>9600.0</td>
<td>4.080000</td>
<td>667.0</td>
<td>3</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">492213</td>
<td>3000.0</td>
<td>39.150002</td>
<td>541.0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">407114</td>
<td>8800.0</td>
<td>20.610001</td>
<td>682.0</td>
<td>6</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">68646</td>
<td>35000.0</td>
<td>11.590000</td>
<td>687.0</td>
<td>10</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">548455</td>
<td>4000.0</td>
<td>19.430000</td>
<td>541.0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>Second, we randomly select 1 rejected applicant from the test set to explain. This applicant will be used to demonstrate the counterfactual explanation process.</p>
<div class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>sample_reject <span class="op">=</span> df_ttd_test[keep_cols][df_ttd_test.model_rejection <span class="op">==</span> <span class="dv">1</span>].sample(<span class="dv">1</span>, random_state<span class="op">=</span><span class="dv">2020</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a>display(sample_reject)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-sample-applicant" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="8">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-sample-applicant-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Sample rejected applicant
</figcaption>
<div aria-describedby="tbl-sample-applicant-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_amnt</th>
<th data-quarto-table-cell-role="th">dti</th>
<th data-quarto-table-cell-role="th">credit_score</th>
<th data-quarto-table-cell-role="th">emp_length</th>
<th data-quarto-table-cell-role="th">model_rejection</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">583069</td>
<td>5500.0</td>
<td>20.219999</td>
<td>541.0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="counterfactual-explainer" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="counterfactual-explainer"><span class="header-section-number">3.2</span> Counterfactual Explainer</h2>
<p>Setup an <code>dice-explainer</code> using the <code>dice_ml</code> library. The explainer will be used to generate counterfactuals for the rejected applicant.</p>
<p>The explainer needs two objects:</p>
<ol type="1">
<li>Data with the predicted labels (<code>model_rejection</code>).</li>
<li>The trained model used to generate prediction labels.</li>
</ol>
<div id="setup-counterfactuals" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>dice_data <span class="op">=</span> dice_ml.Data(</span>
<span id="cb11-2"><a href="#cb11-2"></a>    dataframe<span class="op">=</span>df_ttd_train[keep_cols],</span>
<span id="cb11-3"><a href="#cb11-3"></a>    continuous_features<span class="op">=</span>AutoGluon_TTD_model.feature_names_,</span>
<span id="cb11-4"><a href="#cb11-4"></a>    outcome_name<span class="op">=</span><span class="st">"model_rejection"</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>)</span>
<span id="cb11-6"><a href="#cb11-6"></a></span>
<span id="cb11-7"><a href="#cb11-7"></a>dice_model <span class="op">=</span> dice_ml.Model(</span>
<span id="cb11-8"><a href="#cb11-8"></a>    model<span class="op">=</span>AutoGluon_TTD_model,</span>
<span id="cb11-9"><a href="#cb11-9"></a>    backend<span class="op">=</span><span class="st">'sklearn'</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>)</span>
<span id="cb11-11"><a href="#cb11-11"></a></span>
<span id="cb11-12"><a href="#cb11-12"></a>dice_explainer <span class="op">=</span> dice_ml.Dice(</span>
<span id="cb11-13"><a href="#cb11-13"></a>    data_interface<span class="op">=</span>dice_data,</span>
<span id="cb11-14"><a href="#cb11-14"></a>    model_interface<span class="op">=</span>dice_model,</span>
<span id="cb11-15"><a href="#cb11-15"></a>    method<span class="op">=</span><span class="st">"kdtree"</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A k-d tree (k-dimensional tree) is a data structure used for organizing points in a k-dimensional space. It recursively partitions the space along different dimensions, allowing for efficient nearest neighbor searches. This structure helps quickly find data points that are close to a given query point in multiple dimensions.</p>
<p>DiCE uses the k-d tree method to efficiently search the feature space for counterfactual examples. It builds a k-d tree using the training data points. When generating counterfactuals for a specific instance (like the rejected applicant), DiCE searches the k-d tree to find the nearest data points that result in the desired outcome (e.g., loan approval) while minimizing changes to the original features.</p>
</section>
<section id="counterfactual-explanations-1" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="counterfactual-explanations-1"><span class="header-section-number">3.3</span> Counterfactual Explanations</h2>
<div id="generate-counterfactuals" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>threshold <span class="op">=</span> AutoGluon_TTD_model.predictor.decision_threshold <span class="co"># Use decision_threshold</span></span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a>user_permitted_range <span class="op">=</span> {</span>
<span id="cb12-4"><a href="#cb12-4"></a>    <span class="st">'loan_amnt'</span>: [<span class="dv">500</span>, sample_reject[<span class="st">'loan_amnt'</span>].iloc[<span class="dv">0</span>]],</span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="st">'dti'</span>: [<span class="dv">0</span>, sample_reject[<span class="st">'dti'</span>].iloc[<span class="dv">0</span>]],</span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="st">'credit_score'</span>: [sample_reject[<span class="st">'credit_score'</span>].iloc[<span class="dv">0</span>], <span class="dv">850</span>],</span>
<span id="cb12-7"><a href="#cb12-7"></a>    <span class="st">'emp_length'</span>: [sample_reject[<span class="st">'emp_length'</span>].iloc[<span class="dv">0</span>], <span class="dv">10</span>]</span>
<span id="cb12-8"><a href="#cb12-8"></a>}</span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a>dice_exp <span class="op">=</span> dice_explainer.generate_counterfactuals(</span>
<span id="cb12-11"><a href="#cb12-11"></a>    query_instances<span class="op">=</span>sample_reject[AutoGluon_TTD_model.feature_names_],</span>
<span id="cb12-12"><a href="#cb12-12"></a>    total_CFs<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb12-13"><a href="#cb12-13"></a>    permitted_range<span class="op">=</span>user_permitted_range</span>
<span id="cb12-14"><a href="#cb12-14"></a>    )</span>
<span id="cb12-15"><a href="#cb12-15"></a></span>
<span id="cb12-16"><a href="#cb12-16"></a><span class="co"># Extract the counterfactual features (scaled)</span></span>
<span id="cb12-17"><a href="#cb12-17"></a>df_counterfactuals <span class="op">=</span> dice_exp.cf_examples_list[<span class="dv">0</span>].final_cfs_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>user_permitted_range</code> dictionary prevents counterfactuals that are unintuitive or impossible. It prevents counterfactuals with a <code>loan_amnt</code> greater than the application amount, a <code>dti</code> greater than the applicant value, a <code>credit_score</code> less than the applicant value, and an <code>emp_length</code> less than the applicant value.</p>
<div class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>display(sample_reject)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-rejected-applicant" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="11">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-rejected-applicant-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Rejected applicant
</figcaption>
<div aria-describedby="tbl-rejected-applicant-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_amnt</th>
<th data-quarto-table-cell-role="th">dti</th>
<th data-quarto-table-cell-role="th">credit_score</th>
<th data-quarto-table-cell-role="th">emp_length</th>
<th data-quarto-table-cell-role="th">model_rejection</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">583069</td>
<td>5500.0</td>
<td>20.219999</td>
<td>541.0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>display(df_counterfactuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-counterfactuals" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="12">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-counterfactuals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Counterfactuals for rejected applicant
</figcaption>
<div aria-describedby="tbl-counterfactuals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_amnt</th>
<th data-quarto-table-cell-role="th">dti</th>
<th data-quarto-table-cell-role="th">credit_score</th>
<th data-quarto-table-cell-role="th">emp_length</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1120825</td>
<td>5500.0</td>
<td>20.1</td>
<td>662.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1141706</td>
<td>5500.0</td>
<td>19.3</td>
<td>662.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1013223</td>
<td>5500.0</td>
<td>19.0</td>
<td>662.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">556186</td>
<td>5500.0</td>
<td>18.8</td>
<td>662.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">153045</td>
<td>5500.0</td>
<td>18.2</td>
<td>662.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>Verify that the counterfactuals provided would have generated an approval by the TTD model.</p>
<div class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>df_counterfactuals[<span class="st">'verify_model_rejection'</span>] <span class="op">=</span> AutoGluon_TTD_model.predict(</span>
<span id="cb15-2"><a href="#cb15-2"></a>    df_counterfactuals[AutoGluon_TTD_model.feature_names_]</span>
<span id="cb15-3"><a href="#cb15-3"></a>)</span>
<span id="cb15-4"><a href="#cb15-4"></a></span>
<span id="cb15-5"><a href="#cb15-5"></a>display(df_counterfactuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-verify-counterfactuals" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="13">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-verify-counterfactuals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: Verify counterfactuals
</figcaption>
<div aria-describedby="tbl-verify-counterfactuals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_amnt</th>
<th data-quarto-table-cell-role="th">dti</th>
<th data-quarto-table-cell-role="th">credit_score</th>
<th data-quarto-table-cell-role="th">emp_length</th>
<th data-quarto-table-cell-role="th">verify_model_rejection</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1120825</td>
<td>5500.0</td>
<td>20.1</td>
<td>662.0</td>
<td>0.0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1141706</td>
<td>5500.0</td>
<td>19.3</td>
<td>662.0</td>
<td>0.0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1013223</td>
<td>5500.0</td>
<td>19.0</td>
<td>662.0</td>
<td>0.0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">556186</td>
<td>5500.0</td>
<td>18.8</td>
<td>662.0</td>
<td>0.0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">153045</td>
<td>5500.0</td>
<td>18.2</td>
<td>662.0</td>
<td>0.0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p><strong>Interpretation:</strong> The output shows alternative feature values (the counterfactuals) that would have led to an ‘Approve’ decision. This highlights the key factors driving the rejection and provides concrete suggestions for the applicant.</p>
</section>
</section>
<section id="generate-adverse-action-codes" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Generate Adverse Action Codes</h1>
<p>The script below generates a list of adverse action codes based on differences between <code>sample_reject</code> and <code>df_counterfactuals</code>. It does this by comparing the values of each feature, and if a value differs between the two datasets, it appends a predefined message to the adverse action codes list.</p>
<p>By comparing each feature of the original sample against the counterfactual, the code effectively identifies which factors (such as a too-high loan amount or a low credit score) contributed to the adverse decision and communicates those reasons clearly to the applicant.</p>
<div id="adverse-action-codes" class="cell" data-tbl-cap="Adverse Action Codes" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">def</span> generate_adverse_action_codes(df_rejected, df_counterfactuals, dict_feature_to_action, list_features_to_compare):</span>
<span id="cb16-2"><a href="#cb16-2"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="co">    Generate adverse action codes based on differences between a rejected applicant and its counterfactual.</span></span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="co">    Args:</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="co">        df_rejected (DataFrame): DataFrame with the rejected applicant's data (assumed to be a single row).</span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="co">        df_counterfactuals (DataFrame): DataFrame containing counterfactual data (first row is used).</span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="co">        dict_feature_to_action (dict): Mapping from feature names to their corresponding adverse action message.</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="co">        list_features_to_compare (list): List of feature names to compare between the rejected and counterfactual data.</span></span>
<span id="cb16-10"><a href="#cb16-10"></a></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="co">    Returns:</span></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="co">        list: A list of adverse action codes as strings.</span></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="co">    """</span></span>
<span id="cb16-14"><a href="#cb16-14"></a>    adverse_action_codes <span class="op">=</span> []</span>
<span id="cb16-15"><a href="#cb16-15"></a></span>
<span id="cb16-16"><a href="#cb16-16"></a>    <span class="cf">for</span> feature <span class="kw">in</span> list_features_to_compare:</span>
<span id="cb16-17"><a href="#cb16-17"></a>        original_value <span class="op">=</span> df_rejected[feature].iloc[<span class="dv">0</span>]</span>
<span id="cb16-18"><a href="#cb16-18"></a>        counterfactual_value <span class="op">=</span> df_counterfactuals[feature].iloc[<span class="dv">0</span>]</span>
<span id="cb16-19"><a href="#cb16-19"></a>        <span class="cf">if</span> original_value <span class="op">!=</span> counterfactual_value:</span>
<span id="cb16-20"><a href="#cb16-20"></a>            adverse_action_codes.append(dict_feature_to_action[feature])</span>
<span id="cb16-21"><a href="#cb16-21"></a></span>
<span id="cb16-22"><a href="#cb16-22"></a>    <span class="cf">return</span> adverse_action_codes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="adverse-action-codes-example" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>feature_to_action_code <span class="op">=</span> {</span>
<span id="cb17-2"><a href="#cb17-2"></a>    <span class="st">'loan_amnt'</span>: <span class="st">"Loan amount too high"</span>,</span>
<span id="cb17-3"><a href="#cb17-3"></a>    <span class="st">'dti'</span>: <span class="st">"Debt-to-income ratio too high"</span>,</span>
<span id="cb17-4"><a href="#cb17-4"></a>    <span class="st">'credit_score'</span>: <span class="st">"Credit score too low"</span>,</span>
<span id="cb17-5"><a href="#cb17-5"></a>    <span class="st">'emp_length'</span>: <span class="st">"Employment length too short"</span></span>
<span id="cb17-6"><a href="#cb17-6"></a>}</span>
<span id="cb17-7"><a href="#cb17-7"></a></span>
<span id="cb17-8"><a href="#cb17-8"></a>action_codes <span class="op">=</span> generate_adverse_action_codes(</span>
<span id="cb17-9"><a href="#cb17-9"></a>    sample_reject, </span>
<span id="cb17-10"><a href="#cb17-10"></a>    df_counterfactuals, </span>
<span id="cb17-11"><a href="#cb17-11"></a>    feature_to_action_code, </span>
<span id="cb17-12"><a href="#cb17-12"></a>    AutoGluon_TTD_model.feature_names_</span>
<span id="cb17-13"><a href="#cb17-13"></a>)</span>
<span id="cb17-14"><a href="#cb17-14"></a></span>
<span id="cb17-15"><a href="#cb17-15"></a><span class="bu">print</span>(<span class="st">"Adverse Action Codes:"</span>)</span>
<span id="cb17-16"><a href="#cb17-16"></a><span class="cf">for</span> code <span class="kw">in</span> action_codes:</span>
<span id="cb17-17"><a href="#cb17-17"></a>    <span class="bu">print</span>(<span class="ss">f"- </span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Adverse Action Codes:
- Debt-to-income ratio too high
- Credit score too low</code></pre>
</div>
</div>
</section>
<section id="improved-adverse-action-codes" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Improved Adverse Action Codes</h1>
<p>A major drawback of this approach is that the order of the generated codes depends on the order of the features in the list <code>AutoGluon_TTD_model.feature_names_</code>. Ideally (and legally), the order should be based on the importance of the features in the model decision.</p>
<p>We can re-order the elements in the list based on permutation feature importance (PFI) scores. The code below generates the PFI scores and re-orders the adverse action codes based on the PFI scores.</p>
<div id="permutation-feature-importance" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>pfi <span class="op">=</span> AutoGluon_TTD_model.predictor.feature_importance(</span>
<span id="cb19-2"><a href="#cb19-2"></a>    df_ttd_test[AutoGluon_TTD_model.feature_names_ <span class="op">+</span> [<span class="st">'default_flag'</span>]],</span>
<span id="cb19-3"><a href="#cb19-3"></a>    silent<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>)</span>
<span id="cb19-5"><a href="#cb19-5"></a></span>
<span id="cb19-6"><a href="#cb19-6"></a>important_features <span class="op">=</span> pfi.index.tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="improved-adverse-action-codes" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>improved_action_codes <span class="op">=</span> generate_adverse_action_codes(</span>
<span id="cb20-2"><a href="#cb20-2"></a>    sample_reject, </span>
<span id="cb20-3"><a href="#cb20-3"></a>    df_counterfactuals, </span>
<span id="cb20-4"><a href="#cb20-4"></a>    feature_to_action_code, </span>
<span id="cb20-5"><a href="#cb20-5"></a>    important_features</span>
<span id="cb20-6"><a href="#cb20-6"></a>)</span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="bu">print</span>(<span class="st">"Improved Adverse Action Codes:"</span>)</span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="cf">for</span> code <span class="kw">in</span> improved_action_codes:</span>
<span id="cb20-10"><a href="#cb20-10"></a>    <span class="bu">print</span>(<span class="ss">f"- </span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Improved Adverse Action Codes:
- Credit score too low
- Debt-to-income ratio too high</code></pre>
</div>
</div>
<p>Permutation feature importance provides a global ranking of feature impacts in the model. By ordering the adverse action codes according to this ranking, we ensure that the most important features are highlighted first. This is crucial for effective communication with applicants, as it emphasizes the most significant factors influencing their application outcome.</p>
<p>However, global ranking of feature impacts is not always equal to the local ranking of feature impacts. For example, the most important feature for the model may not be the most important feature for a specific applicant. This is a limitation of the PFI approach. SHAP values can be used to generate local rankings of feature impacts.</p>
</section>
<section id="shap-values" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> SHAP Values</h1>
<section id="concept" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="concept"><span class="header-section-number">6.1</span> Concept</h2>
<p>The difference between the predicted probability of default (<span class="math inline">\(\widehat{PD_i}\)</span>) for an applicant (<span class="math inline">\(i\)</span>) and the average predicted PD (<span class="math inline">\(\overline{PD}\)</span>) for a given data set can be decomposed into the contributions of each feature. The contributions are called SHAP values.</p>
<p>Suppose a credit scorecard model had 4 features. Then, for applicant <span class="math inline">\(i\)</span>, there would be 4 SHAP values, one for each feature. The SHAP values can be interpreted as the contribution of each feature to the difference between the predicted PD and the average PD.</p>
<p><span class="math inline">\(\widehat{PD_i} - \overline{PD} = \phi_{i,DTI} + \phi_{i,CreditScore} + \phi_{i,EmpLength} + \phi_{i,LoanAmnt}\)</span></p>
<p>For a given data set (e.g., training set), <span class="math inline">\(\overline{PD}\)</span> is constant. Therefore, the SHAP values can be interpreted as the contribution of each feature to the predicted PD.</p>
<p><span class="math inline">\(\widehat{PD_i} = \overline{PD} + \phi_{i,DTI} + \phi_{i,CreditScore} + \phi_{i,EmpLength} + \phi_{i,LoanAmnt}\)</span></p>
<p>SHAP values can be negative or positive. A negative SHAP value means that the feature decreases the predicted PD, while a positive SHAP value means that the feature increases the predicted PD.</p>
</section>
<section id="setup-shap-explainer" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="setup-shap-explainer"><span class="header-section-number">6.2</span> Setup SHAP Explainer</h2>
<p>Initialize the SHAP explainer using the constrained model and a background dataset (usually a sample of the training data) to represent the baseline prediction.</p>
<p>Notice that the background dataset does not contain the true label. The SHAP explainer uses the background dataset to calculate the expected value of the model’s predictions. This is important because the SHAP values are calculated as the difference between the predicted value and the expected value.</p>
<p>We pass a custom <code>predict_proba</code> function (with <code>[:, 1]</code>) to the explainer that returns the model’s predicted probability of the positive class (default=1), as we want to explain this specific outcome.</p>
<p>The background data provides a reference distribution to calculate the baseline prediction (<span class="math inline">\(E[f(X)]\)</span>) and baseline values for each feature. A sample is often used for computational efficiency.</p>
<div id="setup-shap" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a>background_data_sample <span class="op">=</span> df_ttd_train[AutoGluon_TTD_model.feature_names_].sample(<span class="dv">60_000</span>, random_state<span class="op">=</span><span class="dv">2025</span>)</span>
<span id="cb22-2"><a href="#cb22-2"></a></span>
<span id="cb22-3"><a href="#cb22-3"></a>shap_explainer <span class="op">=</span> shap.Explainer(<span class="kw">lambda</span> x: AutoGluon_TTD_model.predict_proba(x)[:, <span class="dv">1</span>], background_data_sample)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="local-interpretability-waterfall-plots" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="local-interpretability-waterfall-plots"><span class="header-section-number">6.3</span> Local Interpretability (Waterfall Plots)</h2>
<p>Calculate SHAP values for the 1 rejected applicant and plot the SHAP values using a waterfall plot. The waterfall plot shows the contribution of each feature to the predicted PD for that specific applicant.</p>
<div id="cell-fig-calculate-local-shap" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># Generate SHAP values for the rejected applicant</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>shap_values <span class="op">=</span> shap_explainer(sample_reject[AutoGluon_TTD_model.feature_names_])</span>
<span id="cb23-3"><a href="#cb23-3"></a></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="co"># Display the waterfall plot for the first (and only) instance</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>shap.plots.waterfall(shap_values[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-calculate-local-shap" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-calculate-local-shap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Lab%2003_files/figure-html/fig-calculate-local-shap-output-1.png" width="792" height="347" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-calculate-local-shap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: SHAP Waterfall Plot for Rejected Applicant
</figcaption>
</figure>
</div>
</div>
</div>
<p><strong>Interpretation:</strong> The baseline PD is 0.234. The sum of the SHAP values (feature contributions) for this applicant is approximately 0.247. Adding this to the baseline prediction gives the final prediction 0.234 + 0.247 = 0.481.</p>
<div class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a>df_local_shap <span class="op">=</span> pd.DataFrame({</span>
<span id="cb24-2"><a href="#cb24-2"></a>    <span class="st">'feature'</span>: AutoGluon_TTD_model.feature_names_,</span>
<span id="cb24-3"><a href="#cb24-3"></a>    <span class="st">'shap_value'</span>: shap_values[<span class="dv">0</span>].values</span>
<span id="cb24-4"><a href="#cb24-4"></a>})</span>
<span id="cb24-5"><a href="#cb24-5"></a>df_local_shap[<span class="st">'abs_shap_value'</span>] <span class="op">=</span> df_local_shap[<span class="st">'shap_value'</span>].<span class="bu">abs</span>()</span>
<span id="cb24-6"><a href="#cb24-6"></a>df_local_shap.sort_values(<span class="st">'abs_shap_value'</span>, ascending<span class="op">=</span><span class="va">False</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-7"><a href="#cb24-7"></a></span>
<span id="cb24-8"><a href="#cb24-8"></a>display(df_local_shap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-local-shap-values" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="20">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-local-shap-values-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7: Sorted SHAP values for rejected applicant
</figcaption>
<div aria-describedby="tbl-local-shap-values-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">feature</th>
<th data-quarto-table-cell-role="th">shap_value</th>
<th data-quarto-table-cell-role="th">abs_shap_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>credit_score</td>
<td>0.259814</td>
<td>0.259814</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>dti</td>
<td>-0.012162</td>
<td>0.012162</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>loan_amnt</td>
<td>-0.008869</td>
<td>0.008869</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>emp_length</td>
<td>0.007766</td>
<td>0.007766</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>When we generate a ranked list of features that affected the predicted PD, we should use the <strong>absolute value</strong> of the SHAP values. The absolute value of the SHAP value indicates the magnitude of the impact, regardless of whether it is positive or negative.</p>
<p>The feature that contributes the most to the predicted PD is <code>credit_score</code>, followed by <code>dti</code> and <code>loan_amnt</code>. The feature <code>emp_length</code> has the least impact on the predicted PD.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Important Point: Understanding a Single SHAP Value</strong></p>
<p>Think of the SHAP values shown in the waterfall plot for one applicant:</p>
<ul>
<li><p><strong>What they explain:</strong> Each SHAP value shows how a specific feature <em>value</em> for <em>that particular applicant</em> pushed their prediction away from the average prediction (the baseline <code>E[f(X)]</code>). For instance, the positive SHAP value for <code>credit_score</code> means <em>this applicant’s specific credit score</em> increased their predicted Probability of Default (PD) compared to the average.</p></li>
<li><p><strong>What they DON’T explain:</strong></p>
<ul>
<li><p>A single SHAP value for one applicant doesn’t tell you the <em>overall trend</em> or <em>marginal effect</em> of that feature. It doesn’t answer the question: “In general, if someone increases their <code>credit_score</code>, will their predicted PD decrease?” We should use dependence plots to answer this question.</p></li>
<li><p>Nor does the SHAP value answer the question for the rejected applicant: “If the <code>credit_score</code> was 20 points higher, would the predicted PD be lower for the applicant?” We should use counterfactuals to answer this question.</p></li>
</ul></li>
</ul>
</div>
</div>
</section>
</section>
<section id="local-adverse-action-codes" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Local Adverse Action Codes</h1>
<p>The code below generates adverse action codes for the 1 rejected applicant based on the SHAP values. It uses the same logic as before, but now it uses the SHAP values to determine which features are most important for our specific applicant.</p>
<div id="local-adverse-action-codes" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a>shap_local_important_features <span class="op">=</span> df_local_shap[<span class="st">'feature'</span>].tolist()</span>
<span id="cb25-2"><a href="#cb25-2"></a></span>
<span id="cb25-3"><a href="#cb25-3"></a>shap_action_codes <span class="op">=</span> generate_adverse_action_codes(</span>
<span id="cb25-4"><a href="#cb25-4"></a>    sample_reject, </span>
<span id="cb25-5"><a href="#cb25-5"></a>    df_counterfactuals, </span>
<span id="cb25-6"><a href="#cb25-6"></a>    feature_to_action_code, </span>
<span id="cb25-7"><a href="#cb25-7"></a>    shap_local_important_features</span>
<span id="cb25-8"><a href="#cb25-8"></a>)</span>
<span id="cb25-9"><a href="#cb25-9"></a></span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="bu">print</span>(<span class="st">"SHAP Adverse Action Codes:"</span>)</span>
<span id="cb25-11"><a href="#cb25-11"></a><span class="cf">for</span> code <span class="kw">in</span> shap_action_codes:</span>
<span id="cb25-12"><a href="#cb25-12"></a>    <span class="bu">print</span>(<span class="ss">f"- </span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>SHAP Adverse Action Codes:
- Credit score too low
- Debt-to-income ratio too high</code></pre>
</div>
</div>
</section>
<section id="concluding-remarks-for-adverse-action-codes" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Concluding Remarks for Adverse Action Codes</h1>
<p>Subsequent sections of the lab will show other uses of SHAP values and a potpourri of data science topics. Before we address those topics, let’s quickly summarize adverse action codes and the process used to generate them.</p>
<ol type="1">
<li><p>Each rejected applicant must be given a list of reasons for rejection. This is a legal requirement in the US.</p></li>
<li><p>The list of reasons should be ordered from most impactful to least impactful. This is also a legal requirement in the US.</p></li>
<li><p>To generate the list of adverse action codes, we needed to find an example of an <strong>approved applicant</strong> that was very similar to the rejected applicant. This was accomplished using <strong>counterfactual explanations</strong>.</p></li>
<li><p>The order of the adverse action codes was based on the <strong>permutation feature importance</strong> (PFI) scores, representing a global ranking of feature impacts in the model.</p></li>
<li><p>Alternatively, we could have used <strong>SHAP values</strong> to generate a local ranking of feature impacts, providing a more accurate ranking for the specific applicant.</p></li>
</ol>
</section>
<section id="other-uses-of-shap-values" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Other Uses of SHAP Values</h1>
<section id="global-interpretability-summary-plots" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="global-interpretability-summary-plots"><span class="header-section-number">9.1</span> Global Interpretability (Summary Plots)</h2>
<p>Aggregate SHAP values across a larger sample (e.g., the test set) to understand overall feature importance and effects.</p>
<p>Bar Plot: Ranks features by their average impact (mean absolute SHAP value) across the sample. Higher bars mean more influence overall.</p>
<div id="cell-fig-global-bar-chart" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a>test_set_sample <span class="op">=</span> df_ttd_test[AutoGluon_TTD_model.feature_names_].sample(<span class="dv">1000</span>, random_state<span class="op">=</span><span class="dv">2025</span>)</span>
<span id="cb27-2"><a href="#cb27-2"></a></span>
<span id="cb27-3"><a href="#cb27-3"></a>shap_values_global <span class="op">=</span> shap_explainer(test_set_sample)</span>
<span id="cb27-4"><a href="#cb27-4"></a></span>
<span id="cb27-5"><a href="#cb27-5"></a>shap.plots.bar(shap_values_global, max_display<span class="op">=</span><span class="dv">10</span>, show<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-global-bar-chart" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-global-bar-chart-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Lab%2003_files/figure-html/fig-global-bar-chart-output-1.png" width="728" height="325" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-global-bar-chart-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: SHAP Feature Importance Bar Plot
</figcaption>
</figure>
</div>
</div>
</div>
<p>Show the bar plot as a data frame.</p>
<div class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># Calculate mean absolute SHAP values</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>mean_abs_shap <span class="op">=</span> np.<span class="bu">abs</span>(shap_values_global.values).mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb28-3"><a href="#cb28-3"></a></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="co"># Create DataFrame</span></span>
<span id="cb28-5"><a href="#cb28-5"></a>df_shap_summary <span class="op">=</span> pd.DataFrame({</span>
<span id="cb28-6"><a href="#cb28-6"></a>    <span class="st">'feature'</span>: test_set_sample.columns,</span>
<span id="cb28-7"><a href="#cb28-7"></a>    <span class="st">'mean_abs_shap_value'</span>: mean_abs_shap</span>
<span id="cb28-8"><a href="#cb28-8"></a>})</span>
<span id="cb28-9"><a href="#cb28-9"></a></span>
<span id="cb28-10"><a href="#cb28-10"></a><span class="co"># Sort by mean absolute SHAP value (descending)</span></span>
<span id="cb28-11"><a href="#cb28-11"></a>df_shap_summary <span class="op">=</span> df_shap_summary.sort_values(<span class="st">'mean_abs_shap_value'</span>, ascending<span class="op">=</span><span class="va">False</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-12"><a href="#cb28-12"></a></span>
<span id="cb28-13"><a href="#cb28-13"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb28-14"><a href="#cb28-14"></a>display(df_shap_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-global-bar-chart" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="23">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-global-bar-chart-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;8: Average Absolute SHAP values
</figcaption>
<div aria-describedby="tbl-global-bar-chart-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">feature</th>
<th data-quarto-table-cell-role="th">mean_abs_shap_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>credit_score</td>
<td>0.131946</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>dti</td>
<td>0.017907</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>loan_amnt</td>
<td>0.008824</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>emp_length</td>
<td>0.004365</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>Beeswarm Plot: Shows each feature’s SHAP value distribution. Each point is one instance. Color indicates the feature’s value (high/low). This reveals not just importance but also the direction of the effect (e.g., high credit_score (red points) have negative SHAP values, decreasing default probability).</p>
<div id="cell-fig-global-beeswarm" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a>shap.plots.beeswarm(shap_values_global, max_display<span class="op">=</span><span class="dv">10</span>, show<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-global-beeswarm" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-global-beeswarm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Lab%2003_files/figure-html/fig-global-beeswarm-output-1.png" width="718" height="300" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-global-beeswarm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: SHAP Summary Plot
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="shap-dependence-plots" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="shap-dependence-plots"><span class="header-section-number">9.2</span> SHAP Dependence Plots</h2>
<p>Explore how a feature’s impact (SHAP value) changes with its value, potentially colored by an interacting feature.</p>
<p>These plots show the relationship between a feature’s value (x-axis) and its SHAP value (y-axis). The vertical spread, often colored by an interacting feature, highlights how the feature’s impact might depend on other factors.</p>
<p>The SHAP dependence plot is an alternative to PDP, ICE, and ALE plots. It provides a more detailed view of how a feature’s value affects the model’s prediction, especially when interactions with other features are present.</p>
<div class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a>features_for_dependence <span class="op">=</span> AutoGluon_TTD_model.feature_names_</span>
<span id="cb30-2"><a href="#cb30-2"></a></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="cf">for</span> feature <span class="kw">in</span> features_for_dependence:</span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="cf">if</span> feature <span class="kw">in</span> test_set_sample.columns: <span class="co"># Use the defined sample DataFrame</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>        <span class="co"># Generate the plot but don't show it immediately</span></span>
<span id="cb30-6"><a href="#cb30-6"></a>        shap.plots.scatter(shap_values_global[:, feature], color<span class="op">=</span>shap_values_global, alpha<span class="op">=</span><span class="fl">0.4</span>, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-7"><a href="#cb30-7"></a>        <span class="co"># Display the current figure explicitly</span></span>
<span id="cb30-8"><a href="#cb30-8"></a>        plt.show()</span>
<span id="cb30-9"><a href="#cb30-9"></a>        <span class="co"># Close the figure to prevent the message</span></span>
<span id="cb30-10"><a href="#cb30-10"></a>        plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-shap-dependence" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="25">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-shap-dependence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display">
<div id="fig-shap-dependence-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-shap-dependence-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Lab%2003_files/figure-html/fig-shap-dependence-output-1.png" data-ref-parent="fig-shap-dependence" width="664" height="435" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-shap-dependence-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) SHAP Dependence Plot
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="fig-shap-dependence-2" class="quarto-float quarto-figure quarto-figure-center anchored" width="642" height="435">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-shap-dependence-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Lab%2003_files/figure-html/fig-shap-dependence-output-2.png" id="fig-shap-dependence-2" data-ref-parent="fig-shap-dependence" width="642" height="435" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-shap-dependence-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="fig-shap-dependence-3" class="quarto-float quarto-figure quarto-figure-center anchored" width="636" height="435">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-shap-dependence-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Lab%2003_files/figure-html/fig-shap-dependence-output-3.png" id="fig-shap-dependence-3" data-ref-parent="fig-shap-dependence" width="636" height="435" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-shap-dependence-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="fig-shap-dependence-4" class="quarto-float quarto-figure quarto-figure-center anchored" width="683" height="441">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-shap-dependence-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Lab%2003_files/figure-html/fig-shap-dependence-output-4.png" id="fig-shap-dependence-4" data-ref-parent="fig-shap-dependence" width="683" height="441" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-shap-dependence-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-shap-dependence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4
</figcaption>
</figure>
</div>
</div>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="an">title:</span><span class="co"> "Lab 03: Counterfactuals &amp; SHAP"</span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="co">    html:</span></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="co">        toc: true</span></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="co">        code-fold: true</span></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="co">        code-tools: true</span></span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="co">        code-line-numbers: true</span></span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="co">        page-layout: full</span></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="an">number-figures:</span><span class="co"> true</span></span>
<span id="cb31-12"><a href="#cb31-12"></a><span class="an">number-tables:</span><span class="co"> true</span></span>
<span id="cb31-13"><a href="#cb31-13"></a><span class="an">execute:</span></span>
<span id="cb31-14"><a href="#cb31-14"></a><span class="co">    warning: false</span></span>
<span id="cb31-15"><a href="#cb31-15"></a><span class="co">    message: false</span></span>
<span id="cb31-16"><a href="#cb31-16"></a><span class="co">---</span></span>
<span id="cb31-17"><a href="#cb31-17"></a></span>
<span id="cb31-18"><a href="#cb31-18"></a><span class="fu"># Introduction</span></span>
<span id="cb31-19"><a href="#cb31-19"></a></span>
<span id="cb31-20"><a href="#cb31-20"></a>The lab will examine two interpretability techniques:</span>
<span id="cb31-21"><a href="#cb31-21"></a></span>
<span id="cb31-22"><a href="#cb31-22"></a><span class="ss">1.  </span>Counterfactual Explanations</span>
<span id="cb31-23"><a href="#cb31-23"></a><span class="ss">2.  </span>SHAP (SHapley Additive exPlanations)</span>
<span id="cb31-24"><a href="#cb31-24"></a></span>
<span id="cb31-25"><a href="#cb31-25"></a>We will use counterfactual explanations to provide actionable feedback to applicants whose applications were rejected by the model. This is a requirement in the US for credit decisions.</span>
<span id="cb31-26"><a href="#cb31-26"></a></span>
<span id="cb31-27"><a href="#cb31-27"></a>We will use SHAP for both local (individual applicant) and global (overall feature importance) model explanations. SHAP values are versatile, offering alternatives to methods like permutation feature importance, partial dependence plots, ICE plots, and ALE plots.</span>
<span id="cb31-28"><a href="#cb31-28"></a></span>
<span id="cb31-31"><a href="#cb31-31"></a><span class="in">```{python}</span></span>
<span id="cb31-32"><a href="#cb31-32"></a><span class="co">#| label: setup-imports</span></span>
<span id="cb31-33"><a href="#cb31-33"></a><span class="co">#| message: false</span></span>
<span id="cb31-34"><a href="#cb31-34"></a></span>
<span id="cb31-35"><a href="#cb31-35"></a><span class="co"># System utilities</span></span>
<span id="cb31-36"><a href="#cb31-36"></a><span class="im">import</span> os</span>
<span id="cb31-37"><a href="#cb31-37"></a><span class="im">import</span> shutil</span>
<span id="cb31-38"><a href="#cb31-38"></a><span class="im">import</span> random</span>
<span id="cb31-39"><a href="#cb31-39"></a><span class="im">import</span> warnings</span>
<span id="cb31-40"><a href="#cb31-40"></a><span class="im">import</span> time</span>
<span id="cb31-41"><a href="#cb31-41"></a><span class="im">import</span> gc</span>
<span id="cb31-42"><a href="#cb31-42"></a><span class="im">import</span> psutil</span>
<span id="cb31-43"><a href="#cb31-43"></a></span>
<span id="cb31-44"><a href="#cb31-44"></a><span class="co"># Data manipulation and visualization</span></span>
<span id="cb31-45"><a href="#cb31-45"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-46"><a href="#cb31-46"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-47"><a href="#cb31-47"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb31-48"><a href="#cb31-48"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb31-49"><a href="#cb31-49"></a><span class="im">from</span> IPython.display <span class="im">import</span> display <span class="co"># Explicit import for display</span></span>
<span id="cb31-50"><a href="#cb31-50"></a><span class="im">from</span> scipy <span class="im">import</span> stats, special</span>
<span id="cb31-51"><a href="#cb31-51"></a><span class="im">from</span> sklearn.feature_selection <span class="im">import</span> mutual_info_classif</span>
<span id="cb31-52"><a href="#cb31-52"></a><span class="im">import</span> re</span>
<span id="cb31-53"><a href="#cb31-53"></a><span class="im">import</span> duckdb</span>
<span id="cb31-54"><a href="#cb31-54"></a></span>
<span id="cb31-55"><a href="#cb31-55"></a><span class="co"># Machine learning - scikit-learn</span></span>
<span id="cb31-56"><a href="#cb31-56"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb31-57"><a href="#cb31-57"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression, LogisticRegressionCV</span>
<span id="cb31-58"><a href="#cb31-58"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_auc_score, f1_score, confusion_matrix, classification_report</span>
<span id="cb31-59"><a href="#cb31-59"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder, StandardScaler, OneHotEncoder</span>
<span id="cb31-60"><a href="#cb31-60"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb31-61"><a href="#cb31-61"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb31-62"><a href="#cb31-62"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb31-63"><a href="#cb31-63"></a><span class="im">from</span> sklearn.inspection <span class="im">import</span> PartialDependenceDisplay</span>
<span id="cb31-64"><a href="#cb31-64"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, ClassifierMixin</span>
<span id="cb31-65"><a href="#cb31-65"></a><span class="im">from</span> sklearn.utils.validation <span class="im">import</span> check_is_fitted, check_X_y, check_array</span>
<span id="cb31-66"><a href="#cb31-66"></a><span class="im">from</span> sklearn <span class="im">import</span> set_config</span>
<span id="cb31-67"><a href="#cb31-67"></a><span class="im">import</span> torch</span>
<span id="cb31-68"><a href="#cb31-68"></a></span>
<span id="cb31-69"><a href="#cb31-69"></a><span class="co"># Specialized ML libraries</span></span>
<span id="cb31-70"><a href="#cb31-70"></a><span class="im">from</span> autogluon.tabular <span class="im">import</span> TabularPredictor, TabularDataset</span>
<span id="cb31-71"><a href="#cb31-71"></a><span class="im">from</span> autogluon.common.features.feature_metadata <span class="im">import</span> FeatureMetadata <span class="co"># For monotonic constraints</span></span>
<span id="cb31-72"><a href="#cb31-72"></a><span class="im">import</span> shap</span>
<span id="cb31-73"><a href="#cb31-73"></a><span class="im">from</span> ydata_profiling <span class="im">import</span> ProfileReport</span>
<span id="cb31-74"><a href="#cb31-74"></a></span>
<span id="cb31-75"><a href="#cb31-75"></a><span class="co"># Counterfactual Explanations (optional, install if needed: pip install dice-ml)</span></span>
<span id="cb31-76"><a href="#cb31-76"></a><span class="cf">try</span>:</span>
<span id="cb31-77"><a href="#cb31-77"></a>    <span class="im">import</span> dice_ml</span>
<span id="cb31-78"><a href="#cb31-78"></a>    <span class="im">from</span> dice_ml.utils <span class="im">import</span> helpers <span class="co"># Helper functions for DICE</span></span>
<span id="cb31-79"><a href="#cb31-79"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb31-80"><a href="#cb31-80"></a>    <span class="bu">print</span>(<span class="st">"""</span></span>
<span id="cb31-81"><a href="#cb31-81"></a><span class="st">    </span></span>
<span id="cb31-82"><a href="#cb31-82"></a><span class="st">    dice-ml not found. You need to update your conda env by running:</span></span>
<span id="cb31-83"><a href="#cb31-83"></a><span class="st">    </span></span>
<span id="cb31-84"><a href="#cb31-84"></a><span class="st">    conda activate env_AutoGluon_202502</span></span>
<span id="cb31-85"><a href="#cb31-85"></a><span class="st">    conda install -c conda-forge dice-ml</span></span>
<span id="cb31-86"><a href="#cb31-86"></a><span class="st">    </span></span>
<span id="cb31-87"><a href="#cb31-87"></a><span class="st">    """</span>)</span>
<span id="cb31-88"><a href="#cb31-88"></a>    dice_ml <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-89"><a href="#cb31-89"></a></span>
<span id="cb31-90"><a href="#cb31-90"></a><span class="co"># Settings</span></span>
<span id="cb31-91"><a href="#cb31-91"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="dv">50</span>)</span>
<span id="cb31-92"><a href="#cb31-92"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">100</span>)</span>
<span id="cb31-93"><a href="#cb31-93"></a>warnings.filterwarnings(<span class="st">'ignore'</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>) <span class="co"># Suppress specific FutureWarnings</span></span>
<span id="cb31-94"><a href="#cb31-94"></a>set_config(transform_output<span class="op">=</span><span class="st">"pandas"</span>) <span class="co"># Set sklearn output to pandas</span></span>
<span id="cb31-95"><a href="#cb31-95"></a></span>
<span id="cb31-96"><a href="#cb31-96"></a><span class="kw">def</span> global_set_seed(seed_value<span class="op">=</span><span class="dv">2025</span>):</span>
<span id="cb31-97"><a href="#cb31-97"></a>    random.seed(seed_value)</span>
<span id="cb31-98"><a href="#cb31-98"></a>    np.random.seed(seed_value)</span>
<span id="cb31-99"><a href="#cb31-99"></a>    torch.manual_seed(seed_value)</span>
<span id="cb31-100"><a href="#cb31-100"></a></span>
<span id="cb31-101"><a href="#cb31-101"></a>global_set_seed(<span class="dv">2025</span>)</span>
<span id="cb31-102"><a href="#cb31-102"></a></span>
<span id="cb31-103"><a href="#cb31-103"></a><span class="bu">print</span>(<span class="st">"Libraries imported successfully."</span>)</span>
<span id="cb31-104"><a href="#cb31-104"></a></span>
<span id="cb31-105"><a href="#cb31-105"></a></span>
<span id="cb31-106"><a href="#cb31-106"></a></span>
<span id="cb31-107"><a href="#cb31-107"></a><span class="in">```</span></span>
<span id="cb31-108"><a href="#cb31-108"></a></span>
<span id="cb31-111"><a href="#cb31-111"></a><span class="in">```{python}</span></span>
<span id="cb31-112"><a href="#cb31-112"></a><span class="co">#| label: helper-functions</span></span>
<span id="cb31-113"><a href="#cb31-113"></a></span>
<span id="cb31-114"><a href="#cb31-114"></a><span class="kw">class</span> AutoGluonSklearnWrapper(BaseEstimator, ClassifierMixin):</span>
<span id="cb31-115"><a href="#cb31-115"></a>    <span class="co">"""</span></span>
<span id="cb31-116"><a href="#cb31-116"></a><span class="co">    Scikit-learn compatible wrapper for AutoGluon TabularPredictor</span></span>
<span id="cb31-117"><a href="#cb31-117"></a><span class="co">    </span></span>
<span id="cb31-118"><a href="#cb31-118"></a><span class="co">    Inherits from scikit-learn's BaseEstimator and ClassifierMixin to provide</span></span>
<span id="cb31-119"><a href="#cb31-119"></a><span class="co">    full compatibility with scikit-learn tools like PartialDependenceDisplay().</span></span>
<span id="cb31-120"><a href="#cb31-120"></a><span class="co">    </span></span>
<span id="cb31-121"><a href="#cb31-121"></a><span class="co">    Parameters</span></span>
<span id="cb31-122"><a href="#cb31-122"></a><span class="co">    ----------</span></span>
<span id="cb31-123"><a href="#cb31-123"></a><span class="co">    label : str</span></span>
<span id="cb31-124"><a href="#cb31-124"></a><span class="co">        Name of the target column</span></span>
<span id="cb31-125"><a href="#cb31-125"></a></span>
<span id="cb31-126"><a href="#cb31-126"></a><span class="co">    **predictor_args : dict</span></span>
<span id="cb31-127"><a href="#cb31-127"></a><span class="co">        Additional arguments passed to TabularPredictor()</span></span>
<span id="cb31-128"><a href="#cb31-128"></a><span class="co">        (e.g., problem_type, eval_metric, path)</span></span>
<span id="cb31-129"><a href="#cb31-129"></a></span>
<span id="cb31-130"><a href="#cb31-130"></a><span class="co">    **fit_args : dict</span></span>
<span id="cb31-131"><a href="#cb31-131"></a><span class="co">        Additional arguments passed to TabularPredictor.fit() method</span></span>
<span id="cb31-132"><a href="#cb31-132"></a><span class="co">        (e.g., holdout_frac, presets, time_limit, excluded_model_types)</span></span>
<span id="cb31-133"><a href="#cb31-133"></a></span>
<span id="cb31-134"><a href="#cb31-134"></a></span>
<span id="cb31-135"><a href="#cb31-135"></a><span class="co">    Attributes</span></span>
<span id="cb31-136"><a href="#cb31-136"></a><span class="co">    ----------</span></span>
<span id="cb31-137"><a href="#cb31-137"></a><span class="co">    predictor : TabularPredictor</span></span>
<span id="cb31-138"><a href="#cb31-138"></a><span class="co">        The trained AutoGluon predictor</span></span>
<span id="cb31-139"><a href="#cb31-139"></a></span>
<span id="cb31-140"><a href="#cb31-140"></a><span class="co">    classes_ : ndarray</span></span>
<span id="cb31-141"><a href="#cb31-141"></a><span class="co">        Class labels (for classification tasks)</span></span>
<span id="cb31-142"><a href="#cb31-142"></a></span>
<span id="cb31-143"><a href="#cb31-143"></a><span class="co">    n_features_in_ : int</span></span>
<span id="cb31-144"><a href="#cb31-144"></a><span class="co">        Number of features seen during fit</span></span>
<span id="cb31-145"><a href="#cb31-145"></a></span>
<span id="cb31-146"><a href="#cb31-146"></a><span class="co">    feature_names_ : list</span></span>
<span id="cb31-147"><a href="#cb31-147"></a><span class="co">        Feature names inferred during fitting</span></span>
<span id="cb31-148"><a href="#cb31-148"></a></span>
<span id="cb31-149"><a href="#cb31-149"></a><span class="co">    is_fitted_ : bool</span></span>
<span id="cb31-150"><a href="#cb31-150"></a><span class="co">        Whether the estimator has been fitted</span></span>
<span id="cb31-151"><a href="#cb31-151"></a><span class="co">    """</span></span>
<span id="cb31-152"><a href="#cb31-152"></a>    </span>
<span id="cb31-153"><a href="#cb31-153"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, label, predictor_args<span class="op">=</span><span class="va">None</span>, fit_args<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb31-154"><a href="#cb31-154"></a>        <span class="va">self</span>.label <span class="op">=</span> label</span>
<span id="cb31-155"><a href="#cb31-155"></a>        <span class="va">self</span>.predictor_args <span class="op">=</span> predictor_args <span class="cf">if</span> predictor_args <span class="cf">else</span> {}</span>
<span id="cb31-156"><a href="#cb31-156"></a>        <span class="va">self</span>.fit_args <span class="op">=</span> fit_args <span class="cf">if</span> fit_args <span class="cf">else</span> {}</span>
<span id="cb31-157"><a href="#cb31-157"></a>        <span class="va">self</span>.predictor <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-158"><a href="#cb31-158"></a>        <span class="va">self</span>.classes_ <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-159"><a href="#cb31-159"></a>        <span class="va">self</span>.n_features_in_ <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-160"><a href="#cb31-160"></a>        <span class="va">self</span>.feature_names_ <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-161"><a href="#cb31-161"></a>        <span class="va">self</span>.is_fitted_ <span class="op">=</span> <span class="va">False</span></span>
<span id="cb31-162"><a href="#cb31-162"></a></span>
<span id="cb31-163"><a href="#cb31-163"></a>    <span class="kw">def</span> __sklearn_is_fitted__(<span class="va">self</span>):</span>
<span id="cb31-164"><a href="#cb31-164"></a>        <span class="co">"""Official scikit-learn API for checking fitted status"""</span></span>
<span id="cb31-165"><a href="#cb31-165"></a>        <span class="cf">return</span> <span class="va">self</span>.is_fitted_</span>
<span id="cb31-166"><a href="#cb31-166"></a></span>
<span id="cb31-167"><a href="#cb31-167"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y, sample_weight<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb31-168"><a href="#cb31-168"></a>        <span class="co">"""</span></span>
<span id="cb31-169"><a href="#cb31-169"></a><span class="co">        Fit AutoGluon model using scikit-learn interface.</span></span>
<span id="cb31-170"><a href="#cb31-170"></a><span class="co">        If sample_weight is provided, it is added as a column to X for AutoGluon.</span></span>
<span id="cb31-171"><a href="#cb31-171"></a><span class="co">        """</span></span>
<span id="cb31-172"><a href="#cb31-172"></a>        <span class="va">self</span>._check_feature_names(X, reset<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-173"><a href="#cb31-173"></a>        <span class="va">self</span>._check_n_features(X, reset<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-174"><a href="#cb31-174"></a></span>
<span id="cb31-175"><a href="#cb31-175"></a>        <span class="co"># Convert to DataFrame with preserved feature names</span></span>
<span id="cb31-176"><a href="#cb31-176"></a>        train_data <span class="op">=</span> pd.DataFrame(X, columns<span class="op">=</span><span class="va">self</span>.feature_names_)</span>
<span id="cb31-177"><a href="#cb31-177"></a>        train_data[<span class="va">self</span>.label] <span class="op">=</span> y</span>
<span id="cb31-178"><a href="#cb31-178"></a></span>
<span id="cb31-179"><a href="#cb31-179"></a>        <span class="co"># If sample_weight is provided, add it as a column (name must match predictor_args['sample_weight'])</span></span>
<span id="cb31-180"><a href="#cb31-180"></a>        weight_col_name <span class="op">=</span> <span class="va">self</span>.predictor_args.get(<span class="st">'sample_weight'</span>, <span class="va">None</span>)</span>
<span id="cb31-181"><a href="#cb31-181"></a>        <span class="cf">if</span> sample_weight <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb31-182"><a href="#cb31-182"></a>            <span class="cf">if</span> weight_col_name:</span>
<span id="cb31-183"><a href="#cb31-183"></a>                train_data[weight_col_name] <span class="op">=</span> sample_weight</span>
<span id="cb31-184"><a href="#cb31-184"></a>            <span class="cf">else</span>:</span>
<span id="cb31-185"><a href="#cb31-185"></a>                <span class="bu">print</span>(<span class="st">"Warning: sample_weight provided to fit, but 'sample_weight' key not found in predictor_args. Weights will be ignored by AutoGluon."</span>)</span>
<span id="cb31-186"><a href="#cb31-186"></a></span>
<span id="cb31-187"><a href="#cb31-187"></a>        train_data <span class="op">=</span> TabularDataset(train_data)</span>
<span id="cb31-188"><a href="#cb31-188"></a></span>
<span id="cb31-189"><a href="#cb31-189"></a>        <span class="co"># Remove sample_weight from fit_args if present (TabularPredictor.fit does not accept it)</span></span>
<span id="cb31-190"><a href="#cb31-190"></a>        fit_args_clean <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="va">self</span>.fit_args.items() <span class="cf">if</span> k <span class="op">!=</span> <span class="st">'sample_weight'</span>}</span>
<span id="cb31-191"><a href="#cb31-191"></a></span>
<span id="cb31-192"><a href="#cb31-192"></a>        <span class="va">self</span>.predictor <span class="op">=</span> TabularPredictor(</span>
<span id="cb31-193"><a href="#cb31-193"></a>            label<span class="op">=</span><span class="va">self</span>.label,</span>
<span id="cb31-194"><a href="#cb31-194"></a>            <span class="op">**</span><span class="va">self</span>.predictor_args</span>
<span id="cb31-195"><a href="#cb31-195"></a>        ).fit(train_data, <span class="op">**</span>fit_args_clean)</span>
<span id="cb31-196"><a href="#cb31-196"></a></span>
<span id="cb31-197"><a href="#cb31-197"></a>        <span class="cf">if</span> <span class="va">self</span>.predictor.problem_type <span class="kw">in</span> [<span class="st">'binary'</span>, <span class="st">'multiclass'</span>]:</span>
<span id="cb31-198"><a href="#cb31-198"></a>            <span class="va">self</span>.classes_ <span class="op">=</span> np.array(<span class="va">self</span>.predictor.class_labels)</span>
<span id="cb31-199"><a href="#cb31-199"></a></span>
<span id="cb31-200"><a href="#cb31-200"></a>        <span class="va">self</span>.is_fitted_ <span class="op">=</span> <span class="va">True</span></span>
<span id="cb31-201"><a href="#cb31-201"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb31-202"><a href="#cb31-202"></a></span>
<span id="cb31-203"><a href="#cb31-203"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, X):</span>
<span id="cb31-204"><a href="#cb31-204"></a>        <span class="co">"""</span></span>
<span id="cb31-205"><a href="#cb31-205"></a><span class="co">        Make class predictions</span></span>
<span id="cb31-206"><a href="#cb31-206"></a><span class="co">        </span></span>
<span id="cb31-207"><a href="#cb31-207"></a><span class="co">        Parameters</span></span>
<span id="cb31-208"><a href="#cb31-208"></a><span class="co">        ----------</span></span>
<span id="cb31-209"><a href="#cb31-209"></a><span class="co">        X : {array-like, sparse matrix} of shape (n_samples, n_features)</span></span>
<span id="cb31-210"><a href="#cb31-210"></a><span class="co">            Input data</span></span>
<span id="cb31-211"><a href="#cb31-211"></a><span class="co">            </span></span>
<span id="cb31-212"><a href="#cb31-212"></a><span class="co">        Returns</span></span>
<span id="cb31-213"><a href="#cb31-213"></a><span class="co">        -------</span></span>
<span id="cb31-214"><a href="#cb31-214"></a><span class="co">        y_pred : ndarray of shape (n_samples,)</span></span>
<span id="cb31-215"><a href="#cb31-215"></a><span class="co">            Predicted class labels</span></span>
<span id="cb31-216"><a href="#cb31-216"></a><span class="co">        """</span></span>
<span id="cb31-217"><a href="#cb31-217"></a>        check_is_fitted(<span class="va">self</span>)</span>
<span id="cb31-218"><a href="#cb31-218"></a>        <span class="va">self</span>._check_feature_names(X)</span>
<span id="cb31-219"><a href="#cb31-219"></a>        <span class="va">self</span>._check_n_features(X)</span>
<span id="cb31-220"><a href="#cb31-220"></a></span>
<span id="cb31-221"><a href="#cb31-221"></a>        df <span class="op">=</span> pd.DataFrame(X, columns<span class="op">=</span><span class="va">self</span>.feature_names_)</span>
<span id="cb31-222"><a href="#cb31-222"></a>        df <span class="op">=</span> TabularDataset(df)</span>
<span id="cb31-223"><a href="#cb31-223"></a></span>
<span id="cb31-224"><a href="#cb31-224"></a>        <span class="cf">return</span> <span class="va">self</span>.predictor.predict(df).values</span>
<span id="cb31-225"><a href="#cb31-225"></a></span>
<span id="cb31-226"><a href="#cb31-226"></a>    <span class="kw">def</span> predict_proba(<span class="va">self</span>, X):</span>
<span id="cb31-227"><a href="#cb31-227"></a>        <span class="co">"""</span></span>
<span id="cb31-228"><a href="#cb31-228"></a><span class="co">        Predict class probabilities</span></span>
<span id="cb31-229"><a href="#cb31-229"></a><span class="co">        </span></span>
<span id="cb31-230"><a href="#cb31-230"></a><span class="co">        Parameters</span></span>
<span id="cb31-231"><a href="#cb31-231"></a><span class="co">        ----------</span></span>
<span id="cb31-232"><a href="#cb31-232"></a><span class="co">        X : {array-like, sparse matrix} of shape (n_samples, n_features)</span></span>
<span id="cb31-233"><a href="#cb31-233"></a><span class="co">            Input data</span></span>
<span id="cb31-234"><a href="#cb31-234"></a><span class="co">            </span></span>
<span id="cb31-235"><a href="#cb31-235"></a><span class="co">        Returns</span></span>
<span id="cb31-236"><a href="#cb31-236"></a><span class="co">        -------</span></span>
<span id="cb31-237"><a href="#cb31-237"></a><span class="co">        proba : ndarray of shape (n_samples, n_classes)</span></span>
<span id="cb31-238"><a href="#cb31-238"></a><span class="co">            Class probabilities</span></span>
<span id="cb31-239"><a href="#cb31-239"></a><span class="co">        """</span></span>
<span id="cb31-240"><a href="#cb31-240"></a>        check_is_fitted(<span class="va">self</span>)</span>
<span id="cb31-241"><a href="#cb31-241"></a>        <span class="va">self</span>._check_feature_names(X)</span>
<span id="cb31-242"><a href="#cb31-242"></a>        <span class="va">self</span>._check_n_features(X)</span>
<span id="cb31-243"><a href="#cb31-243"></a></span>
<span id="cb31-244"><a href="#cb31-244"></a>        df <span class="op">=</span> pd.DataFrame(X, columns<span class="op">=</span><span class="va">self</span>.feature_names_)</span>
<span id="cb31-245"><a href="#cb31-245"></a>        df <span class="op">=</span> TabularDataset(df)</span>
<span id="cb31-246"><a href="#cb31-246"></a></span>
<span id="cb31-247"><a href="#cb31-247"></a>        <span class="cf">return</span> <span class="va">self</span>.predictor.predict_proba(df).values</span>
<span id="cb31-248"><a href="#cb31-248"></a></span>
<span id="cb31-249"><a href="#cb31-249"></a>    <span class="kw">def</span> get_params(<span class="va">self</span>, deep<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb31-250"><a href="#cb31-250"></a>        <span class="co">"""Get parameters for this estimator"""</span></span>
<span id="cb31-251"><a href="#cb31-251"></a>        <span class="cf">return</span> {</span>
<span id="cb31-252"><a href="#cb31-252"></a>            <span class="st">'label'</span>: <span class="va">self</span>.label,</span>
<span id="cb31-253"><a href="#cb31-253"></a>            <span class="st">'predictor_args'</span>: <span class="va">self</span>.predictor_args,</span>
<span id="cb31-254"><a href="#cb31-254"></a>            <span class="st">'fit_args'</span>: <span class="va">self</span>.fit_args</span>
<span id="cb31-255"><a href="#cb31-255"></a>        }</span>
<span id="cb31-256"><a href="#cb31-256"></a></span>
<span id="cb31-257"><a href="#cb31-257"></a>    <span class="kw">def</span> set_params(<span class="va">self</span>, <span class="op">**</span>params):</span>
<span id="cb31-258"><a href="#cb31-258"></a>        <span class="co">"""Set parameters for this estimator"""</span></span>
<span id="cb31-259"><a href="#cb31-259"></a>        <span class="cf">for</span> param, value <span class="kw">in</span> params.items():</span>
<span id="cb31-260"><a href="#cb31-260"></a>            <span class="cf">if</span> param <span class="op">==</span> <span class="st">'label'</span>:</span>
<span id="cb31-261"><a href="#cb31-261"></a>                <span class="va">self</span>.label <span class="op">=</span> value</span>
<span id="cb31-262"><a href="#cb31-262"></a>            <span class="cf">else</span>:</span>
<span id="cb31-263"><a href="#cb31-263"></a>                <span class="va">self</span>.predictor_args[param] <span class="op">=</span> value</span>
<span id="cb31-264"><a href="#cb31-264"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb31-265"><a href="#cb31-265"></a></span>
<span id="cb31-266"><a href="#cb31-266"></a>    <span class="kw">def</span> _check_n_features(<span class="va">self</span>, X, reset<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb31-267"><a href="#cb31-267"></a>        <span class="co">"""Validate number of features"""</span></span>
<span id="cb31-268"><a href="#cb31-268"></a>        n_features <span class="op">=</span> X.shape[<span class="dv">1</span>]</span>
<span id="cb31-269"><a href="#cb31-269"></a>        <span class="cf">if</span> reset:</span>
<span id="cb31-270"><a href="#cb31-270"></a>            <span class="va">self</span>.n_features_in_ <span class="op">=</span> n_features</span>
<span id="cb31-271"><a href="#cb31-271"></a>        <span class="cf">elif</span> n_features <span class="op">!=</span> <span class="va">self</span>.n_features_in_:</span>
<span id="cb31-272"><a href="#cb31-272"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Expected </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>n_features_in_<span class="sc">}</span><span class="ss"> features, got </span><span class="sc">{</span>n_features<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-273"><a href="#cb31-273"></a></span>
<span id="cb31-274"><a href="#cb31-274"></a>    <span class="kw">def</span> _check_feature_names(<span class="va">self</span>, X, reset<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb31-275"><a href="#cb31-275"></a>        <span class="co">"""Validate feature names (AutoGluon requirement)"""</span></span>
<span id="cb31-276"><a href="#cb31-276"></a>        <span class="cf">if</span> reset:</span>
<span id="cb31-277"><a href="#cb31-277"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(X, np.ndarray):</span>
<span id="cb31-278"><a href="#cb31-278"></a>                <span class="va">self</span>.feature_names_ <span class="op">=</span> [<span class="ss">f'feat_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(X.shape[<span class="dv">1</span>])]</span>
<span id="cb31-279"><a href="#cb31-279"></a>            <span class="cf">else</span>:</span>
<span id="cb31-280"><a href="#cb31-280"></a>                <span class="va">self</span>.feature_names_ <span class="op">=</span> X.columns.tolist()</span>
<span id="cb31-281"><a href="#cb31-281"></a>        <span class="cf">elif</span> <span class="bu">hasattr</span>(X, <span class="st">'columns'</span>):</span>
<span id="cb31-282"><a href="#cb31-282"></a>            <span class="cf">if</span> <span class="bu">list</span>(X.columns) <span class="op">!=</span> <span class="va">self</span>.feature_names_:</span>
<span id="cb31-283"><a href="#cb31-283"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Feature names mismatch between fit and predict"</span>)</span>
<span id="cb31-284"><a href="#cb31-284"></a></span>
<span id="cb31-285"><a href="#cb31-285"></a><span class="kw">def</span> load_autogluon(folder_path: <span class="bu">str</span>, persist_model: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>) <span class="op">-&gt;</span> AutoGluonSklearnWrapper:</span>
<span id="cb31-286"><a href="#cb31-286"></a>    <span class="co">"""</span></span>
<span id="cb31-287"><a href="#cb31-287"></a><span class="co">    Loads a pre-trained AutoGluon TabularPredictor from a specified path</span></span>
<span id="cb31-288"><a href="#cb31-288"></a><span class="co">    into an AutoGluonSklearnWrapper instance.</span></span>
<span id="cb31-289"><a href="#cb31-289"></a></span>
<span id="cb31-290"><a href="#cb31-290"></a><span class="co">    Parameters</span></span>
<span id="cb31-291"><a href="#cb31-291"></a><span class="co">    ----------</span></span>
<span id="cb31-292"><a href="#cb31-292"></a><span class="co">    folder_path : str</span></span>
<span id="cb31-293"><a href="#cb31-293"></a><span class="co">        The path to the directory containing the saved AutoGluon predictor.</span></span>
<span id="cb31-294"><a href="#cb31-294"></a><span class="co">    persist_model : bool, default=False</span></span>
<span id="cb31-295"><a href="#cb31-295"></a><span class="co">        If True, calls predictor.persist() after loading to potentially</span></span>
<span id="cb31-296"><a href="#cb31-296"></a><span class="co">        speed up future predictions by loading models into memory.</span></span>
<span id="cb31-297"><a href="#cb31-297"></a></span>
<span id="cb31-298"><a href="#cb31-298"></a><span class="co">    Returns</span></span>
<span id="cb31-299"><a href="#cb31-299"></a><span class="co">    -------</span></span>
<span id="cb31-300"><a href="#cb31-300"></a><span class="co">    AutoGluonSklearnWrapper</span></span>
<span id="cb31-301"><a href="#cb31-301"></a><span class="co">        An instance of the wrapper containing the loaded predictor and its metadata.</span></span>
<span id="cb31-302"><a href="#cb31-302"></a></span>
<span id="cb31-303"><a href="#cb31-303"></a><span class="co">    Raises</span></span>
<span id="cb31-304"><a href="#cb31-304"></a><span class="co">    ------</span></span>
<span id="cb31-305"><a href="#cb31-305"></a><span class="co">    FileNotFoundError</span></span>
<span id="cb31-306"><a href="#cb31-306"></a><span class="co">        If the specified folder_path does not exist or doesn't contain a valid predictor.</span></span>
<span id="cb31-307"><a href="#cb31-307"></a><span class="co">    Exception</span></span>
<span id="cb31-308"><a href="#cb31-308"></a><span class="co">        If any other error occurs during loading or processing.</span></span>
<span id="cb31-309"><a href="#cb31-309"></a><span class="co">    """</span></span>
<span id="cb31-310"><a href="#cb31-310"></a>    <span class="cf">try</span>:</span>
<span id="cb31-311"><a href="#cb31-311"></a>        <span class="bu">print</span>(<span class="ss">f"Loading AutoGluon predictor from: </span><span class="sc">{</span>folder_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-312"><a href="#cb31-312"></a>        predictor <span class="op">=</span> TabularPredictor.load(folder_path)</span>
<span id="cb31-313"><a href="#cb31-313"></a>        <span class="bu">print</span>(<span class="st">"Predictor loaded successfully."</span>)</span>
<span id="cb31-314"><a href="#cb31-314"></a></span>
<span id="cb31-315"><a href="#cb31-315"></a>        <span class="co"># Extract metadata from the loaded predictor</span></span>
<span id="cb31-316"><a href="#cb31-316"></a>        label <span class="op">=</span> predictor.label</span>
<span id="cb31-317"><a href="#cb31-317"></a>        feature_names <span class="op">=</span> predictor.feature_metadata_in.get_features() <span class="co"># Get feature names used during training</span></span>
<span id="cb31-318"><a href="#cb31-318"></a>        n_features <span class="op">=</span> <span class="bu">len</span>(feature_names)</span>
<span id="cb31-319"><a href="#cb31-319"></a>        classes <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-320"><a href="#cb31-320"></a>        <span class="cf">if</span> predictor.problem_type <span class="kw">in</span> [<span class="st">'binary'</span>, <span class="st">'multiclass'</span>]:</span>
<span id="cb31-321"><a href="#cb31-321"></a>            classes <span class="op">=</span> np.array(predictor.class_labels)</span>
<span id="cb31-322"><a href="#cb31-322"></a></span>
<span id="cb31-323"><a href="#cb31-323"></a>        <span class="co"># Instantiate the wrapper</span></span>
<span id="cb31-324"><a href="#cb31-324"></a>        <span class="co"># Note: predictor_args and fit_args used during original training aren't easily accessible</span></span>
<span id="cb31-325"><a href="#cb31-325"></a>        <span class="co"># We initialize them as empty dicts here.</span></span>
<span id="cb31-326"><a href="#cb31-326"></a>        wrapper <span class="op">=</span> AutoGluonSklearnWrapper(label<span class="op">=</span>label, predictor_args<span class="op">=</span>{}, fit_args<span class="op">=</span>{})</span>
<span id="cb31-327"><a href="#cb31-327"></a></span>
<span id="cb31-328"><a href="#cb31-328"></a>        <span class="co"># Assign the loaded predictor and metadata to the wrapper</span></span>
<span id="cb31-329"><a href="#cb31-329"></a>        wrapper.predictor <span class="op">=</span> predictor</span>
<span id="cb31-330"><a href="#cb31-330"></a>        wrapper.classes_ <span class="op">=</span> classes</span>
<span id="cb31-331"><a href="#cb31-331"></a>        wrapper.n_features_in_ <span class="op">=</span> n_features</span>
<span id="cb31-332"><a href="#cb31-332"></a>        wrapper.feature_names_ <span class="op">=</span> feature_names</span>
<span id="cb31-333"><a href="#cb31-333"></a>        wrapper.is_fitted_ <span class="op">=</span> <span class="va">True</span> <span class="co"># Mark as fitted</span></span>
<span id="cb31-334"><a href="#cb31-334"></a></span>
<span id="cb31-335"><a href="#cb31-335"></a>        <span class="co"># Optionally persist the model</span></span>
<span id="cb31-336"><a href="#cb31-336"></a>        <span class="cf">if</span> persist_model:</span>
<span id="cb31-337"><a href="#cb31-337"></a>            <span class="bu">print</span>(<span class="st">"Persisting predictor models in memory..."</span>)</span>
<span id="cb31-338"><a href="#cb31-338"></a>            <span class="co"># This loads models into memory for faster predictions, requires sufficient RAM</span></span>
<span id="cb31-339"><a href="#cb31-339"></a>            wrapper.predictor.persist()</span>
<span id="cb31-340"><a href="#cb31-340"></a>            <span class="bu">print</span>(<span class="st">"Predictor models persisted."</span>)</span>
<span id="cb31-341"><a href="#cb31-341"></a></span>
<span id="cb31-342"><a href="#cb31-342"></a>        <span class="bu">print</span>(<span class="st">"AutoGluonSklearnWrapper created and populated successfully."</span>)</span>
<span id="cb31-343"><a href="#cb31-343"></a>        <span class="cf">return</span> wrapper</span>
<span id="cb31-344"><a href="#cb31-344"></a></span>
<span id="cb31-345"><a href="#cb31-345"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb31-346"><a href="#cb31-346"></a>        <span class="bu">print</span>(<span class="ss">f"Error: Predictor directory not found at </span><span class="sc">{</span>folder_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-347"><a href="#cb31-347"></a>        <span class="cf">raise</span></span>
<span id="cb31-348"><a href="#cb31-348"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb31-349"><a href="#cb31-349"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred while loading the predictor or creating the wrapper: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-350"><a href="#cb31-350"></a>        <span class="im">import</span> traceback</span>
<span id="cb31-351"><a href="#cb31-351"></a>        traceback.print_exc()</span>
<span id="cb31-352"><a href="#cb31-352"></a>        <span class="cf">raise</span></span>
<span id="cb31-353"><a href="#cb31-353"></a></span>
<span id="cb31-354"><a href="#cb31-354"></a></span>
<span id="cb31-355"><a href="#cb31-355"></a><span class="in">```</span></span>
<span id="cb31-356"><a href="#cb31-356"></a></span>
<span id="cb31-357"><a href="#cb31-357"></a><span class="fu"># Load Data and Pre-trained Model</span></span>
<span id="cb31-358"><a href="#cb31-358"></a></span>
<span id="cb31-361"><a href="#cb31-361"></a><span class="in">```{python}</span></span>
<span id="cb31-362"><a href="#cb31-362"></a><span class="co">#| label: load-data</span></span>
<span id="cb31-363"><a href="#cb31-363"></a></span>
<span id="cb31-364"><a href="#cb31-364"></a>df_ttd_train <span class="op">=</span> pd.read_parquet(<span class="st">"../Data/lendingclub/lendingclub_ttd_train.parquet"</span>)</span>
<span id="cb31-365"><a href="#cb31-365"></a>df_ttd_test <span class="op">=</span> pd.read_parquet(<span class="st">"../Data/lendingclub/lendingclub_ttd_test_cloning.parquet"</span>)</span>
<span id="cb31-366"><a href="#cb31-366"></a>df_ttd_test_noCloning <span class="op">=</span> pd.read_parquet(<span class="st">"../Data/lendingclub/lendingclub_ttd_test_noCloning.parquet"</span>)</span>
<span id="cb31-367"><a href="#cb31-367"></a></span>
<span id="cb31-368"><a href="#cb31-368"></a><span class="in">```</span></span>
<span id="cb31-369"><a href="#cb31-369"></a></span>
<span id="cb31-372"><a href="#cb31-372"></a><span class="in">```{python}</span></span>
<span id="cb31-373"><a href="#cb31-373"></a><span class="co">#| label: load-model</span></span>
<span id="cb31-374"><a href="#cb31-374"></a></span>
<span id="cb31-375"><a href="#cb31-375"></a>model_path <span class="op">=</span> <span class="st">"Lab02_ag_models_TTD_Constrained"</span></span>
<span id="cb31-376"><a href="#cb31-376"></a></span>
<span id="cb31-377"><a href="#cb31-377"></a>AutoGluon_TTD_model <span class="op">=</span> load_autogluon(</span>
<span id="cb31-378"><a href="#cb31-378"></a>    folder_path<span class="op">=</span>model_path,</span>
<span id="cb31-379"><a href="#cb31-379"></a>    persist_model<span class="op">=</span><span class="va">True</span></span>
<span id="cb31-380"><a href="#cb31-380"></a>)</span>
<span id="cb31-381"><a href="#cb31-381"></a><span class="in">```</span></span>
<span id="cb31-382"><a href="#cb31-382"></a></span>
<span id="cb31-383"><a href="#cb31-383"></a><span class="fu"># Counterfactual Explanations</span></span>
<span id="cb31-384"><a href="#cb31-384"></a></span>
<span id="cb31-385"><a href="#cb31-385"></a><span class="fu">## Overview</span></span>
<span id="cb31-386"><a href="#cb31-386"></a></span>
<span id="cb31-387"><a href="#cb31-387"></a>**Concept:** Counterfactual explanations identify the minimal changes needed to alter a predicted label. For example, if an applicant is rejected, a counterfactual explanation would suggest how their features could be adjusted to achieve approval.</span>
<span id="cb31-388"><a href="#cb31-388"></a></span>
<span id="cb31-389"><a href="#cb31-389"></a>First, we need to score the training and test sets to identify the applicants that were accepted and rejected by the model. Note that this is different than the default flag, which is the target variable. The model decision is based on the **predicted** probability of default (PD) and a threshold.</span>
<span id="cb31-390"><a href="#cb31-390"></a></span>
<span id="cb31-391"><a href="#cb31-391"></a>Also keep in mind that <span class="in">`model_rejection = 1`</span> means the applicant was rejected by the model, while <span class="in">`model_rejection = 0`</span> means the applicant was accepted.</span>
<span id="cb31-392"><a href="#cb31-392"></a></span>
<span id="cb31-393"><a href="#cb31-393"></a>Crucially, <span class="in">`model_rejection`</span> represents the model's lending decision, which may not match the actual <span class="in">`default_flag`</span>.</span>
<span id="cb31-394"><a href="#cb31-394"></a></span>
<span id="cb31-397"><a href="#cb31-397"></a><span class="in">```{python}</span></span>
<span id="cb31-398"><a href="#cb31-398"></a><span class="co">#| label: score-data</span></span>
<span id="cb31-399"><a href="#cb31-399"></a></span>
<span id="cb31-400"><a href="#cb31-400"></a><span class="co"># append predicted labels to the training and test sets</span></span>
<span id="cb31-401"><a href="#cb31-401"></a></span>
<span id="cb31-402"><a href="#cb31-402"></a>df_ttd_train[<span class="st">'model_rejection'</span>] <span class="op">=</span> AutoGluon_TTD_model.predict(</span>
<span id="cb31-403"><a href="#cb31-403"></a>    df_ttd_train[AutoGluon_TTD_model.feature_names_]</span>
<span id="cb31-404"><a href="#cb31-404"></a>)</span>
<span id="cb31-405"><a href="#cb31-405"></a></span>
<span id="cb31-406"><a href="#cb31-406"></a>df_ttd_test[<span class="st">'model_rejection'</span>] <span class="op">=</span> AutoGluon_TTD_model.predict(</span>
<span id="cb31-407"><a href="#cb31-407"></a>    df_ttd_test[AutoGluon_TTD_model.feature_names_]</span>
<span id="cb31-408"><a href="#cb31-408"></a>)</span>
<span id="cb31-409"><a href="#cb31-409"></a><span class="in">```</span></span>
<span id="cb31-410"><a href="#cb31-410"></a></span>
<span id="cb31-413"><a href="#cb31-413"></a><span class="in">```{python}</span></span>
<span id="cb31-414"><a href="#cb31-414"></a><span class="co">#| label: tbl-training-decisions</span></span>
<span id="cb31-415"><a href="#cb31-415"></a><span class="co">#| tbl-cap: "Training set decisions"</span></span>
<span id="cb31-416"><a href="#cb31-416"></a></span>
<span id="cb31-417"><a href="#cb31-417"></a>keep_cols <span class="op">=</span> AutoGluon_TTD_model.feature_names_ <span class="op">+</span> [<span class="st">'model_rejection'</span>]</span>
<span id="cb31-418"><a href="#cb31-418"></a></span>
<span id="cb31-419"><a href="#cb31-419"></a>display(df_ttd_train[keep_cols].sample(<span class="dv">20</span>, random_state<span class="op">=</span><span class="dv">2024</span>).head(<span class="dv">10</span>))</span>
<span id="cb31-420"><a href="#cb31-420"></a><span class="in">```</span></span>
<span id="cb31-421"><a href="#cb31-421"></a></span>
<span id="cb31-424"><a href="#cb31-424"></a><span class="in">```{python}</span></span>
<span id="cb31-425"><a href="#cb31-425"></a><span class="co">#| label: tbl-test-decisions</span></span>
<span id="cb31-426"><a href="#cb31-426"></a><span class="co">#| tbl-cap: "Test set decisions"</span></span>
<span id="cb31-427"><a href="#cb31-427"></a></span>
<span id="cb31-428"><a href="#cb31-428"></a>display(df_ttd_test[keep_cols].sample(<span class="dv">20</span>, random_state<span class="op">=</span><span class="dv">2024</span>).head(<span class="dv">10</span>))</span>
<span id="cb31-429"><a href="#cb31-429"></a></span>
<span id="cb31-430"><a href="#cb31-430"></a><span class="in">```</span></span>
<span id="cb31-431"><a href="#cb31-431"></a></span>
<span id="cb31-432"><a href="#cb31-432"></a>Second, we randomly select 1 rejected applicant from the test set to explain. This applicant will be used to demonstrate the counterfactual explanation process.</span>
<span id="cb31-433"><a href="#cb31-433"></a></span>
<span id="cb31-436"><a href="#cb31-436"></a><span class="in">```{python}</span></span>
<span id="cb31-437"><a href="#cb31-437"></a><span class="co">#| label: tbl-sample-applicant</span></span>
<span id="cb31-438"><a href="#cb31-438"></a><span class="co">#| tbl-cap: "Sample rejected applicant"</span></span>
<span id="cb31-439"><a href="#cb31-439"></a></span>
<span id="cb31-440"><a href="#cb31-440"></a>sample_reject <span class="op">=</span> df_ttd_test[keep_cols][df_ttd_test.model_rejection <span class="op">==</span> <span class="dv">1</span>].sample(<span class="dv">1</span>, random_state<span class="op">=</span><span class="dv">2020</span>)</span>
<span id="cb31-441"><a href="#cb31-441"></a></span>
<span id="cb31-442"><a href="#cb31-442"></a>display(sample_reject)</span>
<span id="cb31-443"><a href="#cb31-443"></a><span class="in">```</span></span>
<span id="cb31-444"><a href="#cb31-444"></a></span>
<span id="cb31-445"><a href="#cb31-445"></a><span class="fu">## Counterfactual Explainer</span></span>
<span id="cb31-446"><a href="#cb31-446"></a></span>
<span id="cb31-447"><a href="#cb31-447"></a>Setup an <span class="in">`dice-explainer`</span> using the <span class="in">`dice_ml`</span> library. The explainer will be used to generate counterfactuals for the rejected applicant.</span>
<span id="cb31-448"><a href="#cb31-448"></a></span>
<span id="cb31-449"><a href="#cb31-449"></a>The explainer needs two objects:</span>
<span id="cb31-450"><a href="#cb31-450"></a></span>
<span id="cb31-451"><a href="#cb31-451"></a><span class="ss">1.  </span>Data with the predicted labels (<span class="in">`model_rejection`</span>).</span>
<span id="cb31-452"><a href="#cb31-452"></a><span class="ss">2.  </span>The trained model used to generate prediction labels.</span>
<span id="cb31-453"><a href="#cb31-453"></a></span>
<span id="cb31-456"><a href="#cb31-456"></a><span class="in">```{python}</span></span>
<span id="cb31-457"><a href="#cb31-457"></a><span class="co">#| label: setup-counterfactuals</span></span>
<span id="cb31-458"><a href="#cb31-458"></a></span>
<span id="cb31-459"><a href="#cb31-459"></a>dice_data <span class="op">=</span> dice_ml.Data(</span>
<span id="cb31-460"><a href="#cb31-460"></a>    dataframe<span class="op">=</span>df_ttd_train[keep_cols],</span>
<span id="cb31-461"><a href="#cb31-461"></a>    continuous_features<span class="op">=</span>AutoGluon_TTD_model.feature_names_,</span>
<span id="cb31-462"><a href="#cb31-462"></a>    outcome_name<span class="op">=</span><span class="st">"model_rejection"</span></span>
<span id="cb31-463"><a href="#cb31-463"></a>)</span>
<span id="cb31-464"><a href="#cb31-464"></a></span>
<span id="cb31-465"><a href="#cb31-465"></a>dice_model <span class="op">=</span> dice_ml.Model(</span>
<span id="cb31-466"><a href="#cb31-466"></a>    model<span class="op">=</span>AutoGluon_TTD_model,</span>
<span id="cb31-467"><a href="#cb31-467"></a>    backend<span class="op">=</span><span class="st">'sklearn'</span></span>
<span id="cb31-468"><a href="#cb31-468"></a>)</span>
<span id="cb31-469"><a href="#cb31-469"></a></span>
<span id="cb31-470"><a href="#cb31-470"></a>dice_explainer <span class="op">=</span> dice_ml.Dice(</span>
<span id="cb31-471"><a href="#cb31-471"></a>    data_interface<span class="op">=</span>dice_data,</span>
<span id="cb31-472"><a href="#cb31-472"></a>    model_interface<span class="op">=</span>dice_model,</span>
<span id="cb31-473"><a href="#cb31-473"></a>    method<span class="op">=</span><span class="st">"kdtree"</span></span>
<span id="cb31-474"><a href="#cb31-474"></a>)</span>
<span id="cb31-475"><a href="#cb31-475"></a></span>
<span id="cb31-476"><a href="#cb31-476"></a><span class="in">```</span></span>
<span id="cb31-477"><a href="#cb31-477"></a></span>
<span id="cb31-478"><a href="#cb31-478"></a>A k-d tree (k-dimensional tree) is a data structure used for organizing points in a k-dimensional space. It recursively partitions the space along different dimensions, allowing for efficient nearest neighbor searches. This structure helps quickly find data points that are close to a given query point in multiple dimensions.</span>
<span id="cb31-479"><a href="#cb31-479"></a></span>
<span id="cb31-480"><a href="#cb31-480"></a>DiCE uses the k-d tree method to efficiently search the feature space for counterfactual examples. It builds a k-d tree using the training data points. When generating counterfactuals for a specific instance (like the rejected applicant), DiCE searches the k-d tree to find the nearest data points that result in the desired outcome (e.g., loan approval) while minimizing changes to the original features.</span>
<span id="cb31-481"><a href="#cb31-481"></a></span>
<span id="cb31-482"><a href="#cb31-482"></a><span class="fu">## Counterfactual Explanations</span></span>
<span id="cb31-483"><a href="#cb31-483"></a></span>
<span id="cb31-486"><a href="#cb31-486"></a><span class="in">```{python}</span></span>
<span id="cb31-487"><a href="#cb31-487"></a><span class="co">#| label: generate-counterfactuals</span></span>
<span id="cb31-488"><a href="#cb31-488"></a></span>
<span id="cb31-489"><a href="#cb31-489"></a>threshold <span class="op">=</span> AutoGluon_TTD_model.predictor.decision_threshold <span class="co"># Use decision_threshold</span></span>
<span id="cb31-490"><a href="#cb31-490"></a></span>
<span id="cb31-491"><a href="#cb31-491"></a>user_permitted_range <span class="op">=</span> {</span>
<span id="cb31-492"><a href="#cb31-492"></a>    <span class="st">'loan_amnt'</span>: [<span class="dv">500</span>, sample_reject[<span class="st">'loan_amnt'</span>].iloc[<span class="dv">0</span>]],</span>
<span id="cb31-493"><a href="#cb31-493"></a>    <span class="st">'dti'</span>: [<span class="dv">0</span>, sample_reject[<span class="st">'dti'</span>].iloc[<span class="dv">0</span>]],</span>
<span id="cb31-494"><a href="#cb31-494"></a>    <span class="st">'credit_score'</span>: [sample_reject[<span class="st">'credit_score'</span>].iloc[<span class="dv">0</span>], <span class="dv">850</span>],</span>
<span id="cb31-495"><a href="#cb31-495"></a>    <span class="st">'emp_length'</span>: [sample_reject[<span class="st">'emp_length'</span>].iloc[<span class="dv">0</span>], <span class="dv">10</span>]</span>
<span id="cb31-496"><a href="#cb31-496"></a>}</span>
<span id="cb31-497"><a href="#cb31-497"></a></span>
<span id="cb31-498"><a href="#cb31-498"></a>dice_exp <span class="op">=</span> dice_explainer.generate_counterfactuals(</span>
<span id="cb31-499"><a href="#cb31-499"></a>    query_instances<span class="op">=</span>sample_reject[AutoGluon_TTD_model.feature_names_],</span>
<span id="cb31-500"><a href="#cb31-500"></a>    total_CFs<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb31-501"><a href="#cb31-501"></a>    permitted_range<span class="op">=</span>user_permitted_range</span>
<span id="cb31-502"><a href="#cb31-502"></a>    )</span>
<span id="cb31-503"><a href="#cb31-503"></a></span>
<span id="cb31-504"><a href="#cb31-504"></a><span class="co"># Extract the counterfactual features (scaled)</span></span>
<span id="cb31-505"><a href="#cb31-505"></a>df_counterfactuals <span class="op">=</span> dice_exp.cf_examples_list[<span class="dv">0</span>].final_cfs_df</span>
<span id="cb31-506"><a href="#cb31-506"></a></span>
<span id="cb31-507"><a href="#cb31-507"></a><span class="in">```</span></span>
<span id="cb31-508"><a href="#cb31-508"></a></span>
<span id="cb31-509"><a href="#cb31-509"></a>The <span class="in">`user_permitted_range`</span> dictionary prevents counterfactuals that are unintuitive or impossible. It prevents counterfactuals with a <span class="in">`loan_amnt`</span> greater than the application amount, a <span class="in">`dti`</span> greater than the applicant value, a <span class="in">`credit_score`</span> less than the applicant value, and an <span class="in">`emp_length`</span> less than the applicant value.</span>
<span id="cb31-510"><a href="#cb31-510"></a></span>
<span id="cb31-513"><a href="#cb31-513"></a><span class="in">```{python}</span></span>
<span id="cb31-514"><a href="#cb31-514"></a><span class="co">#| label: tbl-rejected-applicant</span></span>
<span id="cb31-515"><a href="#cb31-515"></a><span class="co">#| tbl-cap: "Rejected applicant"</span></span>
<span id="cb31-516"><a href="#cb31-516"></a></span>
<span id="cb31-517"><a href="#cb31-517"></a>display(sample_reject)</span>
<span id="cb31-518"><a href="#cb31-518"></a></span>
<span id="cb31-519"><a href="#cb31-519"></a><span class="in">```</span></span>
<span id="cb31-520"><a href="#cb31-520"></a></span>
<span id="cb31-523"><a href="#cb31-523"></a><span class="in">```{python}</span></span>
<span id="cb31-524"><a href="#cb31-524"></a><span class="co">#| label: tbl-counterfactuals</span></span>
<span id="cb31-525"><a href="#cb31-525"></a><span class="co">#| tbl-cap: "Counterfactuals for rejected applicant"</span></span>
<span id="cb31-526"><a href="#cb31-526"></a></span>
<span id="cb31-527"><a href="#cb31-527"></a></span>
<span id="cb31-528"><a href="#cb31-528"></a>display(df_counterfactuals)</span>
<span id="cb31-529"><a href="#cb31-529"></a><span class="in">```</span></span>
<span id="cb31-530"><a href="#cb31-530"></a></span>
<span id="cb31-531"><a href="#cb31-531"></a>Verify that the counterfactuals provided would have generated an approval by the TTD model.</span>
<span id="cb31-532"><a href="#cb31-532"></a></span>
<span id="cb31-535"><a href="#cb31-535"></a><span class="in">```{python}</span></span>
<span id="cb31-536"><a href="#cb31-536"></a><span class="co">#| label: tbl-verify-counterfactuals</span></span>
<span id="cb31-537"><a href="#cb31-537"></a><span class="co">#| tbl-cap: "Verify counterfactuals"</span></span>
<span id="cb31-538"><a href="#cb31-538"></a></span>
<span id="cb31-539"><a href="#cb31-539"></a>df_counterfactuals[<span class="st">'verify_model_rejection'</span>] <span class="op">=</span> AutoGluon_TTD_model.predict(</span>
<span id="cb31-540"><a href="#cb31-540"></a>    df_counterfactuals[AutoGluon_TTD_model.feature_names_]</span>
<span id="cb31-541"><a href="#cb31-541"></a>)</span>
<span id="cb31-542"><a href="#cb31-542"></a></span>
<span id="cb31-543"><a href="#cb31-543"></a>display(df_counterfactuals)</span>
<span id="cb31-544"><a href="#cb31-544"></a><span class="in">```</span></span>
<span id="cb31-545"><a href="#cb31-545"></a></span>
<span id="cb31-546"><a href="#cb31-546"></a>**Interpretation:** The output shows alternative feature values (the counterfactuals) that would have led to an 'Approve' decision. This highlights the key factors driving the rejection and provides concrete suggestions for the applicant.</span>
<span id="cb31-547"><a href="#cb31-547"></a></span>
<span id="cb31-548"><a href="#cb31-548"></a><span class="fu"># Generate Adverse Action Codes</span></span>
<span id="cb31-549"><a href="#cb31-549"></a></span>
<span id="cb31-550"><a href="#cb31-550"></a>The script below generates a list of adverse action codes based on differences between <span class="in">`sample_reject`</span> and <span class="in">`df_counterfactuals`</span>. It does this by comparing the values of each feature, and if a value differs between the two datasets, it appends a predefined message to the adverse action codes list.</span>
<span id="cb31-551"><a href="#cb31-551"></a></span>
<span id="cb31-552"><a href="#cb31-552"></a>By comparing each feature of the original sample against the counterfactual, the code effectively identifies which factors (such as a too-high loan amount or a low credit score) contributed to the adverse decision and communicates those reasons clearly to the applicant.</span>
<span id="cb31-553"><a href="#cb31-553"></a></span>
<span id="cb31-556"><a href="#cb31-556"></a><span class="in">```{python}</span></span>
<span id="cb31-557"><a href="#cb31-557"></a><span class="co">#| label: adverse-action-codes</span></span>
<span id="cb31-558"><a href="#cb31-558"></a><span class="co">#| tbl-cap: "Adverse Action Codes"</span></span>
<span id="cb31-559"><a href="#cb31-559"></a></span>
<span id="cb31-560"><a href="#cb31-560"></a><span class="kw">def</span> generate_adverse_action_codes(df_rejected, df_counterfactuals, dict_feature_to_action, list_features_to_compare):</span>
<span id="cb31-561"><a href="#cb31-561"></a>    <span class="co">"""</span></span>
<span id="cb31-562"><a href="#cb31-562"></a><span class="co">    Generate adverse action codes based on differences between a rejected applicant and its counterfactual.</span></span>
<span id="cb31-563"><a href="#cb31-563"></a></span>
<span id="cb31-564"><a href="#cb31-564"></a><span class="co">    Args:</span></span>
<span id="cb31-565"><a href="#cb31-565"></a><span class="co">        df_rejected (DataFrame): DataFrame with the rejected applicant's data (assumed to be a single row).</span></span>
<span id="cb31-566"><a href="#cb31-566"></a><span class="co">        df_counterfactuals (DataFrame): DataFrame containing counterfactual data (first row is used).</span></span>
<span id="cb31-567"><a href="#cb31-567"></a><span class="co">        dict_feature_to_action (dict): Mapping from feature names to their corresponding adverse action message.</span></span>
<span id="cb31-568"><a href="#cb31-568"></a><span class="co">        list_features_to_compare (list): List of feature names to compare between the rejected and counterfactual data.</span></span>
<span id="cb31-569"><a href="#cb31-569"></a></span>
<span id="cb31-570"><a href="#cb31-570"></a><span class="co">    Returns:</span></span>
<span id="cb31-571"><a href="#cb31-571"></a><span class="co">        list: A list of adverse action codes as strings.</span></span>
<span id="cb31-572"><a href="#cb31-572"></a><span class="co">    """</span></span>
<span id="cb31-573"><a href="#cb31-573"></a>    adverse_action_codes <span class="op">=</span> []</span>
<span id="cb31-574"><a href="#cb31-574"></a></span>
<span id="cb31-575"><a href="#cb31-575"></a>    <span class="cf">for</span> feature <span class="kw">in</span> list_features_to_compare:</span>
<span id="cb31-576"><a href="#cb31-576"></a>        original_value <span class="op">=</span> df_rejected[feature].iloc[<span class="dv">0</span>]</span>
<span id="cb31-577"><a href="#cb31-577"></a>        counterfactual_value <span class="op">=</span> df_counterfactuals[feature].iloc[<span class="dv">0</span>]</span>
<span id="cb31-578"><a href="#cb31-578"></a>        <span class="cf">if</span> original_value <span class="op">!=</span> counterfactual_value:</span>
<span id="cb31-579"><a href="#cb31-579"></a>            adverse_action_codes.append(dict_feature_to_action[feature])</span>
<span id="cb31-580"><a href="#cb31-580"></a></span>
<span id="cb31-581"><a href="#cb31-581"></a>    <span class="cf">return</span> adverse_action_codes</span>
<span id="cb31-582"><a href="#cb31-582"></a><span class="in">```</span></span>
<span id="cb31-583"><a href="#cb31-583"></a></span>
<span id="cb31-586"><a href="#cb31-586"></a><span class="in">```{python}</span></span>
<span id="cb31-587"><a href="#cb31-587"></a><span class="co">#| label: adverse-action-codes-example</span></span>
<span id="cb31-588"><a href="#cb31-588"></a>feature_to_action_code <span class="op">=</span> {</span>
<span id="cb31-589"><a href="#cb31-589"></a>    <span class="st">'loan_amnt'</span>: <span class="st">"Loan amount too high"</span>,</span>
<span id="cb31-590"><a href="#cb31-590"></a>    <span class="st">'dti'</span>: <span class="st">"Debt-to-income ratio too high"</span>,</span>
<span id="cb31-591"><a href="#cb31-591"></a>    <span class="st">'credit_score'</span>: <span class="st">"Credit score too low"</span>,</span>
<span id="cb31-592"><a href="#cb31-592"></a>    <span class="st">'emp_length'</span>: <span class="st">"Employment length too short"</span></span>
<span id="cb31-593"><a href="#cb31-593"></a>}</span>
<span id="cb31-594"><a href="#cb31-594"></a></span>
<span id="cb31-595"><a href="#cb31-595"></a>action_codes <span class="op">=</span> generate_adverse_action_codes(</span>
<span id="cb31-596"><a href="#cb31-596"></a>    sample_reject, </span>
<span id="cb31-597"><a href="#cb31-597"></a>    df_counterfactuals, </span>
<span id="cb31-598"><a href="#cb31-598"></a>    feature_to_action_code, </span>
<span id="cb31-599"><a href="#cb31-599"></a>    AutoGluon_TTD_model.feature_names_</span>
<span id="cb31-600"><a href="#cb31-600"></a>)</span>
<span id="cb31-601"><a href="#cb31-601"></a></span>
<span id="cb31-602"><a href="#cb31-602"></a><span class="bu">print</span>(<span class="st">"Adverse Action Codes:"</span>)</span>
<span id="cb31-603"><a href="#cb31-603"></a><span class="cf">for</span> code <span class="kw">in</span> action_codes:</span>
<span id="cb31-604"><a href="#cb31-604"></a>    <span class="bu">print</span>(<span class="ss">f"- </span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-605"><a href="#cb31-605"></a><span class="in">```</span></span>
<span id="cb31-606"><a href="#cb31-606"></a></span>
<span id="cb31-607"><a href="#cb31-607"></a><span class="fu"># Improved Adverse Action Codes</span></span>
<span id="cb31-608"><a href="#cb31-608"></a></span>
<span id="cb31-609"><a href="#cb31-609"></a>A major drawback of this approach is that the order of the generated codes depends on the order of the features in the list <span class="in">`AutoGluon_TTD_model.feature_names_`</span>. Ideally (and legally), the order should be based on the importance of the features in the model decision.</span>
<span id="cb31-610"><a href="#cb31-610"></a></span>
<span id="cb31-611"><a href="#cb31-611"></a>We can re-order the elements in the list based on permutation feature importance (PFI) scores. The code below generates the PFI scores and re-orders the adverse action codes based on the PFI scores.</span>
<span id="cb31-612"><a href="#cb31-612"></a></span>
<span id="cb31-615"><a href="#cb31-615"></a><span class="in">```{python}</span></span>
<span id="cb31-616"><a href="#cb31-616"></a><span class="co">#| label: permutation-feature-importance</span></span>
<span id="cb31-617"><a href="#cb31-617"></a></span>
<span id="cb31-618"><a href="#cb31-618"></a>pfi <span class="op">=</span> AutoGluon_TTD_model.predictor.feature_importance(</span>
<span id="cb31-619"><a href="#cb31-619"></a>    df_ttd_test[AutoGluon_TTD_model.feature_names_ <span class="op">+</span> [<span class="st">'default_flag'</span>]],</span>
<span id="cb31-620"><a href="#cb31-620"></a>    silent<span class="op">=</span><span class="va">True</span></span>
<span id="cb31-621"><a href="#cb31-621"></a>)</span>
<span id="cb31-622"><a href="#cb31-622"></a></span>
<span id="cb31-623"><a href="#cb31-623"></a>important_features <span class="op">=</span> pfi.index.tolist()</span>
<span id="cb31-624"><a href="#cb31-624"></a><span class="in">```</span></span>
<span id="cb31-625"><a href="#cb31-625"></a></span>
<span id="cb31-628"><a href="#cb31-628"></a><span class="in">```{python}</span></span>
<span id="cb31-629"><a href="#cb31-629"></a><span class="co">#| label: improved-adverse-action-codes</span></span>
<span id="cb31-630"><a href="#cb31-630"></a></span>
<span id="cb31-631"><a href="#cb31-631"></a>improved_action_codes <span class="op">=</span> generate_adverse_action_codes(</span>
<span id="cb31-632"><a href="#cb31-632"></a>    sample_reject, </span>
<span id="cb31-633"><a href="#cb31-633"></a>    df_counterfactuals, </span>
<span id="cb31-634"><a href="#cb31-634"></a>    feature_to_action_code, </span>
<span id="cb31-635"><a href="#cb31-635"></a>    important_features</span>
<span id="cb31-636"><a href="#cb31-636"></a>)</span>
<span id="cb31-637"><a href="#cb31-637"></a></span>
<span id="cb31-638"><a href="#cb31-638"></a><span class="bu">print</span>(<span class="st">"Improved Adverse Action Codes:"</span>)</span>
<span id="cb31-639"><a href="#cb31-639"></a><span class="cf">for</span> code <span class="kw">in</span> improved_action_codes:</span>
<span id="cb31-640"><a href="#cb31-640"></a>    <span class="bu">print</span>(<span class="ss">f"- </span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-641"><a href="#cb31-641"></a><span class="in">```</span></span>
<span id="cb31-642"><a href="#cb31-642"></a></span>
<span id="cb31-643"><a href="#cb31-643"></a>Permutation feature importance provides a global ranking of feature impacts in the model. By ordering the adverse action codes according to this ranking, we ensure that the most important features are highlighted first. This is crucial for effective communication with applicants, as it emphasizes the most significant factors influencing their application outcome.</span>
<span id="cb31-644"><a href="#cb31-644"></a></span>
<span id="cb31-645"><a href="#cb31-645"></a>However, global ranking of feature impacts is not always equal to the local ranking of feature impacts. For example, the most important feature for the model may not be the most important feature for a specific applicant. This is a limitation of the PFI approach. SHAP values can be used to generate local rankings of feature impacts.</span>
<span id="cb31-646"><a href="#cb31-646"></a></span>
<span id="cb31-647"><a href="#cb31-647"></a><span class="fu"># SHAP Values</span></span>
<span id="cb31-648"><a href="#cb31-648"></a></span>
<span id="cb31-649"><a href="#cb31-649"></a><span class="fu">## Concept</span></span>
<span id="cb31-650"><a href="#cb31-650"></a></span>
<span id="cb31-651"><a href="#cb31-651"></a>The difference between the predicted probability of default ($\widehat{PD_i}$) for an applicant ($i$) and the average predicted PD ($\overline{PD}$) for a given data set can be decomposed into the contributions of each feature. The contributions are called SHAP values.</span>
<span id="cb31-652"><a href="#cb31-652"></a></span>
<span id="cb31-653"><a href="#cb31-653"></a>Suppose a credit scorecard model had 4 features. Then, for applicant $i$, there would be 4 SHAP values, one for each feature. The SHAP values can be interpreted as the contribution of each feature to the difference between the predicted PD and the average PD.</span>
<span id="cb31-654"><a href="#cb31-654"></a></span>
<span id="cb31-655"><a href="#cb31-655"></a>$\widehat{PD_i} - \overline{PD} = \phi_{i,DTI} + \phi_{i,CreditScore} + \phi_{i,EmpLength} + \phi_{i,LoanAmnt}$</span>
<span id="cb31-656"><a href="#cb31-656"></a></span>
<span id="cb31-657"><a href="#cb31-657"></a>For a given data set (e.g., training set), $\overline{PD}$ is constant. Therefore, the SHAP values can be interpreted as the contribution of each feature to the predicted PD.</span>
<span id="cb31-658"><a href="#cb31-658"></a></span>
<span id="cb31-659"><a href="#cb31-659"></a>$\widehat{PD_i} = \overline{PD} + \phi_{i,DTI} + \phi_{i,CreditScore} + \phi_{i,EmpLength} + \phi_{i,LoanAmnt}$</span>
<span id="cb31-660"><a href="#cb31-660"></a></span>
<span id="cb31-661"><a href="#cb31-661"></a>SHAP values can be negative or positive. A negative SHAP value means that the feature decreases the predicted PD, while a positive SHAP value means that the feature increases the predicted PD.</span>
<span id="cb31-662"><a href="#cb31-662"></a></span>
<span id="cb31-663"><a href="#cb31-663"></a><span class="fu">## Setup SHAP Explainer</span></span>
<span id="cb31-664"><a href="#cb31-664"></a></span>
<span id="cb31-665"><a href="#cb31-665"></a>Initialize the SHAP explainer using the constrained model and a background dataset (usually a sample of the training data) to represent the baseline prediction.</span>
<span id="cb31-666"><a href="#cb31-666"></a></span>
<span id="cb31-667"><a href="#cb31-667"></a>Notice that the background dataset does not contain the true label. The SHAP explainer uses the background dataset to calculate the expected value of the model's predictions. This is important because the SHAP values are calculated as the difference between the predicted value and the expected value.</span>
<span id="cb31-668"><a href="#cb31-668"></a></span>
<span id="cb31-669"><a href="#cb31-669"></a>We pass a custom <span class="in">`predict_proba`</span> function (with <span class="in">`[:, 1]`</span>) to the explainer that returns the model's predicted probability of the positive class (default=1), as we want to explain this specific outcome.</span>
<span id="cb31-670"><a href="#cb31-670"></a></span>
<span id="cb31-671"><a href="#cb31-671"></a>The background data provides a reference distribution to calculate the baseline prediction ($E<span class="co">[</span><span class="ot">f(X)</span><span class="co">]</span>$) and baseline values for each feature. A sample is often used for computational efficiency.</span>
<span id="cb31-672"><a href="#cb31-672"></a></span>
<span id="cb31-675"><a href="#cb31-675"></a><span class="in">```{python}</span></span>
<span id="cb31-676"><a href="#cb31-676"></a><span class="co">#| label: setup-shap</span></span>
<span id="cb31-677"><a href="#cb31-677"></a></span>
<span id="cb31-678"><a href="#cb31-678"></a>background_data_sample <span class="op">=</span> df_ttd_train[AutoGluon_TTD_model.feature_names_].sample(<span class="dv">60_000</span>, random_state<span class="op">=</span><span class="dv">2025</span>)</span>
<span id="cb31-679"><a href="#cb31-679"></a></span>
<span id="cb31-680"><a href="#cb31-680"></a>shap_explainer <span class="op">=</span> shap.Explainer(<span class="kw">lambda</span> x: AutoGluon_TTD_model.predict_proba(x)[:, <span class="dv">1</span>], background_data_sample)</span>
<span id="cb31-681"><a href="#cb31-681"></a></span>
<span id="cb31-682"><a href="#cb31-682"></a><span class="in">```</span></span>
<span id="cb31-683"><a href="#cb31-683"></a></span>
<span id="cb31-684"><a href="#cb31-684"></a><span class="fu">## Local Interpretability (Waterfall Plots)</span></span>
<span id="cb31-685"><a href="#cb31-685"></a></span>
<span id="cb31-686"><a href="#cb31-686"></a>Calculate SHAP values for the 1 rejected applicant and plot the SHAP values using a waterfall plot. The waterfall plot shows the contribution of each feature to the predicted PD for that specific applicant.</span>
<span id="cb31-687"><a href="#cb31-687"></a></span>
<span id="cb31-690"><a href="#cb31-690"></a><span class="in">```{python}</span></span>
<span id="cb31-691"><a href="#cb31-691"></a><span class="co">#| label: fig-calculate-local-shap</span></span>
<span id="cb31-692"><a href="#cb31-692"></a><span class="co">#| fig-cap: "SHAP Waterfall Plot for Rejected Applicant"</span></span>
<span id="cb31-693"><a href="#cb31-693"></a></span>
<span id="cb31-694"><a href="#cb31-694"></a><span class="co"># Generate SHAP values for the rejected applicant</span></span>
<span id="cb31-695"><a href="#cb31-695"></a>shap_values <span class="op">=</span> shap_explainer(sample_reject[AutoGluon_TTD_model.feature_names_])</span>
<span id="cb31-696"><a href="#cb31-696"></a></span>
<span id="cb31-697"><a href="#cb31-697"></a><span class="co"># Display the waterfall plot for the first (and only) instance</span></span>
<span id="cb31-698"><a href="#cb31-698"></a>shap.plots.waterfall(shap_values[<span class="dv">0</span>])</span>
<span id="cb31-699"><a href="#cb31-699"></a><span class="in">```</span></span>
<span id="cb31-700"><a href="#cb31-700"></a></span>
<span id="cb31-701"><a href="#cb31-701"></a>**Interpretation:** The baseline PD is <span class="in">`{python} round(float(shap_values.base_values[0]),3)`</span>. The sum of the SHAP values (feature contributions) for this applicant is approximately <span class="in">`{python} round(np.sum(shap_values.values),3)`</span>. Adding this to the baseline prediction gives the final prediction <span class="in">`{python} round(float(shap_values.base_values[0]),3)`</span> + <span class="in">`{python} round(np.sum(shap_values.values),3)`</span> = <span class="in">`{python} round(float(shap_values.base_values[0]) + np.sum(shap_values.values),3)`</span>. </span>
<span id="cb31-702"><a href="#cb31-702"></a></span>
<span id="cb31-705"><a href="#cb31-705"></a><span class="in">```{python}</span></span>
<span id="cb31-706"><a href="#cb31-706"></a><span class="co">#| label: tbl-local-shap-values</span></span>
<span id="cb31-707"><a href="#cb31-707"></a><span class="co">#| tbl-cap: "Sorted SHAP values for rejected applicant"</span></span>
<span id="cb31-708"><a href="#cb31-708"></a></span>
<span id="cb31-709"><a href="#cb31-709"></a></span>
<span id="cb31-710"><a href="#cb31-710"></a>df_local_shap <span class="op">=</span> pd.DataFrame({</span>
<span id="cb31-711"><a href="#cb31-711"></a>    <span class="st">'feature'</span>: AutoGluon_TTD_model.feature_names_,</span>
<span id="cb31-712"><a href="#cb31-712"></a>    <span class="st">'shap_value'</span>: shap_values[<span class="dv">0</span>].values</span>
<span id="cb31-713"><a href="#cb31-713"></a>})</span>
<span id="cb31-714"><a href="#cb31-714"></a>df_local_shap[<span class="st">'abs_shap_value'</span>] <span class="op">=</span> df_local_shap[<span class="st">'shap_value'</span>].<span class="bu">abs</span>()</span>
<span id="cb31-715"><a href="#cb31-715"></a>df_local_shap.sort_values(<span class="st">'abs_shap_value'</span>, ascending<span class="op">=</span><span class="va">False</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-716"><a href="#cb31-716"></a></span>
<span id="cb31-717"><a href="#cb31-717"></a>display(df_local_shap)</span>
<span id="cb31-718"><a href="#cb31-718"></a></span>
<span id="cb31-719"><a href="#cb31-719"></a><span class="in">```</span></span>
<span id="cb31-720"><a href="#cb31-720"></a></span>
<span id="cb31-721"><a href="#cb31-721"></a>When we generate a ranked list of features that affected the predicted PD, we should use the **absolute value** of the SHAP values. The absolute value of the SHAP value indicates the magnitude of the impact, regardless of whether it is positive or negative.</span>
<span id="cb31-722"><a href="#cb31-722"></a></span>
<span id="cb31-723"><a href="#cb31-723"></a>The feature that contributes the most to the predicted PD is <span class="in">`credit_score`</span>, followed by <span class="in">`dti`</span> and <span class="in">`loan_amnt`</span>. The feature <span class="in">`emp_length`</span> has the least impact on the predicted PD.</span>
<span id="cb31-724"><a href="#cb31-724"></a></span>
<span id="cb31-725"><a href="#cb31-725"></a>::: callout-warning</span>
<span id="cb31-726"><a href="#cb31-726"></a>**Important Point: Understanding a Single SHAP Value**</span>
<span id="cb31-727"><a href="#cb31-727"></a></span>
<span id="cb31-728"><a href="#cb31-728"></a>Think of the SHAP values shown in the waterfall plot for one applicant:</span>
<span id="cb31-729"><a href="#cb31-729"></a></span>
<span id="cb31-730"><a href="#cb31-730"></a><span class="ss">-   </span>**What they explain:** Each SHAP value shows how a specific feature *value* for *that particular applicant* pushed their prediction away from the average prediction (the baseline `E[f(X)]`). For instance, the positive SHAP value for `credit_score` means *this applicant's specific credit score* increased their predicted Probability of Default (PD) compared to the average.</span>
<span id="cb31-731"><a href="#cb31-731"></a></span>
<span id="cb31-732"><a href="#cb31-732"></a><span class="ss">-   </span>**What they DON'T explain:**</span>
<span id="cb31-733"><a href="#cb31-733"></a></span>
<span id="cb31-734"><a href="#cb31-734"></a><span class="ss">    -   </span>A single SHAP value for one applicant doesn't tell you the *overall trend* or *marginal effect* of that feature. It doesn't answer the question: "In general, if someone increases their <span class="in">`credit_score`</span>, will their predicted PD decrease?" We should use dependence plots to answer this question.</span>
<span id="cb31-735"><a href="#cb31-735"></a></span>
<span id="cb31-736"><a href="#cb31-736"></a><span class="ss">    -   </span>Nor does the SHAP value answer the question for the rejected applicant: "If the <span class="in">`credit_score`</span> was 20 points higher, would the predicted PD be lower for the applicant?" We should use counterfactuals to answer this question.</span>
<span id="cb31-737"><a href="#cb31-737"></a></span>
<span id="cb31-738"><a href="#cb31-738"></a>:::</span>
<span id="cb31-739"><a href="#cb31-739"></a></span>
<span id="cb31-740"><a href="#cb31-740"></a><span class="fu"># Local Adverse Action Codes</span></span>
<span id="cb31-741"><a href="#cb31-741"></a></span>
<span id="cb31-742"><a href="#cb31-742"></a>The code below generates adverse action codes for the 1 rejected applicant based on the SHAP values. It uses the same logic as before, but now it uses the SHAP values to determine which features are most important for our specific applicant.</span>
<span id="cb31-743"><a href="#cb31-743"></a></span>
<span id="cb31-746"><a href="#cb31-746"></a><span class="in">```{python}</span></span>
<span id="cb31-747"><a href="#cb31-747"></a><span class="co">#| label: local-adverse-action-codes</span></span>
<span id="cb31-748"><a href="#cb31-748"></a></span>
<span id="cb31-749"><a href="#cb31-749"></a></span>
<span id="cb31-750"><a href="#cb31-750"></a>shap_local_important_features <span class="op">=</span> df_local_shap[<span class="st">'feature'</span>].tolist()</span>
<span id="cb31-751"><a href="#cb31-751"></a></span>
<span id="cb31-752"><a href="#cb31-752"></a>shap_action_codes <span class="op">=</span> generate_adverse_action_codes(</span>
<span id="cb31-753"><a href="#cb31-753"></a>    sample_reject, </span>
<span id="cb31-754"><a href="#cb31-754"></a>    df_counterfactuals, </span>
<span id="cb31-755"><a href="#cb31-755"></a>    feature_to_action_code, </span>
<span id="cb31-756"><a href="#cb31-756"></a>    shap_local_important_features</span>
<span id="cb31-757"><a href="#cb31-757"></a>)</span>
<span id="cb31-758"><a href="#cb31-758"></a></span>
<span id="cb31-759"><a href="#cb31-759"></a><span class="bu">print</span>(<span class="st">"SHAP Adverse Action Codes:"</span>)</span>
<span id="cb31-760"><a href="#cb31-760"></a><span class="cf">for</span> code <span class="kw">in</span> shap_action_codes:</span>
<span id="cb31-761"><a href="#cb31-761"></a>    <span class="bu">print</span>(<span class="ss">f"- </span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-762"><a href="#cb31-762"></a><span class="in">```</span></span>
<span id="cb31-763"><a href="#cb31-763"></a></span>
<span id="cb31-764"><a href="#cb31-764"></a><span class="fu"># Concluding Remarks for Adverse Action Codes</span></span>
<span id="cb31-765"><a href="#cb31-765"></a></span>
<span id="cb31-766"><a href="#cb31-766"></a>Subsequent sections of the lab will show other uses of SHAP values and a potpourri of data science topics. Before we address those topics, let's quickly summarize adverse action codes and the process used to generate them.</span>
<span id="cb31-767"><a href="#cb31-767"></a></span>
<span id="cb31-768"><a href="#cb31-768"></a><span class="ss">1.  </span>Each rejected applicant must be given a list of reasons for rejection. This is a legal requirement in the US.</span>
<span id="cb31-769"><a href="#cb31-769"></a></span>
<span id="cb31-770"><a href="#cb31-770"></a><span class="ss">2.  </span>The list of reasons should be ordered from most impactful to least impactful. This is also a legal requirement in the US.</span>
<span id="cb31-771"><a href="#cb31-771"></a></span>
<span id="cb31-772"><a href="#cb31-772"></a><span class="ss">3.  </span>To generate the list of adverse action codes, we needed to find an example of an **approved applicant** that was very similar to the rejected applicant. This was accomplished using **counterfactual explanations**.</span>
<span id="cb31-773"><a href="#cb31-773"></a></span>
<span id="cb31-774"><a href="#cb31-774"></a><span class="ss">4.  </span>The order of the adverse action codes was based on the **permutation feature importance** (PFI) scores, representing a global ranking of feature impacts in the model.</span>
<span id="cb31-775"><a href="#cb31-775"></a></span>
<span id="cb31-776"><a href="#cb31-776"></a><span class="ss">5.  </span>Alternatively, we could have used **SHAP values** to generate a local ranking of feature impacts, providing a more accurate ranking for the specific applicant.</span>
<span id="cb31-777"><a href="#cb31-777"></a></span>
<span id="cb31-778"><a href="#cb31-778"></a><span class="fu"># Other Uses of SHAP Values</span></span>
<span id="cb31-779"><a href="#cb31-779"></a></span>
<span id="cb31-780"><a href="#cb31-780"></a><span class="fu">## Global Interpretability (Summary Plots)</span></span>
<span id="cb31-781"><a href="#cb31-781"></a></span>
<span id="cb31-782"><a href="#cb31-782"></a>Aggregate SHAP values across a larger sample (e.g., the test set) to understand overall feature importance and effects.</span>
<span id="cb31-783"><a href="#cb31-783"></a></span>
<span id="cb31-784"><a href="#cb31-784"></a>Bar Plot: Ranks features by their average impact (mean absolute SHAP value) across the sample. Higher bars mean more influence overall.</span>
<span id="cb31-785"><a href="#cb31-785"></a></span>
<span id="cb31-788"><a href="#cb31-788"></a><span class="in">```{python}</span></span>
<span id="cb31-789"><a href="#cb31-789"></a><span class="co">#| label: fig-global-bar-chart</span></span>
<span id="cb31-790"><a href="#cb31-790"></a><span class="co">#| fig-cap: "SHAP Feature Importance Bar Plot"</span></span>
<span id="cb31-791"><a href="#cb31-791"></a></span>
<span id="cb31-792"><a href="#cb31-792"></a>test_set_sample <span class="op">=</span> df_ttd_test[AutoGluon_TTD_model.feature_names_].sample(<span class="dv">1000</span>, random_state<span class="op">=</span><span class="dv">2025</span>)</span>
<span id="cb31-793"><a href="#cb31-793"></a></span>
<span id="cb31-794"><a href="#cb31-794"></a>shap_values_global <span class="op">=</span> shap_explainer(test_set_sample)</span>
<span id="cb31-795"><a href="#cb31-795"></a></span>
<span id="cb31-796"><a href="#cb31-796"></a>shap.plots.bar(shap_values_global, max_display<span class="op">=</span><span class="dv">10</span>, show<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-797"><a href="#cb31-797"></a><span class="in">```</span></span>
<span id="cb31-798"><a href="#cb31-798"></a></span>
<span id="cb31-799"><a href="#cb31-799"></a>Show the bar plot as a data frame.</span>
<span id="cb31-800"><a href="#cb31-800"></a></span>
<span id="cb31-803"><a href="#cb31-803"></a><span class="in">```{python}</span></span>
<span id="cb31-804"><a href="#cb31-804"></a><span class="co">#| label: tbl-global-bar-chart</span></span>
<span id="cb31-805"><a href="#cb31-805"></a><span class="co">#| tbl-cap: "Average Absolute SHAP values"</span></span>
<span id="cb31-806"><a href="#cb31-806"></a></span>
<span id="cb31-807"><a href="#cb31-807"></a></span>
<span id="cb31-808"><a href="#cb31-808"></a><span class="co"># Calculate mean absolute SHAP values</span></span>
<span id="cb31-809"><a href="#cb31-809"></a>mean_abs_shap <span class="op">=</span> np.<span class="bu">abs</span>(shap_values_global.values).mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb31-810"><a href="#cb31-810"></a></span>
<span id="cb31-811"><a href="#cb31-811"></a><span class="co"># Create DataFrame</span></span>
<span id="cb31-812"><a href="#cb31-812"></a>df_shap_summary <span class="op">=</span> pd.DataFrame({</span>
<span id="cb31-813"><a href="#cb31-813"></a>    <span class="st">'feature'</span>: test_set_sample.columns,</span>
<span id="cb31-814"><a href="#cb31-814"></a>    <span class="st">'mean_abs_shap_value'</span>: mean_abs_shap</span>
<span id="cb31-815"><a href="#cb31-815"></a>})</span>
<span id="cb31-816"><a href="#cb31-816"></a></span>
<span id="cb31-817"><a href="#cb31-817"></a><span class="co"># Sort by mean absolute SHAP value (descending)</span></span>
<span id="cb31-818"><a href="#cb31-818"></a>df_shap_summary <span class="op">=</span> df_shap_summary.sort_values(<span class="st">'mean_abs_shap_value'</span>, ascending<span class="op">=</span><span class="va">False</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-819"><a href="#cb31-819"></a></span>
<span id="cb31-820"><a href="#cb31-820"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb31-821"><a href="#cb31-821"></a>display(df_shap_summary)</span>
<span id="cb31-822"><a href="#cb31-822"></a><span class="in">```</span></span>
<span id="cb31-823"><a href="#cb31-823"></a></span>
<span id="cb31-824"><a href="#cb31-824"></a>Beeswarm Plot: Shows each feature's SHAP value distribution. Each point is one instance. Color indicates the feature's value (high/low). This reveals not just importance but also the direction of the effect (e.g., high credit_score (red points) have negative SHAP values, decreasing default probability).</span>
<span id="cb31-825"><a href="#cb31-825"></a></span>
<span id="cb31-828"><a href="#cb31-828"></a><span class="in">```{python}</span></span>
<span id="cb31-829"><a href="#cb31-829"></a><span class="co">#| label: fig-global-beeswarm</span></span>
<span id="cb31-830"><a href="#cb31-830"></a><span class="co">#| fig-cap: "SHAP Summary Plot"</span></span>
<span id="cb31-831"><a href="#cb31-831"></a></span>
<span id="cb31-832"><a href="#cb31-832"></a>shap.plots.beeswarm(shap_values_global, max_display<span class="op">=</span><span class="dv">10</span>, show<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-833"><a href="#cb31-833"></a><span class="in">```</span></span>
<span id="cb31-834"><a href="#cb31-834"></a></span>
<span id="cb31-835"><a href="#cb31-835"></a><span class="fu">## SHAP Dependence Plots</span></span>
<span id="cb31-836"><a href="#cb31-836"></a></span>
<span id="cb31-837"><a href="#cb31-837"></a>Explore how a feature's impact (SHAP value) changes with its value, potentially colored by an interacting feature.</span>
<span id="cb31-838"><a href="#cb31-838"></a></span>
<span id="cb31-839"><a href="#cb31-839"></a>These plots show the relationship between a feature's value (x-axis) and its SHAP value (y-axis). The vertical spread, often colored by an interacting feature, highlights how the feature's impact might depend on other factors.</span>
<span id="cb31-840"><a href="#cb31-840"></a></span>
<span id="cb31-841"><a href="#cb31-841"></a>The SHAP dependence plot is an alternative to PDP, ICE, and ALE plots. It provides a more detailed view of how a feature's value affects the model's prediction, especially when interactions with other features are present.</span>
<span id="cb31-842"><a href="#cb31-842"></a></span>
<span id="cb31-845"><a href="#cb31-845"></a><span class="in">```{python}</span></span>
<span id="cb31-846"><a href="#cb31-846"></a><span class="co">#| label: fig-shap-dependence</span></span>
<span id="cb31-847"><a href="#cb31-847"></a><span class="co">#| fig-cap: "SHAP Dependence Plot"</span></span>
<span id="cb31-848"><a href="#cb31-848"></a></span>
<span id="cb31-849"><a href="#cb31-849"></a>features_for_dependence <span class="op">=</span> AutoGluon_TTD_model.feature_names_</span>
<span id="cb31-850"><a href="#cb31-850"></a></span>
<span id="cb31-851"><a href="#cb31-851"></a><span class="cf">for</span> feature <span class="kw">in</span> features_for_dependence:</span>
<span id="cb31-852"><a href="#cb31-852"></a>    <span class="cf">if</span> feature <span class="kw">in</span> test_set_sample.columns: <span class="co"># Use the defined sample DataFrame</span></span>
<span id="cb31-853"><a href="#cb31-853"></a>        <span class="co"># Generate the plot but don't show it immediately</span></span>
<span id="cb31-854"><a href="#cb31-854"></a>        shap.plots.scatter(shap_values_global[:, feature], color<span class="op">=</span>shap_values_global, alpha<span class="op">=</span><span class="fl">0.4</span>, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-855"><a href="#cb31-855"></a>        <span class="co"># Display the current figure explicitly</span></span>
<span id="cb31-856"><a href="#cb31-856"></a>        plt.show()</span>
<span id="cb31-857"><a href="#cb31-857"></a>        <span class="co"># Close the figure to prevent the message</span></span>
<span id="cb31-858"><a href="#cb31-858"></a>        plt.close()</span>
<span id="cb31-859"><a href="#cb31-859"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>